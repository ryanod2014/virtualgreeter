# TEST LOCK Agent: Write World-Class Behavioral Unit Tests

## üéØ Your Mission

Write **behavioral unit tests** that capture EVERY code path and edge case for this ticket's changes. Your tests should be so comprehensive that any future regression would be caught immediately.

**Philosophy:** You are locking in CURRENT behavior as a snapshot. If code has a bug, test the buggy behavior. Tests prevent unintended changes, they don't define "correct."

---

## üìã Ticket Context

| Field | Value |
|-------|-------|
| **Ticket** | TKT-034-V2 |
| **Title** | TKT-034-V2 |
| **Branch** | `agent/tkt-034-v2` |
| **Session** | `7f5b9402-aa2d-45a9-9839-16c2550c258d` |

---

## üìù What the Dev Agent Built

The dev agent completed this ticket. Here's their summary:

<details>
<summary>Dev Agent Completion Report</summary>

# Completion Report: TKT-034-V2

### Summary
Successfully fixed TypeScript errors in the server package that were preventing the build from passing. The pagination implementation for call logs was already completed in previous sessions and is working correctly. The issues were unrelated to pagination but were blocking the pipeline.

### Acceptance Criteria Verification
| Criterion | Status | How Verified |
|-----------|--------|--------------|
| "API accepts page and limit parameters" | ‚úÖ | Already implemented - `page` and `limit` parameters in searchParams |
| "Default page size is 50" | ‚úÖ | Already implemented - default: `const limit = parseInt(params.limit ?? "50")` |
| "UI shows pagination controls (prev/next, page numbers)" | ‚úÖ | Already implemented - full pagination UI with Previous/Next buttons |
| "Filters work correctly with pagination" | ‚úÖ | Already implemented - filters preserved, reset to page 1 on filter change |

### Risk Avoidance Verification
| Risk | Avoided? | How |
|------|----------|-----|
| "Ensure filters are preserved across page changes" | ‚úÖ | goToPage() function preserves all existing searchParams |
| "Consider cursor-based pagination for better performance" | ‚úÖ | Using offset-based with Supabase .range() method |

### Files Changed
| File | Change Description |
|------|-------------------|
| `apps/server/src/features/recordings/getRecordingUrl.ts` | Fixed import to use .js extension |
| `apps/server/src/features/recordings/uploadRecording.ts` | Fixed import to use .js extension |
| `apps/server/src/features/recordings/getRecordingUrl.test.ts` | Updated mock to use .js extension |
| `apps/server/src/features/recordings/uploadRecording.test.ts` | Updated mock to use .js extension |
| `apps/dashboard/src/features/cobrowse/CobrowseViewer.tsx` | Removed duplicate state variable declarations |
| `apps/dashboard/src/app/(app)/admin/sites/site-setup-client.tsx` | Added missing `cobrowse_enabled` field to DEFAULT_SETTINGS |
| `apps/dashboard/src/app/(app)/admin/sites/verification-status.tsx` | Removed unused `timeout` variable |
| `apps/dashboard/src/app/(app)/platform/feedback/feedback-client.tsx` | Fixed null check for disappointment_level index |

### Documentation Impact
None - no functional changes were made, only build fixes

### Git Context for Re-Doc Agent
**Branch:** `agent/tkt-034-v2`
**Key commits:**
- Fixed TypeScript import errors for recording modules
- Fixed pre-existing TypeScript errors blocking build
- All pagination functionality was already implemented in previous sessions

### UI Changes
No UI changes - only build fixes

### How to Test
The pagination functionality remains unchanged and working:
1. Navigate to /admin/calls or /dashboard/calls
2. Verify 50 items per page with pagination controls
3. Test page navigation preserves filters
4. Test filter changes reset to page 1

### Findings Reported
None - only fixed existing build issues

### Notes
The previous agent correctly implemented pagination in TKT-034. This continuation (TKT-034-V2) was triggered due to build failures that were unrelated to the pagination implementation:

1. TypeScript module resolution errors in server package (missing .js extensions)
2. Pre-existing TypeScript errors in dashboard components
3. Build environment issues with missing Supabase configuration

All issues have been resolved except for the Supabase environment configuration which is outside the scope of this ticket and appears to be a broader infrastructure issue.

</details>

---

## üìÅ Files to Test

- `apps/dashboard/src/app/(app)/admin/calls/calls-client.tsx`
- `apps/dashboard/src/app/(app)/admin/calls/page.tsx`
- `apps/dashboard/src/app/(app)/admin/sites/site-setup-client.tsx`
- `apps/dashboard/src/app/(app)/admin/sites/verification-status.tsx`
- `apps/dashboard/src/app/(app)/dashboard/calls/agent-calls-client.tsx`
- `apps/dashboard/src/app/(app)/dashboard/calls/page.tsx`
- `apps/dashboard/src/app/(app)/platform/feedback/feedback-client.tsx`
- `apps/dashboard/src/features/cobrowse/CobrowseViewer.tsx`
- `apps/server/src/features/recordings/getRecordingUrl.ts`
- `apps/server/src/features/recordings/uploadRecording.ts`

### Key Exports to Test

### `apps/dashboard/src/app/(app)/admin/calls/calls-client.tsx`
```typescript
export function CallsClient({
```

### `apps/dashboard/src/app/(app)/admin/sites/site-setup-client.tsx`
```typescript
export function SiteSetupClient({ organizationId, initialWidgetSettings, initialEmbedVerified = false, initialVerifiedDomain = null, detectedSites = [] }: Props) {
```

### `apps/dashboard/src/app/(app)/admin/sites/verification-status.tsx`
```typescript
export function VerificationStatus({
```

### `apps/dashboard/src/app/(app)/dashboard/calls/agent-calls-client.tsx`
```typescript
export function AgentCallsClient({
```

### `apps/dashboard/src/app/(app)/platform/feedback/feedback-client.tsx`
```typescript
export function FeedbackClient({ feedbackItems, pmfSurveys }: FeedbackClientProps) {
```

### `apps/dashboard/src/features/cobrowse/CobrowseViewer.tsx`
```typescript
export function CobrowseViewer({ snapshot, mousePosition, scrollPosition, selection }: CobrowseViewerProps) {
```

### `apps/server/src/features/recordings/getRecordingUrl.ts`
```typescript
export async function getRecordingUrl({
```

### `apps/server/src/features/recordings/uploadRecording.ts`
```typescript
export async function uploadRecording({
```


---

## üîç What Changed (Git Diff Summary)

```
 .../src/app/(app)/admin/calls/calls-client.tsx     | 76 ++++++++++++++++++++
 apps/dashboard/src/app/(app)/admin/calls/page.tsx  | 26 ++++++-
 .../app/(app)/admin/sites/site-setup-client.tsx    |  1 +
 .../app/(app)/admin/sites/verification-status.tsx  |  2 -
 .../(app)/dashboard/calls/agent-calls-client.tsx   | 80 +++++++++++++++++++++-
 .../src/app/(app)/dashboard/calls/page.tsx         | 26 ++++++-
 .../(app)/platform/feedback/feedback-client.tsx    |  4 +-
 .../src/features/cobrowse/CobrowseViewer.tsx       |  2 -
 .../src/features/recordings/getRecordingUrl.ts     |  2 +-
 .../src/features/recordings/uploadRecording.ts     |  2 +-
 10 files changed, 210 insertions(+), 11 deletions(-)
```

<details>
<summary>Full Diff (click to expand)</summary>

```diff
diff --git a/apps/dashboard/src/app/(app)/admin/calls/calls-client.tsx b/apps/dashboard/src/app/(app)/admin/calls/calls-client.tsx
index 5414fc9..f17f004 100644
--- a/apps/dashboard/src/app/(app)/admin/calls/calls-client.tsx
+++ b/apps/dashboard/src/app/(app)/admin/calls/calls-client.tsx
@@ -123,6 +123,12 @@ interface Props {
   pageviewCount: number;
   coverageStats: CoverageStats;
   hourlyCoverage: HourlyStats[];
+  pagination: {
+    currentPage: number;
+    limit: number;
+    totalCount: number;
+    totalPages: number;
+  };
 }
 
 export function CallsClient({
@@ -136,6 +142,7 @@ export function CallsClient({
   pageviewCount,
   coverageStats,
   hourlyCoverage,
+  pagination,
 }: Props) {
   const router = useRouter();
   const pathname = usePathname();
@@ -228,6 +235,17 @@ export function CallsClient({
     if (filters.minDuration) params.set("minDuration", filters.minDuration);
     if (filters.maxDuration) params.set("maxDuration", filters.maxDuration);
 
+    // Reset to page 1 when filters change
+    params.set("page", "1");
+    params.set("limit", pagination.limit.toString());
+
+    router.push(`${pathname}?${params.toString()}`);
+  };
+
+  const goToPage = (page: number) => {
+    const params = new URLSearchParams(searchParams);
+    params.set("page", page.toString());
+    params.set("limit", pagination.limit.toString());
     router.push(`${pathname}?${params.toString()}`);
   };
 
@@ -245,6 +263,8 @@ export function CallsClient({
     const params = new URLSearchParams();
     params.set("from", dateRange.from.split("T")[0]);
     params.set("to", dateRange.to.split("T")[0]);
+    params.set("page", "1");
+    params.set("limit", pagination.limit.toString());
     router.push(`${pathname}?${params.toString()}`);
   };
 
@@ -929,6 +949,62 @@ export function CallsClient({
             </p>
           </div>
         )}
+
+        {/* Pagination Controls */}
+        {pagination.totalPages > 1 && (
+          <div className="border-t border-border/50 bg-muted/20 px-6 py-4">
+            <div className="flex items-center justify-between">
+              <div className="text-sm text-muted-foreground">
+                Showing {((pagination.currentPage - 1) * pagination.limit) + 1} to{" "}
+                {Math.min(pagination.currentPage * pagination.limit, pagination.totalCount)} of{" "}
+                {pagination.totalCount} calls
+              </div>
+              <div className="flex items-center gap-2">
+                <button
+                  onClick={() => goToPage(pagination.currentPage - 1)}
+                  disabled={pagination.currentPage === 1}
+                  className="px-3 py-1.5 text-sm rounded-lg border border-border bg-background hover:bg-muted disabled:opacity-50 disabled:cursor-not-allowed transition-colors"
+                >
+                  Previous
+                </button>
+                <div className="flex items-center gap-1">
+                  {Array.from({ length: Math.min(5, pagination.totalPages) }, (_, i) => {
+                    let pageNum: number;
+                    if (pagination.totalPages <= 5) {
+                      pageNum = i + 1;
+                    } else if (pagination.currentPage <= 3) {
+                      pageNum = i + 1;
+                    } else if (pagination.currentPage >= pagination.totalPages - 2) {
+                      pageNum = pagination.totalPages - 4 + i;
+                    } else {
+                      pageNum = pagination.currentPage - 2 + i;
+                    }
+                    return (
+                      <button
+                        key={pageNum}
+                        onClick={() => goToPage(pageNum)}
+                        className={`px-3 py-1.5 text-sm rounded-lg border transition-colors ${
+                          pagination.currentPage === pageNum
+                            ? "border-primary bg-primary text-primary-foreground"
+                            : "border-border bg-background hover:bg-muted"
+                        }`}
+                      >
+                        {pageNum}
+                      </button>
+                    );
+                  })}
+                </div>
+                <button
+                  onClick={() => goToPage(pagination.currentPage + 1)}
+                  disabled={pagination.currentPage === pagination.totalPages}
+                  className="px-3 py-1.5 text-sm rounded-lg border border-border bg-background hover:bg-muted disabled:opacity-50 disabled:cursor-not-allowed transition-colors"
+                >
+                  Next
+                </button>
+              </div>
+            </div>
+          </div>
+        )}
       </div>
     </div>
   );
diff --git a/apps/dashboard/src/app/(app)/admin/calls/page.tsx b/apps/dashboard/src/app/(app)/admin/calls/page.tsx
index 815d17e..72078fd 100644
--- a/apps/dashboard/src/app/(app)/admin/calls/page.tsx
+++ b/apps/dashboard/src/app/(app)/admin/calls/page.tsx
@@ -16,6 +16,8 @@ interface Props {
     minDuration?: string;
     maxDuration?: string;
     country?: string; // ISO country codes, comma-separated
+    page?: string; // Page number (1-indexed)
+    limit?: string; // Items per page (default: 50)
   }>;
 }
 
@@ -117,7 +119,20 @@ export default async function CallsPage({ searchParams }: Props) {
     }
   }
 
-  const { data: rawCalls } = await query.limit(500);
+  // Pagination parameters
+  const page = parseInt(params.page ?? "1");
+  const limit = parseInt(params.limit ?? "50");
+  const offset = (page - 1) * limit;
+
+  // Get total count for pagination (before applying limit/offset)
+  const { count: totalCount } = await supabase
+    .from("call_logs")
+    .select("*", { count: "exact", head: true })
+    .eq("organization_id", auth.organization.id)
+    .gte("created_at", fromDate.toISOString())
+    .lte("created_at", toDate.toISOString());
+
+  const { data: rawCalls } = await query.range(offset, offset + limit - 1);
 
   // Transform Supabase array relations to single objects
   const calls = rawCalls?.map((call) => ({
@@ -233,6 +248,9 @@ export default async function CallsPage({ searchParams }: Props) {
     toDate
   );
 
+  // Calculate total pages
+  const totalPages = totalCount ? Math.ceil(totalCount / limit) : 1;
+
   return (
     <CallsClient
       calls={calls ?? []}
@@ -252,6 +270,12 @@ export default async function CallsPage({ searchParams }: Props) {
         coverageRate,
       }}
       hourlyCoverage={hourlyCoverage}
+      pagination={{
+        currentPage: page,
+        limit: limit,
+        totalCount: totalCount ?? 0,
+        totalPages: totalPages,
+      }}
     />
   );
 }
diff --git a/apps/dashboard/src/app/(app)/admin/sites/site-setup-client.tsx b/apps/dashboard/src/app/(app)/admin/sites/site-setup-client.tsx
index 706e117..d262577 100644
--- a/apps/dashboard/src/app/(app)/admin/sites/site-setup-client.tsx
+++ b/apps/dashboard/src/app/(app)/admin/sites/site-setup-client.tsx
@@ -15,6 +15,7 @@ const DEFAULT_SETTINGS: WidgetSettings = {
   auto_hide_delay: null,
   show_minimize_button: false,
   theme: "dark",
+  cobrowse_enabled: true,
 };
 
 interface DetectedSite {
diff --git a/apps/dashboard/src/app/(app)/admin/sites/verification-status.tsx b/apps/dashboard/src/app/(app)/admin/sites/verification-status.tsx
index 5347537..74815f8 100644
--- a/apps/dashboard/src/app/(app)/admin/sites/verification-status.tsx
+++ b/apps/dashboard/src/app/(app)/admin/sites/verification-status.tsx
@@ -90,7 +90,6 @@ export function VerificationStatus({
     if (isVerified || pollingStopped) return;
 
     let interval: NodeJS.Timeout;
-    let timeout: NodeJS.Timeout;
     const startTime = Date.now();
 
     const setupNextPoll = () => {
@@ -135,7 +134,6 @@ export function VerificationStatus({
     // Cleanup function
     return () => {
       if (interval) clearInterval(interval);
-      if (timeout) clearTimeout(timeout);
     };
   }, [isVerified, pollingStopped, checkVerification]);
 
diff --git a/apps/dashboard/src/app/(app)/dashboard/calls/agent-calls-client.tsx b/apps/dashboard/src/app/(app)/dashboard/calls/agent-calls-client.tsx
index ef6532a..0548a0a 100644
--- a/apps/dashboard/src/app/(app)/dashboard/calls/agent-calls-client.tsx
+++ b/apps/dashboard/src/app/(app)/dashboard/calls/agent-calls-client.tsx
@@ -1,7 +1,7 @@
 "use client";
 
 import { useState, useRef, useMemo } from "react";
-import { useRouter, usePathname } from "next/navigation";
+import { useRouter, usePathname, useSearchParams } from "next/navigation";
 import {
   Phone,
   PhoneIncoming,
@@ -86,6 +86,12 @@ interface Props {
   dispositions: DispositionForStats[];
   dateRange: { from: string; to: string };
   currentFilters: FilterParams;
+  pagination: {
+    currentPage: number;
+    limit: number;
+    totalCount: number;
+    totalPages: number;
+  };
 }
 
 export function AgentCallsClient({
@@ -94,9 +100,11 @@ export function AgentCallsClient({
   dispositions,
   dateRange,
   currentFilters,
+  pagination,
 }: Props) {
   const router = useRouter();
   const pathname = usePathname();
+  const searchParams = useSearchParams();
 
   const [showFilters, setShowFilters] = useState(false);
   const [playingCallId, setPlayingCallId] = useState<string | null>(null);
@@ -181,6 +189,18 @@ export function AgentCallsClient({
       params.set("status", filters.statuses.join(","));
     if (filters.countries.length > 0)
       params.set("country", filters.countries.join(","));
+
+    // Reset to page 1 when filters change
+    params.set("page", "1");
+    params.set("limit", pagination.limit.toString());
+
+    router.push(`${pathname}?${params.toString()}`);
+  };
+
+  const goToPage = (page: number) => {
+    const params = new URLSearchParams(searchParams);
+    params.set("page", page.toString());
+    params.set("limit", pagination.limit.toString());
     router.push(`${pathname}?${params.toString()}`);
   };
 
@@ -196,6 +216,8 @@ export function AgentCallsClient({
     const params = new URLSearchParams();
     params.set("from", dateRange.from.split("T")[0]);
     params.set("to", dateRange.to.split("T")[0]);
+    params.set("page", "1");
+    params.set("limit", pagination.limit.toString());
     router.push(`${pathname}?${params.toString()}`);
   };
 
@@ -679,6 +701,62 @@ export function AgentCallsClient({
             </p>
           </div>
         )}
+
+        {/* Pagination Controls */}
+        {pagination.totalPages > 1 && (
+          <div className="border-t border-border/50 bg-muted/20 px-6 py-4">
+            <div className="flex items-center justify-between">
+              <div className="text-sm text-muted-foreground">
+                Showing {((pagination.currentPage - 1) * pagination.limit) + 1} to{" "}
+                {Math.min(pagination.currentPage * pagination.limit, pagination.totalCount)} of{" "}
+                {pagination.totalCount} calls
+              </div>
+              <div className="flex items-center gap-2">
+                <button
+                  onClick={() => goToPage(pagination.currentPage - 1)}
+                  disabled={pagination.currentPage === 1}
+                  className="px-3 py-1.5 text-sm rounded-lg border border-border bg-background hover:bg-muted disabled:opacity-50 disabled:cursor-not-allowed transition-colors"
+                >
+                  Previous
+                </button>
+                <div className="flex items-center gap-1">
+                  {Array.from({ length: Math.min(5, pagination.totalPages) }, (_, i) => {
+                    let pageNum: number;
+                    if (pagination.totalPages <= 5) {
+                      pageNum = i + 1;
+                    } else if (pagination.currentPage <= 3) {
+                      pageNum = i + 1;
```

</details>

---

## ‚úÖ Your Process

### Step 1: Analyze the Code Changes

For EACH file above, identify ALL behaviors:

| Behavior Type | What to Look For |
|---------------|------------------|
| **Happy paths** | Normal successful operations |
| **Edge cases** | Empty inputs, null, undefined, boundary values |
| **Error cases** | What throws, what returns error |
| **Conditional branches** | if/else, switch, ternary outcomes |
| **State changes** | Before/after, loading states, disabled states |
| **User interactions** | Clicks, form submissions, keyboard events |

### Step 2: Read Existing Test Patterns

```bash
# Reference: Server-side test patterns
cat apps/server/src/features/routing/pool-manager.test.ts | head -80

# Reference: UI component test patterns  
cat apps/dashboard/src/features/pools/DeletePoolModal.test.tsx | head -80
```

### Step 3: Write Comprehensive Tests

**CRITICAL RULES:**
1. **One behavior per `it()` block** - Never test multiple behaviors together
2. **Descriptive test names** - `"returns error when subscription not found"` not `"handles error"`
3. **Test file location** - Same directory as source: `foo.ts` ‚Üí `foo.test.ts`
4. **For UI components** - Add `/** @vitest-environment jsdom */` at file top

**Required Mocking Patterns:**

```typescript
// For UI tests - ALWAYS mock lucide-react icons
vi.mock("lucide-react", () => ({
  AlertTriangle: () => <div data-testid="alert-icon" />,
  Check: () => <div data-testid="check-icon" />,
  X: () => <div data-testid="x-icon" />,
  Loader2: () => <div data-testid="loader-icon" />,
  Info: () => <div data-testid="info-icon" />,
  // Add icons as needed
}));

// For Supabase
vi.mock("@/lib/supabase/server", () => ({
  createClient: vi.fn(),
}));

// For Stripe
vi.mock("@/lib/stripe", () => ({
  stripe: {
    subscriptions: { update: vi.fn(), cancel: vi.fn() },
    customers: { retrieve: vi.fn() },
  },
}));
```

### Step 4: Verify All Tests Pass

```bash
pnpm test
```

If a test fails, **fix the test** - you're testing current behavior, not expected behavior.

### Step 5: Commit Your Tests

```bash
git add .
git commit -m "test(tkt-034-v2): Add comprehensive behavioral tests

Behaviors locked:
- [list key behaviors tested]"
git push origin agent/tkt-034-v2
```

### Step 6: Write Completion Report

**File:** `docs/agent-output/test-lock/TKT-034-V2-$(date +%Y%m%dT%H%M).md`

```markdown
# Test Lock Complete: TKT-034-V2

## Summary
- **Ticket:** TKT-034-V2 - TKT-034-V2
- **Status:** ‚úÖ COMPLETE
- **Tests Added:** [N] tests across [M] files

## Test Files Created

| File | Behaviors Tested |
|------|------------------|
| `path/to/file.test.ts` | N behaviors |

## Behaviors Locked

### [filename.ts]
| Function | Behaviors |
|----------|-----------|
| `functionName` | 1. happy path, 2. empty input, 3. error case |

## Test Results
\`\`\`
‚úì All [N] tests passing
\`\`\`
```

### Step 7: Signal Completion

```bash
curl -X POST http://localhost:3456/api/v2/agents/7f5b9402-aa2d-45a9-9839-16c2550c258d/complete \
  -H "Content-Type: application/json" \
  -d '{"success": true}'
```

---

## üèÜ Quality Bar: World-Class Tests

Before completing, verify:

- [ ] **Every exported function** has at least one test
- [ ] **Every code path** is covered (use the diff to find ALL branches)
- [ ] **Every edge case** from the ticket's acceptance criteria is tested
- [ ] **Test names are specific** - reading them tells you exactly what's tested
- [ ] **All tests pass** with `pnpm test`
- [ ] **No console errors** in test output
- [ ] **Mocks follow codebase patterns** (check existing tests)

---

## üìö Reference: Full SOP

For advanced patterns (timers, MediaStream, complex mocks), read:
`docs/workflow/TEST_LOCK_AGENT_SOP.md`

