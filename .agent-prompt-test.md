# TEST LOCK Agent: Write World-Class Behavioral Unit Tests

## üéØ Your Mission

Write **behavioral unit tests** that capture EVERY code path and edge case for this ticket's changes. Your tests should be so comprehensive that any future regression would be caught immediately.

**Philosophy:** You are locking in CURRENT behavior as a snapshot. If code has a bug, test the buggy behavior. Tests prevent unintended changes, they don't define "correct."

---

## üìã Ticket Context

| Field | Value |
|-------|-------|
| **Ticket** | TKT-077 |
| **Title** | TKT-077 |
| **Branch** | `agent/tkt-077` |
| **Session** | `58871234-f619-4c02-a38d-4710456b9cb6` |

---

## üìù What the Dev Agent Built

The dev agent completed this ticket. Here's their summary:

<details>
<summary>Dev Agent Completion Report</summary>

# TKT-077: Improve Error Message for Catch-All Pool Routing Rules

## Status: COMPLETE

## Summary

Improved the user experience when attempting to add or modify routing rules on catch-all pools by:

1. **Displaying user-friendly error messages** instead of silent `console.warn()` calls
2. **Catching database trigger errors** that prevent routing rules on catch-all pools
3. **Providing clear, actionable guidance** to users

## Changes Made

### File: `apps/dashboard/src/app/(app)/admin/pools/pools-client.tsx`

#### `handleAddRoutingRule` function (lines 1785-1838)
- Changed `console.warn()` to `alert()` with user-friendly message
- Added error handling for database insert errors
- Detects catch-all pool errors by checking for "catch-all" or "catch_all" in error message
- Shows generic error message for other database failures

#### `handleUpdateRoutingRule` function (lines 1855-1904)
- Same improvements as above for consistency
- Changed `console.warn()` to `alert()` with user-friendly message
- Added error handling for database update errors

### Error Message Displayed

> "Routing rules cannot be added to the catch-all pool. This pool automatically receives all visitors not matched by other rules."

## Acceptance Criteria

- [x] Error message is clear and actionable
- [x] User understands why operation failed
- [x] F-108 is resolved

## Notes

### Pre-existing Codebase Issues

The `pnpm typecheck` and `pnpm build` commands fail due to pre-existing issues in the codebase (not related to this ticket):

1. **Merge conflict markers** in:
   - `apps/dashboard/src/features/cobrowse/CobrowseViewer.tsx`
   - `apps/dashboard/src/features/surveys/ellis-survey-modal.tsx`
   - `apps/dashboard/src/app/(app)/platform/feedback/page.tsx`
   - `apps/widget/src/features/webrtc/useWebRTC.test.ts`

2. The changes in this ticket are syntactically correct and follow existing patterns in the codebase.

### UI Already Handles Catch-All Pools

The "Add Rule" button is already hidden for catch-all pools in the UI (lines 2201-2232 of `pools-client.tsx`). Instead, users see an informational box explaining:
- "This pool automatically receives all visitors that don't match any other pool's routing rules"
- "No Rules Allowed" badge
- Option to create a new pool instead

The error handling added in this ticket provides defense-in-depth for edge cases where:
1. The client-side `is_catch_all` state is stale
2. Direct API calls bypass the UI

## Branch

`agent/tkt-077`

## Commit

`230f324` - TKT-077: Improve error message for catch-all pool routing rules

</details>

---

## üìÅ Files to Test

- `apps/dashboard/src/app/(app)/admin/pools/pools-client.tsx`

### Key Exports to Test

### `apps/dashboard/src/app/(app)/admin/pools/pools-client.tsx`
```typescript
export function PoolsClient({ 
```


---

## üîç What Changed (Git Diff Summary)

```
 .../src/app/(app)/admin/pools/pools-client.tsx     | 36 +++++++++++++++++-----
 1 file changed, 28 insertions(+), 8 deletions(-)
```

<details>
<summary>Full Diff (click to expand)</summary>

```diff
diff --git a/apps/dashboard/src/app/(app)/admin/pools/pools-client.tsx b/apps/dashboard/src/app/(app)/admin/pools/pools-client.tsx
index 0ec81fe..c01c3de 100644
--- a/apps/dashboard/src/app/(app)/admin/pools/pools-client.tsx
+++ b/apps/dashboard/src/app/(app)/admin/pools/pools-client.tsx
@@ -1786,9 +1786,9 @@ export function PoolsClient({
     const pool = pools.find(p => p.id === poolId);
     if (!pool) return;
 
-    // Catch-all pools cannot have routing rules
+    // Catch-all pools cannot have routing rules - show user-friendly message
     if (pool.is_catch_all) {
-      console.warn("Cannot add routing rules to catch-all pool");
+      alert("Routing rules cannot be added to the catch-all pool. This pool automatically receives all visitors not matched by other rules.");
       return;
     }
 
@@ -1813,7 +1813,17 @@ export function PoolsClient({
       .select()
       .single();
 
-    if (data && !error) {
+    if (error) {
+      // Check if this is the database trigger error for catch-all pools
+      if (error.message?.includes("catch-all") || error.message?.includes("catch_all")) {
+        alert("Routing rules cannot be added to the catch-all pool. This pool automatically receives all visitors not matched by other rules.");
+      } else {
+        alert(`Failed to add routing rule: ${error.message}`);
+      }
+      return;
+    }
+
+    if (data) {
       setPools(pools.map(p => {
         if (p.id === poolId) {
           return {
@@ -1844,10 +1854,10 @@ export function PoolsClient({
 
   const handleUpdateRoutingRule = async (poolId: string, ruleId: string, conditions: RuleCondition[], ruleName: string) => {
     const pool = pools.find(p => p.id === poolId);
-    
-    // Catch-all pools cannot have routing rules
+
+    // Catch-all pools cannot have routing rules - show user-friendly message
     if (pool?.is_catch_all) {
-      console.warn("Cannot update routing rules on catch-all pool");
+      alert("Routing rules cannot be modified on the catch-all pool. This pool automatically receives all visitors not matched by other rules.");
       return;
     }
 
@@ -1867,12 +1877,22 @@ export function PoolsClient({
       .select()
       .single();
 
-    if (data && !error) {
+    if (error) {
+      // Check if this is a catch-all pool related error
+      if (error.message?.includes("catch-all") || error.message?.includes("catch_all")) {
+        alert("Routing rules cannot be modified on the catch-all pool. This pool automatically receives all visitors not matched by other rules.");
+      } else {
+        alert(`Failed to update routing rule: ${error.message}`);
+      }
+      return;
+    }
+
+    if (data) {
       setPools(pools.map(p => {
         if (p.id === poolId) {
           return {
             ...p,
-            pool_routing_rules: p.pool_routing_rules.map(r => 
+            pool_routing_rules: p.pool_routing_rules.map(r =>
               r.id === ruleId ? data : r
             ),
           };
```

</details>

---

## ‚úÖ Your Process

### Step 1: Analyze the Code Changes

For EACH file above, identify ALL behaviors:

| Behavior Type | What to Look For |
|---------------|------------------|
| **Happy paths** | Normal successful operations |
| **Edge cases** | Empty inputs, null, undefined, boundary values |
| **Error cases** | What throws, what returns error |
| **Conditional branches** | if/else, switch, ternary outcomes |
| **State changes** | Before/after, loading states, disabled states |
| **User interactions** | Clicks, form submissions, keyboard events |

### Step 2: Read Existing Test Patterns

```bash
# Reference: Server-side test patterns
cat apps/server/src/features/routing/pool-manager.test.ts | head -80

# Reference: UI component test patterns  
cat apps/dashboard/src/features/pools/DeletePoolModal.test.tsx | head -80
```

### Step 3: Write Comprehensive Tests

**CRITICAL RULES:**
1. **One behavior per `it()` block** - Never test multiple behaviors together
2. **Descriptive test names** - `"returns error when subscription not found"` not `"handles error"`
3. **Test file location** - Same directory as source: `foo.ts` ‚Üí `foo.test.ts`
4. **For UI components** - Add `/** @vitest-environment jsdom */` at file top

**Required Mocking Patterns:**

```typescript
// For UI tests - ALWAYS mock lucide-react icons
vi.mock("lucide-react", () => ({
  AlertTriangle: () => <div data-testid="alert-icon" />,
  Check: () => <div data-testid="check-icon" />,
  X: () => <div data-testid="x-icon" />,
  Loader2: () => <div data-testid="loader-icon" />,
  Info: () => <div data-testid="info-icon" />,
  // Add icons as needed
}));

// For Supabase
vi.mock("@/lib/supabase/server", () => ({
  createClient: vi.fn(),
}));

// For Stripe
vi.mock("@/lib/stripe", () => ({
  stripe: {
    subscriptions: { update: vi.fn(), cancel: vi.fn() },
    customers: { retrieve: vi.fn() },
  },
}));
```

### Step 4: Verify All Tests Pass

```bash
pnpm test
```

If a test fails, **fix the test** - you're testing current behavior, not expected behavior.

### Step 5: Commit Your Tests

```bash
git add .
git commit -m "test(tkt-077): Add comprehensive behavioral tests

Behaviors locked:
- [list key behaviors tested]"
git push origin agent/tkt-077
```

### Step 6: Write Completion Report

**File:** `docs/agent-output/test-lock/TKT-077-$(date +%Y%m%dT%H%M).md`

```markdown
# Test Lock Complete: TKT-077

## Summary
- **Ticket:** TKT-077 - TKT-077
- **Status:** ‚úÖ COMPLETE
- **Tests Added:** [N] tests across [M] files

## Test Files Created

| File | Behaviors Tested |
|------|------------------|
| `path/to/file.test.ts` | N behaviors |

## Behaviors Locked

### [filename.ts]
| Function | Behaviors |
|----------|-----------|
| `functionName` | 1. happy path, 2. empty input, 3. error case |

## Test Results
\`\`\`
‚úì All [N] tests passing
\`\`\`
```

### Step 7: Signal Completion

```bash
curl -X POST http://localhost:3456/api/v2/agents/58871234-f619-4c02-a38d-4710456b9cb6/complete \
  -H "Content-Type: application/json" \
  -d '{"success": true}'
```

---

## üèÜ Quality Bar: World-Class Tests

Before completing, verify:

- [ ] **Every exported function** has at least one test
- [ ] **Every code path** is covered (use the diff to find ALL branches)
- [ ] **Every edge case** from the ticket's acceptance criteria is tested
- [ ] **Test names are specific** - reading them tells you exactly what's tested
- [ ] **All tests pass** with `pnpm test`
- [ ] **No console errors** in test output
- [ ] **Mocks follow codebase patterns** (check existing tests)

---

## üìö Reference: Full SOP

For advanced patterns (timers, MediaStream, complex mocks), read:
`docs/workflow/TEST_LOCK_AGENT_SOP.md`

