# Documentation Session: December 2, 2024

---

## âš ï¸ NEEDS YOUR ATTENTION

| Type | Count | IDs |
|------|-------|-----|
| ðŸ”´ **CRITICAL** | 1 | CRIT-A5-001 |
| ðŸŸ¡ **Questions** | 21 | Q-1202-005, Q-1202-006, Q-V2-001, Q-V2-002, Q-V2-003, Q-V4-001, Q-V4-002, Q-V4-003, Q-V4-004, Q-D2-001, Q-D2-002, Q-A5-001, Q-A5-002, Q-A5-003, Q-A4-001, Q-A4-002, Q-A4-003, Q-D3-001, Q-D3-002, Q-V5-001, Q-V5-002 |
| ðŸŽ¨ **UI Review** | 0 | - |
| ðŸ”‘ **Credentials Needed** | 0 | - |
| ðŸ’¡ **UX Recommendations** | 3 | UX-1202-001, UX-1203-001, UX-V2-001 |

**Status:** Q1 âœ… Q2 âœ… Q3 âœ… Q4 âœ… Q5 âœ… Q6 âœ… Q7 âœ… Q8 âœ… Q9 âœ…

**Next:** Creating fix tickets from decisions...

---

## Session Info
- **Started:** 2024-12-02
- **Focus:** Tier 1 Critical Features (P2, V3, A2, A3, P4)
- **PM Agent:** Main Chat

---

## Agents Active

| Agent | Feature | Status | Last Update |
|-------|---------|--------|-------------|
| Doc Agent 1 | P2: Agent Assignment Algorithm | âœ… Complete | Documentation complete |
| Doc Agent 2 | V3: Visitor Call | âœ… Complete | Documentation complete |
| Doc Agent 3 | A2: Incoming Call | âœ… Complete | Documentation complete |
| Doc Agent 4 | A3: RNA Timeout | âœ… Complete | Documentation complete |
| Doc Agent 5 | P4: Visitor Reassignment | âœ… Complete | Documentation complete |
| Doc Agent 7 | A1: Bullpen & Agent States | âœ… Complete | Documentation complete |
| Doc Agent 6 | P6: Heartbeat & Staleness Detection | âœ… Complete | Documentation complete |
| Doc Agent 8 | V1: Widget Lifecycle | âœ… Complete | Documentation complete |
| Doc Agent 11 | V2: Video Sequencer | âœ… Complete | Documentation complete |
| Doc Agent 12 | D2: Routing Rules | âœ… Complete | Documentation complete |
| Doc Agent 13 | D3: Tiered Agent Assignment | âœ… Complete | Documentation complete |
| Doc Agent 14 | A4: Agent Active Call | âœ… Complete | Documentation complete |
| Doc Agent 15 | A5: Co-Browse Viewer | âœ… Complete | Documentation complete |
| Doc Agent 13 | D3: Tiered Agent Assignment | âœ… Complete | Documentation complete |
| Doc Agent 16 | V5: Co-Browse Sender | âœ… Complete | Documentation complete |

**Status Key:** â³ Not Started | ðŸŸ¡ In Progress | ðŸ”´ Blocked/Critical | âœ… Complete

---

## ðŸ”´ CRITICAL ISSUES (Stop & Alert Immediately)

> These need YOUR decision before agents continue.
> Format: CRIT-[session]-[number]

<!-- 
### CRIT-1202-001: [Title]
**Found by:** Doc Agent X
**Feature:** [ID]
**File:** `path/to/file.ts:123`

**Current Behavior:**
[What the code does now]

**Why It's Critical:**
[Impact - broken functionality, data loss, revenue impact, etc.]

**Agent's Analysis:**
[What the doc agent thinks is wrong and why]

**Suggested Fix:**
[Initial thoughts - you'll confirm the right approach]

**YOUR DECISION:**
- [ ] Confirmed as bug - create fix ticket
- [ ] Actually intentional because: ___
- [ ] Need more info: ___
-->

### CRIT-A5-001: Password fields visible in co-browse DOM snapshots
**Found by:** Doc Agent 15
**Feature:** A5 - Co-Browse Viewer
**File:** `apps/widget/src/features/cobrowse/useCobrowse.ts:37-122`

**Current Behavior:**
When the `captureSnapshot()` function clones the DOM for co-browsing, it does NOT sanitize or mask sensitive input fields. This means:
- Password inputs (`<input type="password">`) may have their values captured
- Credit card fields and other sensitive inputs are also captured
- The agent can see everything the visitor has typed into forms

```typescript
// Current code - no sanitization of sensitive fields
const docClone = document.cloneNode(true) as Document;
// ... removes scripts and widget ...
const html = docClone.documentElement.outerHTML;
```

**Why It's Critical:**
- Privacy violation - agents can see visitor's passwords
- Security risk - sensitive data transmitted over websockets
- Potential compliance issues (PCI-DSS for credit cards)
- Trust issue if visitors discover this behavior

**Agent's Analysis:**
The DOM clone captures everything including form input values. While `type="password"` visually obscures text to the user, the underlying value can still be present in the DOM depending on how the site handles it. Even if values aren't directly in attributes, the agent could potentially see partial form data or infer passwords from field state.

**Suggested Fix:**
Add sanitization before serializing to HTML:
```typescript
// After cloning, mask sensitive inputs:
docClone.querySelectorAll('input[type="password"]').forEach((input) => {
  input.setAttribute("value", "â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢");
  (input as HTMLInputElement).value = "";
});

// Also consider:
docClone.querySelectorAll('input[type="tel"], input[autocomplete*="cc"]').forEach((input) => {
  input.setAttribute("value", "â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢");
});
```

**YOUR DECISION:**
- [ ] Confirmed as bug - create fix ticket
- [ ] Actually intentional because: ___
- [ ] Need more info: ___

---

## ðŸŸ¡ QUESTIONS FOR HUMAN (Need Your Input)

> Agents are uncertain about these. They've continued working but need clarity.
> Format: Q-[session]-[number]

### Q-1202-001: reassignVisitors() ignores pool-based routing
**Asked by:** Doc Agent 1  
**Feature:** P2
**File:** `apps/server/src/features/routing/pool-manager.ts:781-785`

**Current Behavior:**
When an agent goes away/offline and their visitors need to be reassigned, `reassignVisitors()` calls `findBestAgent()` with NO pool ID:
```typescript
const newAgent = this.findBestAgent(); // No poolId passed!
```

This means a visitor originally matched to "Sales Pool" via URL routing could be reassigned to an agent in "Support Pool" when their original agent becomes unavailable.

**Why I'm Asking:**
This might be intentional as a "better to show any agent than no agent" fallback, OR it might be an oversight that breaks the pool routing design.

**Option A:** This is correct - any agent is better than no agent during reassignment
**Option B:** This should respect pool routing - call `findBestAgentForVisitor(visitor.orgId, visitor.pageUrl)` instead

**Agent's Recommendation:** Option B - The visitor was matched to a specific pool for a reason (e.g., they're on /pricing and should see Sales agents). Reassigning them to a Support agent breaks that intent. The pool-respecting version would fall back to any agent anyway if no pool agents are available.

**YOUR ANSWER:**
- [ ] Go with Option A because: ___
- [ ] Go with Option B because: ___
- [ ] Actually it should be: ___

### Q-1202-002: Theoretical Simultaneous Camera+Mic Click Race Condition
**Asked by:** Doc Agent 2  
**Feature:** V3 - Visitor Call
**File:** `apps/widget/src/Widget.tsx:895-898, 951-955`

**Current Behavior:**
Both `handleCameraToggle` and `handleMicToggle` check `if (state === "open")` before calling `requestCall()`. This provides implicit protection against double-clicks on a SINGLE button.

However, if a user clicks BOTH camera AND mic buttons at the exact same moment (within the same event loop tick), both handlers could theoretically execute with `state === "open"` before either `setState("waiting_for_agent")` takes effect, resulting in two `call:request` events being emitted.

**Why I'm Asking:**
This is an extremely rare edge case (user would need to click two separate buttons simultaneously), but the code doesn't explicitly prevent it. The server does handle duplicate call cleanup in `CALL_REQUEST` handler (lines 298-314), so it likely wouldn't break anything.

**Option A:** Intentional - the server-side cleanup handles it gracefully, and the probability is near zero
**Option B:** Should add explicit `isRequestingCall` ref check for defense-in-depth

**Agent's Recommendation:** Option A - the server already cleans up existing calls before creating new ones, and the probability of simultaneous clicks is near zero in practice. Adding extra state would add complexity for minimal benefit.

**YOUR ANSWER:**
- [ ] Go with Option A because: ___
- [ ] Go with Option B because: ___
- [ ] Actually it should be: ___

### Q-1202-003: Incoming Call Modal Shows 30s Countdown but RNA Fires at 15s
**Asked by:** Doc Agent 3  
**Feature:** A2 - Incoming Call
**Files:** 
- `apps/dashboard/src/features/workbench/incoming-call-modal.tsx:131` (hardcoded 30s)
- `packages/domain/src/constants.ts:84` (default 15s)
- `packages/domain/src/database.types.ts:58` (org-configurable `rna_timeout_seconds`)

**Current Behavior:**
The incoming call modal displays "Request expires in 30s" with a progress bar counting down from 30. However, the actual RNA (Ring-No-Answer) timeout defaults to 15 seconds (and is org-configurable via `recording_settings.rna_timeout_seconds`).

```typescript
// incoming-call-modal.tsx:131
<span className="text-sm text-muted-foreground">
  Request expires in {30 - timeElapsed}s
</span>
```

This means the agent sees "Request expires in 25s" on screen, but RNA actually fires at 15s (or earlier if org configured a shorter timeout), potentially confusing the agent.

**Why I'm Asking:**
This is a UX issue but not critical. The agent still gets the call notification and can respond. The question is whether to:

**Option A:** Sync UI countdown with org's actual RNA timeout value (requires fetching settings or having server send timeout in payload)
**Option B:** Keep UI at 30s as a "maximum possible time" buffer (RNA might fire earlier but countdown is never wrong in showing time remaining)
**Option C:** Remove specific countdown entirely and just show "Answer now" without a timer

**Agent's Recommendation:** Option A - The countdown should reflect reality. The `CallIncomingPayload` could include the org's RNA timeout so the UI can display accurate time remaining. This prevents agents from thinking they have more time than they actually do.

**YOUR ANSWER:**
- [ ] Go with Option A because: ___
- [ ] Go with Option B because: ___
- [ ] Go with Option C because: ___
- [ ] Actually it should be: ___

### Q-1202-004: Mid-call agent disconnect ends call with no recovery
**Asked by:** Doc Agent 5  
**Feature:** P4 - Visitor Reassignment
**File:** `apps/server/src/features/signaling/socket-handlers.ts:1373-1391`

**Current Behavior:**
When an agent disconnects **during an active call**, the call is ended immediately with no grace period:
```typescript
if (activeCall) {
  markCallEnded(activeCall.callId);
  poolManager.endCall(activeCall.callId);
  visitorSocket?.emit(SOCKET_EVENTS.CALL_ENDED, {
    callId: activeCall.callId,
    reason: "agent_ended",
  });
}
```

The visitor sees "Call ended" and must start a completely new call. There's no attempt to:
1. Wait for agent to reconnect (like the 10s grace period for pre-call disconnect)
2. Auto-connect visitor to a different available agent
3. Offer visitor a "Reconnect" option

**Why I'm Asking:**
This could be intentional (WebRTC is hard to recover mid-stream), OR it might be a gap in the reconnection logic. The existing call reconnection feature (`CALL_RECONNECT`) only handles **server restarts**, not agent disconnects.

**Option A:** This is correct - WebRTC connections can't be seamlessly transferred, visitor must restart
**Option B:** Add a grace period (10-30s) for agent to reconnect before ending the call
**Option C:** Immediately route visitor to another agent and re-establish WebRTC connection

**Agent's Recommendation:** Option B - The 10s grace period already exists for pre-call disconnects. Extending it to mid-call would handle page refreshes without abruptly ending calls. Full re-routing (Option C) would be complex WebRTC work.

**YOUR ANSWER:**
- [ ] Go with Option A because: ___
- [ ] Go with Option B because: ___
- [ ] Go with Option C because: ___
- [ ] Actually it should be: ___

### Q-1202-005: No warning before idle timeout
**Asked by:** Doc Agent 7  
**Feature:** A1 - Bullpen & Agent States
**File:** `apps/dashboard/src/features/workbench/hooks/useIdleTimer.ts`

**Current Behavior:**
When an agent is idle for 5 minutes in a visible tab, they are immediately marked as away with no warning. The notification/grace period only applies when the tab is hidden.

**Why I'm Asking:**
An agent actively looking at their screen but not moving their mouse could be surprised by suddenly going away. A 30-second warning toast would give them time to wiggle their mouse and stay active.

**Option A:** This is fine - agents should be interacting with their computer regularly
**Option B:** Add a warning toast at 4:30 (30 seconds before timeout) saying "You'll be marked away in 30s due to inactivity"
**Option C:** Add a visual countdown in the sidebar during the last minute

**Agent's Recommendation:** Option B - A simple toast notification at 4:30 would prevent surprise away-marking without adding UI clutter. The agent can simply move their mouse to reset the timer.

**YOUR ANSWER:**
- [ ] Go with Option A because: ___
- [ ] Go with Option B because: ___
- [ ] Go with Option C because: ___
- [ ] Actually it should be: ___

### Q-1202-006: Should idle timeout be org-configurable?
**Asked by:** Doc Agent 7  
**Feature:** A1 - Bullpen & Agent States
**File:** `packages/domain/src/constants.ts:86`

**Current Behavior:**
The idle timeout is hardcoded to 5 minutes in `TIMING.AGENT_IDLE_TIMEOUT`. All organizations use the same value.

**Why I'm Asking:**
Different businesses may have different tolerance for agent inactivity. A high-volume call center might want 2 minutes, while a consultancy with long client calls might want 15 minutes.

**Option A:** Keep it hardcoded - consistency is more important than customization
**Option B:** Make it org-configurable in admin settings (like RNA timeout already is)
**Option C:** Leave as hardcoded for now, add to backlog for later

**Agent's Recommendation:** Option C - Not critical, but worth adding to backlog. The current 5 minutes is a reasonable default. Could be added alongside other timing customizations later.

**YOUR ANSWER:**
- [ ] Go with Option A because: ___
- [ ] Go with Option B because: ___
- [ ] Go with Option C because: ___
- [ ] Actually it should be: ___

### Q-V2-001: Should minimum wave loops before transition be configurable?
**Asked by:** Doc Agent 11  
**Feature:** V2 - Video Sequencer
**File:** `apps/widget/src/features/simulation/VideoSequencer.tsx:201-220`

**Current Behavior:**
Wave video must complete exactly **one full playback** before transitioning to intro (when audio is unlocked). This is hardcoded via the `waveCompletedOnce` state.

**Why I'm Asking:**
Some agents may want visitors to see their wave/attention-grabber video 2-3 times before the intro plays. A longer wave exposure could increase engagement.

**Option A:** Keep it at 1 loop - simpler, faster to audio greeting
**Option B:** Make it configurable per-agent (minWaveLoops: 1-3)
**Option C:** Leave as 1 for now, add to backlog

**Agent's Recommendation:** Option C - The current behavior works well for the "immediate personal greeting" feel. More loops might make it feel less responsive. Low priority feature request.

**YOUR ANSWER:**
- [ ] Go with Option A because: ___
- [ ] Go with Option B because: ___
- [ ] Go with Option C because: ___
- [ ] Actually it should be: ___

### Q-V2-002: What should happen if all three video URLs point to same video?
**Asked by:** Doc Agent 11  
**Feature:** V2 - Video Sequencer
**File:** `apps/widget/src/features/simulation/VideoSequencer.tsx`

**Current Behavior:**
If an agent only uploads one video and uses it for wave/intro/loop, the sequence would:
1. Play video muted on loop (wave)
2. After interaction, play same video with audio (intro)
3. After that ends, play same video forever (loop)

This results in the same video appearing three times in sequence, which may be odd UX.

**Why I'm Asking:**
Wondering if this edge case should be detected and handled specially (e.g., skip intro if wave=intro=loop).

**Option A:** Leave as-is - agent's responsibility to upload appropriate videos
**Option B:** Detect duplicate URLs and simplify sequence
**Option C:** Add admin/agent guidance but no code change

**Agent's Recommendation:** Option A - This is an agent configuration issue. The video recording wizard should guide agents to record distinct videos. Adding complexity to handle misconfiguration isn't worth it.

**YOUR ANSWER:**
- [ ] Go with Option A because: ___
- [ ] Go with Option B because: ___
- [ ] Go with Option C because: ___
- [ ] Actually it should be: ___

### Q-V2-003: Should video load failures be tracked in analytics?
**Asked by:** Doc Agent 11  
**Feature:** V2 - Video Sequencer
**File:** `apps/widget/src/features/simulation/VideoSequencer.tsx:166-182`

**Current Behavior:**
When a video fails to load, the error is logged to console and user sees retry button. No server-side tracking occurs.

**Why I'm Asking:**
Video load failures could indicate CDN issues, CORS misconfigurations, or format compatibility problems. Without analytics, these issues may go unnoticed until many visitors are affected.

**Option A:** Current behavior is fine - errors are visible to users who report them
**Option B:** Add analytics event for video load failures (track video type, error, retry count)
**Option C:** Add to backlog for later implementation

**Agent's Recommendation:** Option B - Low-effort analytics event could help detect systemic video delivery issues before they impact many visitors. Particularly valuable if videos are served from customer CDNs.

**YOUR ANSWER:**
- [ ] Go with Option A because: ___
- [ ] Go with Option B because: ___
- [ ] Go with Option C because: ___
- [ ] Actually it should be: ___

### Q-V4-001: localStorage expiry (5 min) mismatches server timeout (30s)
**Asked by:** Doc Agent 10  
**Feature:** V4 - Call Reconnection
**Files:** 
- `apps/widget/src/features/signaling/useSignaling.ts:23` (5 minutes localStorage expiry)
- `packages/domain/src/constants.ts:88` (30 seconds server timeout)

**Current Behavior:**
When a call is accepted, the visitor stores a reconnect token in localStorage with a 5-minute expiry (`CALL_EXPIRY_MS = 5 * 60 * 1000`). However, the server's `CALL_RECONNECT_TIMEOUT` is only 30 seconds.

This means if a visitor navigates away for 2 minutes and returns, their localStorage still has a valid token, but the server has already timed out the pending reconnect. The visitor will try to reconnect and get "No active call found" error.

**Why I'm Asking:**
This is a timing mismatch that could cause confusion. The visitor's client "thinks" reconnection is possible when it's not.

**Option A:** Keep as-is - the 5-minute localStorage expiry is a "maximum age" safety net, and the 30s server timeout is the real constraint
**Option B:** Reduce localStorage expiry to match server timeout (30s)
**Option C:** Increase server timeout to match localStorage expiry (5 min) for page navigation support

**Agent's Recommendation:** Option C - For page navigation scenarios, visitors may genuinely take 1-2 minutes to browse another page and return. The current 30s timeout is too short for real-world browsing patterns. 5 minutes allows time for navigation while not being so long that resources are tied up indefinitely.

**YOUR ANSWER:**
- [ ] Go with Option A because: ___
- [ ] Go with Option B because: ___
- [ ] Go with Option C because: ___
- [ ] Actually it should be: ___

### Q-V4-002: Is call heartbeat during active calls implemented?
**Asked by:** Doc Agent 10  
**Feature:** V4 - Call Reconnection
**File:** `packages/domain/src/types.ts:111,131` (event types defined), `packages/domain/src/constants.ts:89-90` (timing constants)

**Current Behavior:**
The types and constants define call heartbeat functionality:
- `CallHeartbeatPayload` with `callId` and `reconnectToken`
- `CALL_HEARTBEAT_INTERVAL: 10_000` (10 seconds)

However, I couldn't find implementation in the widget that actually sends these heartbeats during active calls. The `call_logs.last_heartbeat_at` column is only updated when the call is accepted or reconnected.

**Why I'm Asking:**
The heartbeat mechanism appears designed but may not be fully implemented. Without regular heartbeats, the server can't distinguish between:
1. Active calls with both parties connected
2. Calls where one party silently disconnected but their socket hasn't timed out yet

**Option A:** Heartbeat is intentionally not implemented - the socket connection itself serves as the heartbeat
**Option B:** This is a gap - implement call heartbeat for better orphaned call detection
**Option C:** Leave for later - not critical for current functionality

**Agent's Recommendation:** Option C - The socket connection's built-in ping/pong provides basic liveness detection. Full call heartbeat would be a nice-to-have for faster orphaned call detection but isn't critical.

**YOUR ANSWER:**
- [ ] Go with Option A because: ___
- [ ] Go with Option B because: ___
- [ ] Go with Option C because: ___
- [ ] Actually it should be: ___

### Q-V4-003: Multiple browser tabs with same call token
**Asked by:** Doc Agent 10  
**Feature:** V4 - Call Reconnection
**File:** `apps/widget/src/features/signaling/useSignaling.ts:22` (CALL_STORAGE_KEY in localStorage)

**Current Behavior:**
The reconnect token is stored in localStorage with a fixed key (`gg_active_call`). If a visitor has multiple browser tabs open during a call and navigates in one tab, all tabs share the same localStorage token.

**Why I'm Asking:**
Potential scenarios:
1. Tab A in call, Tab B on different page â†’ Tab B could try to reconnect using Tab A's token
2. Tab A navigates, Tab B still in call â†’ Tab A reconnects, Tab B's call orphaned?

**Option A:** Current behavior is fine - browsers typically have one active widget per site anyway
**Option B:** Add tab identifier to storage key to isolate per-tab
**Option C:** Document as known limitation

**Agent's Recommendation:** Option C - Multi-tab calls are an edge case. The widget initializes fresh per page load, and having an active call while browsing in another tab is unusual. Document and monitor for user reports.

**YOUR ANSWER:**
- [ ] Go with Option A because: ___
- [ ] Go with Option B because: ___
- [ ] Go with Option C because: ___
- [ ] Actually it should be: ___

### Q-V4-004: Should there be audio/visual cue when call reconnects?
**Asked by:** Doc Agent 10  
**Feature:** V4 - Call Reconnection
**File:** `apps/widget/src/Widget.tsx:361-369` (onCallReconnected callback)

**Current Behavior:**
When a call successfully reconnects after page navigation:
1. Visitor side: Widget transitions from "minimized" to "in_call" state
2. Agent side: Receives `CALL_RECONNECTED` event (dashboard handles it)
3. WebRTC is re-established

There's no explicit audio or visual cue to announce "You're back in the call!" The video just reappears.

**Why I'm Asking:**
After a page navigation, the visitor might not immediately notice the call has reconnected. A brief notification or sound could confirm the reconnection worked.

**Option A:** Current behavior is fine - video appearing is obvious enough
**Option B:** Add a brief toast notification ("Back in call with [Agent]")
**Option C:** Add a subtle sound chime on reconnection
**Option D:** Add to backlog as UX enhancement

**Agent's Recommendation:** Option D - Not critical but could be a nice UX touch. The video reappearing with the agent's face is a strong visual indicator already.

**YOUR ANSWER:**
- [ ] Go with Option A because: ___
- [ ] Go with Option B because: ___
- [ ] Go with Option C because: ___
- [ ] Go with Option D because: ___
- [ ] Actually it should be: ___

### Q-A4-001: What happens if both agent and visitor screen share simultaneously?
**Asked by:** Doc Agent 14  
**Feature:** A4 - Agent Active Call
**File:** `apps/dashboard/src/features/webrtc/use-webrtc.ts:126-151`

**Current Behavior:**
The WebRTC hook handles incoming remote streams by checking if it's the first stream (camera) or a different stream (screen share). If both parties try to screen share at the same time, both would be adding new streams.

**Why I'm Asking:**
This edge case may cause unexpected behavior - whose screen share takes precedence? Does the UI handle displaying both?

**Option A:** Current behavior is fine - unlikely scenario in practice
**Option B:** Add explicit handling to prevent/warn about dual screen share
**Option C:** Document as known limitation

**Agent's Recommendation:** Option A - In practice, agent screen sharing is for demos while visitor screen sharing is for troubleshooting. They wouldn't happen simultaneously. Not worth the complexity.

**YOUR ANSWER:**
- [ ] Go with Option A because: ___
- [ ] Go with Option B because: ___
- [ ] Go with Option C because: ___
- [ ] Actually it should be: ___

### Q-A4-002: No WebRTC reconnection/ICE restart on mid-call failure
**Asked by:** Doc Agent 14  
**Feature:** A4 - Agent Active Call
**File:** `apps/dashboard/src/features/webrtc/use-webrtc.ts:165-174`

**Current Behavior:**
When `pc.connectionState` becomes `"failed"` or `"disconnected"`, an error message is shown but there's no attempt to restart ICE or renegotiate. The call effectively ends.

**Why I'm Asking:**
Network changes mid-call (switching from WiFi to cellular) could cause temporary ICE failures that might be recoverable with an ICE restart.

**Option A:** Current behavior is fine - complex recovery for rare scenario
**Option B:** Add ICE restart mechanism for `"disconnected"` state
**Option C:** Add to backlog for later

**Agent's Recommendation:** Option C - ICE restart is complex and would need careful testing. Current behavior is acceptable for MVP, but should be improved later for better reliability.

**YOUR ANSWER:**
- [ ] Go with Option A because: ___
- [ ] Go with Option B because: ___
- [ ] Go with Option C because: ___
- [ ] Actually it should be: ___

### Q-A4-003: Recording upload may fail on agent disconnect
**Asked by:** Doc Agent 14  
**Feature:** A4 - Agent Active Call
**File:** `apps/dashboard/src/features/webrtc/use-call-recording.ts:198-311`

**Current Behavior:**
Recording is handled client-side and uploaded when `stopRecording()` is called. If the agent's browser crashes or closes abruptly, the in-progress recording chunks may be lost.

**Why I'm Asking:**
For compliance or quality assurance, losing recordings could be problematic. The recording is only uploaded when the call ends normally.

**Option A:** Current behavior is fine - acceptable tradeoff for simpler architecture
**Option B:** Implement periodic partial uploads during call
**Option C:** Move recording to server-side (significant architecture change)
**Option D:** Add to backlog for later

**Agent's Recommendation:** Option A for now - Server-side recording would be ideal but is a significant effort. The current approach works for 99% of calls that end normally. Could add periodic uploads (Option B) as a future enhancement.

**YOUR ANSWER:**
- [ ] Go with Option A because: ___
- [ ] Go with Option B because: ___
- [ ] Go with Option C because: ___
- [ ] Go with Option D because: ___
- [ ] Actually it should be: ___

### Q-D2-001: Should pool fallback behavior be configurable?
**Asked by:** Doc Agent 12  
**Feature:** D2 - Routing Rules
**File:** `apps/server/src/features/routing/pool-manager.ts:699-709`

**Current Behavior:**
When a visitor's URL matches a pool (e.g., Sales Pool) but all agents in that pool are busy/offline, `findBestAgentForVisitor()` falls back to ANY available agent from any pool:

```typescript
// Fallback: find any available agent (no specific pool)
const fallbackAgent = this.findBestAgent(null, excludeAgentId);
if (fallbackAgent) {
  return { agent: fallbackAgent, poolId: null };
}
```

This means a visitor on `/pricing` intended for Sales could end up with a Support agent if Sales is busy.

**Why I'm Asking:**
This design prioritizes "always show an agent" over "strict pool routing." Some orgs might want strict enforcement where visitors see "no agents available" rather than getting the wrong team.

**Option A:** Current behavior is correct - any agent is better than no agent
**Option B:** Add org-level setting for "strict pool routing" that disables fallback
**Option C:** Add per-pool setting for strict vs. fallback behavior
**Option D:** Leave as-is for now, add to backlog

**Agent's Recommendation:** Option D - The current behavior makes sense as a sensible default. A configuration option could be valuable but isn't urgent. Most orgs probably prefer showing any agent over showing nothing.

**YOUR ANSWER:**
- [ ] Go with Option A because: ___
- [ ] Go with Option B because: ___
- [ ] Go with Option C because: ___
- [ ] Go with Option D because: ___
- [ ] Actually it should be: ___

### Q-D2-002: Should OR logic be exposed in the routing rules UI?
**Asked by:** Doc Agent 12  
**Feature:** D2 - Routing Rules
**Files:** 
- `supabase/migrations/20251126070000_add_rule_conditions.sql:28-35` (condition_groups column exists)
- `apps/dashboard/src/app/(app)/admin/pools/pools-client.tsx:308` (RuleBuilder only uses conditions)

**Current Behavior:**
The database schema has a `condition_groups` JSONB column that was designed for OR logic (multiple condition groups, any of which can match). However, the UI only exposes the `conditions` array with AND logic.

To achieve OR behavior today, admins must create multiple separate rules, each with the same priority and pool assignment. This works but is less intuitive.

**Why I'm Asking:**
The feature was partially implemented but not exposed. Wondering if it should be:

**Option A:** Leave as-is - multiple rules for OR is fine and keeps UI simple
**Option B:** Expose OR logic in UI - "Match ANY of these condition groups"
**Option C:** Remove unused condition_groups column to reduce confusion
**Option D:** Add to backlog for future consideration

**Agent's Recommendation:** Option A - The current approach of multiple rules is straightforward and avoids UI complexity. Most routing scenarios don't need complex boolean logic.

**YOUR ANSWER:**
- [ ] Go with Option A because: ___
- [ ] Go with Option B because: ___
- [ ] Go with Option C because: ___
- [ ] Go with Option D because: ___
- [ ] Actually it should be: ___

### Q-A5-001: Should co-browse have an opt-out toggle for visitors?
**Asked by:** Doc Agent 15  
**Feature:** A5 - Co-Browse Viewer
**File:** `apps/widget/src/Widget.tsx:419-423`

**Current Behavior:**
Co-browsing is automatically enabled when a visitor enters a call. There is no way for the visitor to disable it or opt out. The visitor may not even be aware their screen is being shared.

**Why I'm Asking:**
Privacy-conscious visitors might prefer to have their call without screen sharing. Additionally, some visitors may be on pages with sensitive information they don't want to share.

**Option A:** Current behavior is fine - co-browse is part of the product value proposition
**Option B:** Add a visible indicator that screen is being shared (awareness)
**Option C:** Add a toggle for visitors to enable/disable co-browse during call
**Option D:** Add to backlog for later consideration

**Agent's Recommendation:** Option B - At minimum, visitors should know their screen is being shared. A small "Screen shared with agent" indicator would be transparent without adding opt-out complexity.

**YOUR ANSWER:**
- [ ] Go with Option A because: ___
- [ ] Go with Option B because: ___
- [ ] Go with Option C because: ___
- [ ] Go with Option D because: ___
- [ ] Actually it should be: ___

### Q-A5-002: Should iframes/canvas content be captured?
**Asked by:** Doc Agent 15  
**Feature:** A5 - Co-Browse Viewer
**Files:** 
- `apps/widget/src/features/cobrowse/useCobrowse.ts:42-46` (clones document)

**Current Behavior:**
DOM snapshot only captures the top-level document. Iframes (same-origin or cross-origin) and canvas elements appear as blank boxes to the agent. This means:
- Embedded videos/widgets are invisible
- Charts/graphs rendered in canvas are blank
- Third-party embeds (YouTube, maps, etc.) don't show

**Why I'm Asking:**
If a visitor is looking at a chart or embedded content, the agent can't see what they're discussing. This could limit the usefulness of co-browse.

**Option A:** Current behavior is fine - focus on main page content
**Option B:** Try to capture same-origin iframes recursively
**Option C:** Convert canvas elements to images via `toDataURL()`
**Option D:** Document as known limitation
**Option E:** Add to backlog

**Agent's Recommendation:** Option D - Cross-origin iframes can't be captured due to security restrictions, and canvas conversion adds significant complexity and payload size. Document the limitation so agents know what to expect.

**YOUR ANSWER:**
- [ ] Go with Option A because: ___
- [ ] Go with Option B because: ___
- [ ] Go with Option C because: ___
- [ ] Go with Option D because: ___
- [ ] Go with Option E because: ___
- [ ] Actually it should be: ___

### Q-A5-003: Should there be a loading state before first DOM snapshot?
**Asked by:** Doc Agent 15  
**Feature:** A5 - Co-Browse Viewer
**File:** `apps/dashboard/src/features/cobrowse/CobrowseViewer.tsx:154-164`

**Current Behavior:**
When a call starts, the `CobrowseViewer` component shows "Visitor's screen will appear here during an active call" until the first snapshot arrives. Between call acceptance and first snapshot (potentially 2-3 seconds), the agent sees the empty state message, which might be confusing.

**Why I'm Asking:**
A "Loading visitor's screen..." state would be clearer during the initial connection phase.

**Option A:** Current behavior is fine - snapshot arrives quickly
**Option B:** Add explicit "Loading..." state while waiting for first snapshot
**Option C:** Add to backlog as minor UX polish

**Agent's Recommendation:** Option B - Simple change that improves clarity. The agent knows the call is active but sees "will appear during active call" which is slightly confusing.

**YOUR ANSWER:**
- [ ] Go with Option A because: ___
- [ ] Go with Option B because: ___
- [ ] Go with Option C because: ___
- [ ] Actually it should be: ___

---

### Q-D3-001: Should there be more than 3 priority tiers in the UI?
**Asked by:** Doc Agent 13  
**Feature:** D3 - Tiered Agent Assignment
**Files:** 
- `packages/domain/src/database.types.ts:383` (DB allows 1-99)
- `apps/dashboard/src/app/(app)/admin/pools/pools-client.tsx:141-144` (UI shows 3 options)

**Current Behavior:**
The database constraint allows `priority_rank` between 1 and 99, but the admin UI only exposes 3 tiers:
- ðŸ¥‡ Primary (1)
- ðŸ¥ˆ Standard (2)
- ðŸ¥‰ Backup (3)

An organization with many agents might want finer-grained prioritization (e.g., Senior â†’ Mid â†’ Junior â†’ Trainee).

**Why I'm Asking:**
Is 3 tiers sufficient for all use cases, or should we expose more tiers (e.g., 5 or 10)?

**Option A:** 3 tiers is sufficient - keeps it simple
**Option B:** Add more tiers (5?) to UI for larger teams
**Option C:** Make it configurable per org
**Option D:** Add to backlog for future consideration

**Agent's Recommendation:** Option A - Most organizations don't need more than 3 levels. The complexity of managing 5+ tiers outweighs the benefit for most use cases.

**YOUR ANSWER:**
- [ ] Go with Option A because: ___
- [ ] Go with Option B because: ___
- [ ] Go with Option C because: ___
- [ ] Go with Option D because: ___
- [ ] Actually it should be: ___

---

### Q-D3-002: Should round-robin tracking be per-pool or global?
**Asked by:** Doc Agent 13  
**Feature:** D3 - Tiered Agent Assignment
**File:** `apps/server/src/features/routing/pool-manager.ts:82-83`

**Current Behavior:**
The `lastAssignmentOrder` map is global, not per-pool:
```typescript
private lastAssignmentOrder: Map<string, number> = new Map(); // agentId â†’ assignment order
```

This means if Agent Alice is assigned a visitor in Pool A, her assignment order increases everywhere. If she's also in Pool B (Tier 1), she'll be deprioritized there too, even though she hasn't had any Pool B assignments.

**Why I'm Asking:**
An agent who is Tier 1 in both "Sales" and "Support" pools should ideally have fair round-robin distribution within each pool independently.

**Option A:** Current global behavior is fine - ensures overall fairness
**Option B:** Track per-pool for true fairness within each pool
**Option C:** This is a non-issue in practice - add to backlog if complaints arise

**Agent's Recommendation:** Option A or C - The edge case (agent in multiple pools at same tier) is rare, and global tracking still provides reasonable fairness.

**YOUR ANSWER:**
- [ ] Go with Option A because: ___
- [ ] Go with Option B because: ___
- [ ] Go with Option C because: ___
- [ ] Actually it should be: ___

---

### Q-V5-001: Should there be payload size limits for DOM snapshots?
**Asked by:** Doc Agent 16  
**Feature:** V5 - Co-Browse Sender
**File:** `apps/widget/src/features/cobrowse/useCobrowse.ts:98`

**Current Behavior:**
The full HTML string is sent via socket without any size limit. Large pages with complex DOM could generate 100KB+ payloads per snapshot (every 2 seconds).

**Why I'm Asking:**
Large snapshots could:
- Cause bandwidth issues for visitors on slow connections
- Hit server-side websocket message limits
- Create memory pressure on agent's browser with rapid updates

**Option A:** Current behavior is fine - let network/browser handle limits
**Option B:** Add max payload size (e.g., 500KB) with truncation or error
**Option C:** Add compression (gzip) before sending
**Option D:** Add to backlog for future consideration

**Agent's Recommendation:** Option D - Not seeing issues in practice. Monitor bandwidth metrics before adding complexity.

**YOUR ANSWER:**
- [ ] Go with Option A because: ___
- [ ] Go with Option B because: ___
- [ ] Go with Option C because: ___
- [ ] Go with Option D because: ___
- [ ] Actually it should be: ___

---

### Q-V5-002: Should MutationObserver be more selective?
**Asked by:** Doc Agent 16  
**Feature:** V5 - Co-Browse Sender
**File:** `apps/widget/src/features/cobrowse/useCobrowse.ts:274-279`

**Current Behavior:**
The MutationObserver watches the entire `document.body` with `subtree: true` and filters for "significant" changes (childList additions, class/style/src/href attributes).

**Why I'm Asking:**
On pages with frequent animations or live updates (e.g., stock tickers, chat apps), this could trigger many snapshots. Could be more selective.

**Option A:** Current behavior is fine - "significant change" filter handles most noise
**Option B:** Add configurable selector list to observe
**Option C:** Add debounce to MutationObserver callback
**Option D:** Leave as-is, add to backlog if performance issues arise

**Agent's Recommendation:** Option D - Current filtering seems adequate. MutationObserver callback is cheap; only `captureSnapshot()` is expensive.

**YOUR ANSWER:**
- [ ] Go with Option A because: ___
- [ ] Go with Option B because: ___
- [ ] Go with Option C because: ___
- [ ] Go with Option D because: ___
- [ ] Actually it should be: ___

---

## ðŸŽ¨ AWAITING YOUR REVIEW

> These passed automated QA but need YOUR eyes before merge.
> **ALL UI changes require your approval - no exceptions.**

| Ticket | Type | What Changed | Screenshot | QA Checklist | Status |
|--------|------|--------------|------------|--------------|--------|
| - | - | - | - | - | - |

**Review Types:**
- ðŸŽ¨ **UI** - Visual changes, layout, colors, spacing
- ðŸ“± **Mobile** - Responsive, touch interactions
- ðŸŽ¥ **WebRTC** - Real call testing needed
- ðŸ”Š **Audio/Video** - Playback quality

**To Review:**
1. Check the screenshot(s)
2. Follow the QA checklist at `docs/qa-checklists/[TICKET]-human-qa.md`
3. Test in browser yourself
4. Mark: âœ… APPROVED or âŒ REJECTED (with notes)

---

## ðŸ”‘ CREDENTIALS NEEDED

> Agents blocked because they need login credentials.
> **Human:** Add credentials to `docs/secrets/credentials.md`, then tell PM.

| Platform | Needed By | Ticket | Status |
|----------|-----------|--------|--------|
| - | - | - | - |

---

## ðŸ› QA ISSUES FOUND

> Issues found during QA testing. Need dev fix before approval.

| ID | Ticket | Issue | Severity | Status |
|----|--------|-------|----------|--------|
| - | - | - | - | - |

---

## ðŸŸ¢ MINOR ISSUES (Logged for Later)

> Small improvements, tech debt, non-critical. Will become TODOs if prioritized.

| ID | Feature | Issue | Severity | Notes |
|----|---------|-------|----------|-------|
| M-1202-001 | P2 | No tiebreaker for identical assignment order | ðŸŸ¢ Low | Two agents with same order = arbitrary selection. Add agentId as secondary sort. |
| M-1202-002 | P2 | `maxSimultaneousSimulations` hardcoded to 25 | ðŸŸ¢ Low | Set in `AGENT_LOGIN` handler. Could be configurable per org/agent. |
| M-1202-003 | P2 | Round-robin is global, not per-pool | ðŸŸ¢ Low | Agent in 2 pools uses same assignment order in both. May cause uneven distribution. |
| M-1202-004 | P4 | No cascade protection for reassignments | ðŸŸ¢ Low | If 5 agents go away in sequence, visitor gets 5 handoff messages. Could batch. |
| M-1202-005 | P4 | HANDOFF_MESSAGE_DURATION not configurable | ðŸŸ¢ Low | Fixed 3s duration in widget constants. Could be admin-configurable. |
| M-1202-006 | A1 | `in_simulation` label unclear | ðŸŸ¢ Low | Shows as "Broadcasting" in UI - agents may not understand. Consider "Live" or "Active". |
| M-1202-007 | A1 | Staleness check is linear scan | ðŸŸ¢ Low | `getStaleAgents()` iterates all agents every 60s. Could use sorted structure for scale. |
| M-1202-008 | A1 | Multiple dashboard tabs conflict | ðŸŸ¢ Low | Second tab takes over socket, first shows disconnected. Could sync or warn user. |
| M-1202-006 | P6 | `in_simulation` agents not checked for staleness | ðŸŸ¡ Medium | Only `idle` agents checked. Agent broadcasting to visitors but no heartbeat for 2min should also be marked stale. |
| M-1202-007 | P6 | No pre-staleness warning | ðŸŸ¢ Low | Agent marked away without warning. Could add notification at 1.5min before marking. |
| M-1202-008 | P6 | Tab throttling could cause false positives | ðŸŸ¡ Medium | Chrome aggressively throttles background tabs, heartbeats may slow. Consider Web Worker or visibility API. |
| M-1202-009 | P6 | AGENT_MARKED_AWAY reason is "idle" for staleness | ðŸŸ¢ Low | Could use distinct reason like "heartbeat_stale" instead of generic "idle" for clearer debugging. |
| M-1203-001 | V1 | Widget position not persisted across pages | ðŸŸ¢ Low | User drags widget to top-left, navigates to new page, widget resets to server-configured position. Could store in localStorage. |
| M-1203-002 | V1 | Auto-hide preference not remembered | ðŸŸ¢ Low | If auto-hide minimizes widget and user expands it, preference should persist. Currently resets on page nav. |
| M-1203-003 | V1 | Minimized button always at bottom-right | ðŸŸ¢ Low | Even if user dragged widget to top-left before minimizing, minimized state goes to bottom-right. Could respect last dragged corner. |
| M-1203-004 | V1 | No explicit keyboard navigation | ðŸŸ¡ Medium | Only Escape key supported. Should add Tab/Enter navigation for accessibility. |
| M-1203-005 | P5 | ICE_SERVERS duplicated between widget/dashboard | ðŸŸ¢ Low | Same array in both codebases. Should centralize in @ghost-greeter/domain. |
| M-1203-006 | P5 | No ICE restart on "disconnected" state | ðŸŸ¡ Medium | Mid-call network changes may not recover automatically. Could implement ICE restart. |
| M-1203-007 | P5 | TURN credentials visible in client bundle | ðŸŸ¢ Low | Domain-restricted but visible in dev tools. Consider token rotation or credential vending. |
| M-V4-001 | V4 | localStorage expiry (5 min) vs server timeout (30s) | ðŸŸ¡ Medium | Visitor may try reconnect with valid localStorage token but server already timed out. Confusing error. |
| M-V4-002 | V4 | Agent dashboard has no "visitor reconnecting" UI | ðŸŸ¢ Low | When visitor navigates, agent sees frozen video with no indication reconnection is happening. |
| M-V4-003 | V4 | No audio cue on successful reconnection | ðŸŸ¢ Low | After page nav, call just reappears silently. A subtle confirmation could improve UX. |
| M-A4-001 | A4 | No aria-labels on call control buttons | ðŸŸ¡ Medium | Mute/video/end buttons lack screen reader descriptions. Should add descriptive aria-labels. |
| M-A4-002 | A4 | No keyboard shortcuts for call controls | ðŸŸ¢ Low | No Ctrl+M for mute, etc. Could improve power user experience. |
| M-A4-003 | A4 | No ICE restart on WebRTC disconnected state | ðŸŸ¡ Medium | Mid-call network change (WiFiâ†’cellular) may not recover. Should implement ICE restart. |
| M-A4-004 | A4 | Recording only uploads on normal call end | ðŸŸ¢ Low | Browser crash loses recording. Could implement periodic partial uploads. |
| M-A4-005 | A4 | TURN credentials visible in client bundle | ðŸŸ¢ Low | Same as P5 issue - credentials in code. Consider rotating or vending tokens via API. |

---

## ðŸ’¡ UX RECOMMENDATIONS

> Better user experience suggestions found during documentation.

### UX-1202-001: Visitor Not Informed During RNA Reassignment
**Feature:** A3 - RNA Timeout
**Current:** When an agent RNA times out and the visitor is reassigned to a new agent, the visitor's UI just continues showing "Connecting..." with no indication that anything changed. If the second agent also times out, the process repeats silently.
**Suggested:** Show visitor a brief message like "Finding you another agent..." during reassignment, or display agent's name so they notice when it changes.
**Impact:** Visitor may become frustrated waiting during multiple reassignments without understanding what's happening. A quick status update would set expectations.
**Effort:** Low - just need to detect reassignment in widget and show brief toast/status

**YOUR DECISION:**
- [ ] Yes, create ticket
- [ ] No, not worth it because: ___
- [ ] Later, add to backlog

### UX-1203-001: "Tap to Unmute" Overlay Could Be More Prominent
**Feature:** V1 - Widget Lifecycle
**Current:** When the widget first appears, it shows a small "Tap anywhere to unmute" overlay in the bottom-left corner of the video. This is easy to miss, especially on smaller widget sizes.
**Suggested:** Make the unmute CTA more prominent - perhaps a centered overlay with a larger touch target, or an animated prompt. Alternative: detect when wave video has played 2+ loops without unmute and pulse the overlay.
**Impact:** Visitors may not realize audio is muted and miss the intro video's audio greeting. The audio greeting is key to the "concierge" experience.
**Effort:** Low - CSS/styling change

**YOUR DECISION:**
- [ ] Yes, create ticket
- [ ] No, not worth it because: ___
- [ ] Later, add to backlog

---

## âœ… CONFIRMED WORKING

> Things reviewed that work correctly as designed.

| Feature | Area Verified | Agent | Notes |
|---------|---------------|-------|-------|
| P2 | Tiered priority routing | Doc Agent 1 | Lower priority_rank agents get visitors first, overflow to higher ranks works |
| P2 | Round-robin within tier | Doc Agent 1 | Idle agents with 0 load get equal distribution via assignmentOrder |
| P2 | Least-connections fallback | Doc Agent 1 | Agents with load get visitors routed to lowest load |
| P2 | Race condition safety | Doc Agent 1 | JS single-threaded + atomic counter prevents double-assignment |
| P2 | Agent disconnect grace period | Doc Agent 1 | 10s grace period for page refresh before reassignment |
| P2 | Pool URL matching | Doc Agent 1 | Conditions (domain/path/query) match correctly with AND logic |
| P2 | Status filtering | Doc Agent 1 | in_call, offline, away agents correctly skipped |
| P2 | Capacity checking | Doc Agent 1 | maxSimultaneousSimulations correctly enforced |
| V3 | State machine protection | Doc Agent 2 | Double-click on same button prevented via state === "open" check |
| V3 | Camera/mic permission handling | Doc Agent 2 | All DOMException types handled with user-friendly messages |
| V3 | Call timeout with retry | Doc Agent 2 | 45s timeout shows "Taking longer than usual" with retry option |
| V3 | WebRTC signal queueing | Doc Agent 2 | Signals queue in pendingSignalsRef until peer connection ready |
| V3 | Socket reconnection + call retry | Doc Agent 2 | Option E: pendingCallAgentIdRef retries call on reconnect |
| V3 | Call reconnection | Doc Agent 2 | localStorage token enables reconnection after page navigation |
| V3 | Error recovery | Doc Agent 2 | Retry buttons, clear messages, proper cleanup on failure |
| A3 | Accept vs Timeout race condition | Doc Agent 4 | 100ms grace period + re-checks prevent race |
| A3 | Same agent won't get same call | Doc Agent 4 | Agent marked "away" before reassignment search |
| A3 | Agent notification on RNA | Doc Agent 4 | CALL_CANCELLED + AGENT_MARKED_AWAY events sent |
| A3 | Configurable timeout | Doc Agent 4 | Per-org setting via recording_settings.rna_timeout_seconds |
| A3 | Pool routing respected | Doc Agent 4 | findBestAgentForVisitor used for reassignment |
| A3 | Database logging | Doc Agent 4 | Original call = missed, new call = new row |
| A3 | Timeout cleared on accept/reject/cancel | Doc Agent 4 | clearRNATimeout called in all handlers |
| P4 | Agent away triggers reassignment | Doc Agent 5 | reassignVisitors() called, visitors notified |
| P4 | Agent disconnect grace period | Doc Agent 5 | 10s grace period before reassignment (AGENT_DISCONNECT_GRACE_PERIOD) |
| P4 | Mid-call disconnect ends call | Doc Agent 5 | No grace period for calls - ends immediately, visitor notified |
| P4 | Call rejection routes to next agent | Doc Agent 5 | Uses findBestAgentForVisitor with excludeAgentId |
| P4 | RNA timeout marks agent away | Doc Agent 5 | Agent marked away before searching for next |
| P4 | Handoff message shown to visitor | Doc Agent 5 | "Agent got pulled away. New agent is taking over." |
| P4 | Widget hides when no agents | Doc Agent 5 | AGENT_UNAVAILABLE with previousAgentName for message |
| P4 | Staleness check triggers reassignment | Doc Agent 5 | 2min no heartbeat â†’ agent marked away â†’ reassign |
| P6 | Heartbeat handler updates lastActivityAt | Doc Agent 6 | `heartbeat` event â†’ `updateAgentActivity()` works correctly |
| P6 | Staleness threshold 2 minutes | Doc Agent 6 | `STALENESS_THRESHOLD = 120_000` correctly implemented |
| P6 | Only idle agents checked for staleness | Doc Agent 6 | `status === "idle"` filter prevents in_call/away from being marked stale |
| P6 | Staleness check runs every 60s | Doc Agent 6 | `setInterval` with `STALENESS_CHECK_INTERVAL = 60_000` |
| P6 | Agent disconnect grace period | Doc Agent 6 | `AGENT_DISCONNECT_GRACE_PERIOD = 10000` (10s) for page refresh |
| P6 | Reconnect restores previous status | Doc Agent 6 | `pendingDisconnect.previousStatus` stored and restored |
| P6 | Agent marked away notification | Doc Agent 6 | `AGENT_MARKED_AWAY` event sent with reason and message |
| P6 | Visitors reassigned on staleness | Doc Agent 6 | `reassignVisitors()` called, `notifyReassignments()` notifies visitors |
| P6 | lastActivityAt reset on reconnect | Doc Agent 6 | `agent.lastActivityAt = Date.now()` in `registerAgent()` |
|| A2 | RNA/Accept race condition | Doc Agent 3 | 100ms grace period in startRNATimeout() lets agent accept win if clicked at timeout moment |
|| A2 | Multi-channel notifications | Doc Agent 3 | Ringtone + modal + browser notification + title flash all fire correctly |
|| A2 | Ringtone cleanup | Doc Agent 3 | stopRinging() called on all exit paths (accept, reject, cancel, unmount) - cannot get stuck |
|| A2 | AudioContext initialization | Doc Agent 3 | Auto-initializes on first user interaction (click/keydown/touchstart) |
|| A2 | RNA timeout configurable | Doc Agent 3 | Uses org rna_timeout_seconds from recording_settings, defaults to 15s |
|| A2 | Status filtering | Doc Agent 3 | Agents with status in_call correctly do not receive incoming calls |
|| A2 | Visitor info displayed | Doc Agent 3 | Modal shows visitor ID, page URL, location with flag, time on page |
|| A1 | Status dropdown UI | Doc Agent 7 | Dropdown correctly shows Live/Away options, hidden during calls |
|| A1 | Idle timer Web Worker | Doc Agent 7 | Uses Web Worker to prevent Chrome background throttling |
|| A1 | Heartbeat Web Worker | Doc Agent 7 | 25s heartbeat keeps socket alive in background tabs |
|| A1 | Staleness detection | Doc Agent 7 | Server checks every 60s, marks idle agents with 2min no heartbeat as away |
|| A1 | Page refresh grace period | Doc Agent 7 | 10s grace via pendingDisconnects map, status restored on reconnect |
|| A1 | setAway/setBack retry logic | Doc Agent 7 | 3x retry with exponential backoff, ack-based confirmation |
|| A1 | Visitor reassignment on away | Doc Agent 7 | reassignVisitors() called, visitors get AGENT_UNAVAILABLE or AGENT_REASSIGNED |
|| A1 | Status filtering in routing | Doc Agent 7 | findBestAgent() skips offline, in_call, away agents |
|| A1 | Notification on hidden tab timeout | Doc Agent 7 | "Still there?" notification with 60s grace period |
|| A1 | Auto-reconnect | Doc Agent 7 | Infinite retries with exponential backoff (1s-10s) |
|| V1 | Widget state machine | Doc Agent 8 | hidden â†’ minimized â†’ open â†’ waiting_for_agent â†’ in_call states all work correctly |
|| V1 | Trigger delay with server timestamp | Doc Agent 8 | visitorConnectedAt from server ensures remaining delay is accurate |
|| V1 | Auto-hide logic | Doc Agent 8 | Auto-minimize after delay, cancelled on user interaction |
|| V1 | Drag and drop with snapping | Doc Agent 8 | GPU-accelerated drag, snaps to 5 preset positions (corners + center) |
|| V1 | Device detection | Doc Agent 8 | Mobile detection via screen width + touch capability works |
|| V1 | Shadow DOM isolation | Doc Agent 8 | Styles fully scoped, no conflicts with host site |
|| V1 | Video sequence integration | Doc Agent 8 | VideoSequencer manages wave â†’ intro â†’ loop correctly |
|| V1 | Theme switching | Doc Agent 8 | dark/light/liquid-glass themes apply to shadow host |
|| V1 | Fullscreen with safe areas | Doc Agent 8 | env(safe-area-inset-*) for mobile notches |
|| V1 | Page nav persistence | Doc Agent 8 | localStorage stores widget state for intro skip |
|| V1 | Audio unlock pattern | Doc Agent 8 | AudioContext created on first user interaction |
|| V1 | Minimize button visibility | Doc Agent 8 | Shows if show_minimize_button enabled OR after hasHadCall |
|| P5 | STUN/TURN fallback order | Doc Agent 9 | STUN â†’ TURN UDP â†’ TURN TCP 80 â†’ TURN TCP 443 â†’ TURNS - proper fallback chain |
|| P5 | Signal relay through server | Doc Agent 9 | Server correctly relays signals without inspecting/modifying SDP content |
|| P5 | Agent initiates, visitor responds | Doc Agent 9 | Agent creates offer, visitor creates answer - clear role separation |
|| P5 | Signal queueing | Doc Agent 9 | `pendingSignalsRef` queues signals if they arrive before peer connection ready |
|| P5 | Screen share renegotiation | Doc Agent 9 | Adding/removing screen share triggers proper offer/answer renegotiation |
|| P5 | Media error handling | Doc Agent 9 | All DOMException types (NotAllowed, NotFound, NotReadable) handled with friendly messages |
|| P5 | Connection timeout | Doc Agent 9 | 30s timeout with error message and retry option |
|| P5 | Double-init prevention | Doc Agent 9 | `isInitializingRef` prevents concurrent initialization calls |
|| P5 | Cleanup on unmount | Doc Agent 9 | `isUnmountingRef` prevents state updates after unmount |
|| V2 | Wave â†’ Intro â†’ Loop sequence | Doc Agent 11 | Transitions work seamlessly with audio unlock gating |
|| V2 | Deferred video loading | Doc Agent 11 | Intro/loop only load after wave starts playing - reduces initial bandwidth |
|| V2 | Wave completion check | Doc Agent 11 | Must complete 1 full playback before intro via timeupdate + 0.3s tolerance |
|| V2 | Intro ended validation | Doc Agent 11 | introStartedAt + MIN_PLAY_DURATION prevents spurious ended events |
|| V2 | Triple buffering | Doc Agent 11 | 3 video elements with visibility toggle - no black flashes |
|| V2 | Error retry logic | Doc Agent 11 | 2 retries then error state with retry button |
|| V2 | Call state interruption | Doc Agent 11 | isConnecting/isLive overlays show, videos pause |
|| V2 | skipToLoop on reopen | Doc Agent 11 | localStorage persistence enables skipping intro after page nav |
|| V2 | Video sequence URL comparison | Doc Agent 11 | Different pool = different videos = plays fresh intro |
|| V2 | Muted autoplay | Doc Agent 11 | Wave starts muted (autoplay policy compliant) |
|| V2 | Loop audio fallback | Doc Agent 11 | If audio play fails, falls back to muted then error state |
|| V4 | Token storage and retrieval | Doc Agent 10 | localStorage with 5min expiry, checks orgId match |
|| V4 | Server token validation | Doc Agent 10 | Database lookup verifies token, status, and reconnect_eligible |
|| V4 | Pending reconnect mechanism | Doc Agent 10 | `pendingReconnects` Map handles server restart scenario |
|| V4 | Both-party reconnect | Doc Agent 10 | First to reconnect waits for other with 30s timeout |
|| V4 | New token on reconnect | Doc Agent 10 | `markCallReconnected()` generates fresh token |
|| V4 | Agent profile sent to visitor | Doc Agent 10 | `CALL_RECONNECTED` includes agent profile for WebRTC setup |
|| V4 | Call log continuity | Doc Agent 10 | Same `call_logs` row maintained, only token/heartbeat updated |
|| V4 | Cleanup on disconnect during pending | Doc Agent 10 | `handleReconnectPartyDisconnect()` notifies other party |
|| V4 | Different org check | Doc Agent 10 | `getStoredCall()` validates orgId before returning token |
|| A4 | Call duration timer | Doc Agent 14 | Updates every 1s from call.startedAt, displays MM:SS format |
|| A4 | Mute/video toggle | Doc Agent 14 | Properly toggles track.enabled, visual feedback on buttons |
|| A4 | Screen share start/stop | Doc Agent 14 | Agent can start/stop, handles browser stop button via track.onended |
|| A4 | WebRTC connection states | Doc Agent 14 | Connecting â†’ Connected flow with visual indicators |
|| A4 | Recording start on connect | Doc Agent 14 | Starts when webrtcConnected + localStream + remoteStream all present |
|| A4 | Recording upload | Doc Agent 14 | Uploads to Supabase storage, updates call_logs, triggers transcription |
|| A4 | Fullscreen mode | Doc Agent 14 | Enter/exit via button, handles Escape key |
|| A4 | Visitor screen share detection | Doc Agent 14 | New stream with different ID detected, PiP for visitor camera |
|| A4 | Max call duration timeout | Doc Agent 14 | Server auto-ends after configured duration (default 120 min) |
|| A4 | Call end cleanup | Doc Agent 14 | Streams stopped, peer connection closed, state reset |
|| D2 | URL path matching | Doc Agent 12 | `matchPathToPool()` correctly parses and matches URLs |
|| D2 | Domain conditions | Doc Agent 12 | Domain matching works with exact, contains, starts_with, ends_with |
|| D2 | Path conditions | Doc Agent 12 | Path matching with all match types verified |
|| D2 | Query param conditions | Doc Agent 12 | `paramName` lookup + value match working |
|| D2 | AND logic within rules | Doc Agent 12 | All conditions must match for rule to apply |
|| D2 | Priority ordering | Doc Agent 12 | Higher priority rules checked first, first match wins |
|| D2 | Catch-all fallback | Doc Agent 12 | Traffic not matching any rule goes to default pool |
|| D2 | Catch-all rule prevention | Doc Agent 12 | DB trigger prevents adding rules to catch-all pools |
|| D2 | Server config sync | Doc Agent 12 | `POST /api/config/org` updates server in-memory config |
|| D2 | Case insensitivity | Doc Agent 12 | All comparisons lowercased |
|| D2 | Legacy pattern support | Doc Agent 12 | `domain_pattern` and `path_pattern` still work as fallback |
|| A5 | DOM snapshot capture | Doc Agent 15 | Document cloned, widget removed, scripts removed, URLs absolutified |
|| A5 | Mouse position tracking | Doc Agent 15 | 50ms throttle (~20fps), clientX/clientY sent to agent |
|| A5 | Scroll position tracking | Doc Agent 15 | 100ms throttle (10fps), scrollX/scrollY sent to agent |
|| A5 | Text selection tracking | Doc Agent 15 | Selection text + bounding rect sent on selectionchange |
|| A5 | MutationObserver | Doc Agent 15 | Detects significant DOM changes (childList, class/style attrs) |
|| A5 | Change deduplication | Doc Agent 15 | Length + first 500 chars hash prevents duplicate sends |
|| A5 | Server relay verification | Doc Agent 15 | Active call check before forwarding events to agent |
|| A5 | Iframe sandboxing | Doc Agent 15 | allow-same-origin only, no script execution |
|| A5 | Interaction blocking | Doc Agent 15 | pointer-events: none, user-select: none throughout |
|| A5 | Scroll sync via transform | Doc Agent 15 | CSS transform translate instead of native scroll |
|| A5 | Viewport scaling | Doc Agent 15 | Scales down to fit container, shows scale percentage |
|| A5 | Device detection | Doc Agent 15 | Width-based mobile/tablet/desktop indicator |
|| A5 | Cursor overlay | Doc Agent 15 | Red dot + MousePointer2 icon at scaled position |
|| A5 | Selection highlight | Doc Agent 15 | Blue rect overlay at scaled rect position |
|| A5 | Cleanup on call end | Doc Agent 15 | All intervals cleared, listeners removed, observer disconnected |
|| D3 | Tiered routing algorithm | Doc Agent 13 | Lower priority_rank (1) agents get visitors first, overflow to higher ranks |
|| D3 | Within-tier round-robin | Doc Agent 13 | Idle agents with 0 load get equal distribution via assignmentOrder |
|| D3 | Within-tier least-connections | Doc Agent 13 | Agents with load get visitors routed to lowest load |
|| D3 | Priority rank per-pool | Doc Agent 13 | Agent can have different ranks in different pools |
|| D3 | Agent reconnect reloads priorities | Doc Agent 13 | fetchAgentPoolMemberships() called on connect |
|| D3 | Admin UI tier grouping | Doc Agent 13 | Agents displayed grouped by Primary/Standard/Backup with colors |
|| D3 | Priority dropdown | Doc Agent 13 | ðŸ¥‡ðŸ¥ˆðŸ¥‰ emojis, immediate update, syncs to server |
|| D3 | Default to Primary | Doc Agent 13 | New agents and null priority_rank default to 1 (Primary) |
|| D3 | Priority rank constraint | Doc Agent 13 | Database enforces 1-10 range |
|| V5 | DOM snapshot capture | Doc Agent 16 | Document cloned, widget removed, scripts removed, URLs absolutified |
|| V5 | Mouse position tracking | Doc Agent 16 | 50ms throttle (~20fps), clientX/clientY sent to agent |
|| V5 | Scroll position tracking | Doc Agent 16 | 100ms throttle (10fps), scrollX/scrollY sent to agent |
|| V5 | Text selection tracking | Doc Agent 16 | Selection text + bounding rect sent on selectionchange |
|| V5 | MutationObserver | Doc Agent 16 | Detects significant DOM changes (childList, class/style attrs) |
|| V5 | Change deduplication | Doc Agent 16 | Length + first 500 chars hash prevents duplicate sends |
|| V5 | Periodic snapshots | Doc Agent 16 | 2000ms (2s) interval for baseline sync |
|| V5 | Input capture delay | Doc Agent 16 | 100ms delay after form input before snapshot |
|| V5 | Resize capture delay | Doc Agent 16 | 200ms delay after window resize before snapshot |
|| V5 | Server relay verification | Doc Agent 16 | Active call check before forwarding events to agent |
|| V5 | Rate limiting | Doc Agent 16 | Server limits: 10 snapshots/min, 300 mouse/min, 120 scroll/min |
|| V5 | Cleanup on call end | Doc Agent 16 | All intervals cleared, listeners removed, observer disconnected |
|| V5 | Passive event listeners | Doc Agent 16 | All event listeners use { passive: true } for performance |
|| V5 | Socket ref pattern | Doc Agent 16 | socketRef prevents stale closure issues in callbacks |

---

## ðŸ“ DOCUMENTATION COMPLETED

| Feature | Doc File | Agent | Review Status |
|---------|----------|-------|---------------|
| P2: Agent Assignment Algorithm | `docs/features/platform/agent-assignment.md` | Doc Agent 1 | ðŸ“ Ready for Review |
| V3: Visitor Call | `docs/features/visitor/visitor-call.md` | Doc Agent 2 | ðŸ“ Ready for Review |
| P4: Visitor Reassignment | `docs/features/platform/visitor-reassignment.md` | Doc Agent 5 | ðŸ“ Ready for Review |
| A3: RNA Timeout | `docs/features/agent/rna-timeout.md` | Doc Agent 4 | ðŸ“ Ready for Review |
|| A2: Incoming Call | `docs/features/agent/incoming-call.md` | Doc Agent 3 | ðŸ“ Ready for Review |
| A1: Bullpen & Agent States | `docs/features/agent/bullpen-states.md` | Doc Agent 7 | ðŸ“ Ready for Review |
| P6: Heartbeat & Staleness Detection | `docs/features/platform/heartbeat-staleness.md` | Doc Agent 6 | ðŸ“ Ready for Review |
| V1: Widget Lifecycle | `docs/features/visitor/widget-lifecycle.md` | Doc Agent 8 | ðŸ“ Ready for Review |
| P5: WebRTC Signaling | `docs/features/platform/webrtc-signaling.md` | Doc Agent 9 | ðŸ“ Ready for Review |
| V2: Video Sequencer | `docs/features/visitor/video-sequencer.md` | Doc Agent 11 | ðŸ“ Ready for Review |
| V4: Call Reconnection | `docs/features/visitor/call-reconnection.md` | Doc Agent 10 | ðŸ“ Ready for Review |
| D2: Routing Rules | `docs/features/admin/routing-rules.md` | Doc Agent 12 | ðŸ“ Ready for Review |
| A4: Agent Active Call | `docs/features/agent/agent-active-call.md` | Doc Agent 14 | ðŸ“ Ready for Review |
| A5: Co-Browse Viewer | `docs/features/agent/cobrowse-viewer.md` | Doc Agent 15 | ðŸ“ Ready for Review |
| D3: Tiered Agent Assignment | `docs/features/admin/tiered-routing.md` | Doc Agent 13 | ðŸ“ Ready for Review |
| V5: Co-Browse Sender | `docs/features/visitor/cobrowse-sender.md` | Doc Agent 16 | ðŸ“ Ready for Review |

---

## DECISIONS LOG

> Record of all decisions made this session for future reference.

| Time | ID | Question/Issue | Decision | Rationale |
|------|-----|----------------|----------|-----------|
| 2024-12-02 | Q1 | Pool routing during reassignment | **ALWAYS respect pools** - never assign agent to page they're not in pool for | Pools exist for a reason; visitor on /pricing should ONLY get Sales agents |
| 2024-12-02 | Q2 | Double-click race condition | **Option A** - Leave it, server handles | Near-zero probability, not worth complexity |
| 2024-12-02 | Q3 | Countdown 30s vs RNA 15s | **Option A** - Sync UI with actual org timeout | Agent should see accurate time remaining |
| 2024-12-02 | Q4 | Mid-call disconnect recovery | **Modified C** - grace period + auto-route to new agent | See details below |

**Q4 Detailed Decision:**
- **Agent/Visitor ends call intentionally (A/B):** Widget should show minimized circle (VERIFY THIS)
- **Agent disconnects (C):** Short grace period â†’ "Your connection errored" message â†’ Normal-sized module auto-pops with NEW agent (not minimized, since no one intentionally ended)
| 2024-12-02 | Q5 | Visitor not informed during RNA | **YES** - Show "[Name] got pulled away, connecting you to [New Agent]" | Clear communication during handoff |
| 2024-12-03 | Q5-new | Idle timeout warning | **Option B** - Add warning toast at 4:30 | Prevent surprise away-marking |
| 2024-12-03 | Q6 | Idle timeout org-configurable | **Backlog** - Not now, add to backlog | Reasonable default for now |
| 2024-12-03 | Q7 | Wave loop behavior | **Clarification** - Wave plays once IF audio enabled, loops infinitely if no audio trigger | Just documenting, no change |
| 2024-12-03 | Q8 | Same video for all 3 URLs | **Option A** - Leave as-is, agent's responsibility | No code change needed |
| 2024-12-03 | Q9 | Video load failure tracking | **Option B** - Add analytics event | Help detect systemic issues |

---

## ðŸ’¡ PM INITIATIVES & PROPOSALS

> PM proposes strategic work. Human approves/defers.

| ID | Initiative | Why | Priority | Status |
|----|------------|-----|----------|--------|
| - | - | - | - | - |

**Status:** ðŸ“‹ Proposed | âœ… Approved | â¸ï¸ Deferred | ðŸ”„ In Discussion

---

## ðŸ“Š PM BACKLOG (Deferred Ideas)

> Ideas PM proposed that were deferred for later consideration.

| Initiative | Deferred On | Reason | Revisit? |
|------------|-------------|--------|----------|
| - | - | - | - |

---

## SESSION NOTES

*Add any observations, patterns noticed, or follow-up items here.*

---

## END OF SESSION CHECKLIST

- [ ] All critical issues addressed
- [ ] All questions answered
- [ ] Fix tickets created in AGENT_TASKS.md
- [ ] Feature docs reviewed
- [ ] Status updated in FEATURE_DOCUMENTATION_TODO.md
- [ ] Decisions logged


*Add any observations, patterns noticed, or follow-up items here.*

---

## END OF SESSION CHECKLIST

- [ ] All critical issues addressed
- [ ] All questions answered
- [ ] Fix tickets created in AGENT_TASKS.md
- [ ] Feature docs reviewed
- [ ] Status updated in FEATURE_DOCUMENTATION_TODO.md
- [ ] Decisions logged

