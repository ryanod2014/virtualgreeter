<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>PM Dashboard ‚Ä¢ Digital Greeter</title>
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
  <style>
    :root {
      /* Dark blue color scheme */
      --bg-base: #030712;
      --bg-surface: rgba(15, 23, 42, 0.6);
      --bg-elevated: rgba(30, 41, 59, 0.5);
      --bg-hover: rgba(51, 65, 85, 0.5);
      --text-primary: #f1f5f9;
      --text-secondary: #94a3b8;
      --text-muted: #64748b;
      --border: rgba(71, 85, 105, 0.4);
      --border-subtle: rgba(51, 65, 85, 0.3);
      
      /* Status colors */
      --critical: #f87171;
      --critical-bg: rgba(248,113,113,0.12);
      --high: #fb923c;
      --high-bg: rgba(251,146,60,0.12);
      --medium: #fbbf24;
      --medium-bg: rgba(251,191,36,0.12);
      --low: #4ade80;
      --low-bg: rgba(74,222,128,0.12);
      
      /* Dark blue accent */
      --accent: #3b82f6;
      --accent-bright: #60a5fa;
      --accent-dim: #1d4ed8;
      --accent-bg: rgba(59,130,246,0.12);
      --success: #22c55e;
      --gradient-hero: linear-gradient(135deg, #1e40af 0%, #3b82f6 50%, #60a5fa 100%);
      --gradient-glass: linear-gradient(135deg, rgba(59,130,246,0.1) 0%, rgba(30,64,175,0.05) 100%);
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
      background: var(--bg-base);
      color: var(--text-primary);
      min-height: 100vh;
      line-height: 1.5;
    }
    
    /* Background ambient effects */
    body::before {
      content: '';
      position: fixed;
      top: -50%;
      left: -50%;
      width: 200%;
      height: 200%;
      background: radial-gradient(ellipse at 30% 20%, rgba(59,130,246,0.08) 0%, transparent 50%),
                  radial-gradient(ellipse at 70% 80%, rgba(30,64,175,0.06) 0%, transparent 50%);
      pointer-events: none;
      z-index: 0;
    }
    
    /* Grid pattern overlay */
    body::after {
      content: '';
      position: fixed;
      inset: 0;
      background-image: 
        linear-gradient(rgba(59,130,246,0.02) 1px, transparent 1px),
        linear-gradient(90deg, rgba(59,130,246,0.02) 1px, transparent 1px);
      background-size: 50px 50px;
      pointer-events: none;
      z-index: 0;
    }

    code, .mono { font-family: 'JetBrains Mono', monospace; }
    ::selection { background: var(--accent); color: white; }
    ::-webkit-scrollbar { width: 6px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }
    ::-webkit-scrollbar-thumb:hover { background: var(--text-muted); }

    /* Animations */
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    @keyframes slideUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    @keyframes shimmer {
      0% { background-position: -200% 0; }
      100% { background-position: 200% 0; }
    }
    @keyframes shine {
      0% { left: -100%; }
      50%, 100% { left: 100%; }
    }
    @keyframes pulse-glow {
      0%, 100% { box-shadow: 0 0 20px rgba(59,130,246,0.2); }
      50% { box-shadow: 0 0 40px rgba(59,130,246,0.4); }
    }
    
    .fade-in { animation: fadeIn 0.3s ease; }
    .slide-up { animation: slideUp 0.4s ease; }
    
    /* Shimmer effect */
    .shimmer {
      position: relative;
      overflow: hidden;
    }
    .shimmer::after {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 50%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.08), transparent);
      animation: shine 3s ease-in-out infinite;
    }
    
    /* Glass effect */
    .glass {
      background: var(--bg-surface);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border: 1px solid var(--border);
    }
    
    .glass-card {
      background: linear-gradient(135deg, rgba(30,41,59,0.7) 0%, rgba(15,23,42,0.8) 100%);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border: 1px solid rgba(71,85,105,0.3);
      box-shadow: 0 8px 32px rgba(0,0,0,0.3), inset 0 1px 0 rgba(255,255,255,0.05);
    }

    /* Nav - Glass style */
    .nav { 
      display: flex; 
      gap: 4px; 
      background: linear-gradient(135deg, rgba(30,41,59,0.8) 0%, rgba(15,23,42,0.9) 100%);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      padding: 6px; 
      border-radius: 16px; 
      border: 1px solid rgba(71,85,105,0.3);
      box-shadow: 0 4px 24px rgba(0,0,0,0.2), inset 0 1px 0 rgba(255,255,255,0.05);
    }
    .nav-item { 
      padding: 12px 20px; 
      border: none; 
      background: transparent; 
      color: var(--text-muted); 
      cursor: pointer; 
      border-radius: 10px; 
      font-size: 14px; 
      font-weight: 600; 
      transition: all 0.2s; 
      display: flex; 
      align-items: center; 
      gap: 8px; 
    }
    .nav-item:hover { color: var(--text-secondary); background: rgba(59,130,246,0.1); }
    .nav-item.active { 
      background: linear-gradient(135deg, rgba(59,130,246,0.2) 0%, rgba(59,130,246,0.1) 100%);
      color: var(--accent-bright); 
      box-shadow: 0 0 20px rgba(59,130,246,0.2);
    }

    /* Tabs - Glass style */
    .tabs { 
      display: flex; 
      gap: 4px; 
      background: linear-gradient(135deg, rgba(30,41,59,0.6) 0%, rgba(15,23,42,0.7) 100%);
      backdrop-filter: blur(16px);
      -webkit-backdrop-filter: blur(16px);
      padding: 6px; 
      border-radius: 14px; 
      border: 1px solid rgba(71,85,105,0.25);
      box-shadow: 0 2px 16px rgba(0,0,0,0.15);
      flex-wrap: wrap;
    }
    .tab { 
      padding: 8px 14px; 
      border: none; 
      background: transparent; 
      color: var(--text-muted); 
      cursor: pointer; 
      border-radius: 8px; 
      font-size: 13px; 
      font-weight: 500; 
      transition: all 0.2s; 
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .tab:hover { color: var(--text-secondary); background: rgba(59,130,246,0.08); }
    .tab.active { 
      background: rgba(59,130,246,0.15);
      color: var(--accent-bright); 
      border: 1px solid rgba(59,130,246,0.3);
    }
    .tab .count { 
      padding: 2px 8px; 
      background: rgba(59,130,246,0.2); 
      border-radius: 10px; 
      font-size: 11px;
      font-weight: 600;
    }

    /* Cards - Glass style */
    .card { 
      background: linear-gradient(135deg, rgba(30,41,59,0.6) 0%, rgba(15,23,42,0.7) 100%);
      backdrop-filter: blur(16px);
      -webkit-backdrop-filter: blur(16px);
      border: 1px solid rgba(71,85,105,0.25);
      border-radius: 16px; 
      padding: 20px;
      box-shadow: 0 4px 24px rgba(0,0,0,0.2);
      transition: all 0.3s ease;
    }
    .card:hover {
      border-color: rgba(59,130,246,0.3);
      box-shadow: 0 8px 32px rgba(0,0,0,0.25), 0 0 0 1px rgba(59,130,246,0.1);
    }
    .card-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 12px; }
    
    /* Badges - Clean modern style */
    .badge { 
      display: inline-flex; 
      align-items: center; 
      padding: 4px 10px; 
      border-radius: 8px; 
      font-size: 10px; 
      font-weight: 600; 
      text-transform: uppercase; 
      letter-spacing: 0.5px;
      backdrop-filter: blur(8px);
    }
    .badge-critical { color: var(--critical); background: var(--critical-bg); border: 1px solid rgba(248,113,113,0.2); }
    .badge-high { color: var(--high); background: var(--high-bg); border: 1px solid rgba(251,146,60,0.2); }
    .badge-medium { color: var(--medium); background: var(--medium-bg); border: 1px solid rgba(251,191,36,0.2); }
    .badge-low { color: var(--low); background: var(--low-bg); border: 1px solid rgba(74,222,128,0.2); }
    .badge-pending { color: var(--accent-bright); background: var(--accent-bg); border: 1px solid rgba(59,130,246,0.2); }
    .badge-resolved { color: var(--success); background: rgba(34,197,94,0.12); border: 1px solid rgba(34,197,94,0.2); }
    .badge-qa { color: #a78bfa; background: rgba(167,139,250,0.12); border: 1px solid rgba(167,139,250,0.2); }

    /* Pipeline Card - Glass style */
    .pipeline-card { flex: 1; min-width: 160px; }
    .pipeline-card .inner { 
      background: linear-gradient(135deg, rgba(30,41,59,0.6) 0%, rgba(15,23,42,0.7) 100%);
      backdrop-filter: blur(16px);
      -webkit-backdrop-filter: blur(16px);
      border: 1px solid rgba(71,85,105,0.25);
      border-radius: 16px; 
      padding: 20px; 
      height: 100%; 
      position: relative; 
      overflow: hidden;
      box-shadow: 0 4px 24px rgba(0,0,0,0.15);
    }
    .pipeline-card.complete .inner::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 3px; background: var(--success); }
    .pipeline-card .icon { font-size: 18px; margin-right: 8px; }
    .pipeline-card .label { font-size: 11px; text-transform: uppercase; letter-spacing: 1px; color: var(--text-muted); font-weight: 600; }
    .pipeline-card .value { font-size: 36px; font-weight: 800; font-family: 'JetBrains Mono', monospace; margin: 12px 0; }
    .pipeline-card .value span { font-size: 20px; color: var(--text-muted); }
    .pipeline-card .subtitle { font-size: 12px; color: var(--text-muted); }
    .pipeline-card .bar { height: 4px; background: rgba(51,65,85,0.5); border-radius: 2px; margin: 12px 0 8px; overflow: hidden; }
    .pipeline-card .bar-fill { height: 100%; background: var(--gradient-hero); transition: width 0.5s ease; }
    .pipeline-card.complete .bar-fill { background: var(--success); }

    /* Thread - Chat bubble style with glass */
    .thread { 
      background: linear-gradient(135deg, rgba(30,41,59,0.4) 0%, rgba(15,23,42,0.5) 100%);
      backdrop-filter: blur(12px);
      border-radius: 16px; 
      padding: 16px; 
      margin-top: 12px;
      border: 1px solid rgba(71,85,105,0.2);
    }
    .message { 
      padding: 14px 18px; 
      margin-bottom: 10px; 
      max-width: 85%; 
      position: relative;
      backdrop-filter: blur(8px);
    }
    .message-system { 
      background: linear-gradient(135deg, rgba(30,41,59,0.8) 0%, rgba(15,23,42,0.9) 100%);
      border: 1px solid rgba(71,85,105,0.3);
      margin-right: auto; 
      border-radius: 4px 20px 20px 20px;
      box-shadow: 0 2px 12px rgba(0,0,0,0.15);
    }
    .message-human { 
      background: linear-gradient(135deg, var(--accent) 0%, var(--accent-dim) 100%);
      border: 1px solid rgba(96,165,250,0.3);
      color: white;
      margin-left: auto; 
      border-radius: 20px 4px 20px 20px;
      box-shadow: 0 2px 12px rgba(59,130,246,0.25);
    }
    
    /* Suggested action card - Glass with shimmer */
    .suggested-action {
      background: linear-gradient(135deg, rgba(59,130,246,0.12) 0%, rgba(30,64,175,0.08) 100%);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      border: 1px solid rgba(59,130,246,0.3);
      border-radius: 16px;
      padding: 18px;
      margin: 14px 0;
      position: relative;
      overflow: hidden;
      box-shadow: 0 4px 20px rgba(59,130,246,0.1);
    }
    .suggested-action::after {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 50%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.06), transparent);
      animation: shine 4s ease-in-out infinite;
    }
    .suggested-action-label {
      font-size: 10px;
      text-transform: uppercase;
      letter-spacing: 1.5px;
      color: var(--accent-bright);
      font-weight: 700;
      margin-bottom: 10px;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .suggested-action-text {
      font-size: 14px;
      line-height: 1.7;
      color: var(--text-primary);
      margin-bottom: 16px;
    }
    .suggested-action-buttons {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }
    
    /* Quick reply input - Glass style */
    .quick-reply-input {
      width: 100%;
      padding: 14px 18px;
      background: linear-gradient(135deg, rgba(15,23,42,0.8) 0%, rgba(30,41,59,0.6) 100%);
      backdrop-filter: blur(12px);
      border: 1px solid rgba(71,85,105,0.3);
      border-radius: 14px;
      color: var(--text-primary);
      font-size: 14px;
      font-family: inherit;
      transition: all 0.2s;
    }
    .quick-reply-input:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 3px rgba(59,130,246,0.15);
    }
    .quick-reply-input::placeholder {
      color: var(--text-muted);
    }
    
    /* Details/Summary for "other options" */
    details summary::-webkit-details-marker { display: none; }
    details[open] summary span:first-child { transform: rotate(90deg); display: inline-block; }
    details summary:hover { color: var(--text-secondary); }

    /* Inputs */
    .input-group { display: flex; gap: 8px; margin-top: 12px; }
    .input { 
      flex: 1; 
      padding: 12px 16px; 
      background: linear-gradient(135deg, rgba(15,23,42,0.8) 0%, rgba(30,41,59,0.6) 100%);
      backdrop-filter: blur(8px);
      border: 1px solid rgba(71,85,105,0.3); 
      border-radius: 10px; 
      color: var(--text-primary); 
      font-size: 14px; 
      font-family: inherit;
      transition: all 0.2s;
    }
    .input:focus { 
      outline: none; 
      border-color: var(--accent);
      box-shadow: 0 0 0 3px rgba(59,130,246,0.15);
    }
    
    /* Buttons - Glass style */
    .btn { 
      padding: 10px 18px; 
      border: none; 
      border-radius: 10px; 
      font-size: 13px; 
      font-weight: 600; 
      cursor: pointer; 
      transition: all 0.2s;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      position: relative;
      overflow: hidden;
    }
    .btn::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 50%;
      background: linear-gradient(180deg, rgba(255,255,255,0.1) 0%, transparent 100%);
      pointer-events: none;
    }
    .btn-primary { 
      background: linear-gradient(135deg, var(--accent) 0%, var(--accent-dim) 100%);
      color: white;
      box-shadow: 0 2px 12px rgba(59,130,246,0.3);
    }
    .btn-primary:hover { 
      background: linear-gradient(135deg, var(--accent-bright) 0%, var(--accent) 100%);
      box-shadow: 0 4px 20px rgba(59,130,246,0.4);
      transform: translateY(-1px);
    }
    .btn-secondary { 
      background: linear-gradient(135deg, rgba(51,65,85,0.6) 0%, rgba(30,41,59,0.8) 100%);
      backdrop-filter: blur(8px);
      color: var(--text-secondary); 
      border: 1px solid rgba(71,85,105,0.4);
    }
    .btn-secondary:hover { 
      background: linear-gradient(135deg, rgba(71,85,105,0.6) 0%, rgba(51,65,85,0.8) 100%);
      border-color: rgba(96,165,250,0.3);
      color: var(--text-primary);
    }
    .btn-success { 
      background: linear-gradient(135deg, var(--accent) 0%, var(--accent-dim) 100%);
      color: white;
      box-shadow: 0 2px 12px rgba(59,130,246,0.3);
    }
    .btn-success:hover { 
      background: linear-gradient(135deg, var(--accent-bright) 0%, var(--accent) 100%);
      box-shadow: 0 4px 20px rgba(59,130,246,0.4);
      transform: translateY(-1px);
    }
    .btn-danger { 
      background: linear-gradient(135deg, var(--critical) 0%, #dc2626 100%);
      color: white;
      box-shadow: 0 2px 12px rgba(248,113,113,0.3);
    }
    .btn-danger:hover { 
      background: linear-gradient(135deg, #fca5a5 0%, var(--critical) 100%);
      box-shadow: 0 4px 20px rgba(248,113,113,0.4);
      transform: translateY(-1px);
    }
    .btn-sm { padding: 8px 14px; font-size: 12px; }
    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none !important;
    }

    /* Quick answers */
    .quick-answers { display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 8px; }
    .quick-btn { 
      padding: 8px 14px; 
      background: linear-gradient(135deg, rgba(30,41,59,0.6) 0%, rgba(15,23,42,0.7) 100%);
      backdrop-filter: blur(8px);
      border: 1px solid rgba(71,85,105,0.3); 
      border-radius: 10px; 
      color: var(--text-secondary); 
      font-size: 13px; 
      cursor: pointer; 
      transition: all 0.2s; 
    }
    .quick-btn:hover { 
      border-color: rgba(59,130,246,0.4); 
      color: var(--accent-bright);
      background: rgba(59,130,246,0.1);
    }

    /* Ticket Grid */
    .ticket-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 16px; }
    .ticket-card { background: var(--bg-surface); border: 1px solid var(--border); border-radius: 12px; padding: 18px; cursor: pointer; transition: all 0.2s; border-left: 3px solid var(--border); }
    .ticket-card:hover { background: var(--bg-elevated); }
    .ticket-card.priority-critical { border-left-color: var(--critical); }
    .ticket-card.priority-high { border-left-color: var(--high); }
    .ticket-card.priority-medium { border-left-color: var(--medium); }
    .ticket-card.priority-low { border-left-color: var(--low); }

    /* Command Box */
    .command-box { background: var(--bg-elevated); border: 1px solid var(--border); border-radius: 8px; padding: 16px; position: relative; }
    .command-box pre { background: var(--bg-base); padding: 14px; border-radius: 6px; font-size: 12px; overflow-x: auto; white-space: pre-wrap; margin: 0; }
    .command-box .copy-btn { position: absolute; top: 24px; right: 24px; }

    /* Modal */
    .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.85); display: flex; align-items: center; justify-content: center; z-index: 1000; padding: 40px; backdrop-filter: blur(4px); }
    .modal { background: var(--bg-surface); border: 1px solid var(--border); border-radius: 16px; max-width: 800px; width: 100%; max-height: 85vh; overflow: auto; }
    .modal-header { padding: 20px 24px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; background: var(--bg-surface); z-index: 10; }
    .modal-body { padding: 24px; }

    /* Section */
    .section { margin-bottom: 32px; }
    .section-title { font-size: 12px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1.5px; font-weight: 600; margin-bottom: 16px; }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect, useMemo } = React;

    // ================= SVG ICONS =================
    const Icons = {
      inbox: () => (
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
          <polyline points="22 12 16 12 14 15 10 15 8 12 2 12" />
          <path d="M5.45 5.11 2 12v6a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2v-6l-3.45-6.89A2 2 0 0 0 16.76 4H7.24a2 2 0 0 0-1.79 1.11z" />
        </svg>
      ),
      pipeline: () => (
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
          <path d="M3 3v18h18" />
          <path d="m19 9-5 5-4-4-3 3" />
        </svg>
      ),
      launch: () => (
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
          <path d="M4.5 16.5c-1.5 1.26-2 5-2 5s3.74-.5 5-2c.71-.84.7-2.13-.09-2.91a2.18 2.18 0 0 0-2.91-.09z" />
          <path d="m12 15-3-3a22 22 0 0 1 2-3.95A12.88 12.88 0 0 1 22 2c0 2.72-.78 7.5-6 11a22.35 22.35 0 0 1-4 2z" />
          <path d="M9 12H4s.55-3.03 2-4c1.62-1.08 5 0 5 0" />
          <path d="M12 15v5s3.03-.55 4-2c1.08-1.62 0-5 0-5" />
        </svg>
      ),
      chat: () => (
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
          <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z" />
        </svg>
      ),
      check: () => (
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="3" strokeLinecap="round" strokeLinejoin="round">
          <polyline points="20 6 9 17 4 12" />
        </svg>
      ),
      checkCircle: () => (
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
          <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14" />
          <polyline points="22 4 12 14.01 9 11.01" />
        </svg>
      ),
      circle: () => (
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
          <circle cx="12" cy="12" r="10" />
        </svg>
      ),
      clock: () => (
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
          <circle cx="12" cy="12" r="10" />
          <polyline points="12 6 12 12 16 14" />
        </svg>
      ),
      save: () => (
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
          <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z" />
          <polyline points="17 21 17 13 7 13 7 21" />
          <polyline points="7 3 7 8 15 8" />
        </svg>
      ),
      sparkle: () => (
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
          <path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z" />
        </svg>
      ),
      lightbulb: () => (
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
          <path d="M15 14c.2-1 .7-1.7 1.5-2.5 1-.9 1.5-2.2 1.5-3.5A6 6 0 0 0 6 8c0 1 .2 2.2 1.5 3.5.7.7 1.3 1.5 1.5 2.5" />
          <path d="M9 18h6" />
          <path d="M10 22h4" />
        </svg>
      ),
      x: () => (
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
          <line x1="18" y1="6" x2="6" y2="18" />
          <line x1="6" y1="6" x2="18" y2="18" />
        </svg>
      ),
      arrowUp: () => (
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round">
          <line x1="12" y1="19" x2="12" y2="5" />
          <polyline points="5 12 12 5 19 12" />
        </svg>
      ),
      chevronRight: () => (
        <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
          <polyline points="9 18 15 12 9 6" />
        </svg>
      ),
      export: () => (
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
          <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" />
          <polyline points="17 8 12 3 7 8" />
          <line x1="12" y1="3" x2="12" y2="15" />
        </svg>
      ),
      copy: () => (
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
          <rect x="9" y="9" width="13" height="13" rx="2" ry="2" />
          <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1" />
        </svg>
      ),
      server: () => (
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
          <rect x="2" y="2" width="20" height="8" rx="2" ry="2" />
          <rect x="2" y="14" width="20" height="8" rx="2" ry="2" />
          <line x1="6" y1="6" x2="6.01" y2="6" />
          <line x1="6" y1="18" x2="6.01" y2="18" />
        </svg>
      ),
      warning: () => (
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
          <path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z" />
          <line x1="12" y1="9" x2="12" y2="13" />
          <line x1="12" y1="17" x2="12.01" y2="17" />
        </svg>
      ),
      file: () => (
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
          <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z" />
          <polyline points="14 2 14 8 20 8" />
        </svg>
      ),
      ticket: () => (
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
          <path d="M2 9a3 3 0 0 1 0 6v2a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2v-2a3 3 0 0 1 0-6V7a2 2 0 0 0-2-2H4a2 2 0 0 0-2 2Z" />
          <path d="M13 5v2" />
          <path d="M13 17v2" />
          <path d="M13 11v2" />
        </svg>
      )
    };

    // Status dot component
    const StatusDot = ({ color }) => (
      <span style={{
        width: '8px',
        height: '8px',
        borderRadius: '50%',
        backgroundColor: color,
        display: 'inline-block',
        boxShadow: `0 0 6px ${color}`
      }} />
    );

    // Format message text with basic markdown-like styling
    function formatMessage(text) {
      if (!text) return null;
      
      // First split by newlines to create paragraphs
      const paragraphs = text.split('\n').filter(p => p.trim());
      
      return paragraphs.map((para, pIdx) => {
        // Split into parts for bold and numbered items
        const parts = para.split(/(\*\*[^*]+\*\*|\(\d+\))/g);
        
        const content = parts.map((part, i) => {
          // Bold text: **text**
          if (part.startsWith('**') && part.endsWith('**')) {
            return <strong key={i} style={{ color: 'var(--accent-bright)' }}>{part.slice(2, -2)}</strong>;
          }
          // Numbered option: (1), (2), etc.
          if (part.match(/^\(\d+\)$/)) {
            return <strong key={i} style={{ color: 'var(--success)' }}>{part}</strong>;
          }
          // Regular text
          return <span key={i}>{part}</span>;
        });
        
        return <div key={pIdx} style={{ marginBottom: '8px' }}>{content}</div>;
      });
    }

    // ================= DATA =================
    const FINDINGS_SUMMARY = {
      "meta": { "total_features": 61, "reviewed_features": 61, "total_findings": 742 },
      "by_priority": {
        "critical": { "total": 15, "answered": 15, "tickets_created": 7, "pending": 0 },
        "high": { "total": 48, "answered": 20, "tickets_created": 12, "pending": 28 },
        "medium": { "total": 315, "answered": 2, "tickets_created": 2, "pending": 313 },
        "low": { "total": 364, "answered": 2, "tickets_created": 2, "pending": 362 }
      }
    };

    // Fallback data - server data takes precedence when available
    const TICKETS_DATA = [];

    // Findings will be loaded from server or embedded fallback
    let FINDINGS_DATA = [];

    const PM_COMMANDS = {
      docMode: {
        label: "Launch Doc Sprint",
        command: "You are the PM. Read and execute docs/workflow/PM_DOCS_SOP.md - Doc Mode.\n\nGenerate launch commands for all undocumented features.",
        description: "PM reads inventory, creates prompts, outputs batch of doc-agent commands"
      },
      reviewMode: {
        label: "Launch Review Sprint", 
        command: "You are the PM. Read and execute docs/workflow/PM_DOCS_SOP.md - Review Mode.\n\nGenerate launch commands for all documented features that need review.",
        description: "PM reads tracker, creates prompts, outputs batch of review-agent commands"
      },
      processDecisions: {
        label: "Process Triage Decisions",
        command: "Run: node docs/scripts/process-decisions.js\n\nThis will:\n1. Create tickets in tickets.json for resolved findings\n2. Update findings.json status to 'ticketed'\n3. Dashboard will auto-refresh with changes",
        description: "Creates tickets from your resolved findings (run the script, then refresh dashboard)"
      },
      answerQuestions: {
        label: "Answer User Questions",
        command: "Read docs/data/decisions.json and look for threads where:\n- status is 'in_discussion'\n- decision.option_id is 'custom'\n- There are human messages without a system response\n\nFor each question, add a PM response using:\nnode docs/scripts/pm-respond.js F-XXX 'Your response here'\n\nThen the user can refresh the dashboard to see your answers.",
        description: "Respond to questions from the dashboard"
      },
      continueHighFindings: {
        label: "Continue High Priority Triage",
        command: "You are the PM. Continue processing High priority findings.\n\nRead docs/REVIEW_FINDINGS.md and present the next batch of 10 High priority findings with questions.",
        description: "Continue triaging remaining High priority findings"
      }
    };

    // ================= COMPONENTS =================

    function Badge({ type, children }) {
      return <span className={`badge badge-${type}`}>{children}</span>;
    }

    function PipelineCard({ icon, label, current, total, subtitle, complete }) {
      const pct = total > 0 ? Math.round((current / total) * 100) : 0;
      const iconMap = {
        doc: <Icons.file />,
        review: <Icons.checkCircle />,
        triage: <Icons.inbox />,
        ticket: <Icons.ticket />,
        progress: <Icons.server />
      };
      return (
        <div className={`pipeline-card ${complete ? 'complete' : ''}`}>
          <div className="inner shimmer">
            <div style={{ display: 'flex', alignItems: 'center', marginBottom: '8px' }}>
              <span className="icon" style={{ color: complete ? 'var(--success)' : 'var(--accent-bright)' }}>{iconMap[icon] || icon}</span>
              <span className="label">{label}</span>
            </div>
            <div className="value" style={{ color: complete ? 'var(--success)' : 'var(--text-primary)' }}>
              {current}<span>/{total}</span>
            </div>
            <div className="bar"><div className="bar-fill" style={{ width: `${pct}%` }} /></div>
            <div className="subtitle">{subtitle}</div>
          </div>
        </div>
      );
    }

    function TicketCard({ ticket, onClick }) {
      return (
        <div className={`ticket-card priority-${ticket.priority}`} onClick={onClick}>
          <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: '8px' }}>
            <code style={{ fontSize: '12px', color: 'var(--text-muted)' }}>{ticket.id}</code>
            <div style={{ display: 'flex', gap: '6px' }}>
              <Badge type={ticket.priority}>{ticket.priority}</Badge>
              <Badge type={ticket.difficulty === 'easy' ? 'low' : ticket.difficulty === 'hard' ? 'critical' : 'medium'}>{ticket.difficulty}</Badge>
            </div>
          </div>
          <h3 style={{ fontSize: '14px', fontWeight: 600, marginBottom: '6px' }}>{ticket.title}</h3>
          <div style={{ fontSize: '12px', color: 'var(--text-muted)', marginBottom: '8px' }}>{ticket.feature}</div>
          <div style={{ fontSize: '11px', color: 'var(--text-secondary)' }}>{(ticket.files_to_modify || ticket.files || []).length} files ‚Ä¢ {(ticket.acceptance_criteria || []).length} criteria</div>
        </div>
      );
    }

    function ReviewModal({ item, ticket, onClose, onApprove, onRequestFixes }) {
      const [reportContent, setReportContent] = useState(null);
      const [reportLoading, setReportLoading] = useState(false);
      const [reportError, setReportError] = useState(null);
      const [showReport, setShowReport] = useState(true);
      
      // Fetch report content when modal opens
      useEffect(() => {
        if (item?.completion_file) {
          setReportLoading(true);
          setReportError(null);
          fetch(`/api/file?path=${encodeURIComponent(item.completion_file)}`)
            .then(res => {
              if (!res.ok) throw new Error('Failed to load report');
              return res.text();
            })
            .then(content => {
              setReportContent(content);
              setReportLoading(false);
            })
            .catch(err => {
              setReportError(err.message);
              setReportLoading(false);
            });
        }
      }, [item?.completion_file]);
      
      if (!item || !ticket) return null;
      return (
        <div className="modal-overlay" onClick={onClose}>
          <div className="modal fade-in" onClick={e => e.stopPropagation()} style={{ maxWidth: '800px', maxHeight: '90vh', display: 'flex', flexDirection: 'column' }}>
            <div className="modal-header" style={{ borderBottom: '3px solid var(--success)' }}>
              <div>
                <div style={{ display: 'flex', alignItems: 'center', gap: '10px', marginBottom: '4px' }}>
                  <code style={{ color: 'var(--text-muted)' }}>{ticket.id}</code>
                  <Badge type="resolved">Completed</Badge>
                  <Badge type={ticket.priority}>{ticket.priority}</Badge>
                  <Badge type={ticket.difficulty === 'easy' ? 'low' : ticket.difficulty === 'hard' ? 'critical' : 'medium'}>{ticket.difficulty}</Badge>
                </div>
                <h2 style={{ fontSize: '18px', fontWeight: 600, marginTop: '4px' }}>{ticket.title}</h2>
                <div style={{ fontSize: '12px', color: 'var(--text-muted)', marginTop: '6px' }}>{ticket.feature}</div>
              </div>
              <button className="btn btn-sm btn-secondary" onClick={onClose}>√ó</button>
            </div>
            <div className="modal-body" style={{ overflow: 'auto', flex: 1 }}>
              {/* Completion Info */}
              <div style={{ padding: '16px', background: 'rgba(16,185,129,0.1)', borderRadius: '8px', border: '1px solid rgba(16,185,129,0.2)', marginBottom: '16px' }}>
                <div style={{ fontSize: '12px', color: 'var(--success)', fontWeight: 600, marginBottom: '8px' }}>‚úÖ Completion Details</div>
                <div style={{ fontSize: '13px', marginBottom: '4px' }}>
                  <strong>Branch:</strong> <code style={{ color: 'var(--accent-bright)' }}>{item.branch}</code>
                </div>
                <div style={{ fontSize: '13px', marginBottom: '4px' }}>
                  <strong>Completed:</strong> {new Date(item.completed_at).toLocaleString()}
                </div>
              </div>
              
              {/* Agent Report */}
              {item.completion_file && (
                <div style={{ marginBottom: '16px' }}>
                  <div 
                    style={{ 
                      display: 'flex', 
                      justifyContent: 'space-between', 
                      alignItems: 'center',
                      padding: '12px 16px',
                      background: 'var(--bg-elevated)',
                      borderRadius: showReport ? '8px 8px 0 0' : '8px',
                      cursor: 'pointer',
                      border: '1px solid var(--border)'
                    }}
                    onClick={() => setShowReport(!showReport)}
                  >
                    <div style={{ display: 'flex', alignItems: 'center', gap: '8px' }}>
                      <span style={{ fontSize: '14px' }}>üìÑ</span>
                      <span style={{ fontSize: '13px', fontWeight: 600 }}>Agent Completion Report</span>
                      <code style={{ fontSize: '10px', color: 'var(--text-muted)' }}>{item.completion_file.split('/').pop()}</code>
                    </div>
                    <span style={{ color: 'var(--text-muted)', fontSize: '12px' }}>{showReport ? '‚ñº' : '‚ñ∂'}</span>
                  </div>
                  {showReport && (
                    <div style={{ 
                      padding: '16px', 
                      background: 'var(--bg-base)', 
                      border: '1px solid var(--border)',
                      borderTop: 'none',
                      borderRadius: '0 0 8px 8px',
                      maxHeight: '400px',
                      overflow: 'auto'
                    }}>
                      {reportLoading && (
                        <div style={{ color: 'var(--text-muted)', fontSize: '13px' }}>Loading report...</div>
                      )}
                      {reportError && (
                        <div style={{ color: 'var(--critical)', fontSize: '13px' }}>Error: {reportError}</div>
                      )}
                      {reportContent && (
                        <pre style={{ 
                          margin: 0, 
                          whiteSpace: 'pre-wrap', 
                          wordBreak: 'break-word',
                          fontSize: '12px',
                          lineHeight: '1.6',
                          fontFamily: 'ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace'
                        }}>{reportContent}</pre>
                      )}
                    </div>
                  )}
                </div>
              )}
              
              <div className="section">
                <div className="section-title">Issue</div>
                <p style={{ color: 'var(--text-secondary)' }}>{ticket.issue}</p>
              </div>
              
              <div className="section">
                <div className="section-title">Files Changed</div>
                <div style={{ display: 'flex', flexWrap: 'wrap', gap: '8px' }}>
                  {(ticket.files_to_modify || ticket.files || []).map((f, i) => <code key={i} style={{ padding: '6px 10px', background: 'var(--bg-elevated)', borderRadius: '6px', fontSize: '12px', color: 'var(--accent-bright)' }}>{f}</code>)}
                </div>
              </div>
              
              <div className="section">
                <div className="section-title">Acceptance Criteria to Verify</div>
                {(ticket.acceptance_criteria || []).map((c, i) => (
                  <div key={i} style={{ padding: '10px 12px', background: 'var(--bg-elevated)', borderRadius: '6px', marginBottom: '6px', fontSize: '13px', display: 'flex', alignItems: 'center', gap: '8px' }}>
                    <span style={{ fontSize: '16px' }}>‚òê</span> {c}
                  </div>
                ))}
              </div>
              
              {(ticket.risks || ticket.risk_notes) && (
                <div style={{ padding: '16px', background: 'var(--critical-bg)', borderRadius: '8px', border: '1px solid rgba(239,68,68,0.2)', marginBottom: '16px' }}>
                  <div style={{ fontSize: '12px', color: 'var(--critical)', fontWeight: 600, marginBottom: '8px', display: 'flex', alignItems: 'center', gap: '6px' }}><Icons.warning /> Risks to Check</div>
                  {(ticket.risks || ticket.risk_notes || []).map((n, i) => <div key={i} style={{ fontSize: '13px', marginBottom: '4px' }}>‚Ä¢ {n}</div>)}
                </div>
              )}
              
              {ticket.qa_notes && (
                <div style={{ padding: '16px', background: 'rgba(234,179,8,0.1)', borderRadius: '8px', border: '1px solid rgba(234,179,8,0.2)', marginBottom: '16px' }}>
                  <div style={{ fontSize: '12px', color: 'var(--medium)', fontWeight: 600, marginBottom: '8px' }}>QA Notes</div>
                  <div style={{ fontSize: '13px', color: 'var(--text-secondary)' }}>{ticket.qa_notes}</div>
                </div>
              )}
              
              {/* Git Commands */}
              <div style={{ padding: '16px', background: 'var(--bg-elevated)', borderRadius: '8px', marginBottom: '16px' }}>
                <div style={{ fontSize: '12px', color: 'var(--text-muted)', fontWeight: 600, marginBottom: '8px' }}>Review Commands</div>
                <pre style={{ background: 'var(--bg-base)', padding: '12px', borderRadius: '6px', fontSize: '11px', overflow: 'auto' }}>
{`# View the changes
git diff main..${item.branch}

# Checkout and test
git checkout ${item.branch}
pnpm install
pnpm build`}
                </pre>
              </div>
              
              {/* Action Buttons */}
              <div style={{ display: 'flex', gap: '12px', marginTop: '20px' }}>
                <button className="btn btn-success" style={{ flex: 1 }} onClick={() => { onApprove(item.ticket_id); onClose(); }}>
                  ‚úì Approve & Merge
                </button>
                <button className="btn btn-secondary" style={{ flex: 1 }} onClick={() => { onRequestFixes(item.ticket_id); onClose(); }}>
                  üîÑ Request Fixes
                </button>
              </div>
            </div>
          </div>
        </div>
      );
    }

    function TicketModal({ ticket, onClose }) {
      if (!ticket) return null;
      return (
        <div className="modal-overlay" onClick={onClose}>
          <div className="modal fade-in" onClick={e => e.stopPropagation()}>
            <div className="modal-header">
              <div>
                <code style={{ color: 'var(--text-muted)' }}>{ticket.id}</code>
                <h2 style={{ fontSize: '18px', fontWeight: 600, marginTop: '4px' }}>{ticket.title}</h2>
              </div>
              <button className="btn btn-sm btn-secondary" onClick={onClose}>√ó</button>
            </div>
            <div className="modal-body">
              <div className="section">
                <div className="section-title">Issue</div>
                <p style={{ color: 'var(--text-secondary)' }}>{ticket.issue}</p>
              </div>
              <div className="section">
                <div className="section-title">Files to Edit</div>
                <div style={{ display: 'flex', flexWrap: 'wrap', gap: '8px' }}>
                  {(ticket.files_to_modify || ticket.files || []).map((f, i) => <code key={i} style={{ padding: '6px 10px', background: 'var(--bg-elevated)', borderRadius: '6px', fontSize: '12px', color: 'var(--accent-bright)' }}>{f}</code>)}
                </div>
              </div>
              {/* Feature Docs */}
              {ticket.feature_docs && ticket.feature_docs.length > 0 && (
                <div className="section">
                  <div className="section-title" style={{ display: 'flex', alignItems: 'center', gap: '8px' }}><Icons.file /> Feature Documentation</div>
                  <div style={{ display: 'flex', flexWrap: 'wrap', gap: '8px' }}>
                    {ticket.feature_docs.map((doc, i) => <code key={i} style={{ padding: '6px 10px', background: 'var(--bg-elevated)', borderRadius: '6px', fontSize: '11px', color: 'var(--text-secondary)' }}>{doc}</code>)}
                  </div>
                </div>
              )}
              
              {/* Similar Code */}
              {ticket.similar_code && ticket.similar_code.length > 0 && (
                <div className="section">
                  <div className="section-title">Similar Code to Follow</div>
                  {ticket.similar_code.map((code, i) => (
                    <div key={i} style={{ padding: '10px 12px', background: 'var(--bg-elevated)', borderRadius: '6px', marginBottom: '6px', fontSize: '12px', color: 'var(--text-secondary)' }}>{code}</div>
                  ))}
                </div>
              )}
              
              {/* Out of Scope */}
              {ticket.out_of_scope && ticket.out_of_scope.length > 0 && (
                <div className="section">
                  <div className="section-title" style={{ color: 'var(--critical)' }}>Out of Scope</div>
                  {ticket.out_of_scope.map((item, i) => (
                    <div key={i} style={{ padding: '8px 12px', background: 'rgba(239,68,68,0.08)', borderRadius: '6px', marginBottom: '6px', fontSize: '12px', color: 'var(--critical)' }}>{item}</div>
                  ))}
                </div>
              )}
              
              <div className="section">
                <div className="section-title">Acceptance Criteria</div>
                {(ticket.acceptance_criteria || []).map((c, i) => (
                  <div key={i} style={{ padding: '10px 12px', background: 'var(--bg-elevated)', borderRadius: '6px', marginBottom: '6px', fontSize: '13px' }}>{c}</div>
                ))}
              </div>
              
              {(ticket.risks || ticket.risk_notes) && (
                <div style={{ padding: '16px', background: 'var(--critical-bg)', borderRadius: '8px', border: '1px solid rgba(239,68,68,0.2)', marginBottom: '16px' }}>
                  <div style={{ fontSize: '12px', color: 'var(--critical)', fontWeight: 600, marginBottom: '8px', display: 'flex', alignItems: 'center', gap: '6px' }}><Icons.warning /> Risks to Avoid</div>
                  {(ticket.risks || ticket.risk_notes || []).map((n, i) => <div key={i} style={{ fontSize: '13px', marginBottom: '4px' }}>‚Ä¢ {n}</div>)}
                </div>
              )}
              
              {/* Dev Checks */}
              {ticket.dev_checks && ticket.dev_checks.length > 0 && (
                <div style={{ padding: '16px', background: 'var(--accent-bg)', borderRadius: '8px', border: '1px solid rgba(99,102,241,0.2)', marginBottom: '16px' }}>
                  <div style={{ fontSize: '12px', color: 'var(--accent-bright)', fontWeight: 600, marginBottom: '8px' }}>Dev Checks (Before Submitting)</div>
                  {ticket.dev_checks.map((check, i) => <div key={i} style={{ fontSize: '13px', marginBottom: '4px' }}>{check}</div>)}
                </div>
              )}
              
              {/* QA Notes */}
              {ticket.qa_notes && (
                <div style={{ padding: '16px', background: 'rgba(234,179,8,0.1)', borderRadius: '8px', border: '1px solid rgba(234,179,8,0.2)' }}>
                  <div style={{ fontSize: '12px', color: 'var(--medium)', fontWeight: 600, marginBottom: '8px' }}>QA Notes</div>
                  <div style={{ fontSize: '13px', color: 'var(--text-secondary)' }}>{ticket.qa_notes}</div>
                </div>
              )}
            </div>
          </div>
        </div>
      );
    }

    function FindingCard({ finding, thread, onSelectOption, onCustomResponse, onResolve, onSkip, onCombine }) {
      const [customInput, setCustomInput] = useState('');
      const [showCustom, setShowCustom] = useState(false);
      const isResolved = thread?.status === 'resolved';
      const hasDecision = thread?.decision?.option_id;
      const options = finding.options || [];
      const recommendedOption = options.find(o => o.recommended);
      const combinable = finding.combinable_with;

      const handleCustomSubmit = () => {
        if (customInput.trim()) {
          onCustomResponse(finding.id, customInput);
          setCustomInput('');
          setShowCustom(false);
        }
      };

      return (
        <div className="card slide-up" style={{ marginBottom: '16px' }}>
          {/* Header */}
          <div className="card-header">
            <div>
              <div style={{ display: 'flex', alignItems: 'center', gap: '8px', flexWrap: 'wrap' }}>
                <code style={{ color: 'var(--text-muted)', fontSize: '12px' }}>{finding.blocker_context?.ticket_id || finding.id}</code>
                {finding.category && <span style={{ fontSize: '10px', color: 'var(--text-muted)', background: 'var(--bg-elevated)', padding: '2px 6px', borderRadius: '4px' }}>{finding.category}</span>}
                {finding.blocker_context?.branch && (
                  <code style={{ fontSize: '10px', color: 'var(--accent-bright)', background: 'rgba(99,102,241,0.1)', padding: '2px 6px', borderRadius: '4px' }}>
                    {finding.blocker_context.branch}
                  </code>
                )}
              </div>
              <h3 style={{ fontSize: '15px', fontWeight: 600, marginTop: '6px' }}>{finding.title}</h3>
              <div style={{ fontSize: '12px', color: 'var(--text-muted)', marginTop: '4px' }}>{finding.feature}</div>
            </div>
            <div style={{ display: 'flex', gap: '6px', flexShrink: 0 }}>
              {finding._isDevBlocker && (
                <Badge type="critical"><span style={{ display: 'flex', alignItems: 'center', gap: '4px' }}>üöß DEV BLOCKER</span></Badge>
              )}
              {finding.type === 'blocker' && !finding._isDevBlocker && (
                <Badge type="critical"><span style={{ display: 'flex', alignItems: 'center', gap: '4px' }}>‚ö†Ô∏è BLOCKER</span></Badge>
              )}
              <Badge type={finding.severity}>{finding.severity}</Badge>
              <Badge type={isResolved ? 'resolved' : hasDecision ? 'pending' : 'pending'}><span style={{ display: 'flex', alignItems: 'center', gap: '4px' }}>{isResolved ? <><Icons.checkCircle /> Done</> : hasDecision ? <><Icons.clock /> Ready</> : <><Icons.circle /> Pending</>}</span></Badge>
            </div>
          </div>

          {/* Issue */}
          <p style={{ fontSize: '13px', color: 'var(--text-secondary)', marginBottom: '12px', lineHeight: '1.6' }}>{finding.issue}</p>
          
          {/* Suggested Fix */}
          <div style={{ fontSize: '12px', padding: '12px 14px', background: 'var(--bg-elevated)', borderRadius: '8px', marginBottom: '12px', borderLeft: '3px solid var(--accent)' }}>
            <span style={{ color: 'var(--accent-bright)', fontWeight: 600, display: 'inline-flex', alignItems: 'center', gap: '6px' }}><Icons.lightbulb /> Suggested Fix:</span>
            <span style={{ color: 'var(--text-secondary)', marginLeft: '8px' }}>{finding.suggested_fix}</span>
          </div>

          {/* Combinable Findings Alert */}
          {combinable && combinable.length > 0 && (
            <div style={{ fontSize: '12px', padding: '12px 14px', background: 'rgba(234,179,8,0.1)', borderRadius: '8px', marginBottom: '12px', border: '1px solid rgba(234,179,8,0.2)' }}>
              <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                <div>
                  <span style={{ color: 'var(--medium)', fontWeight: 600 }}>Related Findings:</span>
                  <span style={{ color: 'var(--text-secondary)', marginLeft: '6px' }}>
                    {combinable.map(c => `${c.id}: ${c.title}`).join(', ')}
                  </span>
                </div>
                <button
                  onClick={() => onCombine(finding.id, combinable.map(c => c.id))}
                  style={{
                    padding: '6px 12px',
                    background: 'var(--medium)',
                    border: 'none',
                    borderRadius: '6px',
                    color: 'black',
                    fontSize: '12px',
                    fontWeight: 600,
                    cursor: 'pointer',
                    whiteSpace: 'nowrap'
                  }}
                >
                  Combine into 1 ticket ‚Üí
                </button>
              </div>
              <div style={{ fontSize: '11px', color: 'var(--text-muted)', marginTop: '6px' }}>
                Category: {combinable[0]?.group?.replace(/_/g, ' ')}
              </div>
            </div>
          )}

          {/* Decision Area - Simplified Chat-Style */}
          <div style={{ background: 'var(--bg-elevated)', borderRadius: '12px', padding: '16px', marginTop: '8px' }}>
            
            {/* Conversation Thread - Chat bubbles */}
            {thread?.messages?.length > 0 && (
              <div style={{ marginBottom: '16px' }}>
                {thread.messages.map((msg, i, arr) => {
                  const isLastPmMessage = msg.role === 'system' && i === arr.length - 1;
                  return (
                    <div key={i} style={{ marginBottom: '10px' }}>
                      <div className={`message message-${msg.role}`}>
                        {msg.role === 'system' && (
                          <div style={{ fontSize: '10px', color: 'var(--text-muted)', marginBottom: '6px', fontWeight: 500 }}>PM</div>
                        )}
                        <div style={{ fontSize: '14px', lineHeight: 1.6 }}>{formatMessage(msg.text)}</div>
                        {/* Create Ticket link inside last PM message - subtle, bottom right */}
                        {isLastPmMessage && !isResolved && (
                          <div style={{ display: 'flex', justifyContent: 'flex-end', marginTop: '10px', paddingTop: '8px', borderTop: '1px solid rgba(71,85,105,0.2)' }}>
                            <span 
                              onClick={() => onResolve(finding.id)}
                              style={{ fontSize: '11px', color: 'var(--accent-bright)', cursor: 'pointer', textDecoration: 'underline', textUnderlineOffset: '2px' }}
                            >
                              Create Ticket
                            </span>
                          </div>
                        )}
                      </div>
                    </div>
                  );
                })}
              </div>
            )}

            {!isResolved && (
              <>
                {/* Suggested Action - The recommended option gets prime real estate */}
                {recommendedOption && !hasDecision && (
                  <div className="suggested-action">
                    <div className="suggested-action-label"><Icons.sparkle /> Suggested</div>
                    <div className="suggested-action-text">{recommendedOption.label}</div>
                    <div className="suggested-action-buttons" style={{ alignItems: 'center' }}>
                      <button 
                        className="btn btn-primary"
                        onClick={() => {
                          onSelectOption(finding.id, recommendedOption);
                          setTimeout(() => onResolve(finding.id), 50);
                        }}
                        style={{ display: 'flex', alignItems: 'center', gap: '6px' }}
                      >
                        <Icons.check /> Accept & Create Ticket
                      </button>
                      <button 
                        className="btn btn-sm"
                        onClick={() => onSkip(finding.id, 'Won\'t fix - acceptable risk')}
                        style={{ background: 'transparent', color: 'var(--text-muted)', border: '1px dashed var(--border)' }}
                      >
                        Skip
                      </button>
                    </div>
                  </div>
                )}

                {/* Other options - collapsed by default */}
                {options.filter(o => !o.recommended).length > 0 && !hasDecision && (
                  <details style={{ marginTop: '8px' }}>
                    <summary style={{ 
                      fontSize: '12px', 
                      color: 'var(--text-muted)', 
                      cursor: 'pointer',
                      padding: '8px 0',
                      listStyle: 'none',
                      display: 'flex',
                      alignItems: 'center',
                      gap: '6px'
                    }}>
                      <span style={{ fontSize: '10px' }}>‚ñ∂</span> Other options ({options.filter(o => !o.recommended).length})
                    </summary>
                    <div style={{ display: 'flex', flexDirection: 'column', gap: '6px', marginTop: '8px', paddingLeft: '16px' }}>
                      {options.filter(o => !o.recommended).map(opt => (
                        <button
                          key={opt.id}
                          onClick={() => {
                            onSelectOption(finding.id, opt);
                            setTimeout(() => onResolve(finding.id), 50);
                          }}
                          style={{
                            padding: '10px 14px',
                            background: 'var(--bg-surface)',
                            border: '1px solid var(--border)',
                            borderRadius: '8px',
                            color: 'var(--text-secondary)',
                            fontSize: '13px',
                            cursor: 'pointer',
                            textAlign: 'left',
                            transition: 'all 0.15s'
                          }}
                          onMouseOver={e => { e.currentTarget.style.background = 'var(--bg-hover)'; e.currentTarget.style.borderColor = 'var(--accent)'; }}
                          onMouseOut={e => { e.currentTarget.style.background = 'var(--bg-surface)'; e.currentTarget.style.borderColor = 'var(--border)'; }}
                        >
                          {opt.label}
                        </button>
                      ))}
                    </div>
                  </details>
                )}

                {/* Decision made but not yet confirmed - show what was selected */}
                {hasDecision && thread?.decision?.option_id !== 'custom' && (
                  <div style={{ 
                    padding: '14px 16px', 
                    background: 'rgba(59,130,246,0.08)', 
                    border: '1px solid rgba(59,130,246,0.3)',
                    borderRadius: '10px', 
                    marginBottom: '12px' 
                  }}>
                    <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'flex-start' }}>
                      <div>
                        <div style={{ display: 'flex', alignItems: 'center', gap: '8px', marginBottom: '6px' }}>
                          <span style={{ color: 'var(--accent-bright)' }}><Icons.check /></span>
                          <span style={{ fontSize: '14px', color: 'var(--text-primary)' }}>{thread?.decision?.option_label}</span>
                        </div>
                        {thread?.decision?.custom_note && (
                          <div style={{ fontSize: '12px', color: 'var(--text-secondary)', paddingLeft: '24px' }}>
                            Note: {thread.decision.custom_note}
                          </div>
                        )}
                      </div>
                      <div style={{ display: 'flex', gap: '12px', alignItems: 'center' }}>
                        <span 
                          onClick={() => onResolve(finding.id)}
                          style={{ color: 'var(--accent-bright)', fontSize: '13px', cursor: 'pointer', textDecoration: 'underline', textUnderlineOffset: '2px' }}
                        >
                          Create Ticket
                        </span>
                        <span 
                          onClick={() => onSkip(finding.id, 'Won\'t fix')}
                          style={{ color: 'var(--text-muted)', fontSize: '12px', cursor: 'pointer' }}
                        >
                          Skip
                        </span>
                      </div>
                    </div>
                  </div>
                )}

                {/* Always-visible reply input with two submit options */}
                <div style={{ marginTop: '12px' }}>
                  <input
                    type="text"
                    className="quick-reply-input"
                    value={customInput}
                    onChange={e => setCustomInput(e.target.value)}
                    onKeyDown={e => {
                      if (e.key === 'Enter' && !e.shiftKey && customInput.trim()) {
                        e.preventDefault();
                        handleCustomSubmit();
                      }
                    }}
                    placeholder="Type a question or your decision..."
                    style={{ width: '100%', marginBottom: '8px' }}
                  />
                  <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                    <button 
                      className="btn btn-sm" 
                      onClick={() => onSkip(finding.id, 'Won\'t fix')}
                      style={{ background: 'transparent', color: 'var(--text-muted)', border: '1px dashed var(--border)' }}
                    >
                      Skip
                    </button>
                    <div style={{ display: 'flex', gap: '8px' }}>
                      <button 
                        className="btn btn-primary btn-sm"
                        onClick={handleCustomSubmit}
                        disabled={!customInput.trim()}
                        style={{ display: 'flex', alignItems: 'center', gap: '4px' }}
                      >
                        <Icons.chat /> Ask Question
                      </button>
                      <button 
                        className="btn btn-primary btn-sm"
                        onClick={() => {
                          if (customInput.trim()) {
                            onCustomResponse(finding.id, customInput);
                            setCustomInput('');
                            setTimeout(() => onResolve(finding.id), 100);
                          }
                        }}
                        disabled={!customInput.trim()}
                        style={{ display: 'flex', alignItems: 'center', gap: '4px' }}
                      >
                        <Icons.ticket /> Create Ticket
                      </button>
                    </div>
                  </div>
                </div>
              </>
            )}

            {/* Resolved State */}
            {isResolved && (
              <div style={{ padding: '12px', background: 'rgba(16,185,129,0.1)', borderRadius: '6px', fontSize: '13px' }}>
                <div style={{ color: 'var(--success)', fontWeight: 600, marginBottom: '4px', display: 'flex', alignItems: 'center', gap: '6px' }}><Icons.check /> {thread?.decision?.option_label || 'Decision recorded'}</div>
                {thread?.decision?.combined_with && (
                  <div style={{ color: 'var(--text-secondary)', fontSize: '12px', marginTop: '4px' }}>
                    Combined with: {thread.decision.combined_with.join(', ')}
                  </div>
                )}
                {thread?.decision?.custom_note && (
                  <div style={{ color: 'var(--text-secondary)', fontSize: '12px', marginTop: '4px' }}>Note: {thread.decision.custom_note}</div>
                )}
              </div>
            )}
            
            {/* Combined but not yet resolved */}
            {!isResolved && thread?.decision?.combined_with && (
              <div style={{ padding: '12px', background: 'rgba(234,179,8,0.1)', borderRadius: '6px', fontSize: '13px', marginTop: '12px' }}>
                <div style={{ color: 'var(--medium)', fontWeight: 600, marginBottom: '4px' }}>
                  {thread?.decision?.is_primary ? 'Primary finding' : 'Will be combined with'}: {thread?.decision?.is_primary ? thread.decision.combined_with.join(', ') : finding.id}
                </div>
                {thread?.decision?.is_primary && (
                  <button className="btn btn-success btn-sm" style={{ marginTop: '8px' }} onClick={() => onResolve(finding.id)}>
                    Confirm Combined Ticket
                  </button>
                )}
              </div>
            )}
          </div>
        </div>
      );
    }

    function CommandBox({ label, command, description }) {
      const [copied, setCopied] = useState(false);
      const copy = () => { navigator.clipboard.writeText(command); setCopied(true); setTimeout(() => setCopied(false), 2000); };
      return (
        <div style={{ marginBottom: '16px' }}>
          <div style={{ fontSize: '13px', fontWeight: 600, marginBottom: '6px' }}>{label}</div>
          {description && <div style={{ fontSize: '12px', color: 'var(--text-muted)', marginBottom: '8px' }}>{description}</div>}
          <div className="command-box">
            <pre>{command}</pre>
            <button className="btn btn-sm btn-primary copy-btn" onClick={copy}>{copied ? 'Copied!' : 'Copy'}</button>
          </div>
        </div>
      );
    }

    // ================= VIEWS =================

    // DEPRECATED - Replaced by NewPipelineView
    function PipelineView_DEPRECATED() {
      const s = FINDINGS_SUMMARY;
      const totalAnswered = Object.values(s.by_priority).reduce((sum, p) => sum + p.answered, 0);
      const totalPending = Object.values(s.by_priority).reduce((sum, p) => sum + p.pending, 0);
      const ticketCount = TICKETS_DATA.length;

      return (
        <div className="fade-in">
          <div className="section">
            <div className="section-title">Pipeline Status</div>
            <div style={{ display: 'flex', gap: '16px', flexWrap: 'wrap' }}>
              <PipelineCard icon="doc" label="Documented" current={s.meta.total_features} total={s.meta.total_features} subtitle="Features documented" complete={true} />
              <PipelineCard icon="review" label="Reviewed" current={s.meta.reviewed_features} total={s.meta.total_features} subtitle="Features reviewed" complete={true} />
              <PipelineCard icon="triage" label="Triaged" current={totalAnswered} total={s.meta.total_findings} subtitle={`${totalPending} pending`} complete={totalPending === 0} />
              <PipelineCard icon="ticket" label="Ticketed" current={ticketCount} total={ticketCount} subtitle="Ready for dev" complete={true} />
              <PipelineCard icon="progress" label="In Progress" current={0} total={ticketCount} subtitle="Being developed" complete={false} />
            </div>
          </div>


          <div className="section">
            <div className="section-title">Quick Actions</div>
            <div style={{ display: 'flex', gap: '12px', flexWrap: 'wrap' }}>
              <div className="card" style={{ flex: 1, padding: '16px' }}>
                <div style={{ fontSize: '14px', fontWeight: 600, marginBottom: '8px', display: 'flex', alignItems: 'center', gap: '6px' }}><Icons.inbox /> Triage Findings</div>
                <div style={{ fontSize: '12px', color: 'var(--text-muted)', marginBottom: '12px' }}>Answer questions for {totalPending} pending findings</div>
                <button className="btn btn-primary btn-sm">Go to Triage ‚Üí</button>
              </div>
              <div className="card" style={{ flex: 1, padding: '16px' }}>
                <div style={{ fontSize: '14px', fontWeight: 600, marginBottom: '8px', display: 'flex', alignItems: 'center', gap: '6px' }}><Icons.launch /> Launch Agents</div>
                <div style={{ fontSize: '12px', color: 'var(--text-muted)', marginBottom: '12px' }}>Get commands for doc/review agents</div>
                <button className="btn btn-secondary btn-sm">Go to Agents ‚Üí</button>
              </div>
            </div>
          </div>
        </div>
      );
    }

    // ================= INBOX VIEW =================
    // Unified inbox - blockers are now part of findings with type: "blocker"
    // Dev agent blockers from agent-output/blocked/ are shown FIRST

    function InboxView({ serverMode, onSave, findingsData, serverDecisions, onDecisionsChange, agentOutputs, staging }) {
      return (
        <div className="fade-in">
          <TriageContent serverMode={serverMode} onSave={onSave} findingsData={findingsData} serverDecisions={serverDecisions} onDecisionsChange={onDecisionsChange} agentOutputs={agentOutputs} staging={staging} />
        </div>
      );
    }

    // ================= TRIAGE CONTENT =================
    // Renamed from TriageView to be embedded in InboxView

    function TriageContent({ serverMode, onSave, findingsData, serverDecisions, onDecisionsChange, agentOutputs, staging }) {
      const [severityFilter, setSeverityFilter] = useState('all');
      const [copyStatus, setCopyStatus] = useState(null);
      
      // Copy Cleanup Agent prompt to clipboard
      const copyCleanupPrompt = () => {
        const prompt = `You are a Cleanup Agent. Read docs/workflow/CLEANUP_AGENT_SOP.md then process next 10 HIGHEST priority from staging.`;
        navigator.clipboard.writeText(prompt).then(() => {
          setCopyStatus('copied');
          setTimeout(() => setCopyStatus(null), 2000);
        }).catch(() => {
          setCopyStatus('error');
          setTimeout(() => setCopyStatus(null), 2000);
        });
      };
      const [saveStatus, setSaveStatus] = useState(null);
      const [page, setPage] = useState(0);
      const PAGE_SIZE = 10;
      const isLocalUpdate = React.useRef(false); // Track if we triggered the update
      
      // Parse dev agent blockers from agent-output/blocked/ files and convert to finding-like format
      const devBlockersAsFindings = useMemo(() => {
        if (!agentOutputs?.blocked) return [];
        return agentOutputs.blocked.map(b => {
          try {
            const parsed = typeof b.content === 'string' ? JSON.parse(b.content) : b.content;
            // Convert blocker to finding-like format so it shows in the list
            return {
              id: parsed.id || b.ticketId,
              title: parsed.title || 'Dev Agent Blocked',
              issue: parsed.issue,
              severity: 'critical', // Dev blockers are always critical priority
              type: 'dev-blocker', // Special type to identify dev blockers
              feature: parsed.feature || 'Development',
              category: parsed.category || 'dev-blocker',
              status: parsed.status || 'pending',
              options: parsed.options || [],
              suggested_fix: parsed.recommendation,
              blocker_context: parsed.blocker_context,
              _raw: b,
              _isDevBlocker: true
            };
          } catch (e) {
            return null;
          }
        }).filter(Boolean);
      }, [agentOutputs]);
      
      // Combine findings with dev blockers - dev blockers go first
      const allFindings = useMemo(() => {
        const regularFindings = findingsData || [];
        return [...devBlockersAsFindings, ...regularFindings];
      }, [findingsData, devBlockersAsFindings]);
      
      const findings = allFindings;

      const [decisions, setDecisions] = useState(() => {
        const saved = localStorage.getItem('pm-decisions-v3');
        if (saved) return JSON.parse(saved);
        return { threads: [] };
      });

      // Merge server decisions (PM responses) into local state
      // Skip if we triggered this update ourselves to prevent infinite loop
      useEffect(() => {
        if (isLocalUpdate.current) {
          isLocalUpdate.current = false;
          return;
        }
        if (serverDecisions?.threads) {
          setDecisions(prev => {
            const localThreadMap = new Map(prev.threads.map(t => [t.finding_id, t]));
            let hasChanges = false;
            
            // Create new threads array with merged data
            const newThreads = prev.threads.map(localThread => {
              const serverThread = serverDecisions.threads.find(t => t.finding_id === localThread.finding_id);
              if (!serverThread) return localThread;
              
              // Check if we need to merge anything
              const localMsgTexts = new Set((localThread.messages || []).map(m => m.text));
              const pmMessages = (serverThread.messages || []).filter(m => m.role === 'system');
              const newMessages = pmMessages.filter(m => !localMsgTexts.has(m.text));
              
              const needsDecision = !localThread.decision && serverThread.decision;
              const needsStatus = localThread.status === 'pending' && serverThread.status !== 'pending';
              
              if (newMessages.length === 0 && !needsDecision && !needsStatus) {
                return localThread; // No changes needed
              }
              
              hasChanges = true;
              // Create new thread with merged data
              return {
                ...localThread,
                messages: [...(localThread.messages || []), ...newMessages].sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp)),
                decision: needsDecision ? serverThread.decision : localThread.decision,
                status: needsStatus ? serverThread.status : localThread.status
              };
            });
            
            // Add threads that only exist on server
            for (const serverThread of serverDecisions.threads) {
              if (!localThreadMap.has(serverThread.finding_id)) {
                newThreads.push({ ...serverThread });
                hasChanges = true;
              }
            }
            
            if (!hasChanges) return prev; // No changes, don't trigger re-render
            return { ...prev, threads: newThreads };
          });
        }
      }, [serverDecisions]);

      // Initialize threads for new findings
      useEffect(() => {
        if (findings.length > 0) {
          setDecisions(prev => {
            const existingIds = new Set(prev.threads.map(t => t.finding_id));
            const newThreads = findings
              .filter(f => !existingIds.has(f.id))
              .map(f => ({ finding_id: f.id, status: 'pending', messages: [], decision: null }));
            if (newThreads.length === 0) return prev;
            return { ...prev, threads: [...prev.threads, ...newThreads] };
          });
        }
      }, [findings]);

      // Auto-save when decisions change
      useEffect(() => {
        localStorage.setItem('pm-decisions-v3', JSON.stringify(decisions));
        
        // Update parent state so other views (like Launch) see the changes
        // Set flag to prevent merge useEffect from re-triggering
        if (onDecisionsChange) {
          isLocalUpdate.current = true;
          onDecisionsChange(decisions);
        }
        
        if (serverMode && onSave && decisions.threads.length > 0) {
          setSaveStatus('saving');
          onSave(decisions).then(() => {
            setSaveStatus('saved');
            setTimeout(() => setSaveStatus(null), 2000);
          }).catch(() => {
            setSaveStatus('error');
          });
        }
      }, [decisions, serverMode, onSave]);

      const getThread = (id) => decisions.threads.find(t => t.finding_id === id);
      
      const handleSelectOption = (id, option) => {
        setDecisions(prev => ({
          ...prev,
          threads: prev.threads.map(t => {
            if (t.finding_id !== id) return t;
            return {
              ...t,
              status: 'in_discussion',
              decision: {
                option_id: option.id,
                option_label: option.label,
                recommended: option.recommended || false,
                timestamp: new Date().toISOString()
              }
            };
          })
        }));
      };

      const handleCustomResponse = (id, text) => {
        setDecisions(prev => ({
          ...prev,
          threads: prev.threads.map(t => {
            if (t.finding_id !== id) return t;
            
            // Check if there's already a selected option (not custom/null)
            const hasSelectedOption = t.decision?.option_id && t.decision.option_id !== 'custom';
            
            if (hasSelectedOption) {
              // User is adding a note to their selected option - preserve the option
              return {
                ...t,
                status: 'in_discussion',
                messages: [
                  ...t.messages,
                  { role: 'human', text, timestamp: new Date().toISOString() }
                ],
                decision: {
                  ...t.decision,
                  custom_note: text,
                  timestamp: new Date().toISOString()
                }
              };
            } else {
              // No option selected - treat as a question for PM
              return {
                ...t,
                status: 'in_discussion',
                messages: [
                  ...t.messages,
                  { role: 'human', text, timestamp: new Date().toISOString() }
                ],
                decision: {
                  option_id: 'custom',
                  option_label: 'Custom response',
                  custom_note: text,
                  timestamp: new Date().toISOString()
                }
              };
            }
          })
        }));
      };

      const handleResolve = (id) => {
        setDecisions(prev => ({
          ...prev,
          threads: prev.threads.map(t => {
            if (t.finding_id !== id) return t;
            return { ...t, status: 'resolved' };
          })
        }));
      };

      const handleSkip = (id, reason) => {
        setDecisions(prev => ({
          ...prev,
          threads: prev.threads.map(t => {
            if (t.finding_id !== id) return t;
            return { 
              ...t, 
              status: 'resolved',
              decision: {
                option_id: 'skip',
                option_label: reason || 'Skipped - no action needed',
                recommended: false,
                timestamp: new Date().toISOString()
              }
            };
          })
        }));
      };

      const handleCombine = (primaryId, relatedIds) => {
        const allIds = [primaryId, ...relatedIds];
        const primaryFinding = findings.find(f => f.id === primaryId);
        const relatedFindings = relatedIds.map(id => findings.find(f => f.id === id)).filter(Boolean);
        
        // Create combined decision
        const combinedDecision = {
          option_id: 'combined',
          option_label: `Combined ticket: ${primaryFinding?.title}`,
          combined_with: relatedIds,
          combined_titles: relatedFindings.map(f => f?.title),
          timestamp: new Date().toISOString()
        };

        setDecisions(prev => ({
          ...prev,
          threads: prev.threads.map(t => {
            if (!allIds.includes(t.finding_id)) return t;
            return {
              ...t,
              status: 'in_discussion',
              decision: {
                ...combinedDecision,
                is_primary: t.finding_id === primaryId
              }
            };
          })
        }));
      };

      // Calculate stats - count pending (non-ticketed, non-resolved) per severity
      // Now includes blockers (type: "blocker") as a separate category
      const stats = useMemo(() => {
        const bySeverity = { critical: 0, high: 0, medium: 0, low: 0 };
        const answeredBySeverity = { critical: 0, high: 0, medium: 0, low: 0 };
        let ticketed = 0;
        let skipped = 0;
        let answered = 0;
        let resolved = 0;
        let blockers = 0;
        
        findings.forEach(f => {
          const thread = getThread(f.id);
          const isResolved = thread?.status === 'resolved';
          const hasNonCustomDecision = thread?.decision && thread.decision.option_id && thread.decision.option_id !== 'custom';
          const hasCustomDecision = thread?.decision && thread.decision.option_id === 'custom';
          const msgs = thread?.messages || [];
          const hasResolutionMsg = msgs.some(m => 
            m.role === 'system' && 
            (m.text?.includes('Decision confirmed') || m.text?.includes('Marking resolved') || m.text?.includes('Ticket TKT-'))
          );
          
          // Count blockers separately (they show in Blockers tab)
          // Include both regular blockers (type: 'blocker') and dev blockers (type: 'dev-blocker' or _isDevBlocker)
          const isBlocker = f.type === 'blocker' || f.type === 'dev-blocker' || f._isDevBlocker;
          // DEV BLOCKERS: Always show if file exists - ignore thread status
          // The blocker file existing means the agent is still blocked, regardless of previous decisions
          if (f._isDevBlocker && f.status !== 'ticketed' && f.status !== 'skipped') {
            blockers++;
            // Dev blockers also show in All and Critical tabs
          } else if (isBlocker && f.status !== 'ticketed' && f.status !== 'skipped' && !isResolved && !hasResolutionMsg) {
            blockers++;
            // Regular blockers respect thread status
            if (!f._isDevBlocker) return;
          }
          
          if (f.status === 'ticketed') {
            ticketed++;
          } else if (f.status === 'skipped') {
            skipped++;
          } else if (isResolved || hasResolutionMsg) {
            // Fully resolved
            resolved++;
          } else if (hasNonCustomDecision) {
            // Has a decision (PM picked an option) - ready to process
            answered++;
            answeredBySeverity[f.severity] = (answeredBySeverity[f.severity] || 0) + 1;
          } else {
            // Pending - needs decision (includes custom responses in discussion)
            bySeverity[f.severity] = (bySeverity[f.severity] || 0) + 1;
          }
        });
        
        const done = ticketed + skipped + resolved;
        const totalPending = Object.values(bySeverity).reduce((sum, n) => sum + n, 0);
        
        // Count open conversations using decisions (merged state that works for rendering)
        let openConvos = 0;
        if (decisions?.threads) {
          findings.forEach(f => {
            if (f.type === 'blocker' || f.status === 'ticketed' || f.status === 'skipped') return;
            const thread = decisions.threads.find(t => t.finding_id === f.id);
            if (!thread) return;
            
            const isEffResolved = thread.status === 'resolved' || 
              (thread.decision && thread.decision.option_id && thread.decision.option_id !== 'custom') ||
              (thread.messages || []).some(m => m.role === 'system' && 
                (m.text?.includes('Decision confirmed') || m.text?.includes('Marking resolved') || m.text?.includes('Ticket TKT-')));
            if (isEffResolved) return;
            
            const msgs = thread.messages || [];
            const lastMsg = msgs[msgs.length - 1];
            const hasOpenConvo = thread.decision?.option_id === 'custom' && lastMsg?.role === 'system';
            if (hasOpenConvo) openConvos++;
          });
        }
        
        return { bySeverity, answeredBySeverity, ticketed, skipped, answered, resolved, done, blockers, totalPending, openConvos };
      }, [findings, decisions, serverDecisions]);

      // Filter findings - by blockers, severity, ticketed, or answered
      const filtered = useMemo(() => {
        // Helper to check if resolved
        const isEffectivelyResolved = (f) => {
          const thread = getThread(f.id);
          if (thread?.status === 'resolved') return true;
          // Only consider resolved if has a FINAL decision (not custom, which means in-progress discussion)
          if (thread?.decision && thread.decision.option_id && thread.decision.option_id !== 'custom') return true;
          const msgs = thread?.messages || [];
          return msgs.some(m => 
            m.role === 'system' && 
            (m.text?.includes('Decision confirmed') || m.text?.includes('Marking resolved') || m.text?.includes('Ticket TKT-'))
          );
        };
        
        // All filter - show all pending findings, sorted by: open convos first, then severity
        // Dev blockers (type: 'dev-blocker') always show in All, regular blockers shown in Blockers tab
        if (severityFilter === 'all') {
          const pending = findings.filter(f => {
            if (f.type === 'blocker' && !f._isDevBlocker) return false; // Regular blockers shown separately, but dev blockers show here
            if (f.status === 'ticketed' || f.status === 'skipped') return false;
            // Dev blockers always show if file exists (ignore thread status)
            if (f._isDevBlocker) return true;
            return !isEffectivelyResolved(f);
          });
          
          // Sort: open convos first (has messages with system response to custom decision), then by severity
          const severityOrder = { critical: 0, high: 1, medium: 2, low: 3 };
          
          // Try serverDecisions first, fall back to decisions (merged local state)
          const getAnyThread = (id) => {
            return serverDecisions?.threads?.find(t => t.finding_id === id) 
                || decisions?.threads?.find(t => t.finding_id === id);
          };
          
          return pending.sort((a, b) => {
            // Dev blockers ALWAYS first
            if (a._isDevBlocker && !b._isDevBlocker) return -1;
            if (!a._isDevBlocker && b._isDevBlocker) return 1;
            
            const threadA = getAnyThread(a.id);
            const threadB = getAnyThread(b.id);
            const msgsA = threadA?.messages || [];
            const msgsB = threadB?.messages || [];
            const lastMsgA = msgsA[msgsA.length - 1];
            const lastMsgB = msgsB[msgsB.length - 1];
            
            // Check if has open convo (custom decision with system response waiting for PM)
            const hasOpenConvoA = threadA?.decision?.option_id === 'custom' && lastMsgA?.role === 'system';
            const hasOpenConvoB = threadB?.decision?.option_id === 'custom' && lastMsgB?.role === 'system';
            
            // Open convos first
            if (hasOpenConvoA && !hasOpenConvoB) return -1;
            if (!hasOpenConvoA && hasOpenConvoB) return 1;
            
            // Then by severity
            return (severityOrder[a.severity] || 4) - (severityOrder[b.severity] || 4);
          });
        }
        
        // Blockers filter - show type: "blocker" or "dev-blocker" items that need decision
        // DEV BLOCKERS: Always show if file exists - the blocker file means agent is still blocked
        if (severityFilter === 'blockers') {
          return findings.filter(f => {
            if (f.type !== 'blocker' && f.type !== 'dev-blocker' && !f._isDevBlocker) return false;
            if (f.status === 'ticketed' || f.status === 'skipped') return false;
            // Dev blockers always show if file exists (ignore thread status)
            if (f._isDevBlocker) return true;
            return !isEffectivelyResolved(f);
          }).sort((a, b) => {
            // Dev blockers first
            if (a._isDevBlocker && !b._isDevBlocker) return -1;
            if (!a._isDevBlocker && b._isDevBlocker) return 1;
            return 0;
          });
        }
        
        // Open Convos filter - show items with custom decision and system response
        if (severityFilter === 'convos') {
          // Try both serverDecisions and decisions to maximize chances of finding threads
          const getAnyThread = (id) => {
            return serverDecisions?.threads?.find(t => t.finding_id === id) 
                || decisions?.threads?.find(t => t.finding_id === id);
          };
          
          return findings.filter(f => {
            if (f.type === 'blocker') return false;
            if (f.status === 'ticketed' || f.status === 'skipped') return false;
            if (isEffectivelyResolved(f)) return false;
            
            const thread = getAnyThread(f.id);
            if (!thread) return false;
            
            const msgs = thread.messages || [];
            const lastMsg = msgs[msgs.length - 1];
            return thread.decision?.option_id === 'custom' && lastMsg?.role === 'system';
          });
        }
        
        if (severityFilter === 'ticketed') {
          return findings.filter(f => f.status === 'ticketed');
        }
        if (severityFilter === 'answered') {
          // Show resolved findings that haven't been ticketed yet
          return findings.filter(f => {
            if (f.status === 'ticketed' || f.status === 'skipped') return false;
            const thread = getThread(f.id);
            return thread?.status === 'resolved' || (thread?.decision && thread?.decision?.option_id !== 'custom');
          });
        }
        if (severityFilter === 'done') {
          // Show all resolved/ticketed items
          return findings.filter(f => {
            if (f.status === 'ticketed' || f.status === 'skipped') return true;
            const thread = getThread(f.id);
            return thread?.status === 'resolved';
          });
        }
        return findings.filter(f => {
          // Hide blockers from severity tabs (they have their own tab)
          if (f.type === 'blocker') return false;
          // Hide ticketed, skipped, AND resolved items from triage
          if (f.status === 'ticketed' || f.status === 'skipped') return false;
          // Also hide resolved items (decision already made)
          if (isEffectivelyResolved(f)) return false;
          return f.severity === severityFilter;
        });
      }, [findings, severityFilter, decisions, serverDecisions]);

      // Paginated
      const paginated = filtered.slice(page * PAGE_SIZE, (page + 1) * PAGE_SIZE);
      const totalPages = Math.ceil(filtered.length / PAGE_SIZE);

      // Set default filter to blockers if there are any, otherwise all
      // Dev blockers are shown at top regardless of filter, so no need to change filter for them
      useEffect(() => {
        if (stats.blockers > 0 && severityFilter === 'all') {
          setSeverityFilter('blockers');
        }
      }, [stats.blockers]);

      return (
        <div className="fade-in">
          {/* Single Bar: Blockers + Severity + Done */}
          <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '20px' }}>
            <div className="tabs">
              {/* All Tab */}
              <button className={`tab ${severityFilter === 'all' ? 'active' : ''}`} onClick={() => { setSeverityFilter('all'); setPage(0); }}>
                All <span className="count">{stats.totalPending}</span>
              </button>
              {/* Open Convos Tab - only show if there are open convos */}
              {stats.openConvos > 0 && (
                <button 
                  className={`tab ${severityFilter === 'convos' ? 'active' : ''}`} 
                  onClick={() => { setSeverityFilter('convos'); setPage(0); }}
                  style={{ 
                    background: severityFilter === 'convos' ? 'rgba(59,130,246,0.15)' : undefined,
                    borderColor: severityFilter === 'convos' ? 'var(--accent)' : undefined
                  }}
                >
                  <Icons.chat /> Convos <span className="count" style={{ background: 'var(--accent)', color: 'white' }}>{stats.openConvos}</span>
                </button>
              )}
              {/* Blockers Tab - only show if there are blockers */}
              {stats.blockers > 0 && (
                <button 
                  className={`tab ${severityFilter === 'blockers' ? 'active' : ''}`} 
                  onClick={() => { setSeverityFilter('blockers'); setPage(0); }}
                  style={{ 
                    background: severityFilter === 'blockers' ? 'rgba(239,68,68,0.15)' : undefined,
                    borderColor: severityFilter === 'blockers' ? 'var(--critical)' : undefined
                  }}
                >
                  üö® Blockers <span className="count" style={{ background: 'var(--critical)', color: 'white' }}>{stats.blockers}</span>
                </button>
              )}
              <button className={`tab ${severityFilter === 'critical' ? 'active' : ''}`} onClick={() => { setSeverityFilter('critical'); setPage(0); }}>
                <StatusDot color="var(--critical)" /> Critical <span className="count">{stats.bySeverity.critical || 0}</span>
              </button>
              <button className={`tab ${severityFilter === 'high' ? 'active' : ''}`} onClick={() => { setSeverityFilter('high'); setPage(0); }}>
                <StatusDot color="var(--high)" /> High <span className="count">{stats.bySeverity.high || 0}</span>
              </button>
              <button className={`tab ${severityFilter === 'medium' ? 'active' : ''}`} onClick={() => { setSeverityFilter('medium'); setPage(0); }}>
                <StatusDot color="var(--medium)" /> Medium <span className="count">{stats.bySeverity.medium || 0}</span>
              </button>
              <button className={`tab ${severityFilter === 'low' ? 'active' : ''}`} onClick={() => { setSeverityFilter('low'); setPage(0); }}>
                <StatusDot color="var(--low)" /> Low <span className="count">{stats.bySeverity.low || 0}</span>
              </button>
              <button 
                className={`tab ${severityFilter === 'answered' ? 'active' : ''}`} 
                onClick={() => { setSeverityFilter('answered'); setPage(0); }}
                style={{ marginLeft: '12px' }}
              >
                <Icons.checkCircle /> Answered <span className="count">{stats.answered}</span>
              </button>
              <button 
                className={`tab ${severityFilter === 'done' ? 'active' : ''}`} 
                onClick={() => { setSeverityFilter('done'); setPage(0); }}
              >
                <Icons.clock /> History <span className="count">{stats.done}</span>
              </button>
              {/* Staging Tab - shows raw findings waiting for cleanup */}
              {staging?.count > 0 && (
                <button 
                  className={`tab ${severityFilter === 'staging' ? 'active' : ''}`} 
                  onClick={() => { setSeverityFilter('staging'); setPage(0); }}
                  style={{ 
                    marginLeft: '12px',
                    background: severityFilter === 'staging' ? 'rgba(168,85,247,0.15)' : undefined,
                    borderColor: severityFilter === 'staging' ? '#a855f7' : undefined
                  }}
                >
                  üì¶ Staging <span className="count" style={{ background: '#a855f7', color: 'white' }}>{staging.count}</span>
                </button>
              )}
            </div>
            <div style={{ display: 'flex', gap: '8px', alignItems: 'center' }}>
              {/* Cleanup Agent Button */}
              {staging?.count > 0 && (
                <button 
                  className="btn btn-sm"
                  onClick={copyCleanupPrompt}
                  style={{
                    background: copyStatus === 'copied' ? 'var(--success)' : 'linear-gradient(135deg, #a855f7 0%, #7c3aed 100%)',
                    color: 'white',
                    border: 'none',
                    display: 'flex',
                    alignItems: 'center',
                    gap: '6px',
                    transition: 'all 0.2s'
                  }}
                  title="Copy Cleanup Agent prompt to clipboard"
                >
                  {copyStatus === 'copied' ? '‚úì Copied!' : 'üßπ Launch Cleanup Agent'}
                </button>
              )}
              {!serverMode && (
                <button className="btn btn-primary btn-sm" onClick={() => {
                  const json = JSON.stringify(decisions, null, 2);
                  navigator.clipboard.writeText(json);
                  alert('Decisions JSON copied!\n\nTip: Run "node docs/pm-dashboard-ui/server.js" for auto-save!');
                }}><Icons.export /> Export</button>
              )}
            </div>
          </div>

          {/* Staging View */}
          {severityFilter === 'staging' && staging?.count > 0 ? (
            <div className="card" style={{ padding: '40px', background: 'linear-gradient(135deg, rgba(168,85,247,0.1) 0%, rgba(124,58,237,0.05) 100%)' }}>
              <div style={{ textAlign: 'center', marginBottom: '32px' }}>
                <div style={{ fontSize: '48px', marginBottom: '16px' }}>üì¶</div>
                <h2 style={{ fontSize: '24px', fontWeight: '700', marginBottom: '8px' }}>Staging Queue</h2>
                <p style={{ color: 'var(--text-secondary)', fontSize: '14px' }}>
                  Raw findings from agents waiting for cleanup before entering inbox
                </p>
              </div>
              
              <div style={{ 
                display: 'grid', 
                gridTemplateColumns: 'repeat(4, 1fr)', 
                gap: '16px', 
                marginBottom: '32px',
                maxWidth: '600px',
                margin: '0 auto 32px'
              }}>
                <div style={{ 
                  background: 'var(--critical-bg)', 
                  border: '1px solid var(--critical)', 
                  borderRadius: '12px', 
                  padding: '16px', 
                  textAlign: 'center' 
                }}>
                  <div style={{ fontSize: '28px', fontWeight: '700', color: 'var(--critical)' }}>{staging.bySeverity?.critical || 0}</div>
                  <div style={{ fontSize: '12px', color: 'var(--text-muted)', marginTop: '4px' }}>Critical</div>
                </div>
                <div style={{ 
                  background: 'var(--high-bg)', 
                  border: '1px solid var(--high)', 
                  borderRadius: '12px', 
                  padding: '16px', 
                  textAlign: 'center' 
                }}>
                  <div style={{ fontSize: '28px', fontWeight: '700', color: 'var(--high)' }}>{staging.bySeverity?.high || 0}</div>
                  <div style={{ fontSize: '12px', color: 'var(--text-muted)', marginTop: '4px' }}>High</div>
                </div>
                <div style={{ 
                  background: 'var(--medium-bg)', 
                  border: '1px solid var(--medium)', 
                  borderRadius: '12px', 
                  padding: '16px', 
                  textAlign: 'center' 
                }}>
                  <div style={{ fontSize: '28px', fontWeight: '700', color: 'var(--medium)' }}>{staging.bySeverity?.medium || 0}</div>
                  <div style={{ fontSize: '12px', color: 'var(--text-muted)', marginTop: '4px' }}>Medium</div>
                </div>
                <div style={{ 
                  background: 'var(--low-bg)', 
                  border: '1px solid var(--low)', 
                  borderRadius: '12px', 
                  padding: '16px', 
                  textAlign: 'center' 
                }}>
                  <div style={{ fontSize: '28px', fontWeight: '700', color: 'var(--low)' }}>{staging.bySeverity?.low || 0}</div>
                  <div style={{ fontSize: '12px', color: 'var(--text-muted)', marginTop: '4px' }}>Low</div>
                </div>
              </div>
              
              <div style={{ 
                textAlign: 'center',
                padding: '24px',
                background: 'var(--bg-elevated)',
                borderRadius: '12px',
                border: '1px solid var(--border)'
              }}>
                <div style={{ fontSize: '14px', color: 'var(--text-secondary)', marginBottom: '16px' }}>
                  <strong>{staging.count}</strong> findings need cleanup before human review
                </div>
                <button 
                  className="btn"
                  onClick={copyCleanupPrompt}
                  style={{
                    background: copyStatus === 'copied' ? 'var(--success)' : 'linear-gradient(135deg, #a855f7 0%, #7c3aed 100%)',
                    color: 'white',
                    border: 'none',
                    padding: '12px 24px',
                    fontSize: '15px',
                    fontWeight: '600',
                    display: 'inline-flex',
                    alignItems: 'center',
                    gap: '8px',
                    transition: 'all 0.2s'
                  }}
                >
                  {copyStatus === 'copied' ? '‚úì Copied to Clipboard!' : 'üßπ Copy Cleanup Agent Prompt'}
                </button>
                <div style={{ fontSize: '12px', color: 'var(--text-muted)', marginTop: '12px' }}>
                  Paste into a new Cursor chat to launch the Cleanup Agent
                </div>
              </div>
            </div>
          ) : filtered.length === 0 ? (
            <div className="card" style={{ textAlign: 'center', padding: '60px' }}>
              <div style={{ marginBottom: '12px', color: 'var(--success)' }}><Icons.checkCircle /></div>
              <div style={{ color: 'var(--text-muted)' }}>
                {severityFilter === 'done' ? 'No history yet' : severityFilter === 'answered' ? 'No answered findings yet' : severityFilter === 'staging' ? 'Staging queue is empty!' : `All ${severityFilter} priority findings are done!`}
              </div>
            </div>
          ) : (
            <>
              <div style={{ fontSize: '12px', color: 'var(--text-muted)', marginBottom: '12px' }}>
                Showing {page * PAGE_SIZE + 1}-{Math.min((page + 1) * PAGE_SIZE, filtered.length)} of {filtered.length} {severityFilter === 'done' ? 'completed' : severityFilter === 'answered' ? 'answered' : severityFilter === 'all' ? '' : severityFilter} findings
                {severityFilter === 'all' && stats.openConvos > 0 && page === 0 && ' (open conversations first)'}
              </div>
              {paginated.map((f, idx) => {
                // Check if this is an open convo item (using getThread which uses decisions state)
                const thread = getThread(f.id);
                const msgs = thread?.messages || [];
                const lastMsg = msgs[msgs.length - 1];
                const isOpenConvo = thread?.decision?.option_id === 'custom' && lastMsg?.role === 'system';
                
                // Show section header for first open convo and first regular item
                const prevF = paginated[idx - 1];
                const prevThread = prevF ? getThread(prevF.id) : null;
                const prevMsgs = prevThread?.messages || [];
                const prevLastMsg = prevMsgs[prevMsgs.length - 1];
                const prevIsOpenConvo = prevThread?.decision?.option_id === 'custom' && prevLastMsg?.role === 'system';
                
                const showOpenConvoHeader = severityFilter === 'all' && isOpenConvo && idx === 0;
                const showRegularHeader = severityFilter === 'all' && !isOpenConvo && (idx === 0 || prevIsOpenConvo);
                
                return (
                  <React.Fragment key={f.id}>
                    {showRegularHeader && (
                      <div style={{ fontSize: '13px', fontWeight: 600, color: 'var(--text-secondary)', marginBottom: '12px', marginTop: idx > 0 ? '20px' : '0', display: 'flex', alignItems: 'center', gap: '6px' }}>
                        <Icons.file /> All Findings
                      </div>
                    )}
                    <FindingCard 
                      finding={f} 
                      thread={getThread(f.id)} 
                      onSelectOption={handleSelectOption}
                      onCustomResponse={handleCustomResponse}
                      onResolve={handleResolve}
                      onSkip={handleSkip}
                      onCombine={handleCombine}
                    />
                  </React.Fragment>
                );
              })}
              
              {/* Pagination */}
              {totalPages > 1 && (
                <div style={{ display: 'flex', justifyContent: 'center', gap: '8px', marginTop: '24px' }}>
                  <button 
                    className="btn btn-sm btn-secondary" 
                    disabled={page === 0}
                    onClick={() => setPage(p => p - 1)}
                  >‚Üê Previous</button>
                  <span style={{ padding: '6px 12px', color: 'var(--text-muted)', fontSize: '13px' }}>
                    Page {page + 1} of {totalPages}
                  </span>
                  <button 
                    className="btn btn-sm btn-secondary"
                    disabled={page >= totalPages - 1}
                    onClick={() => setPage(p => p + 1)}
                  >Next ‚Üí</button>
                </div>
              )}
            </>
          )}
        </div>
      );
    }

    // DEPRECATED - Replaced by NewPipelineView "All Tickets" tab
    function TicketsView_DEPRECATED({ ticketsData }) {
      const [filter, setFilter] = useState('all');
      const [selectedTicket, setSelectedTicket] = useState(null);
      
      const tickets = ticketsData || [];

      const stats = useMemo(() => {
        const byP = { critical: 0, high: 0, medium: 0, low: 0 };
        tickets.forEach(t => byP[t.priority]++);
        return byP;
      }, [tickets]);

      const filtered = filter === 'all' ? tickets : tickets.filter(t => t.priority === filter);

      return (
        <div className="fade-in">
          <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '20px' }}>
            <div className="tabs">
              <button className={`tab ${filter === 'all' ? 'active' : ''}`} onClick={() => setFilter('all')}>All <span className="count">{tickets.length}</span></button>
              <button className={`tab ${filter === 'critical' ? 'active' : ''}`} onClick={() => setFilter('critical')}><StatusDot color="var(--critical)" /> Critical <span className="count">{stats.critical}</span></button>
              <button className={`tab ${filter === 'high' ? 'active' : ''}`} onClick={() => setFilter('high')}><StatusDot color="var(--high)" /> High <span className="count">{stats.high}</span></button>
              <button className={`tab ${filter === 'medium' ? 'active' : ''}`} onClick={() => setFilter('medium')}><StatusDot color="var(--medium)" /> Medium <span className="count">{stats.medium}</span></button>
              <button className={`tab ${filter === 'low' ? 'active' : ''}`} onClick={() => setFilter('low')}><StatusDot color="var(--low)" /> Low <span className="count">{stats.low}</span></button>
            </div>
          </div>
          <div className="ticket-grid">
            {filtered.map(t => <TicketCard key={t.id} ticket={t} onClick={() => setSelectedTicket(t)} />)}
          </div>
          {selectedTicket && <TicketModal ticket={selectedTicket} onClose={() => setSelectedTicket(null)} />}
        </div>
      );
    }

    // DEPRECATED - Replaced by LaunchView
    function AgentsView_DEPRECATED() {
      const s = FINDINGS_SUMMARY;
      const totalPending = Object.values(s.by_priority).reduce((sum, p) => sum + p.pending, 0);
      const highPending = s.by_priority.high.pending;

      return (
        <div className="fade-in">
          {/* Current Status */}
          <div className="section">
            <div className="section-title">Current Status</div>
            <div style={{ display: 'flex', gap: '12px', flexWrap: 'wrap', marginBottom: '16px' }}>
              <div className="card" style={{ flex: 1, padding: '16px', textAlign: 'center', minWidth: '140px' }}>
                <div style={{ fontSize: '11px', color: 'var(--text-muted)', textTransform: 'uppercase', marginBottom: '4px' }}>Undocumented</div>
                <div style={{ fontSize: '24px', fontWeight: 700, color: 'var(--success)' }}>0</div>
                <div style={{ fontSize: '11px', color: 'var(--success)' }}>All done</div>
              </div>
              <div className="card" style={{ flex: 1, padding: '16px', textAlign: 'center', minWidth: '140px' }}>
                <div style={{ fontSize: '11px', color: 'var(--text-muted)', textTransform: 'uppercase', marginBottom: '4px' }}>Unreviewed</div>
                <div style={{ fontSize: '24px', fontWeight: 700, color: 'var(--success)' }}>0</div>
                <div style={{ fontSize: '11px', color: 'var(--success)' }}>All done</div>
              </div>
              <div className="card" style={{ flex: 1, padding: '16px', textAlign: 'center', minWidth: '140px' }}>
                <div style={{ fontSize: '11px', color: 'var(--text-muted)', textTransform: 'uppercase', marginBottom: '4px' }}>Pending Triage</div>
                <div style={{ fontSize: '24px', fontWeight: 700, color: totalPending > 0 ? 'var(--high)' : 'var(--success)' }}>{totalPending}</div>
                <div style={{ fontSize: '11px', color: 'var(--text-muted)' }}>{highPending} High priority</div>
              </div>
            </div>
            <div className="card" style={{ padding: '16px', background: 'var(--accent-bg)', border: '1px solid rgba(99,102,241,0.3)' }}>
              <div style={{ fontSize: '14px', fontWeight: 600, marginBottom: '4px', display: 'flex', alignItems: 'center', gap: '6px' }}><Icons.inbox /> Next Step: Triage Findings</div>
              <div style={{ fontSize: '13px', color: 'var(--text-secondary)' }}>
                Answer questions in the <strong>Triage</strong> tab, then run the PM command below to create tickets.
              </div>
            </div>
          </div>

          {/* PM Commands */}
          <div className="section">
            <div className="section-title">PM Commands</div>
            <p style={{ fontSize: '13px', color: 'var(--text-muted)', marginBottom: '16px' }}>
              Copy these commands and paste into a <strong>new Cursor chat</strong>. The PM agent will generate batch commands for doc/review agents, or process your triage decisions.
            </p>
            
            <CommandBox label={PM_COMMANDS.processDecisions.label} command={PM_COMMANDS.processDecisions.command} description={PM_COMMANDS.processDecisions.description} />
            <CommandBox label={PM_COMMANDS.answerQuestions.label} command={PM_COMMANDS.answerQuestions.command} description={PM_COMMANDS.answerQuestions.description} />
            <CommandBox label={PM_COMMANDS.continueHighFindings.label} command={PM_COMMANDS.continueHighFindings.command} description={PM_COMMANDS.continueHighFindings.description} />
            <CommandBox label={PM_COMMANDS.docMode.label} command={PM_COMMANDS.docMode.command} description={PM_COMMANDS.docMode.description} />
            <CommandBox label={PM_COMMANDS.reviewMode.label} command={PM_COMMANDS.reviewMode.command} description={PM_COMMANDS.reviewMode.description} />
          </div>

          {/* Workflow */}
          <div className="section">
            <div className="section-title">How It Works</div>
            <div className="card" style={{ padding: '20px' }}>
              <div style={{ display: 'flex', flexDirection: 'column', gap: '16px' }}>
                <div style={{ display: 'flex', alignItems: 'flex-start', gap: '12px' }}>
                  <div style={{ width: '28px', height: '28px', borderRadius: '50%', background: 'var(--accent)', color: 'white', display: 'flex', alignItems: 'center', justifyContent: 'center', fontSize: '12px', fontWeight: 700, flexShrink: 0 }}>1</div>
                  <div>
                    <div style={{ fontWeight: 600, fontSize: '14px' }}>Doc Sprint</div>
                    <div style={{ fontSize: '12px', color: 'var(--text-muted)' }}>PM generates batch of doc-agent commands ‚Üí You paste each into separate Cursor chats ‚Üí They run in parallel</div>
                  </div>
                </div>
                <div style={{ display: 'flex', alignItems: 'flex-start', gap: '12px' }}>
                  <div style={{ width: '28px', height: '28px', borderRadius: '50%', background: 'var(--accent)', color: 'white', display: 'flex', alignItems: 'center', justifyContent: 'center', fontSize: '12px', fontWeight: 700, flexShrink: 0 }}>2</div>
                  <div>
                    <div style={{ fontWeight: 600, fontSize: '14px' }}>Review Sprint</div>
                    <div style={{ fontSize: '12px', color: 'var(--text-muted)' }}>PM generates batch of review-agent commands ‚Üí Agents find issues ‚Üí Findings written to REVIEW_FINDINGS.md</div>
                  </div>
                </div>
                <div style={{ display: 'flex', alignItems: 'flex-start', gap: '12px' }}>
                  <div style={{ width: '28px', height: '28px', borderRadius: '50%', background: 'var(--accent)', color: 'white', display: 'flex', alignItems: 'center', justifyContent: 'center', fontSize: '12px', fontWeight: 700, flexShrink: 0 }}>3</div>
                  <div>
                    <div style={{ fontWeight: 600, fontSize: '14px' }}>Triage (This Dashboard)</div>
                    <div style={{ fontSize: '12px', color: 'var(--text-muted)' }}>Answer questions in Triage tab ‚Üí Decisions auto-saved ‚Üí Run PM to create tickets</div>
                  </div>
                </div>
                <div style={{ display: 'flex', alignItems: 'flex-start', gap: '12px' }}>
                  <div style={{ width: '28px', height: '28px', borderRadius: '50%', background: 'var(--bg-elevated)', color: 'var(--text-muted)', display: 'flex', alignItems: 'center', justifyContent: 'center', fontSize: '12px', fontWeight: 700, flexShrink: 0 }}>4</div>
                  <div>
                    <div style={{ fontWeight: 600, fontSize: '14px' }}>Dev Sprint</div>
                    <div style={{ fontSize: '12px', color: 'var(--text-muted)' }}>PM generates dev-agent commands from tickets ‚Üí Agents implement fixes</div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      );
    }

    // ================= DEV VIEW (DEPRECATED - kept for reference) =================
    // This component has been replaced by NewPipelineView and LaunchView
    // TODO: Remove after confirming new views work correctly

    function DevView_DEPRECATED({ tickets, devStatus, onBlockedDecision, onSaveDevStatus, serverMode }) {
      const [devTab, setDevTab] = useState('batch');
      const [copied, setCopied] = useState(null);
      const [customInputs, setCustomInputs] = useState({});
      
      // Filter tickets by status
      const blockedItems = devStatus?.blocked || [];
      const inProgressItems = devStatus?.in_progress || [];
      const completedItems = devStatus?.completed || [];
      
      // Ready = status is 'ready' AND not in dev-status completed/in_progress
      const completedIds = new Set(completedItems.map(c => c.ticket_id));
      const inProgressIds = new Set(inProgressItems.map(i => i.ticket_id));
      const readyTickets = tickets.filter(t => 
        t.status === 'ready' && 
        !completedIds.has(t.id) && 
        !inProgressIds.has(t.id)
      );
      
      // Group ready tickets by priority
      const byPriority = {
        critical: readyTickets.filter(t => t.priority === 'critical'),
        high: readyTickets.filter(t => t.priority === 'high'),
        medium: readyTickets.filter(t => t.priority === 'medium'),
        low: readyTickets.filter(t => t.priority === 'low')
      };
      
      const copyCommand = (ticketId, version = 1) => {
        const cmd = `You are a Dev Agent. Read docs/workflow/DEV_AGENT_SOP.md then execute: docs/prompts/active/dev-agent-${ticketId}-v${version}.md`;
        navigator.clipboard.writeText(cmd);
        setCopied(ticketId);
        setTimeout(() => setCopied(null), 2000);
      };
      
      const handleBlockedDecision = (ticketId, optionId, optionLabel) => {
        const customNote = customInputs[ticketId] || '';
        onBlockedDecision(ticketId, { option_id: optionId, option_label: optionLabel }, customNote);
        setCustomInputs(prev => ({ ...prev, [ticketId]: '' }));
      };
      
      const markInProgress = (ticket) => {
        const newInProgress = [...inProgressItems, {
          ticket_id: ticket.id,
          title: ticket.title,
          branch: `agent/${ticket.id.toLowerCase()}-${ticket.title.toLowerCase().replace(/[^a-z0-9]+/g, '-').slice(0, 30)}`,
          started_at: new Date().toISOString()
        }];
        onSaveDevStatus({ ...devStatus, in_progress: newInProgress });
      };
      
      const markCompleted = (ticketId) => {
        const item = inProgressItems.find(i => i.ticket_id === ticketId);
        if (!item) return;
        
        const newInProgress = inProgressItems.filter(i => i.ticket_id !== ticketId);
        const newCompleted = [...completedItems, { ...item, completed_at: new Date().toISOString() }];
        onSaveDevStatus({ ...devStatus, in_progress: newInProgress, completed: newCompleted });
      };
      
      const retryTicket = (ticketId) => {
        const item = inProgressItems.find(i => i.ticket_id === ticketId);
        if (!item) return;
        
        // Move back to ready (remove from in_progress)
        const newInProgress = inProgressItems.filter(i => i.ticket_id !== ticketId);
        
        // Track retry count
        const retryHistory = [...(devStatus.retry_history || []), {
          ticket_id: ticketId,
          retried_at: new Date().toISOString(),
          previous_attempt: item
        }];
        
        onSaveDevStatus({ ...devStatus, in_progress: newInProgress, retry_history: retryHistory });
      };
      
      const cancelTicket = (ticketId) => {
        const newInProgress = inProgressItems.filter(i => i.ticket_id !== ticketId);
        onSaveDevStatus({ ...devStatus, in_progress: newInProgress });
      };
      
      // Helper: get elapsed time in minutes
      const getElapsedMinutes = (startedAt) => {
        if (!startedAt) return 0;
        return Math.floor((Date.now() - new Date(startedAt).getTime()) / 60000);
      };
      
      // Helper: format elapsed time nicely
      const formatElapsed = (startedAt) => {
        const mins = getElapsedMinutes(startedAt);
        if (mins < 1) return 'Just started';
        if (mins < 60) return `${mins} min ago`;
        const hours = Math.floor(mins / 60);
        const remainingMins = mins % 60;
        if (hours < 24) return `${hours}h ${remainingMins}m ago`;
        const days = Math.floor(hours / 24);
        return `${days}d ${hours % 24}h ago`;
      };
      
      // Stale threshold: 30 minutes
      const STALE_THRESHOLD_MINS = 30;
      const isStale = (startedAt) => getElapsedMinutes(startedAt) > STALE_THRESHOLD_MINS;
      
      const pendingBlockers = blockedItems.filter(b => b.status !== 'decided');
      const staleCount = inProgressItems.filter(i => isStale(i.started_at)).length;
      
      // ============ PARALLELIZATION LOGIC ============
      // Calculate which tickets can run simultaneously without file conflicts
      
      // Get files currently being modified by in-progress tickets
      const inProgressTicketIds = new Set(inProgressItems.map(i => i.ticket_id));
      const filesInProgress = new Set();
      tickets.filter(t => inProgressTicketIds.has(t.id)).forEach(t => {
        (t.files_to_modify || []).forEach(f => filesInProgress.add(f));
      });
      
      // ALSO get files locked by completed tickets (in review, not merged yet)
      const completedTicketIds = new Set(completedItems.map(c => c.ticket_id));
      const filesInReview = new Set();
      tickets.filter(t => completedTicketIds.has(t.id)).forEach(t => {
        (t.files_to_modify || []).forEach(f => filesInReview.add(f));
      });
      
      // Combine all locked files
      const allLockedFiles = new Set([...filesInProgress, ...filesInReview]);
      
      // Get tickets that are ready and not in progress or completed
      const availableTickets = readyTickets.filter(t => 
        !inProgressTicketIds.has(t.id) && !completedTicketIds.has(t.id)
      );
      
      // Calculate next batch - greedy algorithm to find non-conflicting tickets
      const calculateNextBatch = () => {
        const batch = [];
        const batchFiles = new Set(allLockedFiles); // Start with ALL locked files (in progress + in review)
        
        // Sort by priority (critical first, then high, etc.)
        const priorityOrder = { critical: 0, high: 1, medium: 2, low: 3 };
        const sorted = [...availableTickets].sort((a, b) => 
          (priorityOrder[a.priority] || 4) - (priorityOrder[b.priority] || 4)
        );
        
        for (const ticket of sorted) {
          const ticketFiles = ticket.files_to_modify || [];
          const hasConflict = ticketFiles.some(f => batchFiles.has(f));
          
          if (!hasConflict) {
            batch.push(ticket);
            ticketFiles.forEach(f => batchFiles.add(f));
          }
        }
        
        return batch;
      };
      
      const nextBatch = calculateNextBatch();
      
      // Find conflicts for display
      const getConflicts = (ticket) => {
        const ticketFiles = ticket.files_to_modify || [];
        const conflicts = [];
        
        // Check against in-progress
        inProgressItems.forEach(ip => {
          const ipTicket = tickets.find(t => t.id === ip.ticket_id);
          if (ipTicket) {
            const ipFiles = ipTicket.files_to_modify || [];
            const sharedFiles = ticketFiles.filter(f => ipFiles.includes(f));
            if (sharedFiles.length > 0) {
              conflicts.push({ ticket_id: ip.ticket_id, files: sharedFiles, type: 'in_progress' });
            }
          }
        });
        
        // Check against completed (in review) - these are unmerged!
        completedItems.forEach(ci => {
          const ciTicket = tickets.find(t => t.id === ci.ticket_id);
          if (ciTicket) {
            const ciFiles = ciTicket.files_to_modify || [];
            const sharedFiles = ticketFiles.filter(f => ciFiles.includes(f));
            if (sharedFiles.length > 0) {
              conflicts.push({ ticket_id: ci.ticket_id, files: sharedFiles, type: 'in_review' });
            }
          }
        });
        
        // Check against batch
        nextBatch.forEach(bt => {
          if (bt.id !== ticket.id) {
            const btFiles = bt.files_to_modify || [];
            const sharedFiles = ticketFiles.filter(f => btFiles.includes(f));
            if (sharedFiles.length > 0) {
              conflicts.push({ ticket_id: bt.id, files: sharedFiles, type: 'batch' });
            }
          }
        });
        
        return conflicts;
      };

      return (
        <div className="fade-in">
          {/* Summary Cards */}
          <div style={{ display: 'grid', gridTemplateColumns: 'repeat(5, 1fr)', gap: '12px', marginBottom: '24px' }}>
            <div 
              className="card" 
              onClick={() => setDevTab('all')}
              style={{ 
                padding: '16px', 
                cursor: 'pointer', 
                borderLeft: '4px solid var(--border)',
                background: devTab === 'all' ? 'var(--bg-elevated)' : undefined
              }}
            >
              <div style={{ fontSize: '24px', fontWeight: 700, color: 'var(--text-primary)' }}>
                {tickets.length}
              </div>
              <div style={{ fontSize: '12px', color: 'var(--text-muted)', marginTop: '4px' }}>All Tickets</div>
            </div>
            <div 
              className="card" 
              onClick={() => setDevTab('batch')}
              style={{ 
                padding: '16px', 
                cursor: 'pointer',
                borderLeft: '4px solid var(--success)',
                background: devTab === 'batch' ? 'var(--bg-elevated)' : undefined
              }}
            >
              <div style={{ fontSize: '24px', fontWeight: 700, color: 'var(--success)' }}>
                {nextBatch.length}
              </div>
              <div style={{ fontSize: '12px', color: 'var(--text-muted)', marginTop: '4px' }}>Next Batch</div>
            </div>
            <div 
              className="card" 
              onClick={() => setDevTab('progress')}
              style={{ 
                padding: '16px', 
                cursor: 'pointer',
                borderLeft: staleCount > 0 ? '4px solid var(--medium)' : inProgressItems.length > 0 ? '4px solid var(--accent)' : '4px solid var(--border)',
                background: devTab === 'progress' ? 'var(--bg-elevated)' : undefined
              }}
            >
              <div style={{ display: 'flex', alignItems: 'baseline', gap: '6px' }}>
                <span style={{ fontSize: '24px', fontWeight: 700, color: staleCount > 0 ? 'var(--medium)' : inProgressItems.length > 0 ? 'var(--accent-bright)' : 'var(--text-muted)' }}>
                  {inProgressItems.length}
                </span>
                {staleCount > 0 && (
                  <span style={{ fontSize: '11px', color: 'var(--medium)', fontWeight: 600 }}>‚ö†Ô∏è</span>
                )}
              </div>
              <div style={{ fontSize: '12px', color: 'var(--text-muted)', marginTop: '4px' }}>In Progress</div>
            </div>
            <div 
              className="card" 
              onClick={() => setDevTab('blockers')}
              style={{ 
                padding: '16px', 
                cursor: 'pointer', 
                borderLeft: pendingBlockers.length > 0 ? '4px solid var(--critical)' : '4px solid var(--border)',
                background: devTab === 'blockers' ? 'var(--bg-elevated)' : undefined
              }}
            >
              <div style={{ fontSize: '24px', fontWeight: 700, color: pendingBlockers.length > 0 ? 'var(--critical)' : 'var(--text-muted)' }}>
                {pendingBlockers.length}
              </div>
              <div style={{ fontSize: '12px', color: 'var(--text-muted)', marginTop: '4px' }}>Blockers</div>
            </div>
            <div 
              className="card" 
              onClick={() => setDevTab('review')}
              style={{ 
                padding: '16px', 
                cursor: 'pointer',
                borderLeft: completedItems.length > 0 ? '4px solid var(--accent)' : '4px solid var(--border)',
                background: devTab === 'review' ? 'var(--bg-elevated)' : undefined
              }}
            >
              <div style={{ fontSize: '24px', fontWeight: 700, color: completedItems.length > 0 ? 'var(--accent-bright)' : 'var(--text-muted)' }}>
                {completedItems.length}
              </div>
              <div style={{ fontSize: '12px', color: 'var(--text-muted)', marginTop: '4px' }}>For Review</div>
            </div>
          </div>
          
          {/* Tab Navigation */}
          <div style={{ display: 'flex', gap: '2px', marginBottom: '20px', borderBottom: '1px solid var(--border)', paddingBottom: '0', overflowX: 'auto' }}>
            {[
              { id: 'all', label: 'All', count: tickets.length, color: 'var(--text-primary)' },
              { id: 'batch', label: 'Next Batch', count: nextBatch.length, color: 'var(--success)' },
              { id: 'progress', label: 'In Progress', count: inProgressItems.length, color: staleCount > 0 ? 'var(--medium)' : 'var(--accent)', stale: staleCount },
              { id: 'blockers', label: 'Blockers', count: pendingBlockers.length, color: 'var(--critical)' },
              { id: 'review', label: 'For Review', count: completedItems.length, color: 'var(--accent)' }
            ].map(tab => (
              <button
                key={tab.id}
                onClick={() => setDevTab(tab.id)}
                style={{
                  padding: '10px 14px',
                  background: 'transparent',
                  border: 'none',
                  borderBottom: devTab === tab.id ? `3px solid ${tab.color}` : '3px solid transparent',
                  color: devTab === tab.id ? 'var(--text-primary)' : 'var(--text-muted)',
                  fontSize: '13px',
                  fontWeight: devTab === tab.id ? 600 : 400,
                  cursor: 'pointer',
                  display: 'flex',
                  alignItems: 'center',
                  gap: '6px',
                  marginBottom: '-1px',
                  whiteSpace: 'nowrap'
                }}
              >
                {tab.label}
                {tab.count > 0 && (
                  <span style={{ 
                    padding: '2px 6px', 
                    background: devTab === tab.id ? tab.color : 'var(--bg-elevated)', 
                    color: devTab === tab.id ? 'white' : 'var(--text-muted)', 
                    borderRadius: '10px', 
                    fontSize: '10px', 
                    fontWeight: 600 
                  }}>
                    {tab.stale ? `‚ö†Ô∏è ${tab.count}` : tab.count}
                  </span>
                )}
              </button>
            ))}
          </div>
          
          {/* Tab Content */}
          
          {/* ALL TICKETS TAB */}
          {devTab === 'all' && (
            <div className="fade-in">
              <div style={{ marginBottom: '16px', padding: '12px 16px', background: 'var(--bg-elevated)', borderRadius: '8px', fontSize: '13px', color: 'var(--text-muted)' }}>
                Showing all {tickets.length} tickets. Filter by status or use "Next Batch" to see parallelizable tickets.
              </div>
              
              {['ready', 'in_progress', 'blocked', 'review', 'done'].map(status => {
                const statusTickets = tickets.filter(t => {
                  if (status === 'in_progress') return inProgressTicketIds.has(t.id);
                  if (status === 'blocked') return blockedItems.some(b => b.ticket_id === t.id);
                  if (status === 'review') return completedItems.some(c => c.ticket_id === t.id);
                  return t.status === status;
                });
                
                if (statusTickets.length === 0) return null;
                
                const statusConfig = {
                  ready: { label: 'Ready', icon: null, color: 'var(--success)' },
                  in_progress: { label: 'In Progress', icon: 'üîÑ', color: 'var(--accent)' },
                  blocked: { label: 'Blocked', icon: 'üöß', color: 'var(--critical)' },
                  review: { label: 'For Review', icon: '‚úÖ', color: 'var(--accent)' },
                  done: { label: 'Done', icon: null, color: 'var(--text-muted)' }
                };
                const config = statusConfig[status] || { label: status, icon: null, color: 'var(--text-muted)' };
                
                return (
                  <div key={status} style={{ marginBottom: '24px' }}>
                    <div style={{ display: 'flex', alignItems: 'center', gap: '8px', marginBottom: '12px' }}>
                      <span>{config.icon}</span>
                      <span style={{ fontSize: '14px', fontWeight: 600, color: config.color }}>{config.label}</span>
                      <span style={{ fontSize: '12px', color: 'var(--text-muted)' }}>({statusTickets.length})</span>
                    </div>
                    <div style={{ display: 'grid', gap: '8px' }}>
                      {statusTickets.map(ticket => (
                        <div key={ticket.id} className="card" style={{ padding: '12px 16px', borderLeft: `3px solid ${config.color}` }}>
                          <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                            <div>
                              <div style={{ display: 'flex', alignItems: 'center', gap: '8px' }}>
                                <code style={{ fontSize: '11px', padding: '2px 6px', background: 'var(--bg-elevated)', borderRadius: '4px' }}>{ticket.id}</code>
                                <span style={{ fontSize: '13px', fontWeight: 500 }}>{ticket.title}</span>
                              </div>
                              <div style={{ fontSize: '11px', color: 'var(--text-muted)', marginTop: '4px' }}>
                                {ticket.priority} ‚Ä¢ {(ticket.files_to_modify || []).length} files
                              </div>
                            </div>
                          </div>
                        </div>
                      ))}
                    </div>
                  </div>
                );
              })}
            </div>
          )}
          
          {/* NEXT BATCH TAB */}
          {devTab === 'batch' && (
            <div className="fade-in">
              {/* Batch Info */}
              <div style={{ 
                padding: '16px 20px', 
                background: 'linear-gradient(135deg, rgba(16,185,129,0.1), rgba(99,102,241,0.1))',
                borderRadius: '12px', 
                marginBottom: '20px',
                border: '1px solid rgba(16,185,129,0.2)'
              }}>
                <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                  <div>
                    <div style={{ fontSize: '18px', fontWeight: 700, color: 'var(--text-primary)' }}>
                      {nextBatch.length} tickets can run in parallel
                    </div>
                    <div style={{ fontSize: '13px', color: 'var(--text-muted)', marginTop: '4px' }}>
                      These tickets have no file conflicts ‚Äî launch them all simultaneously!
                    </div>
                  </div>
                  {nextBatch.length > 0 && (
                    <button 
                      className="btn btn-success"
                      onClick={() => {
                        nextBatch.forEach(t => markInProgress(t));
                      }}
                    >
                      ‚ñ∂ Start All {nextBatch.length}
                    </button>
                  )}
                </div>
              </div>
              
              {/* In Progress Warning */}
              {inProgressItems.length > 0 && (
                <div style={{ 
                  padding: '12px 16px', 
                  background: 'rgba(99,102,241,0.1)', 
                  borderRadius: '8px', 
                  marginBottom: '16px',
                  fontSize: '13px',
                  color: 'var(--text-secondary)'
                }}>
                  ‚ö° <strong>{inProgressItems.length} agents running</strong> ‚Äî these files are locked: {' '}
                  <code style={{ fontSize: '11px' }}>{[...filesInProgress].slice(0, 3).join(', ')}{filesInProgress.size > 3 ? ` +${filesInProgress.size - 3} more` : ''}</code>
                </div>
              )}
              
              {nextBatch.length === 0 ? (
                <div className="card" style={{ textAlign: 'center', padding: '60px', color: 'var(--text-muted)' }}>
                  <div style={{ fontSize: '48px', marginBottom: '16px' }}>üéâ</div>
                  <div style={{ fontSize: '18px', fontWeight: 500 }}>
                    {inProgressItems.length > 0 ? 'All remaining tickets conflict with in-progress work' : 'No ready tickets'}
                  </div>
                  <div style={{ fontSize: '14px', marginTop: '8px' }}>
                    {inProgressItems.length > 0 ? 'Wait for current agents to complete, or check the "All Tickets" tab' : 'Create more tickets or check the backlog'}
                  </div>
                </div>
              ) : (
                <div style={{ display: 'grid', gap: '12px' }}>
                  {nextBatch.map((ticket, idx) => {
                    const priorityColors = { critical: 'var(--critical)', high: 'var(--high)', medium: 'var(--medium)', low: 'var(--low)' };
                    const priorityIcons = { critical: '', high: '', medium: '', low: '' };
                    
                    return (
                      <div key={ticket.id} className="card" style={{ padding: '16px 20px', borderLeft: `4px solid ${priorityColors[ticket.priority] || 'var(--border)'}` }}>
                        <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'flex-start' }}>
                          <div style={{ flex: 1 }}>
                            <div style={{ display: 'flex', alignItems: 'center', gap: '10px', flexWrap: 'wrap' }}>
                              <span style={{ fontSize: '18px', fontWeight: 700, color: 'var(--text-muted)' }}>#{idx + 1}</span>
                              <code style={{ fontSize: '12px', padding: '3px 8px', background: 'var(--bg-elevated)', borderRadius: '4px' }}>{ticket.id}</code>
                              <span style={{ fontSize: '11px' }}>{priorityIcons[ticket.priority]}</span>
                              <Badge type={ticket.priority === 'critical' ? 'critical' : ticket.priority === 'high' ? 'open' : 'active'}>
                                {ticket.priority?.toUpperCase()}
                              </Badge>
                            </div>
                            <div style={{ fontSize: '15px', fontWeight: 600, marginTop: '8px' }}>{ticket.title}</div>
                            <div style={{ fontSize: '12px', color: 'var(--text-muted)', marginTop: '6px' }}>
                              {(ticket.files_to_modify || []).length} files ‚Ä¢ {(ticket.acceptance_criteria || []).length} criteria
                            </div>
                            {(ticket.files_to_modify || []).length > 0 && (
                              <div style={{ fontSize: '11px', color: 'var(--text-muted)', marginTop: '6px' }}>
                                Files: <code>{(ticket.files_to_modify || []).slice(0, 2).join(', ')}{(ticket.files_to_modify || []).length > 2 ? ` +${(ticket.files_to_modify || []).length - 2}` : ''}</code>
                              </div>
                            )}
                          </div>
                          <div style={{ display: 'flex', gap: '8px', marginLeft: '16px' }}>
                            <button 
                              className="btn btn-sm btn-secondary"
                              onClick={() => markInProgress(ticket)}
                            >
                              ‚ñ∂ Start
                            </button>
                            <button 
                              className={`btn btn-sm ${copied === ticket.id ? 'btn-success' : 'btn-primary'}`}
                              onClick={() => copyCommand(ticket.id)}
                            >
                              {copied === ticket.id ? 'Copied!' : 'Copy'}
                            </button>
                          </div>
                        </div>
                      </div>
                    );
                  })}
                </div>
              )}
              
              {/* Conflicting tickets */}
              {availableTickets.length > nextBatch.length && (
                <div style={{ marginTop: '32px' }}>
                  <div style={{ fontSize: '14px', fontWeight: 600, color: 'var(--text-muted)', marginBottom: '12px' }}>
                    ‚è≥ Waiting (file conflicts with batch above)
                  </div>
                  <div style={{ display: 'grid', gap: '8px' }}>
                    {availableTickets.filter(t => !nextBatch.includes(t)).slice(0, 5).map(ticket => {
                      const conflicts = getConflicts(ticket);
                      return (
                        <div key={ticket.id} className="card" style={{ padding: '12px 16px', opacity: 0.7, borderLeft: '3px solid var(--border)' }}>
                          <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                            <div>
                              <div style={{ display: 'flex', alignItems: 'center', gap: '8px' }}>
                                <code style={{ fontSize: '11px' }}>{ticket.id}</code>
                                <span style={{ fontSize: '13px' }}>{ticket.title}</span>
                              </div>
                              {conflicts.length > 0 && (
                                <div style={{ fontSize: '11px', color: 'var(--critical)', marginTop: '4px' }}>
                                  ‚ö†Ô∏è Conflicts with: {conflicts.map(c => 
                                    c.type === 'in_review' ? `${c.ticket_id} (in review)` :
                                    c.type === 'in_progress' ? `${c.ticket_id} (in progress)` :
                                    c.ticket_id
                                  ).join(', ')}
                                </div>
                              )}
                            </div>
                          </div>
                        </div>
                      );
                    })}
                    {availableTickets.filter(t => !nextBatch.includes(t)).length > 5 && (
                      <div style={{ fontSize: '12px', color: 'var(--text-muted)', padding: '8px' }}>
                        ... and {availableTickets.filter(t => !nextBatch.includes(t)).length - 5} more waiting
                      </div>
                    )}
                  </div>
                </div>
              )}
            </div>
          )}
          
          {/* BLOCKERS TAB */}
          {devTab === 'blockers' && (
            <div className="fade-in">
              {pendingBlockers.length === 0 ? (
                <div className="card" style={{ textAlign: 'center', padding: '60px', color: 'var(--text-muted)' }}>
                  <div style={{ fontSize: '48px', marginBottom: '16px' }}>‚úì</div>
                  <div style={{ fontSize: '18px', fontWeight: 500 }}>No blocked agents</div>
                  <div style={{ fontSize: '14px', marginTop: '8px' }}>All agents are running smoothly</div>
                </div>
              ) : (
                pendingBlockers.map(blocked => (
                  <div key={blocked.ticket_id} className="card" style={{ marginBottom: '16px', borderLeft: '4px solid var(--critical)' }}>
                    <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'flex-start', marginBottom: '16px' }}>
                      <div>
                        <code style={{ fontSize: '12px', color: 'var(--text-muted)' }}>{blocked.ticket_id}</code>
                        <h3 style={{ fontSize: '18px', fontWeight: 600, marginTop: '4px' }}>{blocked.title}</h3>
                        {blocked.branch && (
                          <div style={{ fontSize: '12px', color: 'var(--text-muted)', marginTop: '4px' }}>
                            Branch: <code style={{ color: 'var(--accent-bright)' }}>{blocked.branch}</code>
                          </div>
                        )}
                      </div>
                      <Badge type="critical">NEEDS DECISION</Badge>
                    </div>
                    
                    <div style={{ padding: '16px', background: 'var(--bg-elevated)', borderRadius: '8px', marginBottom: '16px' }}>
                      <div style={{ fontSize: '12px', color: 'var(--text-muted)', marginBottom: '6px', textTransform: 'uppercase', letterSpacing: '0.5px' }}>Question:</div>
                      <div style={{ fontSize: '15px', fontWeight: 500, lineHeight: '1.5' }}>{blocked.question}</div>
                    </div>
                    
                    {blocked.progress && (
                      <div style={{ display: 'flex', gap: '24px', fontSize: '13px', color: 'var(--text-muted)', marginBottom: '16px', padding: '12px', background: 'rgba(99,102,241,0.05)', borderRadius: '8px' }}>
                        <div><strong style={{ color: 'var(--success)' }}>Done:</strong> {blocked.progress.done?.length || 0} items</div>
                        <div><strong style={{ color: 'var(--medium)' }}>Remaining:</strong> {blocked.progress.remaining?.length || 0} items</div>
                      </div>
                    )}
                    
                    <div style={{ marginBottom: '16px' }}>
                      <div style={{ fontSize: '12px', color: 'var(--text-muted)', marginBottom: '12px', textTransform: 'uppercase', letterSpacing: '0.5px' }}>Choose an option:</div>
                      <div style={{ display: 'flex', flexDirection: 'column', gap: '10px' }}>
                        {(blocked.options || []).map((opt, i) => (
                          <button
                            key={i}
                            onClick={() => handleBlockedDecision(blocked.ticket_id, opt.id || (i + 1), opt.label)}
                            style={{
                              display: 'flex',
                              alignItems: 'center',
                              justifyContent: 'space-between',
                              padding: '14px 18px',
                              background: opt.recommended ? 'var(--accent-bg)' : 'var(--bg-surface)',
                              border: opt.recommended ? '2px solid var(--accent)' : '1px solid var(--border)',
                              borderRadius: '10px',
                              color: 'var(--text-primary)',
                              fontSize: '14px',
                              cursor: 'pointer',
                              textAlign: 'left',
                              transition: 'all 0.15s ease'
                            }}
                          >
                            <span style={{ flex: 1, paddingRight: '12px' }}>{opt.label}</span>
                            {opt.recommended && (
                              <span style={{ fontSize: '11px', padding: '4px 10px', background: 'var(--accent)', color: 'white', borderRadius: '6px', fontWeight: 600, whiteSpace: 'nowrap' }}>
                                ‚≠ê RECOMMENDED
                              </span>
                            )}
                          </button>
                        ))}
                      </div>
                    </div>
                    
                    <input
                      type="text"
                      placeholder="Add a note with your decision (optional)..."
                      value={customInputs[blocked.ticket_id] || ''}
                      onChange={e => setCustomInputs(prev => ({ ...prev, [blocked.ticket_id]: e.target.value }))}
                      className="input"
                      style={{ width: '100%' }}
                    />
                  </div>
                ))
              )}
              
              {/* Decided blockers */}
              {blockedItems.filter(b => b.status === 'decided').length > 0 && (
                <div style={{ marginTop: '24px' }}>
                  <div style={{ fontSize: '14px', fontWeight: 600, color: 'var(--success)', marginBottom: '12px' }}>Recently Decided</div>
                  {blockedItems.filter(b => b.status === 'decided').map(b => (
                    <div key={b.ticket_id} style={{ padding: '14px', background: 'rgba(16,185,129,0.08)', borderRadius: '10px', marginBottom: '10px', fontSize: '14px', borderLeft: '3px solid var(--success)' }}>
                      <strong>{b.ticket_id}</strong>: {b.decision?.option_label}
                      {b.decision?.custom_note && <div style={{ color: 'var(--text-muted)', marginTop: '4px', fontSize: '13px' }}>Note: {b.decision.custom_note}</div>}
                    </div>
                  ))}
                </div>
              )}
            </div>
          )}
          
          {/* IN PROGRESS TAB */}
          {devTab === 'progress' && (
            <div className="fade-in">
              {/* Stale warning banner */}
              {staleCount > 0 && (
                <div style={{ 
                  padding: '14px 20px', 
                  background: 'rgba(234,179,8,0.15)', 
                  borderRadius: '10px', 
                  marginBottom: '20px',
                  display: 'flex',
                  alignItems: 'center',
                  gap: '12px',
                  border: '1px solid rgba(234,179,8,0.3)'
                }}>
                  <span style={{ fontSize: '20px' }}>‚ö†Ô∏è</span>
                  <div>
                    <div style={{ fontWeight: 600, color: 'var(--medium)' }}>{staleCount} agent{staleCount > 1 ? 's' : ''} may be stalled</div>
                    <div style={{ fontSize: '13px', color: 'var(--text-muted)' }}>No update in over 30 minutes. Consider retrying if the chat errored.</div>
                  </div>
                </div>
              )}
              
              {inProgressItems.length === 0 ? (
                <div className="card" style={{ textAlign: 'center', padding: '60px', color: 'var(--text-muted)' }}>
                  <div style={{ fontSize: '48px', marginBottom: '16px' }}>üöÄ</div>
                  <div style={{ fontSize: '18px', fontWeight: 500 }}>No agents running</div>
                  <div style={{ fontSize: '14px', marginTop: '8px' }}>Go to "Ready to Launch" to start an agent</div>
                </div>
              ) : (
                <div style={{ display: 'grid', gap: '12px' }}>
                  {inProgressItems.map(item => {
                    const stale = isStale(item.started_at);
                    const elapsed = formatElapsed(item.started_at);
                    
                    return (
                      <div 
                        key={item.ticket_id} 
                        className="card" 
                        style={{ 
                          padding: '20px', 
                          borderLeft: stale ? '4px solid var(--medium)' : '4px solid var(--accent)',
                          background: stale ? 'rgba(234,179,8,0.05)' : undefined
                        }}
                      >
                        <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'flex-start' }}>
                          <div style={{ flex: 1 }}>
                            <div style={{ display: 'flex', alignItems: 'center', gap: '12px', flexWrap: 'wrap' }}>
                              <code style={{ fontSize: '13px', padding: '4px 8px', background: 'var(--bg-elevated)', borderRadius: '4px' }}>{item.ticket_id}</code>
                              {stale ? (
                                <Badge type="open">‚ö†Ô∏è Possibly Stalled</Badge>
                              ) : (
                                <Badge type="active">Running</Badge>
                              )}
                              <span style={{ 
                                fontSize: '12px', 
                                color: stale ? 'var(--medium)' : 'var(--text-muted)',
                                fontWeight: stale ? 600 : 400
                              }}>
                                {elapsed}
                              </span>
                            </div>
                            <div style={{ fontSize: '17px', fontWeight: 600, marginTop: '10px' }}>{item.title}</div>
                            <div style={{ fontSize: '13px', color: 'var(--text-muted)', marginTop: '8px' }}>
                              Branch: <code style={{ color: 'var(--accent-bright)', background: 'var(--accent-bg)', padding: '2px 6px', borderRadius: '4px' }}>{item.branch}</code>
                            </div>
                            
                            {stale && (
                              <div style={{ 
                                marginTop: '12px', 
                                padding: '10px 14px', 
                                background: 'rgba(234,179,8,0.1)', 
                                borderRadius: '6px',
                                fontSize: '13px',
                                color: 'var(--text-secondary)'
                              }}>
                                üí° <strong>Tip:</strong> Check if the Cursor chat is still running. If it errored, click Retry to relaunch.
                              </div>
                            )}
                          </div>
                          
                          <div style={{ display: 'flex', flexDirection: 'column', gap: '8px', marginLeft: '16px' }}>
                            <button className="btn btn-success" onClick={() => markCompleted(item.ticket_id)}>
                              ‚úì Complete
                            </button>
                            <button 
                              className="btn btn-secondary" 
                              onClick={() => retryTicket(item.ticket_id)}
                              style={{ fontSize: '13px' }}
                            >
                              ‚ü≥ Retry
                            </button>
                            <button 
                              className="btn" 
                              onClick={() => cancelTicket(item.ticket_id)}
                              style={{ fontSize: '13px', color: 'var(--text-muted)', background: 'transparent', border: '1px solid var(--border)' }}
                            >
                              ‚úó Cancel
                            </button>
                          </div>
                        </div>
                      </div>
                    );
                  })}
                </div>
              )}
              
              {/* Completed items */}
              {completedItems.length > 0 && (
                <div style={{ marginTop: '32px' }}>
                  <div style={{ fontSize: '14px', fontWeight: 600, color: 'var(--success)', marginBottom: '12px' }}>‚úÖ Recently Completed</div>
                  {completedItems.map(item => (
                    <div key={item.ticket_id} className="card" style={{ marginBottom: '12px', borderLeft: '4px solid var(--success)', opacity: 0.8 }}>
                      <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                        <div>
                          <code style={{ fontSize: '12px', color: 'var(--text-muted)' }}>{item.ticket_id}</code>
                          <div style={{ fontSize: '15px', fontWeight: 500, marginTop: '4px' }}>{item.title}</div>
                          <div style={{ fontSize: '12px', color: 'var(--text-muted)', marginTop: '4px' }}>
                            Completed: {new Date(item.completed_at).toLocaleString()}
                          </div>
                        </div>
                        <Badge type="resolved">Done</Badge>
                      </div>
                    </div>
                  ))}
                </div>
              )}
            </div>
          )}
          
          {/* FOR REVIEW TAB */}
          {devTab === 'review' && (
            <div className="fade-in">
              {completedItems.length === 0 ? (
                <div className="card" style={{ textAlign: 'center', padding: '60px', color: 'var(--text-muted)' }}>
                  <div style={{ marginBottom: '16px', color: 'var(--text-muted)' }}><Icons.file /></div>
                  <div style={{ fontSize: '18px', fontWeight: 500 }}>No completed work awaiting review</div>
                  <div style={{ fontSize: '14px', marginTop: '8px' }}>Completed dev agent work will appear here for QA review</div>
                </div>
              ) : (
                <div>
                  <div style={{ 
                    padding: '16px 20px', 
                    background: 'rgba(99,102,241,0.1)', 
                    borderRadius: '12px', 
                    marginBottom: '20px',
                    border: '1px solid rgba(99,102,241,0.2)'
                  }}>
                    <div style={{ fontSize: '16px', fontWeight: 600, color: 'var(--text-primary)' }}>
                      ‚úÖ {completedItems.length} ticket{completedItems.length > 1 ? 's' : ''} ready for review
                    </div>
                    <div style={{ fontSize: '13px', color: 'var(--text-muted)', marginTop: '4px' }}>
                      Review the changes, run QA tests, then mark as done or request fixes
                    </div>
                  </div>
                  
                  <div style={{ display: 'grid', gap: '16px' }}>
                    {completedItems.map(item => {
                      const ticket = tickets.find(t => t.id?.toUpperCase() === item.ticket_id?.toUpperCase());
                      return (
                        <div key={item.ticket_id} className="card" style={{ padding: '20px', borderLeft: '4px solid var(--success)' }}>
                          <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'flex-start' }}>
                            <div style={{ flex: 1 }}>
                              <div style={{ display: 'flex', alignItems: 'center', gap: '10px' }}>
                                <code style={{ fontSize: '12px', padding: '3px 8px', background: 'var(--bg-elevated)', borderRadius: '4px' }}>{item.ticket_id}</code>
                                <Badge type="resolved">Completed</Badge>
                              </div>
                              <div style={{ fontSize: '16px', fontWeight: 600, marginTop: '10px' }}>{item.title}</div>
                              <div style={{ fontSize: '12px', color: 'var(--text-muted)', marginTop: '8px' }}>
                                Branch: <code style={{ color: 'var(--accent-bright)' }}>{item.branch}</code>
                              </div>
                              <div style={{ fontSize: '12px', color: 'var(--text-muted)', marginTop: '4px' }}>
                                Completed: {new Date(item.completed_at).toLocaleString()}
                              </div>
                              
                              {ticket && (
                                <div style={{ marginTop: '12px', padding: '12px', background: 'var(--bg-elevated)', borderRadius: '8px' }}>
                                  <div style={{ fontSize: '11px', color: 'var(--text-muted)', marginBottom: '8px', textTransform: 'uppercase', letterSpacing: '0.5px' }}>Acceptance Criteria to Verify:</div>
                                  <div style={{ display: 'flex', flexDirection: 'column', gap: '4px' }}>
                                    {(ticket.acceptance_criteria || []).map((ac, i) => (
                                      <div key={i} style={{ fontSize: '12px', color: 'var(--text-secondary)' }}>
                                        ‚òê {ac}
                                      </div>
                                    ))}
                                  </div>
                                </div>
                              )}
                            </div>
                            
                            <div style={{ display: 'flex', flexDirection: 'column', gap: '8px', marginLeft: '16px' }}>
                              <button className="btn btn-success" onClick={() => {
                                const newCompleted = completedItems.filter(c => c.ticket_id !== item.ticket_id);
                                onSaveDevStatus({ ...devStatus, completed: newCompleted });
                              }}>
                                ‚úì Approve
                              </button>
                              <button className="btn btn-secondary" style={{ fontSize: '12px' }}>
                                üîÑ Request Fixes
                              </button>
                            </div>
                          </div>
                        </div>
                      );
                    })}
                  </div>
                </div>
              )}
            </div>
          )}
          
        </div>
      );
    }

    // ================= NEW PIPELINE VIEW =================
    // Combines Feature Inventory + All Tickets + In Progress + For Review

    function NewPipelineView({ tickets, devStatus, agentOutputs, onSaveDevStatus, featuresList, findings }) {
      const [pipelineTab, setPipelineTab] = useState('inventory');
      const [selectedTicket, setSelectedTicket] = useState(null);
      const [selectedReviewItem, setSelectedReviewItem] = useState(null);
      const [selectedBlocker, setSelectedBlocker] = useState(null);
      const [filter, setFilter] = useState('all');
      const [selectedFeature, setSelectedFeature] = useState(null);
      
      // Initialize regression status from devStatus (persisted) or empty
      const [regressionStatus, setRegressionStatus] = useState(() => {
        return devStatus?.regression_results || {};
      });
      
      // Sync regression status when devStatus changes (e.g., on reload)
      useEffect(() => {
        if (devStatus?.regression_results) {
          setRegressionStatus(devStatus.regression_results);
        }
      }, [devStatus?.regression_results]);
      
      // Helper to update regression status and persist to devStatus
      const updateRegressionStatus = (ticketId, status) => {
        const newStatus = { ...regressionStatus, [ticketId]: status };
        setRegressionStatus(newStatus);
        // Persist to devStatus
        onSaveDevStatus({ ...devStatus, regression_results: newStatus });
      };
      
      // Parse test-lock completion files to get tested features
      const testedFeatures = useMemo(() => {
        const tested = new Set();
        const testLockOutputs = agentOutputs?.testLock || [];
        testLockOutputs.forEach(output => {
          // Extract feature ID from filename (e.g., "AUTH1-20251205-0054.md" -> "AUTH1")
          const rawId = output.ticketId || output.id || '';
          // Extract just the feature code (AUTH1, B2, P3, etc.) - strip timestamps
          const match = rawId.match(/^([A-Z]+\d*)/i);
          const featureId = match ? match[1].toUpperCase() : rawId.toUpperCase();
          if (featureId) tested.add(featureId);
        });
        return tested;
      }, [agentOutputs]);
      
      // Map feature IDs to feature inventory names (keywords to match)
      const featureIdMapping = {
        'AUTH1': ['signup', 'sign-up', 'registration'],
        'AUTH2': ['login', 'log-in', 'signin', 'sign-in', 'authentication'],
        'B1': ['subscription', 'subscribe', 'payment', 'stripe'],
        'B2': ['seat', 'billing', 'plan-limits', 'plan limits'],
        'P3': ['call', 'lifecycle', 'signaling', 'routing', 'pool']
      };
      
      // Ticket calculations
      const inProgressItems = devStatus?.in_progress || [];
      const completedItems = devStatus?.completed || [];
      // Normalize to uppercase for case-insensitive matching (TKT-004b vs TKT-004B)
      const inProgressTicketIds = new Set(inProgressItems.map(i => i.ticket_id?.toUpperCase()));
      const completedTicketIds = new Set(completedItems.map(c => c.ticket_id?.toUpperCase()));
      
      // Blocked items from agent-output files
      const blockedItems = (agentOutputs?.blocked || []).map(b => {
        // Try to parse JSON content
        try {
          const parsed = JSON.parse(b.content);
          return { ...parsed, fileName: b.fileName, filePath: b.filePath };
        } catch (e) {
          return { ticketId: b.ticketId, fileName: b.fileName, filePath: b.filePath, title: 'Parse error' };
        }
      });
      
      // Ready = status is 'ready' AND not in dev-status completed/in_progress
      const readyTickets = tickets.filter(t => 
        t.status === 'ready' && 
        !completedTicketIds.has(t.id?.toUpperCase()) && 
        !inProgressTicketIds.has(t.id?.toUpperCase())
      );
      
      // Pending tickets = NOT in progress or completed (for All Tickets tab)
      const pendingTickets = tickets.filter(t => 
        !completedTicketIds.has(t.id?.toUpperCase()) && 
        !inProgressTicketIds.has(t.id?.toUpperCase())
      );
      
      // Helper functions
      const getElapsedMinutes = (startedAt) => {
        if (!startedAt) return 0;
        return Math.floor((Date.now() - new Date(startedAt).getTime()) / 60000);
      };
      
      const formatElapsed = (startedAt) => {
        const mins = getElapsedMinutes(startedAt);
        if (mins < 1) return 'Just started';
        if (mins < 60) return `${mins} min ago`;
        const hours = Math.floor(mins / 60);
        const remainingMins = mins % 60;
        if (hours < 24) return `${hours}h ${remainingMins}m ago`;
        const days = Math.floor(hours / 24);
        return `${days}d ${hours % 24}h ago`;
      };
      
      // Auto-requeue threshold: 40 minutes
      const STALE_THRESHOLD_MINS = 40;
      const isStale = (startedAt) => getElapsedMinutes(startedAt) > STALE_THRESHOLD_MINS;
      
      // Filter out stalled agents - they automatically go back to Launch queue
      const activeInProgressItems = inProgressItems.filter(i => !isStale(i.started_at));
      const stalledCount = inProgressItems.length - activeInProgressItems.length;
      
      const markCompleted = (ticketId) => {
        const item = inProgressItems.find(i => i.ticket_id === ticketId);
        if (!item) return;
        const newInProgress = inProgressItems.filter(i => i.ticket_id !== ticketId);
        const newCompleted = [...completedItems, { ...item, completed_at: new Date().toISOString() }];
        onSaveDevStatus({ ...devStatus, in_progress: newInProgress, completed: newCompleted });
      };
      
      const retryTicket = (ticketId) => {
        const item = inProgressItems.find(i => i.ticket_id === ticketId);
        if (!item) return;
        const newInProgress = inProgressItems.filter(i => i.ticket_id !== ticketId);
        const retryHistory = [...(devStatus.retry_history || []), {
          ticket_id: ticketId,
          retried_at: new Date().toISOString(),
          previous_attempt: item
        }];
        onSaveDevStatus({ ...devStatus, in_progress: newInProgress, retry_history: retryHistory });
      };
      
      const cancelTicket = (ticketId) => {
        const newInProgress = inProgressItems.filter(i => i.ticket_id !== ticketId);
        onSaveDevStatus({ ...devStatus, in_progress: newInProgress });
      };

      return (
        <div className="fade-in">
          {/* Summary Row */}
          <div style={{ display: 'grid', gridTemplateColumns: 'repeat(5, 1fr)', gap: '12px', marginBottom: '24px' }}>
            <div 
              className="card" 
              onClick={() => setPipelineTab('inventory')}
              style={{ 
                padding: '16px', 
                cursor: 'pointer', 
                borderLeft: '4px solid var(--accent)',
                background: pipelineTab === 'inventory' ? 'var(--bg-elevated)' : undefined
              }}
            >
              <div style={{ fontSize: '24px', fontWeight: 700, color: 'var(--accent-bright)' }}>
                {FINDINGS_SUMMARY.meta.total_features}
              </div>
              <div style={{ fontSize: '12px', color: 'var(--text-muted)', marginTop: '4px' }}>Features</div>
            </div>
            <div 
              className="card" 
              onClick={() => setPipelineTab('all')}
              style={{ 
                padding: '16px', 
                cursor: 'pointer',
                borderLeft: '4px solid var(--text-muted)',
                background: pipelineTab === 'all' ? 'var(--bg-elevated)' : undefined
              }}
            >
              <div style={{ fontSize: '24px', fontWeight: 700, color: 'var(--text-primary)' }}>
                {pendingTickets.length}
              </div>
              <div style={{ fontSize: '12px', color: 'var(--text-muted)', marginTop: '4px' }}>Pending</div>
            </div>
            <div 
              className="card" 
              onClick={() => setPipelineTab('progress')}
              style={{ 
                padding: '16px', 
                cursor: 'pointer',
                borderLeft: activeInProgressItems.length > 0 ? '4px solid var(--success)' : '4px solid var(--border)',
                background: pipelineTab === 'progress' ? 'var(--bg-elevated)' : undefined
              }}
            >
              <div style={{ display: 'flex', alignItems: 'baseline', gap: '6px' }}>
                <span style={{ fontSize: '24px', fontWeight: 700, color: activeInProgressItems.length > 0 ? 'var(--success)' : 'var(--text-muted)' }}>
                  {activeInProgressItems.length}
                </span>
              </div>
              <div style={{ fontSize: '12px', color: 'var(--text-muted)', marginTop: '4px' }}>In Progress</div>
            </div>
            <div 
              className="card" 
              onClick={() => setPipelineTab('blocked')}
              style={{ 
                padding: '16px', 
                cursor: 'pointer',
                borderLeft: blockedItems.length > 0 ? '4px solid var(--critical)' : '4px solid var(--border)',
                background: pipelineTab === 'blocked' ? 'var(--bg-elevated)' : undefined
              }}
            >
              <div style={{ display: 'flex', alignItems: 'baseline', gap: '6px' }}>
                <span style={{ fontSize: '24px', fontWeight: 700, color: blockedItems.length > 0 ? 'var(--critical)' : 'var(--text-muted)' }}>
                  {blockedItems.length}
                </span>
                {blockedItems.length > 0 && <span style={{ fontSize: '11px' }}>üöß</span>}
              </div>
              <div style={{ fontSize: '12px', color: 'var(--text-muted)', marginTop: '4px' }}>Blocked</div>
            </div>
            <div 
              className="card" 
              onClick={() => setPipelineTab('review')}
              style={{ 
                padding: '16px', 
                cursor: 'pointer',
                borderLeft: completedItems.length > 0 ? '4px solid var(--success)' : '4px solid var(--border)',
                background: pipelineTab === 'review' ? 'var(--bg-elevated)' : undefined
              }}
            >
              <div style={{ fontSize: '24px', fontWeight: 700, color: completedItems.length > 0 ? 'var(--success)' : 'var(--text-muted)' }}>
                {completedItems.length}
              </div>
              <div style={{ fontSize: '12px', color: 'var(--text-muted)', marginTop: '4px' }}>For Review</div>
            </div>
          </div>
          
          {/* Tab Navigation */}
          <div style={{ display: 'flex', gap: '2px', marginBottom: '20px', borderBottom: '1px solid var(--border)', paddingBottom: '0' }}>
            {[
              { id: 'inventory', label: 'Feature Inventory', count: FINDINGS_SUMMARY.meta.total_features, color: 'var(--accent)' },
              { id: 'all', label: 'Pending', count: pendingTickets.length, color: 'var(--text-primary)' },
              { id: 'progress', label: 'In Progress', count: activeInProgressItems.length, color: 'var(--success)' },
              { id: 'blocked', label: 'Blocked', count: blockedItems.length, color: 'var(--critical)' },
              { id: 'review', label: 'For Review', count: completedItems.length, color: 'var(--success)' },
              { id: 'qa', label: 'QA Ready', count: Object.values(regressionStatus).filter(r => r.passed).length, color: '#a78bfa' }
            ].map(tab => (
              <button
                key={tab.id}
                onClick={() => setPipelineTab(tab.id)}
                style={{
                  padding: '10px 14px',
                  background: 'transparent',
                  border: 'none',
                  borderBottom: pipelineTab === tab.id ? `3px solid ${tab.color}` : '3px solid transparent',
                  color: pipelineTab === tab.id ? 'var(--text-primary)' : 'var(--text-muted)',
                  fontSize: '13px',
                  fontWeight: pipelineTab === tab.id ? 600 : 400,
                  cursor: 'pointer',
                  display: 'flex',
                  alignItems: 'center',
                  gap: '6px',
                  marginBottom: '-1px',
                  whiteSpace: 'nowrap'
                }}
              >
                {tab.label}
                {tab.count > 0 && (
                  <span style={{ 
                    padding: '2px 6px', 
                    background: pipelineTab === tab.id ? tab.color : 'var(--bg-elevated)', 
                    color: pipelineTab === tab.id ? 'white' : 'var(--text-muted)', 
                    borderRadius: '10px', 
                    fontSize: '10px', 
                    fontWeight: 600 
                  }}>
                    {tab.stale ? `‚ö†Ô∏è ${tab.count}` : tab.count}
                  </span>
                )}
              </button>
            ))}
          </div>
          
          {/* FEATURE INVENTORY TAB */}
          {pipelineTab === 'inventory' && (
            <div className="fade-in">
              {/* Group features by category */}
              {(() => {
                const byCategory = {};
                featuresList.forEach(f => {
                  if (!byCategory[f.category]) byCategory[f.category] = [];
                  byCategory[f.category].push(f);
                });
                
                // Calculate review status per feature from findings
                // "Reviewed" means review agent ran on this feature (findings exist)
                // "Triaged" shows how many findings have been processed
                const normalize = (str) => (str || '').toLowerCase().replace(/[-\s]/g, '');
                
                const getFeatureReviewStatus = (feature) => {
                  const normalizedName = normalize(feature.name);
                  const fileName = feature.fileName?.replace('.md', '') || '';
                  const normalizedFileName = normalize(fileName);
                  
                  const featureFindings = findings.filter(finding => {
                    const normalizedFeature = normalize(finding.feature);
                    const normalizedCategory = normalize(finding.category);
                    
                    // Match by normalized feature name
                    if (normalizedFeature.includes(normalizedName) || normalizedName.includes(normalizedFeature)) return true;
                    if (normalizedFeature.includes(normalizedFileName) || normalizedFileName.includes(normalizedFeature)) return true;
                    
                    // Match by category (e.g., "A-cobrowse-viewer" matches "cobrowse-viewer.md")
                    if (normalizedCategory.includes(normalizedFileName) || normalizedFileName.includes(normalizedCategory)) return true;
                    
                    return false;
                  });
                  const triaged = featureFindings.filter(f => f.status === 'ticketed' || f.status === 'skipped').length;
                  const total = featureFindings.length;
                  const reviewed = total > 0; // If findings exist, it was reviewed
                  return { triaged, total, reviewed };
                };
                
                // Check if feature has test coverage
                const getFeatureTestStatus = (feature) => {
                  const normalizedName = normalize(feature.name);
                  const fileName = feature.fileName?.replace('.md', '') || '';
                  const normalizedFileName = normalize(fileName);
                  const category = normalize(feature.category || '');
                  
                  // Check against test-lock outputs
                  for (const [featureId, keywords] of Object.entries(featureIdMapping)) {
                    if (testedFeatures.has(featureId)) {
                      for (const keyword of keywords) {
                        const normalizedKeyword = normalize(keyword);
                        if (normalizedFileName.includes(normalizedKeyword) || 
                            normalizedName.includes(normalizedKeyword) ||
                            category.includes(normalizedKeyword)) {
                          return true;
                        }
                      }
                    }
                  }
                  return false;
                };
                
                const categoryLabels = {
                  admin: 'Admin',
                  agent: 'Agent',
                  api: 'API',
                  auth: 'Auth',
                  billing: 'Billing',
                  feedback: 'Feedback',
                  monitoring: 'Monitoring',
                  platform: 'Platform',
                  stats: 'Stats',
                  superadmin: 'Super Admin',
                  visitor: 'Visitor',
                  general: 'General'
                };
                
                return Object.entries(byCategory).sort((a, b) => a[0].localeCompare(b[0])).map(([category, categoryFeatures]) => (
                  <div key={category} style={{ marginBottom: '24px' }}>
                    <div style={{ 
                      fontSize: '14px', 
                      fontWeight: 600, 
                      color: 'var(--text-muted)', 
                      marginBottom: '12px',
                      textTransform: 'uppercase',
                      letterSpacing: '0.5px'
                    }}>
                      {categoryLabels[category] || category}
                    </div>
                    <div style={{ display: 'grid', gap: '8px' }}>
                      {categoryFeatures.map(feature => {
                        const reviewStatus = getFeatureReviewStatus(feature);
                        const isTested = getFeatureTestStatus(feature);
                        return (
                          <div 
                            key={feature.docPath} 
                            className="card" 
                            style={{ 
                              padding: '14px 18px', 
                              cursor: 'pointer',
                              transition: 'all 0.15s ease',
                              borderLeft: '3px solid var(--accent)'
                            }}
                            onClick={() => setSelectedFeature(feature)}
                            onMouseOver={e => e.currentTarget.style.background = 'var(--bg-hover)'}
                            onMouseOut={e => e.currentTarget.style.background = ''}
                          >
                            <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                              <div style={{ display: 'flex', alignItems: 'center', gap: '12px' }}>
                                <span style={{ fontSize: '15px', fontWeight: 500 }}>{feature.name}</span>
                                <code style={{ 
                                  fontSize: '10px', 
                                  padding: '2px 6px', 
                                  background: 'var(--bg-elevated)', 
                                  borderRadius: '4px',
                                  color: 'var(--text-muted)'
                                }}>
                                  {feature.fileName}
                                </code>
                              </div>
                              <div style={{ display: 'flex', gap: '8px', alignItems: 'center' }}>
                                {/* Documented badge - always green since file exists */}
                                <span style={{ 
                                  padding: '4px 10px', 
                                  borderRadius: '6px', 
                                  fontSize: '11px', 
                                  fontWeight: 600,
                                  background: 'rgba(16,185,129,0.15)', 
                                  color: 'var(--success)'
                                }}>
                                  Documented
                                </span>
                                {/* Reviewed badge - green if review agent ran (findings exist) */}
                                <span style={{ 
                                  padding: '4px 10px', 
                                  borderRadius: '6px', 
                                  fontSize: '11px', 
                                  fontWeight: 600,
                                  background: reviewStatus.reviewed ? 'rgba(16,185,129,0.15)' : 'rgba(99,102,241,0.15)', 
                                  color: reviewStatus.reviewed ? 'var(--success)' : 'var(--accent)'
                                }}>
                                  {reviewStatus.reviewed ? 'Reviewed' : 'Pending'}
                                </span>
                                {/* Tested badge - green if TEST LOCK agent has run */}
                                <span style={{ 
                                  padding: '4px 10px', 
                                  borderRadius: '6px', 
                                  fontSize: '11px', 
                                  fontWeight: 600,
                                  background: isTested ? 'rgba(139,92,246,0.15)' : 'rgba(100,116,139,0.15)', 
                                  color: isTested ? '#a78bfa' : 'var(--text-muted)'
                                }}>
                                  {isTested ? 'üß™ Tested' : 'No Tests'}
                                </span>
                                {/* Findings count if any */}
                                {reviewStatus.total > 0 && (
                                  <span style={{ 
                                    padding: '4px 10px', 
                                    borderRadius: '6px', 
                                    fontSize: '11px', 
                                    fontWeight: 600,
                                    background: 'var(--bg-elevated)', 
                                    color: 'var(--text-muted)'
                                  }}>
                                    {reviewStatus.triaged}/{reviewStatus.total} triaged
                                  </span>
                                )}
                                <span style={{ color: 'var(--text-muted)', fontSize: '12px' }}>‚Üí</span>
                              </div>
                            </div>
                          </div>
                        );
                      })}
                    </div>
                  </div>
                ));
              })()}
              
              {/* Feature Doc Modal */}
              {selectedFeature && (
                <div className="modal-overlay" onClick={() => setSelectedFeature(null)}>
                  <div className="modal fade-in" onClick={e => e.stopPropagation()} style={{ maxWidth: '800px' }}>
                    <div className="modal-header">
                      <div>
                        <code style={{ color: 'var(--text-muted)', fontSize: '12px' }}>{selectedFeature.docPath}</code>
                        <h2 style={{ fontSize: '18px', fontWeight: 600, marginTop: '4px' }}>{selectedFeature.name}</h2>
                      </div>
                      <button className="btn btn-sm btn-secondary" onClick={() => setSelectedFeature(null)}>√ó</button>
                    </div>
                    <div className="modal-body">
                      <div style={{ 
                        padding: '20px', 
                        background: 'var(--bg-elevated)', 
                        borderRadius: '8px',
                        marginBottom: '16px'
                      }}>
                        <div style={{ fontSize: '13px', color: 'var(--text-muted)', marginBottom: '12px' }}>
                          To view this documentation, open the file in your editor:
                        </div>
                        <code style={{ 
                          display: 'block',
                          padding: '12px 16px', 
                          background: 'var(--bg-surface)', 
                          borderRadius: '6px',
                          fontSize: '13px',
                          color: 'var(--accent-bright)',
                          fontFamily: 'monospace'
                        }}>
                          {selectedFeature.docPath}
                        </code>
                      </div>
                      
                      <div style={{ display: 'flex', gap: '12px' }}>
                        <button 
                          className="btn btn-primary"
                          onClick={() => {
                            navigator.clipboard.writeText(selectedFeature.docPath);
                          }}
                        >
                          Copy Path
                        </button>
                        <button 
                          className="btn btn-secondary"
                          onClick={() => {
                            navigator.clipboard.writeText(`code ${selectedFeature.docPath}`);
                          }}
                        >
                          üìù Copy VS Code Command
                        </button>
                      </div>
                      
                      {/* Show related findings */}
                      {(() => {
                        const relatedFindings = findings.filter(f => 
                          f.feature?.toLowerCase().includes(selectedFeature.name.toLowerCase()) ||
                          selectedFeature.name.toLowerCase().includes(f.feature?.toLowerCase().split(' ')[0] || '')
                        ).slice(0, 5);
                        
                        if (relatedFindings.length === 0) return null;
                        
                        return (
                          <div style={{ marginTop: '24px' }}>
                            <div style={{ fontSize: '14px', fontWeight: 600, marginBottom: '12px' }}>
                              Related Findings ({relatedFindings.length})
                            </div>
                            <div style={{ display: 'grid', gap: '8px' }}>
                              {relatedFindings.map(f => (
                                <div key={f.id} style={{ 
                                  padding: '10px 14px', 
                                  background: 'var(--bg-elevated)', 
                                  borderRadius: '6px',
                                  borderLeft: `3px solid ${f.severity === 'critical' ? 'var(--critical)' : f.severity === 'high' ? 'var(--high)' : f.severity === 'medium' ? 'var(--medium)' : 'var(--low)'}`
                                }}>
                                  <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                                    <div style={{ fontSize: '13px', fontWeight: 500 }}>{f.title}</div>
                                    <Badge type={f.status === 'ticketed' ? 'resolved' : f.severity}>{f.status === 'ticketed' ? 'Ticketed' : f.severity}</Badge>
                                  </div>
                                </div>
                              ))}
                            </div>
                          </div>
                        );
                      })()}
                    </div>
                  </div>
                </div>
              )}
            </div>
          )}
          
          {/* PENDING TICKETS TAB */}
          {pipelineTab === 'all' && (
            <div className="fade-in">
              {/* Priority Filter Tabs */}
              <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '20px' }}>
                <div className="tabs">
                  <button className={`tab ${filter === 'all' ? 'active' : ''}`} onClick={() => setFilter('all')}>
                    All <span className="count">{pendingTickets.length}</span>
                  </button>
                  <button className={`tab ${filter === 'critical' ? 'active' : ''}`} onClick={() => setFilter('critical')}>
                    <StatusDot color="var(--critical)" /> Critical <span className="count">{pendingTickets.filter(t => t.priority === 'critical').length}</span>
                  </button>
                  <button className={`tab ${filter === 'high' ? 'active' : ''}`} onClick={() => setFilter('high')}>
                    <StatusDot color="var(--high)" /> High <span className="count">{pendingTickets.filter(t => t.priority === 'high').length}</span>
                  </button>
                  <button className={`tab ${filter === 'medium' ? 'active' : ''}`} onClick={() => setFilter('medium')}>
                    <StatusDot color="var(--medium)" /> Medium <span className="count">{pendingTickets.filter(t => t.priority === 'medium').length}</span>
                  </button>
                  <button className={`tab ${filter === 'low' ? 'active' : ''}`} onClick={() => setFilter('low')}>
                    <StatusDot color="var(--low)" /> Low <span className="count">{pendingTickets.filter(t => t.priority === 'low').length}</span>
                  </button>
                </div>
              </div>
              
              {/* Ticket Grid */}
              <div className="ticket-grid">
                {(filter === 'all' ? pendingTickets : pendingTickets.filter(t => t.priority === filter)).map(ticket => (
                  <TicketCard key={ticket.id} ticket={ticket} onClick={() => setSelectedTicket(ticket)} />
                ))}
              </div>
              
              {/* Ticket Modal */}
              {selectedTicket && <TicketModal ticket={selectedTicket} onClose={() => setSelectedTicket(null)} />}
            </div>
          )}
          
          {/* IN PROGRESS TAB */}
          {pipelineTab === 'progress' && (
            <div className="fade-in">
              {activeInProgressItems.length === 0 ? (
                <div className="card" style={{ textAlign: 'center', padding: '60px', color: 'var(--text-muted)' }}>
                  <div style={{ fontSize: '48px', marginBottom: '16px' }}>üöÄ</div>
                  <div style={{ fontSize: '18px', fontWeight: 500 }}>No agents running</div>
                  <div style={{ fontSize: '14px', marginTop: '8px' }}>Go to Launch tab to start agents</div>
                  {stalledCount > 0 && (
                    <div style={{ fontSize: '13px', marginTop: '16px', color: 'var(--text-muted)' }}>
                      {stalledCount} stalled agent{stalledCount > 1 ? 's' : ''} auto-requeued to Launch
                    </div>
                  )}
                </div>
              ) : (
                <div style={{ display: 'grid', gap: '12px' }}>
                  {activeInProgressItems.map(item => {
                    const mins = getElapsedMinutes(item.started_at);
                    const elapsed = formatElapsed(item.started_at);
                    
                    return (
                      <div 
                        key={item.ticket_id} 
                        className="card" 
                        style={{ 
                          padding: '20px', 
                          borderLeft: '4px solid var(--success)'
                        }}
                      >
                        <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'flex-start' }}>
                          <div style={{ flex: 1 }}>
                            <div style={{ display: 'flex', alignItems: 'center', gap: '12px', flexWrap: 'wrap' }}>
                              <code style={{ fontSize: '13px', padding: '4px 8px', background: 'var(--bg-elevated)', borderRadius: '4px' }}>{item.ticket_id}</code>
                              <Badge type="active">Running</Badge>
                              <span style={{ fontSize: '12px', color: 'var(--text-muted)' }}>
                                {mins < 1 ? 'Just started' : `Running ${mins} min`}
                              </span>
                            </div>
                            <div style={{ fontSize: '17px', fontWeight: 600, marginTop: '10px' }}>{item.title}</div>
                            <div style={{ fontSize: '13px', color: 'var(--text-muted)', marginTop: '8px' }}>
                              Branch: <code style={{ color: 'var(--accent-bright)', background: 'var(--accent-bg)', padding: '2px 6px', borderRadius: '4px' }}>{item.branch}</code>
                            </div>
                          </div>
                        </div>
                      </div>
                    );
                  })}
                </div>
              )}
            </div>
          )}
          
          {/* BLOCKED TAB */}
          {pipelineTab === 'blocked' && (
            <div className="fade-in">
              {blockedItems.length === 0 ? (
                <div className="card" style={{ textAlign: 'center', padding: '60px', color: 'var(--text-muted)' }}>
                  <div style={{ fontSize: '48px', marginBottom: '16px' }}>‚úì</div>
                  <div style={{ fontSize: '18px', fontWeight: 500 }}>No blocked agents</div>
                  <div style={{ fontSize: '14px', marginTop: '8px' }}>Agents needing PM decisions will appear here</div>
                </div>
              ) : (
                <div>
                  <div style={{ 
                    padding: '16px 20px', 
                    background: 'rgba(239,68,68,0.1)', 
                    borderRadius: '12px', 
                    marginBottom: '20px',
                    border: '1px solid rgba(239,68,68,0.2)'
                  }}>
                    <div style={{ fontSize: '16px', fontWeight: 600, color: 'var(--critical)' }}>
                      üöß {blockedItems.length} agent{blockedItems.length > 1 ? 's' : ''} blocked - awaiting your decision
                    </div>
                    <div style={{ fontSize: '13px', color: 'var(--text-muted)', marginTop: '6px' }}>
                      Review each blocker and provide a decision to unblock the agent
                    </div>
                  </div>
                  
                  <div style={{ display: 'grid', gap: '16px' }}>
                    {blockedItems.map((blocked, idx) => (
                      <div 
                        key={blocked.id || idx} 
                        className="card" 
                        style={{ 
                          borderLeft: '4px solid var(--critical)',
                          cursor: 'pointer'
                        }}
                        onClick={() => setSelectedBlocker(blocked)}
                      >
                        <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'flex-start', marginBottom: '12px' }}>
                          <div>
                            <code style={{ fontSize: '12px', color: 'var(--text-muted)' }}>
                              {blocked.blocker_context?.ticket_id || blocked.ticketId || blocked.id}
                            </code>
                            <h3 style={{ fontSize: '16px', fontWeight: 600, marginTop: '4px' }}>
                              {blocked.title || 'Blocked'}
                            </h3>
                            {blocked.blocker_context?.branch && (
                              <div style={{ fontSize: '12px', color: 'var(--text-muted)', marginTop: '4px' }}>
                                Branch: <code style={{ color: 'var(--accent-bright)' }}>{blocked.blocker_context.branch}</code>
                              </div>
                            )}
                          </div>
                          <Badge type={blocked.type === 'environmental' ? 'medium' : 'critical'}>
                            {blocked.type === 'environmental' ? 'ENV' : 'BLOCKER'}
                          </Badge>
                        </div>
                        
                        <div style={{ padding: '12px', background: 'var(--bg-elevated)', borderRadius: '8px', marginBottom: '12px' }}>
                          <div style={{ fontSize: '12px', color: 'var(--text-muted)', marginBottom: '6px', textTransform: 'uppercase', letterSpacing: '0.5px' }}>
                            {blocked.category === 'clarification' ? 'Question:' : 'Issue:'}
                          </div>
                          <div style={{ fontSize: '14px', fontWeight: 500, lineHeight: '1.5' }}>
                            {blocked.issue || blocked.question || 'No details provided'}
                          </div>
                        </div>
                        
                        {blocked.options && blocked.options.length > 0 && (
                          <div style={{ fontSize: '12px', color: 'var(--text-muted)' }}>
                            {blocked.options.length} option{blocked.options.length > 1 ? 's' : ''} to choose from
                          </div>
                        )}
                        
                        <div style={{ fontSize: '11px', color: 'var(--text-muted)', marginTop: '8px' }}>
                          Found: {blocked.found_at ? new Date(blocked.found_at).toLocaleString() : 'Unknown'}
                        </div>
                      </div>
                    ))}
                  </div>
                  
                  {/* Blocker Modal */}
                  {selectedBlocker && (
                    <div className="modal-overlay" onClick={() => setSelectedBlocker(null)}>
                      <div className="modal fade-in" onClick={e => e.stopPropagation()} style={{ maxWidth: '700px' }}>
                        <div className="modal-header">
                          <div>
                            <code style={{ color: 'var(--critical)', fontSize: '12px' }}>
                              {selectedBlocker.blocker_context?.ticket_id || selectedBlocker.ticketId || selectedBlocker.id}
                            </code>
                            <h2 style={{ fontSize: '18px', fontWeight: 600, marginTop: '4px' }}>{selectedBlocker.title}</h2>
                          </div>
                          <button className="btn btn-sm btn-secondary" onClick={() => setSelectedBlocker(null)}>√ó</button>
                        </div>
                        <div className="modal-body">
                          {/* Issue Description */}
                          <div style={{ padding: '16px', background: 'var(--bg-elevated)', borderRadius: '8px', marginBottom: '20px' }}>
                            <div style={{ fontSize: '12px', color: 'var(--text-muted)', marginBottom: '8px', textTransform: 'uppercase', letterSpacing: '0.5px' }}>
                              {selectedBlocker.category === 'clarification' ? 'Question:' : 'Issue:'}
                            </div>
                            <div style={{ fontSize: '15px', lineHeight: '1.6' }}>
                              {selectedBlocker.issue || selectedBlocker.question}
                            </div>
                          </div>
                          
                          {/* Options */}
                          {selectedBlocker.options && selectedBlocker.options.length > 0 && (
                            <div style={{ marginBottom: '20px' }}>
                              <div style={{ fontSize: '14px', fontWeight: 600, marginBottom: '12px' }}>Options:</div>
                              <div style={{ display: 'grid', gap: '8px' }}>
                                {selectedBlocker.options.map((opt, idx) => (
                                  <div 
                                    key={opt.id || idx}
                                    style={{ 
                                      padding: '12px 16px', 
                                      background: opt.recommended ? 'rgba(99,102,241,0.1)' : 'var(--bg-elevated)', 
                                      borderRadius: '8px',
                                      border: opt.recommended ? '1px solid var(--accent)' : '1px solid var(--border)',
                                      position: 'relative'
                                    }}
                                  >
                                    {opt.recommended && (
                                      <span style={{ 
                                        position: 'absolute', 
                                        top: '-8px', 
                                        right: '12px', 
                                        background: 'var(--accent)', 
                                        color: 'white', 
                                        padding: '2px 8px', 
                                        fontSize: '10px', 
                                        borderRadius: '4px',
                                        fontWeight: 600
                                      }}>
                                        RECOMMENDED
                                      </span>
                                    )}
                                    <div style={{ display: 'flex', alignItems: 'flex-start', gap: '12px' }}>
                                      <span style={{ 
                                        display: 'inline-flex', 
                                        alignItems: 'center', 
                                        justifyContent: 'center',
                                        width: '24px', 
                                        height: '24px', 
                                        background: 'var(--bg-surface)', 
                                        borderRadius: '50%',
                                        fontSize: '12px',
                                        fontWeight: 600,
                                        flexShrink: 0
                                      }}>
                                        {opt.id || idx + 1}
                                      </span>
                                      <div style={{ fontSize: '14px' }}>{opt.label}</div>
                                    </div>
                                  </div>
                                ))}
                              </div>
                            </div>
                          )}
                          
                          {/* Agent's Recommendation */}
                          {selectedBlocker.recommendation && (
                            <div style={{ 
                              padding: '12px 16px', 
                              background: 'rgba(99,102,241,0.08)', 
                              borderRadius: '8px', 
                              marginBottom: '20px',
                              borderLeft: '3px solid var(--accent)'
                            }}>
                              <div style={{ fontSize: '12px', color: 'var(--accent)', fontWeight: 600, marginBottom: '4px' }}>
                                Agent's Recommendation:
                              </div>
                              <div style={{ fontSize: '14px' }}>{selectedBlocker.recommendation}</div>
                            </div>
                          )}
                          
                          {/* Progress Context */}
                          {selectedBlocker.blocker_context?.progress && (
                            <div style={{ marginBottom: '20px' }}>
                              <div style={{ fontSize: '14px', fontWeight: 600, marginBottom: '12px' }}>Progress Before Block:</div>
                              <div style={{ display: 'grid', gap: '8px' }}>
                                {selectedBlocker.blocker_context.progress.done?.length > 0 && (
                                  <div>
                                    <div style={{ fontSize: '12px', color: 'var(--success)', marginBottom: '4px' }}>‚úì Completed:</div>
                                    <ul style={{ margin: 0, paddingLeft: '20px', fontSize: '13px', color: 'var(--text-secondary)' }}>
                                      {selectedBlocker.blocker_context.progress.done.map((item, i) => (
                                        <li key={i}>{item}</li>
                                      ))}
                                    </ul>
                                  </div>
                                )}
                                {selectedBlocker.blocker_context.progress.remaining?.length > 0 && (
                                  <div>
                                    <div style={{ fontSize: '12px', color: 'var(--critical)', marginBottom: '4px' }}>‚è∏ Remaining:</div>
                                    <ul style={{ margin: 0, paddingLeft: '20px', fontSize: '13px', color: 'var(--text-secondary)' }}>
                                      {selectedBlocker.blocker_context.progress.remaining.map((item, i) => (
                                        <li key={i}>{item}</li>
                                      ))}
                                    </ul>
                                  </div>
                                )}
                              </div>
                            </div>
                          )}
                          
                          {/* File Path */}
                          <div style={{ 
                            padding: '12px', 
                            background: 'var(--bg-surface)', 
                            borderRadius: '6px',
                            marginBottom: '20px',
                            fontSize: '12px'
                          }}>
                            <span style={{ color: 'var(--text-muted)' }}>Blocker file: </span>
                            <code style={{ color: 'var(--accent-bright)' }}>{selectedBlocker.filePath}</code>
                          </div>
                          
                          {/* Actions */}
                          <div style={{ 
                            padding: '16px', 
                            background: 'var(--bg-elevated)', 
                            borderRadius: '8px',
                            border: '1px dashed var(--border)'
                          }}>
                            <div style={{ fontSize: '14px', fontWeight: 600, marginBottom: '12px' }}>To Resolve:</div>
                            <ol style={{ margin: 0, paddingLeft: '20px', fontSize: '13px', color: 'var(--text-secondary)', lineHeight: '1.8' }}>
                              <li>Review the options above and make a decision</li>
                              <li>Edit the blocker file to add your decision</li>
                              <li>Create a continuation ticket for the agent</li>
                              <li>Archive the blocker file to <code>docs/agent-output/archive/</code></li>
                            </ol>
                          </div>
                        </div>
                      </div>
                    </div>
                  )}
                </div>
              )}
            </div>
          )}
          
          {/* FOR REVIEW TAB */}
          {pipelineTab === 'review' && (
            <div className="fade-in">
              {completedItems.length === 0 ? (
                <div className="card" style={{ textAlign: 'center', padding: '60px', color: 'var(--text-muted)' }}>
                  <div style={{ marginBottom: '16px', color: 'var(--text-muted)' }}><Icons.file /></div>
                  <div style={{ fontSize: '18px', fontWeight: 500 }}>No completed work awaiting review</div>
                  <div style={{ fontSize: '14px', marginTop: '8px' }}>Completed dev agent work will appear here for QA review</div>
                </div>
              ) : (
                <div>
                  <div style={{ 
                    padding: '16px 20px', 
                    background: 'rgba(16,185,129,0.1)', 
                    borderRadius: '12px', 
                    marginBottom: '20px',
                    border: '1px solid rgba(16,185,129,0.2)'
                  }}>
                    <div style={{ fontSize: '16px', fontWeight: 600, color: 'var(--text-primary)' }}>
                      ‚úÖ {completedItems.length} ticket{completedItems.length > 1 ? 's' : ''} ready for review
                    </div>
                    <div style={{ fontSize: '13px', color: 'var(--text-muted)', marginTop: '4px' }}>
                      Review the changes, run QA tests, then mark as done or request fixes
                    </div>
                  </div>
                  
                  <div className="ticket-grid">
                    {completedItems.map(item => {
                      const ticket = tickets.find(t => t.id?.toUpperCase() === item.ticket_id?.toUpperCase());
                      const regStatus = regressionStatus[item.ticket_id];
                      return (
                        <div 
                          key={item.ticket_id} 
                          className={`ticket-card priority-${ticket?.priority || 'medium'}`}
                          style={{ borderLeftColor: regStatus?.passed ? '#a78bfa' : 'var(--success)', cursor: 'pointer' }}
                        >
                          <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: '8px' }}>
                            <code style={{ fontSize: '12px', color: 'var(--text-muted)' }}>{item.ticket_id}</code>
                            <div style={{ display: 'flex', gap: '6px' }}>
                              {regStatus?.passed && <Badge type="qa">‚úÖ QA Ready</Badge>}
                              {regStatus?.expectedFailures && <Badge type="qa">‚úÖ QA Ready</Badge>}
                              {regStatus && !regStatus.passed && !regStatus.expectedFailures && regStatus.failedCount > 0 && (
                                <Badge type="high">‚ö†Ô∏è {regStatus.failedCount} unexpected</Badge>
                              )}
                              <Badge type="resolved">Completed</Badge>
                              {ticket && <Badge type={ticket.priority}>{ticket.priority}</Badge>}
                            </div>
                          </div>
                          <div 
                            onClick={() => setSelectedReviewItem({ item, ticket })}
                            style={{ cursor: 'pointer' }}
                          >
                            <div style={{ fontSize: '14px', fontWeight: 600, marginBottom: '8px' }}>{ticket?.title || item.title || 'Unknown Ticket'}</div>
                            <div style={{ fontSize: '12px', color: 'var(--text-muted)', marginBottom: '6px' }}>{ticket?.feature || ''}</div>
                            <div style={{ display: 'flex', gap: '12px', fontSize: '11px', color: 'var(--text-muted)' }}>
                              <span>{(ticket?.files_to_modify || []).length} files</span>
                              <span>‚Ä¢</span>
                              <span>{(ticket?.acceptance_criteria || []).length} criteria</span>
                            </div>
                          </div>
                          <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginTop: '12px', paddingTop: '12px', borderTop: '1px solid var(--border)' }}>
                            <div style={{ fontSize: '11px', color: 'var(--success)' }}>
                              Completed: {new Date(item.completed_at).toLocaleString()}
                            </div>
                            <div style={{ display: 'flex', gap: '6px' }}>
                              <button
                                className={`btn btn-sm ${regStatus?.running ? 'btn-warning' : (regStatus?.passed || regStatus?.expectedFailures) ? 'btn-success' : regStatus?.failedCount ? 'btn-danger' : 'btn-secondary'}`}
                                disabled={regStatus?.running}
                                onClick={async (e) => {
                                  e.stopPropagation();
                                  setRegressionStatus(prev => ({ ...prev, [item.ticket_id]: { running: true } }));
                                  try {
                                    const response = await fetch('/api/run-regression', {
                                      method: 'POST',
                                      headers: { 'Content-Type': 'application/json' },
                                      body: JSON.stringify({ ticketId: item.ticket_id, branch: item.branch })
                                    });
                                    const result = await response.json();
                                    
                                    // Auto-determine if failures are expected based on files_to_modify
                                    const ticketFiles = (ticket?.files_to_modify || []).map(f => f.toLowerCase());
                                    const failedFiles = (result.failedFiles || []).map(f => f.toLowerCase());
                                    
                                    // Check if ALL failed files are in the ticket's files_to_modify
                                    const allFailuresExpected = failedFiles.length > 0 && failedFiles.every(failedFile => 
                                      ticketFiles.some(ticketFile => 
                                        failedFile.includes(ticketFile.replace(/^.*\//, '').replace('.ts', '').replace('.tsx', '')) ||
                                        ticketFile.includes(failedFile.replace(/^.*\//, '').replace('.test.ts', '').replace('.test.tsx', ''))
                                      )
                                    );
                                    
                                    // Find unexpected failures (regressions)
                                    const unexpectedFiles = failedFiles.filter(failedFile => 
                                      !ticketFiles.some(ticketFile => 
                                        failedFile.includes(ticketFile.replace(/^.*\//, '').replace('.ts', '').replace('.tsx', '')) ||
                                        ticketFile.includes(failedFile.replace(/^.*\//, '').replace('.test.ts', '').replace('.test.tsx', ''))
                                      )
                                    );
                                    
                                    const status = { 
                                      running: false, 
                                      passed: result.passed, 
                                      passedCount: result.passedCount,
                                      failedCount: result.failedCount,
                                      failedFiles: result.failedFiles || [],
                                      output: result.output,
                                      testedAt: new Date().toISOString(),
                                      expectedFailures: result.failedCount > 0 && allFailuresExpected,
                                      unexpectedFiles: unexpectedFiles
                                    };
                                    
                                    updateRegressionStatus(item.ticket_id, status);
                                    
                                    // If there are unexpected failures, create a CI blocker for PM
                                    if (unexpectedFiles.length > 0) {
                                      // Create CI blocker file so PM workflow picks it up
                                      fetch('/api/create-ci-blocker', {
                                        method: 'POST',
                                        headers: { 'Content-Type': 'application/json' },
                                        body: JSON.stringify({
                                          ticketId: item.ticket_id,
                                          branch: item.branch,
                                          failedTests: unexpectedFiles,
                                          failedCount: unexpectedFiles.length,
                                          output: result.output?.substring(0, 3000) || '',
                                          attempt: 1
                                        })
                                      })
                                      .then(res => res.json())
                                      .then(data => {
                                        if (data.success) {
                                          console.log(`‚úÖ Created CI blocker for ${item.ticket_id}: ${data.file}`);
                                        }
                                      })
                                      .catch(err => console.error('Failed to create CI blocker:', err));
                                    }
                                  } catch (err) {
                                    updateRegressionStatus(item.ticket_id, { running: false, error: err.message });
                                  }
                                }}
                                style={{ fontSize: '11px', padding: '4px 10px' }}
                              >
                                {regStatus?.running ? 'üß™ Testing...' : 
                                 regStatus?.passed ? '‚úÖ Passed' : 
                                 regStatus?.expectedFailures ? `‚úÖ ${regStatus.failedCount} Expected` :
                                 regStatus?.failedCount ? `‚ùå ${regStatus.failedCount} Regression` : 
                                 'üß™ Run Tests'}
                              </button>
                            </div>
                          </div>
                        </div>
                      );
                    })}
                  </div>
                  
                  {/* Review Modal */}
                  {selectedReviewItem && (
                    <ReviewModal 
                      item={selectedReviewItem.item} 
                      ticket={selectedReviewItem.ticket} 
                      onClose={() => setSelectedReviewItem(null)}
                      onApprove={(ticketId) => {
                        const newCompleted = completedItems.filter(c => c.ticket_id !== ticketId);
                        onSaveDevStatus({ ...devStatus, completed: newCompleted });
                      }}
                      onRequestFixes={(ticketId) => {
                        // TODO: Create fix ticket flow
                        console.log('Request fixes for', ticketId);
                      }}
                    />
                  )}
                </div>
              )}
            </div>
          )}
          
          {/* QA READY TAB */}
          {pipelineTab === 'qa' && (
            <div className="fade-in">
              {(() => {
                // QA Ready = passed OR only has expected failures (in files_to_modify)
                const qaReadyItems = completedItems.filter(item => {
                  const regStatus = regressionStatus[item.ticket_id];
                  if (!regStatus) return false;
                  if (regStatus.passed) return true;
                  // Check if failures are "expected" (in files the ticket was supposed to modify)
                  if (regStatus.failedCount > 0 && regStatus.expectedFailures) return true;
                  return false;
                });
                
                if (qaReadyItems.length === 0) {
                  return (
                    <div className="card" style={{ textAlign: 'center', padding: '60px', color: 'var(--text-muted)' }}>
                      <div style={{ marginBottom: '16px', fontSize: '48px' }}>üß™</div>
                      <div style={{ fontSize: '18px', fontWeight: 500 }}>No tickets have passed regression testing yet</div>
                      <div style={{ fontSize: '14px', marginTop: '8px' }}>
                        Go to "For Review" tab and run regression tests on completed tickets
                      </div>
                    </div>
                  );
                }
                
                return (
                  <div>
                    <div style={{ 
                      padding: '16px 20px', 
                      background: 'rgba(167,139,250,0.1)', 
                      borderRadius: '12px', 
                      marginBottom: '20px',
                      border: '1px solid rgba(167,139,250,0.2)'
                    }}>
                      <div style={{ fontSize: '16px', fontWeight: 600, color: 'var(--text-primary)' }}>
                        üß™ {qaReadyItems.length} ticket{qaReadyItems.length > 1 ? 's' : ''} passed regression testing
                      </div>
                      <div style={{ fontSize: '13px', color: 'var(--text-muted)', marginTop: '4px' }}>
                        These tickets are ready for human QA review. All baseline tests pass.
                      </div>
                    </div>
                    
                    <div className="ticket-grid">
                      {qaReadyItems.map(item => {
                        const ticket = tickets.find(t => t.id?.toUpperCase() === item.ticket_id?.toUpperCase());
                        const regStatus = regressionStatus[item.ticket_id];
                        return (
                          <div 
                            key={item.ticket_id} 
                            className={`ticket-card priority-${ticket?.priority || 'medium'}`}
                            onClick={() => setSelectedReviewItem({ item, ticket })}
                            style={{ borderLeftColor: '#a78bfa', cursor: 'pointer' }}
                          >
                            <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: '8px' }}>
                              <code style={{ fontSize: '12px', color: 'var(--text-muted)' }}>{item.ticket_id}</code>
                              <div style={{ display: 'flex', gap: '6px' }}>
                                <Badge type="qa">‚úÖ QA Ready</Badge>
                                {ticket && <Badge type={ticket.priority}>{ticket.priority}</Badge>}
                              </div>
                            </div>
                            <div style={{ fontSize: '14px', fontWeight: 600, marginBottom: '8px' }}>{ticket?.title || item.title || 'Unknown Ticket'}</div>
                            <div style={{ fontSize: '12px', color: 'var(--text-muted)', marginBottom: '6px' }}>{ticket?.feature || ''}</div>
                            <div style={{ display: 'flex', gap: '12px', fontSize: '11px', color: 'var(--text-muted)' }}>
                              <span>{(ticket?.files_to_modify || []).length} files</span>
                              <span>‚Ä¢</span>
                              <span>{regStatus?.passedCount || 0} tests passed</span>
                            </div>
                            <div style={{ fontSize: '11px', color: '#a78bfa', marginTop: '8px' }}>
                              Ready for QA review
                            </div>
                          </div>
                        );
                      })}
                    </div>
                  </div>
                );
              })()}
            </div>
          )}
        </div>
      );
    }

    // ================= LAUNCH VIEW =================
    // All agent commands in one place

    function LaunchView({ tickets, devStatus, docStatus, onSaveDevStatus, findings, serverDecisions, featuresList, agentOutputs }) {
      const [copied, setCopied] = useState(null);
      // Auto-expand testlock if there are completions to show
      const hasTestLockCompletions = (agentOutputs?.testLock || []).length > 0;
      const [expandedSection, setExpandedSection] = useState(hasTestLockCompletions ? 'testlock' : 'dev');
      const [expandedTicket, setExpandedTicket] = useState(null);
      const [launchNotes, setLaunchNotes] = useState({});
      const [savedNotes, setSavedNotes] = useState({});
      const [worktreeStatus, setWorktreeStatus] = useState(null); // null, 'creating', 'done', 'error'
      const [worktreeResults, setWorktreeResults] = useState([]);
      const [launchingTicket, setLaunchingTicket] = useState(null); // ticket ID being launched
      const [launchingAll, setLaunchingAll] = useState(false);
      const [launchAllProgress, setLaunchAllProgress] = useState(0);
      
      // Launch a single agent: create worktree, open Cursor, copy prompt
      const launchAgent = async (ticket) => {
        setLaunchingTicket(ticket.id);
        
        try {
          // Call API to create worktree and open Cursor
          const response = await fetch('/api/launch-agent', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ ticketId: ticket.id })
          });
          
          const result = await response.json();
          
          if (result.success) {
            // Copy the prompt to clipboard
            const prompt = `You are a Dev Agent. Read docs/workflow/DEV_AGENT_SOP.md then execute: docs/prompts/active/dev-agent-${ticket.id}-v1.md`;
            navigator.clipboard.writeText(prompt);
            
            // Mark as in progress
            markInProgress(ticket);
            
            setCopied(ticket.id);
            setTimeout(() => {
              setCopied(null);
              setLaunchingTicket(null);
            }, 3000);
          } else {
            console.error('Launch failed:', result.error);
            setLaunchingTicket(null);
          }
        } catch (err) {
          console.error('Failed to launch agent:', err);
          setLaunchingTicket(null);
        }
      };
      
      // Calculate undocumented and unreviewed features
      const undocumentedFeatures = useMemo(() => {
        // Features without docPath or with empty docPath are undocumented
        return (featuresList || []).filter(f => !f.docPath || f.docPath === '');
      }, [featuresList]);
      
      const unreviewedFeatures = useMemo(() => {
        // Features that are documented but not marked as reviewed in doc-status.json
        const docStatusFeatures = docStatus?.features || {};
        
        return (featuresList || []).filter(f => {
          if (!f.docPath) return false; // Must be documented first
          
          // Get the feature key from the file name (e.g., "widget-lifecycle.md" -> "widget-lifecycle")
          const featureKey = f.fileName?.replace('.md', '') || '';
          
          // Check if this feature is marked as reviewed in doc-status.json
          const featureStatus = docStatusFeatures[featureKey];
          return !featureStatus?.reviewed;
        });
      }, [featuresList, docStatus]);
      
      // Ticket calculations
      const inProgressItems = devStatus?.in_progress || [];
      const completedItems = devStatus?.completed || [];
      // Normalize to uppercase for case-insensitive matching
      const inProgressTicketIds = new Set(inProgressItems.map(i => i.ticket_id?.toUpperCase()));
      const completedTicketIds = new Set(completedItems.map(c => c.ticket_id?.toUpperCase()));
      
      // Ready = status is 'ready' AND not in dev-status completed/in_progress
      const readyTickets = tickets.filter(t => 
        t.status === 'ready' && 
        !completedTicketIds.has(t.id?.toUpperCase()) && 
        !inProgressTicketIds.has(t.id?.toUpperCase())
      );
      
      const lockedFiles = new Set();
      // Add files from in-progress tickets
      tickets.filter(t => inProgressTicketIds.has(t.id?.toUpperCase())).forEach(t => {
        (t.files_to_modify || []).forEach(f => lockedFiles.add(f));
      });
      // Add files from completed (for review) tickets - they're not merged yet!
      tickets.filter(t => completedTicketIds.has(t.id?.toUpperCase())).forEach(t => {
        (t.files_to_modify || []).forEach(f => lockedFiles.add(f));
      });
      
      const availableTickets = readyTickets;
      
      // Sort by priority
      const priorityOrder = { critical: 0, high: 1, medium: 2, low: 3 };
      const sortedTickets = [...availableTickets].sort((a, b) => 
        (priorityOrder[a.priority] || 4) - (priorityOrder[b.priority] || 4)
      );
      
      // Calculate next batch - greedy algorithm for parallelization
      const calculateNextBatch = () => {
        const batch = [];
        const batchFiles = new Set(lockedFiles);
        
        for (const ticket of sortedTickets) {
          const ticketFiles = ticket.files_to_modify || [];
          const hasConflict = ticketFiles.some(f => batchFiles.has(f));
          if (!hasConflict) {
            batch.push(ticket);
            ticketFiles.forEach(f => batchFiles.add(f));
          }
        }
        return batch;
      };
      
      const nextBatch = calculateNextBatch();
      const nextBatchIds = new Set(nextBatch.map(t => t.id));
      
      // DEBUG: Log conflict calculation
      console.log('[LaunchView DEBUG v2]', {
        totalReady: readyTickets.length,
        completedCount: completedItems.length,
        completedIds: [...completedTicketIds],
        lockedFilesCount: lockedFiles.size,
        lockedFiles: [...lockedFiles].slice(0, 5),
        nextBatchCount: nextBatch.length,
        nextBatchIds: nextBatch.map(t => t.id)
      });
      
      const copyCommand = (id, additionalNotes = '') => {
        let cmd = `# IMPORTANT: First set up your isolated worktree!
# Run: ./scripts/setup-agent-worktree.sh ${id}
# Then: cd ../agent-worktrees/${id}

You are a Dev Agent. Read docs/workflow/DEV_AGENT_SOP.md then execute: docs/prompts/active/dev-agent-${id}-v1.md`;
        if (additionalNotes) {
          cmd += `\n\n---\nPM Notes: ${additionalNotes}`;
        }
        navigator.clipboard.writeText(cmd);
        setCopied(id);
        setTimeout(() => setCopied(null), 2000);
      };
      
      const copyAllBatch = () => {
        const commands = nextBatch.map((t, i) => {
          let cmd = `# ========================================
# Agent ${i + 1}: ${t.id}
# Worktree: ../agent-worktrees/${t.id}
# ========================================
# Setup: ./scripts/setup-agent-worktree.sh ${t.id} && cd ../agent-worktrees/${t.id}

You are a Dev Agent. Read docs/workflow/DEV_AGENT_SOP.md then execute: docs/prompts/active/dev-agent-${t.id}-v1.md`;
          if (launchNotes[t.id]) {
            cmd += `\n\nPM Notes: ${launchNotes[t.id]}`;
          }
          return cmd;
        }).join('\n\n---\n\n');
        navigator.clipboard.writeText(commands);
        setCopied('all-batch');
        setTimeout(() => setCopied(null), 2000);
      };
      
      const markInProgress = (ticket) => {
        const newInProgress = [...inProgressItems, {
          ticket_id: ticket.id,
          title: ticket.title,
          branch: `agent/${ticket.id.toLowerCase()}-${ticket.title.toLowerCase().replace(/[^a-z0-9]+/g, '-').slice(0, 30)}`,
          started_at: new Date().toISOString(),
          launch_notes: launchNotes[ticket.id] || null
        }];
        onSaveDevStatus({ ...devStatus, in_progress: newInProgress });
      };
      
      // Count pipeline items by category
      const pipelineStats = useMemo(() => {
        if (!serverDecisions?.threads) return { pendingResponses: [], awaitingDecision: [], pendingTickets: [] };
        
        const getThread = (id) => serverDecisions.threads.find(t => t.finding_id === id);
        
        const pendingResponses = [];  // PM asked a question, last msg is human ‚Üí waiting for agent
        const awaitingDecision = [];  // Agent responded, last msg is system ‚Üí waiting for PM decision
        const pendingTickets = [];    // PM made final decision ‚Üí ready for ticket creation
        
        findings.forEach(f => {
          const thread = getThread(f.id);
          if (!thread) return;
          
          // Already processed - don't count
          if (f.status === 'ticketed' || f.status === 'skipped') return;
          
          const isResolved = thread.status === 'resolved';
          const hasCustomDecision = thread.decision && thread.decision.option_id === 'custom';
          const hasNonCustomDecision = thread.decision && thread.decision.option_id && thread.decision.option_id !== 'custom';
          const msgs = thread.messages || [];
          const lastMsg = msgs[msgs.length - 1];
          const hasResolutionMsg = msgs.some(m => 
            m.role === 'system' && 
            (m.text?.includes('Decision confirmed') || m.text?.includes('Marking resolved') || m.text?.includes('Ticket TKT-'))
          );
          
          // Skip if already fully resolved
          if (hasResolutionMsg) return;
          
          // Custom decision with conversation
          if (hasCustomDecision && !isResolved) {
            // Check last message to determine who's waiting
            if (lastMsg?.role === 'human' || msgs.length === 0) {
              // Last message from PM (or no messages yet) ‚Üí waiting for agent response
              pendingResponses.push({ ...f, thread, isBlocker: f.type === 'blocker' });
            } else {
              // Last message from system ‚Üí agent responded, waiting for PM decision
              awaitingDecision.push({ ...f, thread, isBlocker: f.type === 'blocker' });
            }
          }
          // Non-custom decision or resolved = ready for ticket creation
          else if (isResolved || hasNonCustomDecision) {
            pendingTickets.push({ ...f, thread, isBlocker: f.type === 'blocker' });
          }
        });
        
        return { pendingResponses, awaitingDecision, pendingTickets };
      }, [findings, serverDecisions]);
      
      const totalToProcess = pipelineStats.pendingResponses.length + pipelineStats.awaitingDecision.length + pipelineStats.pendingTickets.length;
      
      // PM Command - unified
      const pmCommand = {
        label: 'Process Pipeline',
        description: 'Respond to questions & create tickets',
        command: `You are a PM agent. 

**FIRST: Read and understand all existing tickets**
- Read tickets.json completely before processing any findings
- Understand what each ticket covers, its scope, and what findings it addresses
- Keep this context in mind when evaluating new findings

Read decisions.json and findings.json.

THREE TASKS:

1) RESPOND TO QUESTIONS (threads with decision.option_id = "custom" AND last message is human):
   - Read the PM's question from the last human message
   - Read the finding context (issue, options, suggested_fix)  
   - Add your response as a new message: { role: "system", text: "[your answer]", timestamp: now }
   - Keep answers concise and actionable with clear options

2) CREATE TICKETS & RESOLVE THREADS (threads with decision != null AND status != "resolved"):
   
   **BEFORE CREATING ANY TICKET:**
   - Compare the finding against ALL existing tickets you've read
   - Ask: Is this already covered? Should this be merged into an existing ticket?
   - If duplicate or overlap found:
     - Add system message: "This appears covered by TKT-XXX: [title]. Link to existing, merge, or create new?"
     - **DO NOT resolve the thread** - keep status as "in_discussion"
     - **STOP processing this finding** - wait for PM response in next cycle
   - To link (after PM confirms): Set finding.status = "ticketed", finding.ticket_id = "TKT-XXX" (no new ticket)
   
   **SKIP THESE (don't create tickets):**
   - Skip phrases in custom_note: "skip", "dont need", "already have ticket", "already covered"
   - Questions ending in "?" - these need answers first, not tickets
   - "skip" or "won't fix" decisions
   
   **CREATE TICKETS FOR:**
   - Clear "implement" decisions with NO existing coverage after manual review
   - Set finding.status = "ticketed", finding.ticket_id = "TKT-XXX"
   
   **ALWAYS:**
   - Set thread.status = "resolved" in decisions.json for ALL processed items
   - Ensure finding.status is NEVER left as "pending" for resolved threads

3) SYNC CHECK (run after all updates):
   - Run: node docs/scripts/process-decisions.js
   - This catches any inconsistencies between files

Report: X questions answered, Y tickets created, Z items linked to existing, W items skipped.`
      };
      
      const DOC_REVIEW_COMMANDS = {
        docSprint: {
          label: 'Launch Doc Sprint',
          description: 'Generate documentation for all features',
          command: 'You are a PM agent. Read docs/workflow/PM_DOCS_SOP.md and execute doc-sprint mode. Generate doc-agent prompts for all undocumented features.'
        },
        reviewSprint: {
          label: 'Launch Review Sprint', 
          description: 'Review all documented features for issues',
          command: 'You are a PM agent. Read docs/workflow/PM_DOCS_SOP.md and execute review-sprint mode. Generate review-agent prompts for all documented features.'
        }
      };

      // Calculate test-lock stats
      const testLockStats = useMemo(() => {
        const allPrompts = [
          'A1', 'A2', 'A3', 'A4', 'A5',
          'API1', 'API2', 'API3',
          'AUTH1', 'AUTH2', 'AUTH3', 'AUTH4',
          'B1', 'B2', 'B3', 'B4', 'B5', 'B6',
          'D1', 'D2', 'D3', 'D4', 'D5', 'D6', 'D7', 'D8',
          'M1', 'M2',
          'P2', 'P3', 'P4', 'P5', 'P6',
          'STATS1', 'STATS2', 'STATS3',
          'V1', 'V2', 'V3', 'V4', 'V5'
        ];
        const completedIds = new Set((agentOutputs?.testLock || []).map(t => {
          const match = (t.ticketId || t.id || '').match(/^([A-Z]+\d*)/i);
          return match ? match[1].toUpperCase() : '';
        }));
        const completed = allPrompts.filter(id => completedIds.has(id));
        const pending = allPrompts.filter(id => !completedIds.has(id));
        return { total: allPrompts.length, completed, pending, completedCount: completed.length, pendingCount: pending.length };
      }, [agentOutputs?.testLock]);

      return (
        <div className="fade-in">
          {/* Quick Stats Header */}
          <div style={{ 
            display: 'grid', 
            gridTemplateColumns: 'repeat(auto-fit, minmax(180px, 1fr))', 
            gap: '12px', 
            marginBottom: '24px',
            padding: '16px',
            background: 'linear-gradient(135deg, rgba(30,41,59,0.6) 0%, rgba(15,23,42,0.7) 100%)',
            borderRadius: '16px',
            border: '1px solid rgba(71,85,105,0.25)'
          }}>
            {/* Test Lock Progress - Highlighted */}
            <div 
              style={{ 
                padding: '16px', 
                background: testLockStats.completedCount > 0 ? 'rgba(167,139,250,0.15)' : 'rgba(167,139,250,0.08)', 
                borderRadius: '12px',
                border: testLockStats.completedCount > 0 ? '2px solid rgba(167,139,250,0.5)' : '1px solid rgba(167,139,250,0.2)',
                cursor: 'pointer',
                transition: 'all 0.2s'
              }}
              onClick={() => setExpandedSection('testlock')}
            >
              <div style={{ display: 'flex', alignItems: 'center', gap: '8px', marginBottom: '8px' }}>
                <span style={{ fontSize: '18px' }}>üß™</span>
                <span style={{ fontSize: '13px', fontWeight: 600, color: '#a78bfa' }}>TEST LOCK</span>
              </div>
              <div style={{ fontSize: '28px', fontWeight: 700, color: 'var(--text-primary)' }}>
                {testLockStats.completedCount}<span style={{ fontSize: '16px', color: 'var(--text-muted)' }}>/{testLockStats.total}</span>
              </div>
              <div style={{ fontSize: '11px', color: testLockStats.pendingCount > 0 ? '#fbbf24' : 'var(--success)' }}>
                {testLockStats.pendingCount > 0 ? `${testLockStats.pendingCount} pending` : '‚úì All complete'}
              </div>
              {testLockStats.completedCount > 0 && (
                <div style={{ marginTop: '8px', fontSize: '10px', color: 'var(--text-muted)' }}>
                  ‚úì {testLockStats.completed.join(', ')}
                </div>
              )}
            </div>

            {/* Dev Progress */}
            <div 
              style={{ 
                padding: '16px', 
                background: 'rgba(59,130,246,0.08)', 
                borderRadius: '12px',
                border: '1px solid rgba(59,130,246,0.2)',
                cursor: 'pointer'
              }}
              onClick={() => setExpandedSection('dev')}
            >
              <div style={{ display: 'flex', alignItems: 'center', gap: '8px', marginBottom: '8px' }}>
                <span style={{ fontSize: '18px' }}>‚ö°</span>
                <span style={{ fontSize: '13px', fontWeight: 600, color: 'var(--accent-bright)' }}>DEV AGENTS</span>
              </div>
              <div style={{ fontSize: '28px', fontWeight: 700, color: 'var(--text-primary)' }}>
                {(devStatus?.completed || []).length}<span style={{ fontSize: '16px', color: 'var(--text-muted)' }}> done</span>
              </div>
              <div style={{ fontSize: '11px', color: (devStatus?.in_progress || []).length > 0 ? '#fbbf24' : 'var(--text-muted)' }}>
                {(devStatus?.in_progress || []).length > 0 ? `${(devStatus?.in_progress || []).length} in progress` : 'None in progress'}
              </div>
            </div>

            {/* Review Progress */}
            <div 
              style={{ 
                padding: '16px', 
                background: 'rgba(74,222,128,0.08)', 
                borderRadius: '12px',
                border: '1px solid rgba(74,222,128,0.2)',
                cursor: 'pointer'
              }}
              onClick={() => setExpandedSection('review')}
            >
              <div style={{ display: 'flex', alignItems: 'center', gap: '8px', marginBottom: '8px' }}>
                <span style={{ fontSize: '18px' }}>‚úì</span>
                <span style={{ fontSize: '13px', fontWeight: 600, color: 'var(--success)' }}>REVIEWS</span>
              </div>
              <div style={{ fontSize: '28px', fontWeight: 700, color: 'var(--text-primary)' }}>
                {(agentOutputs?.reviews || []).length}
              </div>
              <div style={{ fontSize: '11px', color: unreviewedFeatures.length > 0 ? '#fbbf24' : 'var(--success)' }}>
                {unreviewedFeatures.length > 0 ? `${unreviewedFeatures.length} pending` : '‚úì All reviewed'}
              </div>
            </div>

            {/* Doc Progress */}
            <div 
              style={{ 
                padding: '16px', 
                background: 'rgba(251,191,36,0.08)', 
                borderRadius: '12px',
                border: '1px solid rgba(251,191,36,0.2)',
                cursor: 'pointer'
              }}
              onClick={() => setExpandedSection('doc')}
            >
              <div style={{ display: 'flex', alignItems: 'center', gap: '8px', marginBottom: '8px' }}>
                <span style={{ fontSize: '18px' }}>üìÑ</span>
                <span style={{ fontSize: '13px', fontWeight: 600, color: '#fbbf24' }}>DOCS</span>
              </div>
              <div style={{ fontSize: '28px', fontWeight: 700, color: 'var(--text-primary)' }}>
                {(featuresList || []).length - undocumentedFeatures.length}<span style={{ fontSize: '16px', color: 'var(--text-muted)' }}>/{(featuresList || []).length}</span>
              </div>
              <div style={{ fontSize: '11px', color: undocumentedFeatures.length > 0 ? '#fbbf24' : 'var(--success)' }}>
                {undocumentedFeatures.length > 0 ? `${undocumentedFeatures.length} pending` : '‚úì All documented'}
              </div>
            </div>
          </div>

          {/* Doc Agents Section */}
          <div className="section" style={{ marginBottom: '32px' }}>
            <div 
              className="section-title" 
              style={{ 
                display: 'flex', 
                alignItems: 'center', 
                justifyContent: 'space-between',
                cursor: 'pointer',
                marginBottom: expandedSection === 'doc' ? '16px' : '0'
              }}
              onClick={() => setExpandedSection(expandedSection === 'doc' ? null : 'doc')}
            >
              <div style={{ display: 'flex', alignItems: 'center', gap: '10px' }}>
                <span style={{ color: 'var(--accent-bright)' }}><Icons.file /></span>
                <span style={{ fontWeight: 600 }}>Doc Agents</span>
                {undocumentedFeatures.length > 0 ? (
                  <span style={{ padding: '3px 10px', background: 'var(--accent)', color: 'white', borderRadius: '12px', fontSize: '11px', fontWeight: 600 }}>
                    {undocumentedFeatures.length} pending
                  </span>
                ) : (
                  <span style={{ padding: '3px 10px', background: 'var(--bg-elevated)', color: 'var(--text-muted)', borderRadius: '12px', fontSize: '11px', fontWeight: 600 }}>
                    All done
                  </span>
                )}
                <span style={{ fontSize: '12px', color: 'var(--text-muted)' }}>Document features</span>
              </div>
              <span style={{ color: 'var(--text-muted)', fontSize: '12px' }}>{expandedSection === 'doc' ? '‚ñº' : '‚ñ∂'}</span>
            </div>
            
            {expandedSection === 'doc' && (
              <div className="fade-in">
                {undocumentedFeatures.length === 0 ? (
                  <div className="card" style={{ textAlign: 'center', padding: '40px', color: 'var(--text-muted)' }}>
                    <div style={{ marginBottom: '8px' }}><Icons.checkCircle /></div>
                    <div>All features are documented</div>
                  </div>
                ) : (
                  <>
                    {/* Copy All Header */}
                    <div style={{ 
                      padding: '12px 16px', 
                      background: 'rgba(59,130,246,0.1)', 
                      borderRadius: '8px', 
                      marginBottom: '12px',
                      display: 'flex',
                      justifyContent: 'space-between',
                      alignItems: 'center'
                    }}>
                      <span style={{ fontSize: '13px', color: 'var(--text-secondary)' }}>
                        {undocumentedFeatures.length} features need documentation
                      </span>
                      <button 
                        className={`btn btn-sm ${copied === 'all-doc' ? 'btn-success' : 'btn-primary'}`}
                        onClick={() => {
                          const commands = undocumentedFeatures.map((f, i) => 
                            `# Doc Agent ${i + 1}: ${f.name}\nYou are a Doc Agent. Document the feature: ${f.name}\nRead: docs/workflow/DOC_AGENT_SOP.md`
                          ).join('\n\n---\n\n');
                          navigator.clipboard.writeText(commands);
                          setCopied('all-doc');
                          setTimeout(() => setCopied(null), 2000);
                        }}
                      >
                        {copied === 'all-doc' ? 'Copied All!' : `Copy All ${undocumentedFeatures.length}`}
                      </button>
                    </div>
                    
                    {/* Feature List */}
                    <div style={{ display: 'grid', gap: '8px' }}>
                      {undocumentedFeatures.map((feature, idx) => (
                        <div key={feature.name} className="card" style={{ padding: '12px 16px' }}>
                          <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                            <div style={{ display: 'flex', alignItems: 'center', gap: '10px' }}>
                              <span style={{ fontSize: '14px', fontWeight: 600, color: 'var(--text-muted)' }}>#{idx + 1}</span>
                              <span style={{ fontSize: '14px', fontWeight: 500 }}>{feature.name}</span>
                              <span style={{ fontSize: '11px', color: 'var(--text-muted)', padding: '2px 8px', background: 'var(--bg-elevated)', borderRadius: '4px' }}>{feature.category}</span>
                            </div>
                            <button 
                              className={`btn btn-sm ${copied === `doc-${feature.name}` ? 'btn-success' : 'btn-secondary'}`}
                              onClick={() => {
                                const cmd = `You are a Doc Agent. Document the feature: ${feature.name}\nRead: docs/workflow/DOC_AGENT_SOP.md`;
                                navigator.clipboard.writeText(cmd);
                                setCopied(`doc-${feature.name}`);
                                setTimeout(() => setCopied(null), 2000);
                              }}
                            >
                              {copied === `doc-${feature.name}` ? 'Copied!' : 'Copy'}
                            </button>
                          </div>
                        </div>
                      ))}
                    </div>
                  </>
                )}
              </div>
            )}
          </div>

          {/* TEST LOCK Agents Section */}
          <div className="section">
            <div 
              className="section-title" 
              style={{ 
                display: 'flex', 
                alignItems: 'center', 
                justifyContent: 'space-between',
                cursor: 'pointer',
                marginBottom: expandedSection === 'testlock' ? '16px' : '0'
              }}
              onClick={() => setExpandedSection(expandedSection === 'testlock' ? null : 'testlock')}
            >
              <div style={{ display: 'flex', alignItems: 'center', gap: '10px' }}>
                <span style={{ color: '#a78bfa' }}>üß™</span>
                <span style={{ fontWeight: 600 }}>TEST LOCK Agents</span>
                {(() => {
                  const testedFeatureIds = new Set((agentOutputs?.testLock || []).map(t => t.ticketId?.toUpperCase()));
                  const totalFeatures = featuresList?.length || 0;
                  const testedCount = testedFeatureIds.size;
                  const pendingCount = totalFeatures - testedCount;
                  return pendingCount > 0 ? (
                    <span style={{ padding: '3px 10px', background: '#a78bfa', color: 'white', borderRadius: '12px', fontSize: '11px', fontWeight: 600 }}>
                      {testedCount}/41 done
                    </span>
                  ) : (
                    <span style={{ padding: '3px 10px', background: 'var(--bg-elevated)', color: 'var(--text-muted)', borderRadius: '12px', fontSize: '11px', fontWeight: 600 }}>
                      All done
                    </span>
                  );
                })()}
                <span style={{ fontSize: '12px', color: 'var(--text-muted)' }}>Create baseline behavior tests</span>
              </div>
              <span style={{ color: 'var(--text-muted)', fontSize: '12px' }}>{expandedSection === 'testlock' ? '‚ñº' : '‚ñ∂'}</span>
            </div>
            
            {expandedSection === 'testlock' && (
              <div className="fade-in">
                {/* Test Lock Summary */}
                <div style={{ 
                  padding: '16px 20px', 
                  background: 'rgba(167,139,250,0.1)', 
                  borderRadius: '12px', 
                  marginBottom: '16px',
                  border: '1px solid rgba(167,139,250,0.2)'
                }}>
                  <div style={{ fontSize: '14px', fontWeight: 600, marginBottom: '8px' }}>
                    üß™ TEST LOCK Agent creates baseline behavior tests
                  </div>
                  <div style={{ fontSize: '13px', color: 'var(--text-muted)', marginBottom: '8px' }}>
                    These tests "lock in" current behavior to prevent regressions. They don't define what's correct - they capture what the code currently does.
                  </div>
                  <div style={{ fontSize: '12px', padding: '8px 12px', background: 'rgba(16,185,129,0.15)', borderRadius: '6px', color: 'var(--success)' }}>
                    ‚úì <strong>Can run in parallel</strong> ‚Äî Each agent writes to its own file, no git conflicts
                  </div>
                </div>

                {/* Pending Test Lock Prompts - Ready to Launch */}
                {(() => {
                  // Get completed test lock IDs
                  const completedIds = new Set((agentOutputs?.testLock || []).map(t => {
                    const match = (t.ticketId || t.id || '').match(/^([A-Z]+\d*)/i);
                    return match ? match[1].toUpperCase() : '';
                  }));
                  
                  // Define all test lock prompts (from docs/prompts/active/test-lock-*.md)
                  const allTestLockPrompts = [
                    'A1', 'A2', 'A3', 'A4', 'A5',
                    'API1', 'API2', 'API3',
                    'AUTH1', 'AUTH2', 'AUTH3', 'AUTH4',
                    'B1', 'B2', 'B3', 'B4', 'B5', 'B6',
                    'D1', 'D2', 'D3', 'D4', 'D5', 'D6', 'D7', 'D8',
                    'M1', 'M2',
                    'P2', 'P3', 'P4', 'P5', 'P6',
                    'STATS1', 'STATS2', 'STATS3',
                    'V1', 'V2', 'V3', 'V4', 'V5'
                  ];
                  
                  const pendingPrompts = allTestLockPrompts.filter(id => !completedIds.has(id));
                  
                  return pendingPrompts.length > 0 ? (
                    <div style={{ marginBottom: '16px' }}>
                      <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '12px' }}>
                        <div style={{ fontSize: '12px', fontWeight: 600, color: 'var(--success)' }}>
                          READY TO LAUNCH ({pendingPrompts.length})
                        </div>
                        <button 
                          className={`btn btn-sm ${copied === 'testlock-all' ? 'btn-success' : ''}`}
                          style={{ background: copied === 'testlock-all' ? 'var(--success)' : '#a78bfa' }}
                          onClick={() => {
                            const allCmds = pendingPrompts.map(id => 
                              `Read and execute docs/prompts/active/test-lock-${id}.md`
                            ).join('\n\n---\n\n');
                            navigator.clipboard.writeText(allCmds);
                            setCopied('testlock-all');
                            setTimeout(() => setCopied(null), 2000);
                          }}
                        >
                          {copied === 'testlock-all' ? '‚úì Copied All!' : `Copy All ${pendingPrompts.length} Commands`}
                        </button>
                      </div>
                      <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fill, minmax(200px, 1fr))', gap: '8px' }}>
                        {pendingPrompts.map(id => (
                          <div 
                            key={id} 
                            className="card" 
                            style={{ 
                              padding: '10px 14px', 
                              borderLeft: '3px solid var(--success)',
                              display: 'flex',
                              justifyContent: 'space-between',
                              alignItems: 'center'
                            }}
                          >
                            <div>
                              <span style={{ fontSize: '13px', fontWeight: 600 }}>{id}</span>
                              <div style={{ fontSize: '10px', color: 'var(--text-muted)' }}>test-lock-{id}.md</div>
                            </div>
                            <button 
                              className={`btn btn-sm ${copied === `testlock-${id}` ? 'btn-success' : 'btn-secondary'}`}
                              onClick={() => {
                                navigator.clipboard.writeText(`Read and execute docs/prompts/active/test-lock-${id}.md`);
                                setCopied(`testlock-${id}`);
                                setTimeout(() => setCopied(null), 2000);
                              }}
                            >
                              {copied === `testlock-${id}` ? '‚úì' : 'Copy'}
                            </button>
                          </div>
                        ))}
                      </div>
                    </div>
                  ) : null;
                })()}

                {/* Completed Test Locks */}
                {(agentOutputs?.testLock || []).length > 0 && (
                  <div style={{ marginBottom: '16px' }}>
                    <div style={{ fontSize: '12px', fontWeight: 600, color: 'var(--text-muted)', marginBottom: '8px' }}>
                      COMPLETED ({(agentOutputs?.testLock || []).length})
                    </div>
                    <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fill, minmax(180px, 1fr))', gap: '6px' }}>
                      {(agentOutputs?.testLock || []).map(output => (
                        <div key={output.fileName} className="card" style={{ padding: '8px 12px', borderLeft: '3px solid #a78bfa', opacity: 0.7 }}>
                          <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                            <span style={{ fontSize: '12px', fontWeight: 500 }}>{output.ticketId}</span>
                            <span style={{ fontSize: '10px', color: 'var(--success)' }}>‚úì</span>
                          </div>
                        </div>
                      ))}
                    </div>
                  </div>
                )}
              </div>
            )}
          </div>

          {/* Review Agents Section */}
          <div className="section">
            <div 
              className="section-title" 
              style={{ 
                display: 'flex', 
                alignItems: 'center', 
                justifyContent: 'space-between',
                cursor: 'pointer',
                marginBottom: expandedSection === 'review' ? '16px' : '0'
              }}
              onClick={() => setExpandedSection(expandedSection === 'review' ? null : 'review')}
            >
              <div style={{ display: 'flex', alignItems: 'center', gap: '10px' }}>
                <span style={{ color: 'var(--accent-bright)' }}><Icons.checkCircle /></span>
                <span style={{ fontWeight: 600 }}>Review Agents</span>
                {unreviewedFeatures.length > 0 ? (
                  <span style={{ padding: '3px 10px', background: 'var(--accent)', color: 'white', borderRadius: '12px', fontSize: '11px', fontWeight: 600 }}>
                    {unreviewedFeatures.length} pending
                  </span>
                ) : (
                  <span style={{ padding: '3px 10px', background: 'var(--bg-elevated)', color: 'var(--text-muted)', borderRadius: '12px', fontSize: '11px', fontWeight: 600 }}>
                    All done
                  </span>
                )}
                <span style={{ fontSize: '12px', color: 'var(--text-muted)' }}>Review documented features</span>
              </div>
              <span style={{ color: 'var(--text-muted)', fontSize: '12px' }}>{expandedSection === 'review' ? '‚ñº' : '‚ñ∂'}</span>
            </div>
            
            {expandedSection === 'review' && (
              <div className="fade-in">
                {unreviewedFeatures.length === 0 ? (
                  <div className="card" style={{ textAlign: 'center', padding: '40px', color: 'var(--text-muted)' }}>
                    <div style={{ marginBottom: '8px' }}><Icons.checkCircle /></div>
                    <div>All documented features have been reviewed</div>
                  </div>
                ) : (
                  <>
                    {/* Copy All Header */}
                    <div style={{ 
                      padding: '12px 16px', 
                      background: 'rgba(59,130,246,0.1)', 
                      borderRadius: '8px', 
                      marginBottom: '12px',
                      display: 'flex',
                      justifyContent: 'space-between',
                      alignItems: 'center'
                    }}>
                      <span style={{ fontSize: '13px', color: 'var(--text-secondary)' }}>
                        {unreviewedFeatures.length} features need review
                      </span>
                      <button 
                        className={`btn btn-sm ${copied === 'all-review' ? 'btn-success' : 'btn-primary'}`}
                        onClick={() => {
                          const commands = unreviewedFeatures.map((f, i) => 
                            `# Review Agent ${i + 1}: ${f.name}\nYou are a Review Agent. Review the feature: ${f.name}\nRead: docs/workflow/REVIEW_AGENT_SOP.md\nDoc: ${f.docPath}`
                          ).join('\n\n---\n\n');
                          navigator.clipboard.writeText(commands);
                          setCopied('all-review');
                          setTimeout(() => setCopied(null), 2000);
                        }}
                      >
                        {copied === 'all-review' ? 'Copied All!' : `Copy All ${unreviewedFeatures.length}`}
                      </button>
                    </div>
                    
                    {/* Feature List */}
                    <div style={{ display: 'grid', gap: '8px' }}>
                      {unreviewedFeatures.map((feature, idx) => (
                        <div key={feature.name} className="card" style={{ padding: '12px 16px' }}>
                          <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                            <div style={{ flex: 1 }}>
                              <div style={{ display: 'flex', alignItems: 'center', gap: '10px' }}>
                                <span style={{ fontSize: '14px', fontWeight: 600, color: 'var(--text-muted)' }}>#{idx + 1}</span>
                                <span style={{ fontSize: '14px', fontWeight: 500 }}>{feature.name}</span>
                                <span style={{ fontSize: '11px', color: 'var(--text-muted)', padding: '2px 8px', background: 'var(--bg-elevated)', borderRadius: '4px' }}>{feature.category}</span>
                              </div>
                              <code style={{ fontSize: '10px', color: 'var(--text-muted)', marginTop: '4px', display: 'block' }}>{feature.docPath}</code>
                            </div>
                            <button 
                              className={`btn btn-sm ${copied === `review-${feature.name}` ? 'btn-success' : 'btn-secondary'}`}
                              onClick={() => {
                                const cmd = `You are a Review Agent. Review the feature: ${feature.name}\nRead: docs/workflow/REVIEW_AGENT_SOP.md\nDoc: ${feature.docPath}`;
                                navigator.clipboard.writeText(cmd);
                                setCopied(`review-${feature.name}`);
                                setTimeout(() => setCopied(null), 2000);
                              }}
                            >
                              {copied === `review-${feature.name}` ? 'Copied!' : 'Copy'}
                            </button>
                          </div>
                        </div>
                      ))}
                    </div>
                  </>
                )}
              </div>
            )}
          </div>

          {/* PM Agent Section */}
          <div className="section" style={{ marginBottom: '32px' }}>
            <div 
              className="section-title" 
              style={{ 
                display: 'flex', 
                alignItems: 'center', 
                justifyContent: 'space-between',
                cursor: 'pointer',
                marginBottom: expandedSection === 'pm' ? '16px' : '0'
              }}
              onClick={() => setExpandedSection(expandedSection === 'pm' ? null : 'pm')}
            >
              <div style={{ display: 'flex', alignItems: 'center', gap: '10px' }}>
                <span style={{ color: 'var(--accent-bright)' }}><Icons.file /></span>
                <span style={{ fontWeight: 600 }}>PM Agent</span>
                <span style={{ 
                  padding: '3px 10px', 
                  background: totalToProcess > 0 ? 'var(--accent)' : 'var(--bg-elevated)', 
                  color: totalToProcess > 0 ? 'white' : 'var(--text-muted)', 
                  borderRadius: '12px', 
                  fontSize: '11px', 
                  fontWeight: 600 
                }}>
                  {totalToProcess} to process
                </span>
                <span style={{ fontSize: '12px', color: 'var(--text-muted)' }}>Respond & create tickets</span>
              </div>
              <span style={{ color: 'var(--text-muted)', fontSize: '12px' }}>{expandedSection === 'pm' ? '‚ñº' : '‚ñ∂'}</span>
            </div>
            
            {expandedSection === 'pm' && (
              <div style={{ display: 'grid', gap: '16px' }}>
                {/* Stats breakdown */}
                <div style={{ display: 'grid', gridTemplateColumns: 'repeat(3, 1fr)', gap: '12px' }}>
                  <div className="card" style={{ padding: '16px', textAlign: 'center' }}>
                    <div style={{ fontSize: '28px', fontWeight: 700, color: pipelineStats.pendingResponses.length > 0 ? 'var(--medium)' : 'var(--text-muted)' }}>
                      {pipelineStats.pendingResponses.length}
                    </div>
                    <div style={{ fontSize: '12px', color: 'var(--text-muted)', marginTop: '4px' }}>üí¨ Need Response</div>
                    <div style={{ fontSize: '10px', color: 'var(--text-muted)', marginTop: '2px' }}>
                      You asked, agent will answer
                    </div>
                  </div>
                  <div className="card" style={{ padding: '16px', textAlign: 'center' }}>
                    <div style={{ fontSize: '28px', fontWeight: 700, color: pipelineStats.awaitingDecision.length > 0 ? 'var(--high)' : 'var(--text-muted)' }}>
                      {pipelineStats.awaitingDecision.length}
                    </div>
                    <div style={{ fontSize: '12px', color: 'var(--text-muted)', marginTop: '4px' }}>‚è≥ Awaiting Your Decision</div>
                    <div style={{ fontSize: '10px', color: 'var(--text-muted)', marginTop: '2px' }}>
                      Agent responded, pick an option
                    </div>
                  </div>
                  <div className="card" style={{ padding: '16px', textAlign: 'center' }}>
                    <div style={{ fontSize: '28px', fontWeight: 700, color: pipelineStats.pendingTickets.length > 0 ? 'var(--success)' : 'var(--text-muted)' }}>
                      {pipelineStats.pendingTickets.length}
                    </div>
                    <div style={{ fontSize: '12px', color: 'var(--text-muted)', marginTop: '4px' }}>üé´ Ready for Tickets</div>
                    <div style={{ fontSize: '10px', color: 'var(--text-muted)', marginTop: '2px' }}>
                      Decision made, create tickets
                    </div>
                  </div>
                </div>
                
                {/* Command card */}
                <div className="card" style={{ padding: '16px 20px' }}>
                  <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'flex-start' }}>
                    <div style={{ flex: 1 }}>
                      <div style={{ fontSize: '15px', fontWeight: 600 }}>{pmCommand.label}</div>
                      <div style={{ fontSize: '12px', color: 'var(--text-muted)', marginTop: '4px' }}>{pmCommand.description}</div>
                    </div>
                    <button 
                      className={`btn ${copied === 'pm-command' ? 'btn-success' : 'btn-primary'}`}
                      onClick={() => {
                        navigator.clipboard.writeText(pmCommand.command);
                        setCopied('pm-command');
                        setTimeout(() => setCopied(null), 2000);
                      }}
                    >
                      {copied === 'pm-command' ? 'Copied!' : 'Copy Command'}
                    </button>
                  </div>
                  <div style={{ marginTop: '12px', padding: '12px', background: 'var(--bg-elevated)', borderRadius: '8px' }}>
                    <code style={{ fontSize: '12px', color: 'var(--text-secondary)', wordBreak: 'break-word' }}>{pmCommand.command}</code>
                  </div>
                </div>
              </div>
            )}
          </div>

          {/* Dev Agents Section */}
          <div className="section" style={{ marginBottom: '32px' }}>
            <div 
              className="section-title" 
              style={{ 
                display: 'flex', 
                alignItems: 'center', 
                justifyContent: 'space-between',
                cursor: 'pointer',
                marginBottom: expandedSection === 'dev' ? '16px' : '0'
              }}
              onClick={() => setExpandedSection(expandedSection === 'dev' ? null : 'dev')}
            >
              <div style={{ display: 'flex', alignItems: 'center', gap: '10px' }}>
                <span style={{ color: 'var(--accent-bright)' }}><Icons.server /></span>
                <span style={{ fontWeight: 600 }}>Dev Agents</span>
                {nextBatch.length > 0 && (
                  <span style={{ padding: '3px 10px', background: 'var(--accent)', color: 'white', borderRadius: '12px', fontSize: '11px', fontWeight: 600 }}>
                    {nextBatch.length} ready
                  </span>
                )}
              </div>
              <span style={{ color: 'var(--text-muted)', fontSize: '12px' }}>{expandedSection === 'dev' ? '‚ñº' : '‚ñ∂'}</span>
            </div>
            
            {expandedSection === 'dev' && (
              <div className="fade-in">
                {/* Batch Header */}
                {nextBatch.length > 0 && (
                  <div style={{ 
                    padding: '16px 20px', 
                    background: 'linear-gradient(135deg, rgba(16,185,129,0.1), rgba(99,102,241,0.1))',
                    borderRadius: '12px', 
                    marginBottom: '20px',
                    border: '1px solid rgba(16,185,129,0.2)'
                  }}>
                    <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                      <div>
                        <div style={{ fontSize: '16px', fontWeight: 700, color: 'var(--text-primary)' }}>
                          {nextBatch.length} tickets can run in parallel
                        </div>
                        <div style={{ fontSize: '13px', color: 'var(--text-muted)', marginTop: '4px' }}>
                          Click to expand, add notes, then copy command
                        </div>
                      </div>
                      <div style={{ display: 'flex', gap: '10px' }}>
                        <button 
                          className={`btn ${copied === 'all-batch' ? 'btn-success' : 'btn-primary'}`}
                          onClick={copyAllBatch}
                        >
                          {copied === 'all-batch' ? 'Copied All!' : `Copy All ${nextBatch.length}`}
                        </button>
                        <button 
                          className={`btn ${worktreeStatus === 'done' ? 'btn-success' : worktreeStatus === 'creating' ? 'btn-warning' : 'btn-secondary'}`}
                          disabled={worktreeStatus === 'creating'}
                          onClick={async () => {
                            // Step 1: Create worktrees for all tickets
                            setWorktreeStatus('creating');
                            setWorktreeResults([]);
                            
                            try {
                              const ticketIds = nextBatch.map(t => t.id);
                              const response = await fetch('/api/setup-worktrees', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ ticketIds })
                              });
                              
                              const result = await response.json();
                              setWorktreeResults(result.results || []);
                              
                              if (result.success) {
                                // Step 2: Mark tickets as in progress
                                const newInProgress = nextBatch.map(ticket => ({
                                  ticket_id: ticket.id,
                                  title: ticket.title,
                                  branch: `agent/${ticket.id.toLowerCase()}`,
                                  started_at: new Date().toISOString(),
                                  launch_notes: launchNotes[ticket.id] || null,
                                  worktree_path: `../agent-worktrees/${ticket.id}`
                                }));
                                onSaveDevStatus({ 
                                  ...devStatus, 
                                  in_progress: [...inProgressItems, ...newInProgress] 
                                });
                                setWorktreeStatus('done');
                                setTimeout(() => setWorktreeStatus(null), 3000);
                              } else {
                                setWorktreeStatus('error');
                              }
                            } catch (err) {
                              console.error('Failed to create worktrees:', err);
                              setWorktreeStatus('error');
                            }
                          }}
                        >
                          {worktreeStatus === 'creating' ? '‚è≥ Creating Worktrees...' : 
                           worktreeStatus === 'done' ? '‚úì Worktrees Ready!' : 
                           worktreeStatus === 'error' ? '‚ùå Error (retry)' :
                           `‚ñ∂ Setup Worktrees`}
                        </button>
                        <button 
                          className={`btn ${launchingAll ? 'btn-warning' : 'btn-success'}`}
                          disabled={launchingAll}
                          onClick={async () => {
                            setLaunchingAll(true);
                            setLaunchAllProgress(0);
                            
                            // Launch each agent with a small delay to prevent overwhelming
                            for (let i = 0; i < nextBatch.length; i++) {
                              const ticket = nextBatch[i];
                              setLaunchAllProgress(i + 1);
                              
                              try {
                                await fetch('/api/launch-agent', {
                                  method: 'POST',
                                  headers: { 'Content-Type': 'application/json' },
                                  body: JSON.stringify({ ticketId: ticket.id })
                                });
                                
                                // Small delay between launches
                                await new Promise(r => setTimeout(r, 1000));
                              } catch (err) {
                                console.error(`Failed to launch ${ticket.id}:`, err);
                              }
                            }
                            
                            // Mark all as in progress
                            const newInProgress = nextBatch.map(ticket => ({
                              ticket_id: ticket.id,
                              title: ticket.title,
                              branch: `agent/${ticket.id.toLowerCase()}`,
                              started_at: new Date().toISOString(),
                              launch_notes: launchNotes[ticket.id] || null,
                              worktree_path: `../agent-worktrees/${ticket.id}`
                            }));
                            onSaveDevStatus({ 
                              ...devStatus, 
                              in_progress: [...inProgressItems, ...newInProgress] 
                            });
                            
                            // Copy all prompts to clipboard
                            copyAllBatch();
                            
                            setLaunchingAll(false);
                            setLaunchAllProgress(0);
                          }}
                        >
                          {launchingAll ? `üöÄ Launching ${launchAllProgress}/${nextBatch.length}...` : 
                           `üöÄ Launch All ${nextBatch.length} in Cursor`}
                        </button>
                      </div>
                    </div>
                  </div>
                )}
                
                {/* Worktree Status Display */}
                {worktreeResults.length > 0 && (
                  <div style={{ 
                    padding: '12px 16px', 
                    background: worktreeStatus === 'error' ? 'rgba(239,68,68,0.1)' : 'rgba(34,197,94,0.1)', 
                    borderRadius: '8px', 
                    marginBottom: '16px',
                    fontSize: '13px'
                  }}>
                    <strong>Worktree Setup Results:</strong>
                    <div style={{ marginTop: '8px', display: 'grid', gap: '4px' }}>
                      {worktreeResults.map(r => (
                        <div key={r.ticketId} style={{ display: 'flex', alignItems: 'center', gap: '8px' }}>
                          <span>{r.success ? '‚úÖ' : '‚ùå'}</span>
                          <code style={{ fontSize: '12px' }}>{r.ticketId}</code>
                          <span style={{ color: 'var(--text-muted)', fontSize: '12px' }}>
                            {r.success ? r.path : r.error}
                          </span>
                        </div>
                      ))}
                    </div>
                  </div>
                )}
                
                {(inProgressItems.length > 0 || completedItems.length > 0) && (
                  <div style={{ 
                    padding: '12px 16px', 
                    background: 'rgba(99,102,241,0.1)', 
                    borderRadius: '8px', 
                    marginBottom: '16px',
                    fontSize: '13px',
                    color: 'var(--text-secondary)'
                  }}>
                    ‚ö° <strong>{inProgressItems.length} running, {completedItems.length} for review</strong> ‚Äî locked files: {' '}
                    <code style={{ fontSize: '11px' }}>{[...lockedFiles].slice(0, 3).join(', ')}{lockedFiles.size > 3 ? ` +${lockedFiles.size - 3} more` : ''}</code>
                  </div>
                )}
                
                {nextBatch.length === 0 ? (
                  <div className="card" style={{ textAlign: 'center', padding: '40px', color: 'var(--text-muted)' }}>
                    <div style={{ fontSize: '36px', marginBottom: '12px' }}>üéâ</div>
                    <div style={{ fontSize: '16px', fontWeight: 500 }}>
                      {(inProgressItems.length > 0 || completedItems.length > 0) ? 'All remaining tickets conflict with pending branches' : 'No ready tickets'}
                    </div>
                  </div>
                ) : (
                  <div style={{ display: 'grid', gap: '12px' }}>
                    {/* Group by priority - ONLY show tickets that can be parallelized */}
                    {['critical', 'high', 'medium', 'low'].map(priority => {
                      const priorityTickets = nextBatch.filter(t => t.priority === priority);
                      if (priorityTickets.length === 0) return null;
                      
                      const priorityConfig = {
                        critical: { label: 'Critical', color: 'var(--critical)' },
                        high: { label: 'High', color: 'var(--high)' },
                        medium: { label: 'Medium', color: 'var(--medium)' },
                        low: { label: 'Low', color: 'var(--low)' }
                      };
                      const config = priorityConfig[priority];
                      
                      return (
                        <div key={priority}>
                          <div style={{ 
                            fontSize: '13px', 
                            fontWeight: 600, 
                            color: config.color, 
                            marginBottom: '10px',
                            marginTop: priority !== 'critical' ? '16px' : '0'
                          }}>
                            {config.label} ({priorityTickets.length})
                          </div>
                          
                          {priorityTickets.map((ticket) => {
                            const isExpanded = expandedTicket === ticket.id;
                            
                            return (
                              <div 
                                key={ticket.id} 
                                className="card" 
                                style={{ 
                                  marginBottom: '10px',
                                  borderLeft: `4px solid ${config.color}`
                                }}
                              >
                                {/* Ticket Header - Always Visible */}
                                <div 
                                  style={{ 
                                    padding: '14px 18px',
                                    cursor: 'pointer',
                                    display: 'flex',
                                    justifyContent: 'space-between',
                                    alignItems: 'flex-start'
                                  }}
                                  onClick={() => setExpandedTicket(isExpanded ? null : ticket.id)}
                                >
                                  <div style={{ flex: 1 }}>
                                    <div style={{ display: 'flex', alignItems: 'center', gap: '10px', flexWrap: 'wrap' }}>
                                      <code style={{ fontSize: '12px', padding: '3px 8px', background: 'var(--bg-elevated)', borderRadius: '4px' }}>{ticket.id}</code>
                                      <Badge type={ticket.priority}>{ticket.priority}</Badge>
                                      <Badge type={ticket.difficulty === 'easy' ? 'low' : ticket.difficulty === 'hard' ? 'critical' : 'medium'}>{ticket.difficulty}</Badge>
                                    </div>
                                    <div style={{ fontSize: '15px', fontWeight: 600, marginTop: '8px' }}>{ticket.title}</div>
                                    <div style={{ fontSize: '12px', color: 'var(--text-muted)', marginTop: '4px' }}>
                                      {ticket.feature} ‚Ä¢ {(ticket.files_to_modify || []).length} files ‚Ä¢ {(ticket.acceptance_criteria || []).length} criteria
                                    </div>
                                  </div>
                                  <div style={{ display: 'flex', alignItems: 'center', gap: '8px' }}>
                                    <span style={{ color: 'var(--text-muted)', fontSize: '12px' }}>{isExpanded ? '‚ñº' : '‚ñ∂'}</span>
                                  </div>
                                </div>
                                
                                {/* Expanded Content */}
                                {isExpanded && (
                                  <div style={{ padding: '0 18px 18px 18px', borderTop: '1px solid var(--border)' }}>
                                    {/* Issue */}
                                    <div style={{ marginTop: '16px' }}>
                                      <div style={{ fontSize: '11px', color: 'var(--text-muted)', textTransform: 'uppercase', marginBottom: '6px' }}>Issue</div>
                                      <div style={{ fontSize: '13px', color: 'var(--text-secondary)', lineHeight: 1.5 }}>{ticket.issue}</div>
                                    </div>
                                    
                                    {/* Files to Modify */}
                                    <div style={{ marginTop: '16px' }}>
                                      <div style={{ fontSize: '11px', color: 'var(--text-muted)', textTransform: 'uppercase', marginBottom: '6px' }}>Files to Modify</div>
                                      <div style={{ display: 'flex', flexWrap: 'wrap', gap: '6px' }}>
                                        {(ticket.files_to_modify || []).map((f, i) => (
                                          <code key={i} style={{ fontSize: '11px', padding: '4px 8px', background: 'var(--bg-elevated)', borderRadius: '4px', color: 'var(--accent-bright)' }}>{f}</code>
                                        ))}
                                      </div>
                                    </div>
                                    
                                    {/* Acceptance Criteria */}
                                    <div style={{ marginTop: '16px' }}>
                                      <div style={{ fontSize: '11px', color: 'var(--text-muted)', textTransform: 'uppercase', marginBottom: '6px' }}>Acceptance Criteria</div>
                                      <div style={{ display: 'grid', gap: '4px' }}>
                                        {(ticket.acceptance_criteria || []).map((c, i) => (
                                          <div key={i} style={{ fontSize: '12px', color: 'var(--text-secondary)', padding: '6px 10px', background: 'var(--bg-elevated)', borderRadius: '4px' }}>
                                            {c}
                                          </div>
                                        ))}
                                      </div>
                                    </div>
                                    
                                    {/* Feature Documentation */}
                                    {ticket.feature_docs && ticket.feature_docs.length > 0 && (
                                      <div style={{ marginTop: '16px' }}>
                                        <div style={{ fontSize: '11px', color: 'var(--text-muted)', textTransform: 'uppercase', marginBottom: '6px', display: 'flex', alignItems: 'center', gap: '6px' }}><Icons.file /> Feature Documentation</div>
                                        <div style={{ display: 'flex', flexWrap: 'wrap', gap: '6px' }}>
                                          {ticket.feature_docs.map((doc, i) => (
                                            <code key={i} style={{ fontSize: '11px', padding: '4px 8px', background: 'var(--bg-elevated)', borderRadius: '4px', color: 'var(--text-secondary)' }}>{doc}</code>
                                          ))}
                                        </div>
                                      </div>
                                    )}
                                    
                                    {/* Similar Code to Follow */}
                                    {ticket.similar_code && ticket.similar_code.length > 0 && (
                                      <div style={{ marginTop: '16px' }}>
                                        <div style={{ fontSize: '11px', color: 'var(--text-muted)', textTransform: 'uppercase', marginBottom: '6px' }}>Similar Code to Follow</div>
                                        <div style={{ display: 'grid', gap: '4px' }}>
                                          {ticket.similar_code.map((code, i) => (
                                            <div key={i} style={{ fontSize: '12px', color: 'var(--text-secondary)', padding: '6px 10px', background: 'var(--bg-elevated)', borderRadius: '4px' }}>{code}</div>
                                          ))}
                                        </div>
                                      </div>
                                    )}
                                    
                                    {/* Out of Scope */}
                                    {ticket.out_of_scope && ticket.out_of_scope.length > 0 && (
                                      <div style={{ marginTop: '16px' }}>
                                        <div style={{ fontSize: '11px', color: 'var(--critical)', textTransform: 'uppercase', marginBottom: '6px' }}>Out of Scope</div>
                                        <div style={{ display: 'grid', gap: '4px' }}>
                                          {ticket.out_of_scope.map((item, i) => (
                                            <div key={i} style={{ fontSize: '12px', color: 'var(--critical)', padding: '6px 10px', background: 'rgba(239,68,68,0.08)', borderRadius: '4px' }}>{item}</div>
                                          ))}
                                        </div>
                                      </div>
                                    )}
                                    
                                    {/* Dev Checks */}
                                    {ticket.dev_checks && ticket.dev_checks.length > 0 && (
                                      <div style={{ marginTop: '16px', padding: '12px', background: 'rgba(59,130,246,0.08)', borderRadius: '8px', border: '1px solid rgba(59,130,246,0.2)' }}>
                                        <div style={{ fontSize: '11px', color: 'var(--accent-bright)', fontWeight: 600, marginBottom: '6px' }}>Dev Checks (Before Submitting)</div>
                                        {ticket.dev_checks.map((check, i) => (
                                          <div key={i} style={{ fontSize: '12px', color: 'var(--text-secondary)', marginBottom: '4px' }}>{check}</div>
                                        ))}
                                      </div>
                                    )}
                                    
                                    {/* QA Notes */}
                                    {ticket.qa_notes && (
                                      <div style={{ marginTop: '16px', padding: '12px', background: 'rgba(251,191,36,0.08)', borderRadius: '8px', border: '1px solid rgba(251,191,36,0.2)' }}>
                                        <div style={{ fontSize: '11px', color: 'var(--medium)', fontWeight: 600, marginBottom: '6px' }}>QA Notes</div>
                                        <div style={{ fontSize: '12px', color: 'var(--text-secondary)' }}>{ticket.qa_notes}</div>
                                      </div>
                                    )}
                                    
                                    {/* Risks */}
                                    {(ticket.risks || []).length > 0 && (
                                      <div style={{ marginTop: '16px', padding: '12px', background: 'rgba(239,68,68,0.08)', borderRadius: '8px', border: '1px solid rgba(239,68,68,0.2)' }}>
                                        <div style={{ fontSize: '11px', color: 'var(--critical)', fontWeight: 600, marginBottom: '6px', display: 'flex', alignItems: 'center', gap: '4px' }}><Icons.warning /> Risks to Avoid</div>
                                        {(ticket.risks || []).map((r, i) => (
                                          <div key={i} style={{ fontSize: '12px', color: 'var(--text-secondary)', marginBottom: '4px' }}>‚Ä¢ {r}</div>
                                        ))}
                                      </div>
                                    )}
                                    
                                    {/* Launch Notes Input */}
                                    <div style={{ marginTop: '20px', padding: '16px', background: 'var(--bg-elevated)', borderRadius: '8px' }}>
                                      <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '8px' }}>
                                        <div style={{ fontSize: '12px', color: 'var(--text-muted)' }}>Notes for dev agent</div>
                                        {savedNotes[ticket.id] && (
                                          <span style={{ fontSize: '11px', color: 'var(--accent-bright)' }}>Saved</span>
                                        )}
                                      </div>
                                      <textarea
                                        value={launchNotes[ticket.id] || ''}
                                        onChange={e => {
                                          setLaunchNotes(prev => ({ ...prev, [ticket.id]: e.target.value }));
                                          setSavedNotes(prev => ({ ...prev, [ticket.id]: false }));
                                        }}
                                        placeholder="Add instructions for the dev agent..."
                                        style={{
                                          width: '100%',
                                          minHeight: '60px',
                                          padding: '10px 12px',
                                          background: 'var(--bg-surface)',
                                          border: '1px solid var(--border)',
                                          borderRadius: '6px',
                                          color: 'var(--text-primary)',
                                          fontSize: '13px',
                                          resize: 'vertical',
                                          marginBottom: '10px'
                                        }}
                                      />
                                      <button
                                        className="btn btn-sm btn-secondary"
                                        onClick={() => setSavedNotes(prev => ({ ...prev, [ticket.id]: true }))}
                                        disabled={!launchNotes[ticket.id]?.trim()}
                                        style={{ opacity: launchNotes[ticket.id]?.trim() ? 1 : 0.5 }}
                                      >
                                        <Icons.save /> Save Notes
                                      </button>
                                    </div>
                                    
                                    {/* Action Buttons */}
                                    <div style={{ marginTop: '16px', display: 'flex', gap: '10px', justifyContent: 'flex-end' }}>
                                      <button 
                                        className="btn btn-secondary"
                                        onClick={() => copyCommand(ticket.id, launchNotes[ticket.id])}
                                      >
                                        {copied === ticket.id ? '‚úì Copied!' : 'Copy Command'}
                                      </button>
                                      <button 
                                        className={`btn ${launchingTicket === ticket.id ? 'btn-warning' : copied === ticket.id ? 'btn-success' : 'btn-primary'}`}
                                        disabled={launchingTicket === ticket.id}
                                        onClick={() => launchAgent(ticket)}
                                      >
                                        {launchingTicket === ticket.id ? '‚è≥ Launching...' : 
                                         copied === ticket.id ? '‚úì Cursor Opened! Paste prompt' : 
                                         'üöÄ Launch in Cursor'}
                                      </button>
                                    </div>
                                  </div>
                                )}
                              </div>
                            );
                          })}
                        </div>
                      );
                    })}
                  </div>
                )}
                
                {/* Waiting tickets (file conflicts) - with detailed conflict info */}
                {(() => {
                  const waitingTickets = sortedTickets.filter(t => !nextBatchIds.has(t.id));
                  if (waitingTickets.length === 0) return null;
                  
                  // Build a map of which files conflict with which tickets
                  const getConflictDetails = (ticket) => {
                    const ticketFiles = ticket.files_to_modify || [];
                    const conflicts = [];
                    
                    // Check against locked files (in-progress + completed/in-review)
                    const lockedConflicts = ticketFiles.filter(f => lockedFiles.has(f));
                    if (lockedConflicts.length > 0) {
                      // Find which in-review ticket owns these files
                      const inReviewConflicts = [];
                      tickets.filter(t => completedTicketIds.has(t.id?.toUpperCase())).forEach(reviewTicket => {
                        const sharedFiles = lockedConflicts.filter(f => (reviewTicket.files_to_modify || []).includes(f));
                        if (sharedFiles.length > 0) {
                          inReviewConflicts.push({ ticket: reviewTicket.id, files: sharedFiles });
                        }
                      });
                      if (inReviewConflicts.length > 0) {
                        conflicts.push({ type: 'in-review', details: inReviewConflicts });
                      }
                    }
                    
                    // Check against batch files
                    const batchConflicts = [];
                    nextBatch.forEach(batchTicket => {
                      const sharedFiles = ticketFiles.filter(f => (batchTicket.files_to_modify || []).includes(f));
                      if (sharedFiles.length > 0) {
                        batchConflicts.push({ ticket: batchTicket.id, files: sharedFiles });
                      }
                    });
                    if (batchConflicts.length > 0) {
                      conflicts.push({ type: 'batch', details: batchConflicts });
                    }
                    
                    return conflicts;
                  };
                  
                  return (
                    <div style={{ marginTop: '24px' }}>
                      <details>
                        <summary style={{ 
                          cursor: 'pointer', 
                          padding: '12px 16px',
                          background: 'var(--bg-elevated)', 
                          borderRadius: '8px',
                          fontSize: '13px',
                          color: 'var(--text-muted)'
                        }}>
                          <strong>{waitingTickets.length} tickets excluded</strong> ‚Äî file conflicts (click to see details)
                        </summary>
                        <div style={{ marginTop: '8px', display: 'grid', gap: '8px' }}>
                          {waitingTickets.map(t => {
                            const conflicts = getConflictDetails(t);
                            return (
                              <div key={t.id} style={{ 
                                padding: '12px 14px', 
                                background: 'var(--bg-elevated)', 
                                borderRadius: '6px',
                                borderLeft: '3px solid var(--medium)'
                              }}>
                                <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'flex-start' }}>
                                  <div>
                                    <code style={{ fontSize: '12px', fontWeight: 600 }}>{t.id}</code>
                                    <span style={{ fontSize: '12px', color: 'var(--text-muted)', marginLeft: '8px' }}>{t.title?.substring(0, 40)}{t.title?.length > 40 ? '...' : ''}</span>
                                  </div>
                                  <Badge type={t.priority}>{t.priority}</Badge>
                                </div>
                                {conflicts.length > 0 && (
                                  <div style={{ marginTop: '8px', fontSize: '11px' }}>
                                    {conflicts.map((c, i) => (
                                      <div key={i} style={{ marginBottom: '4px' }}>
                                        {c.type === 'in-review' && (
                                          <span style={{ color: 'var(--medium)' }}>
                                            Conflicts with in-review: {c.details.map(d => `${d.ticket} (${d.files.map(f => f.split('/').pop()).join(', ')})`).join('; ')}
                                          </span>
                                        )}
                                        {c.type === 'batch' && (
                                          <span style={{ color: 'var(--accent-bright)' }}>
                                            Conflicts with batch: {c.details.map(d => `${d.ticket} (${d.files.map(f => f.split('/').pop()).join(', ')})`).join('; ')}
                                          </span>
                                        )}
                                      </div>
                                    ))}
                                  </div>
                                )}
                              </div>
                            );
                          })}
                        </div>
                      </details>
                    </div>
                  );
                })()}
              </div>
            )}
          </div>
        </div>
      );
    }

    // ================= MAIN APP =================

    function App() {
      const [view, setView] = useState('inbox');
      const [serverMode, setServerMode] = useState(false);
      const [findings, setFindings] = useState([]);
      const [tickets, setTickets] = useState([]);
      const [featuresList, setFeaturesList] = useState([]);
      const [devStatus, setDevStatus] = useState({ in_progress: [], completed: [] });
      const [docStatus, setDocStatus] = useState({ features: {} });
      const [agentOutputs, setAgentOutputs] = useState({ blocked: [], completions: [], started: [], findings: [], testLock: [] });
      const [serverDecisions, setServerDecisions] = useState(null);
      const [staging, setStaging] = useState({ count: 0, bySeverity: { critical: 0, high: 0, medium: 0, low: 0 } });
      const [loading, setLoading] = useState(true);
      const [lastRefresh, setLastRefresh] = useState(null);

      // Fetch data from server
      const fetchData = (showLoading = true) => {
        if (showLoading) setLoading(true);
        fetch('/api/data')
          .then(res => {
            if (res.ok) {
              setServerMode(true);
              return res.json();
            }
            throw new Error('Server not available');
          })
          .then(data => {
            if (data.findings?.findings) {
              setFindings(data.findings.findings);
              FINDINGS_DATA = data.findings.findings;
            }
            if (data.decisions) {
              setServerDecisions(data.decisions);
            }
            if (data.tickets?.tickets) {
              setTickets(data.tickets.tickets);
            }
            if (data.devStatus) {
              setDevStatus(data.devStatus);
            }
            if (data.agentOutputs) {
              setAgentOutputs(data.agentOutputs);
            }
            if (data.featuresList) {
              setFeaturesList(data.featuresList);
            }
            if (data.docStatus) {
              setDocStatus(data.docStatus);
            }
            if (data.staging) {
              setStaging(data.staging);
            }
            setLoading(false);
            setLastRefresh(new Date());
          })
          .catch(() => {
            setServerMode(false);
            setLoading(false);
            console.log('Server not available, using fallback data');
          });
      };

      // Initial load and auto-refresh every 30 seconds
      useEffect(() => {
        fetchData(true);
        
        const interval = setInterval(() => {
          fetchData(false); // Don't show loading spinner on auto-refresh
        }, 30000);
        
        return () => clearInterval(interval);
      }, []);

      // Save decisions to server
      const saveDecisions = async (decisions) => {
        const res = await fetch('/api/decisions', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(decisions)
        });
        if (!res.ok) throw new Error('Save failed');
      };
      
      // Save dev status
      const saveDevStatus = async (newStatus) => {
        try {
          const res = await fetch('/api/dev-status', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(newStatus)
          });
          if (!res.ok) throw new Error('Save failed');
          setDevStatus(newStatus);
        } catch (e) {
          console.error('Failed to save dev status:', e);
        }
      };

      return (
        <div style={{ minHeight: '100vh' }}>
          {/* Header */}
          <header style={{ padding: '24px 40px', borderBottom: '1px solid var(--border-subtle)', display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
            <div>
              <h1 style={{ fontSize: '24px', fontWeight: 800, background: 'var(--gradient-hero)', WebkitBackgroundClip: 'text', WebkitTextFillColor: 'transparent' }}>PM Dashboard</h1>
              <div style={{ display: 'flex', alignItems: 'center', gap: '8px', marginTop: '2px' }}>
                {serverMode && (
                  <span 
                    style={{ 
                      fontSize: '11px', 
                      color: 'var(--text-muted)', 
                      cursor: 'pointer',
                      display: 'flex',
                      alignItems: 'center',
                      gap: '4px'
                    }}
                    onClick={() => fetchData(true)}
                    title="Click to refresh now. Auto-refreshes every 30s"
                  >
                    ‚Üª {lastRefresh ? `Updated ${Math.floor((Date.now() - lastRefresh.getTime()) / 1000)}s ago` : 'Loading...'}
                  </span>
                )}
              </div>
              <div style={{ display: 'flex', alignItems: 'center', gap: '8px', marginTop: '2px' }}>
                <span style={{ color: 'var(--text-muted)', fontSize: '13px' }}>Digital Greeter ‚Ä¢ {new Date().toLocaleDateString()}</span>
                {serverMode && (
                  <span style={{ fontSize: '11px', padding: '4px 10px', background: 'rgba(59,130,246,0.15)', color: 'var(--accent-bright)', borderRadius: '6px', display: 'inline-flex', alignItems: 'center', gap: '6px', backdropFilter: 'blur(8px)' }}>
                    <StatusDot color="var(--accent)" /> Server Connected
                  </span>
                )}
                {!serverMode && !loading && (
                  <span style={{ fontSize: '11px', padding: '4px 10px', background: 'rgba(251,191,36,0.15)', color: 'var(--medium)', borderRadius: '6px', display: 'inline-flex', alignItems: 'center', gap: '6px', backdropFilter: 'blur(8px)' }}>
                    <Icons.warning /> Run server for auto-save
                  </span>
                )}
              </div>
            </div>
            <div className="nav">
              <button className={`nav-item ${view === 'inbox' ? 'active' : ''}`} onClick={() => setView('inbox')}>
                <Icons.inbox /> Inbox
                {(() => {
                  const pendingFindings = findings.filter(f => f.status !== 'ticketed' && f.status !== 'skipped');
                  const blockerCount = pendingFindings.filter(f => f.type === 'blocker').length;
                  const totalCount = pendingFindings.length;
                  if (totalCount === 0) return null;
                  return (
                    <span style={{ 
                      marginLeft: '6px', 
                      padding: '2px 6px', 
                      background: blockerCount > 0 ? 'var(--critical)' : 'var(--accent)', 
                      color: 'white', 
                      borderRadius: '10px', 
                      fontSize: '10px', 
                      fontWeight: 600 
                    }}>
                      {blockerCount > 0 ? `üö®${blockerCount}` : Math.min(totalCount, 99)}
                    </span>
                  );
                })()}
              </button>
              <button className={`nav-item ${view === 'pipeline' ? 'active' : ''}`} onClick={() => setView('pipeline')}><Icons.pipeline /> Pipeline</button>
              <button className={`nav-item ${view === 'launch' ? 'active' : ''}`} onClick={() => setView('launch')}>
                <Icons.launch /> Launch
                {(() => {
                  // Calculate launchable tickets (ready, not in progress, not completed)
                  const inProgressIds = new Set((devStatus?.in_progress || []).map(i => i.ticket_id?.toUpperCase()));
                  const completedIds = new Set((devStatus?.completed || []).map(c => c.ticket_id?.toUpperCase()));
                  const launchableCount = tickets.filter(t => 
                    t.status === 'ready' && 
                    !inProgressIds.has(t.id?.toUpperCase()) && 
                    !completedIds.has(t.id?.toUpperCase())
                  ).length;
                  return launchableCount > 0 && (
                    <span style={{ marginLeft: '6px', padding: '2px 6px', background: 'var(--accent)', color: 'white', borderRadius: '10px', fontSize: '10px', fontWeight: 600 }}>
                      {launchableCount}
                    </span>
                  );
                })()}
              </button>
            </div>
          </header>

          {/* Main Content */}
          <main style={{ padding: '32px 40px' }}>
            {loading ? (
              <div className="card" style={{ textAlign: 'center', padding: '60px' }}>
                <div style={{ fontSize: '24px', marginBottom: '12px' }}>‚ü≥</div>
                <div style={{ color: 'var(--text-muted)' }}>Loading...</div>
              </div>
            ) : (
              <>
                {view === 'inbox' && <InboxView 
                  serverMode={serverMode} 
                  onSave={saveDecisions} 
                  findingsData={findings} 
                  serverDecisions={serverDecisions}
                  onDecisionsChange={setServerDecisions}
                  agentOutputs={agentOutputs}
                  staging={staging}
                />}
                {view === 'pipeline' && <NewPipelineView 
                  tickets={tickets} 
                  devStatus={devStatus}
                  agentOutputs={agentOutputs}
                  onSaveDevStatus={saveDevStatus}
                  featuresList={featuresList}
                  findings={findings}
                />}
                {view === 'launch' && <LaunchView 
                  tickets={tickets}
                  devStatus={devStatus}
                  docStatus={docStatus}
                  onSaveDevStatus={saveDevStatus}
                  findings={findings}
                  serverDecisions={serverDecisions}
                  featuresList={featuresList}
                  agentOutputs={agentOutputs}
                />}
              </>
            )}
          </main>
        </div>
      );
    }

    ReactDOM.createRoot(document.getElementById('root')).render(<App />);
  </script>
</body>
</html>
