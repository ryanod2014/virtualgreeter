{
  "ticket": "TKT-005e",
  "branch": "agent/tkt-005e",
  "agent": "QA Agent",
  "status": "FAILED",
  "timestamp": "2025-12-07T01:22:14Z",
  "severity": "BLOCKER",
  "blockerType": "Acceptance Criterion Violation",
  "summary": "AC1 violation: Already-logged-in agents not forced offline when org becomes past_due",
  "acceptanceCriterion": "All agents forced offline when org status becomes past_due",
  "issue": {
    "description": "Agents who are already logged in and available when payment fails are NOT forced offline. Only new logins after the payment failure are caught. This violates the acceptance criterion which states 'ALL agents forced offline'.",
    "expectedBehavior": "When org payment fails and status becomes past_due, ALL currently logged-in agents should be immediately forced to 'away' status, regardless of when they logged in.",
    "actualBehavior": "Only agents logging in AFTER the payment failure are forced to 'away'. Agents already logged in remain 'idle' and continue receiving calls.",
    "testScenario": {
      "steps": [
        "1. Agents A, B, C are logged in and 'idle' (available for calls)",
        "2. Org payment fails → Webhook updates org status to 'past_due'",
        "3. Expected: All agents (A, B, C) immediately forced to 'away'",
        "4. Actual: Agents A, B, C remain 'idle' and continue receiving calls"
      ]
    },
    "rootCause": "AGENT_LOGIN check (socket-handlers.ts:458-465) only runs on new login events. There is no webhook integration or active monitoring to force existing logged-in agents offline when org status changes.",
    "impact": "Agents from organizations with payment failures can continue serving customers, violating the business requirement to restrict service for delinquent accounts. Creates inconsistent enforcement."
  },
  "recommendedFix": {
    "description": "Implement webhook integration in stripe-webhook-handler.ts to force existing agents offline",
    "location": "apps/server/src/features/billing/stripe-webhook-handler.ts - handleInvoicePaymentFailed()",
    "pseudocode": [
      "// After updating org status to 'past_due':",
      "const activeAgents = poolManager.getAgentsForOrg(orgId);",
      "for (const agent of activeAgents) {",
      "  if (agent.profile.status !== 'away') {",
      "    poolManager.updateAgentStatus(agent.agentId, 'away');",
      "    io.to(agent.socketId).emit('AGENT_MARKED_AWAY', {",
      "      reason: 'payment_failed',",
      "      message: getPaymentBlockedMessage()",
      "    });",
      "  }",
      "}"
    ],
    "additionalChanges": [
      "Add poolManager.getAgentsForOrg(orgId) method if not exists",
      "Import socket.io instance into webhook handler",
      "Test webhook triggers agent offline correctly"
    ]
  },
  "testResults": {
    "ac1_new_logins": "PASS",
    "ac1_existing_logins": "FAIL - BLOCKER",
    "ac2_block_toggle": "PASS",
    "ac3_widget_hidden": "PASS",
    "ac4_recovery": "PASS",
    "build_verification": "PASS (production code)",
    "edge_cases": "5 PASS, 2 PARTIAL"
  },
  "otherAcceptanceCriteria": {
    "ac2": "✅ PASS - Agents cannot toggle to 'available' while past_due",
    "ac3": "✅ PASS - Widget shows no available agents (via transitive logic)",
    "ac4": "✅ PASS - When payment resolved, agents can go available again"
  },
  "additionalIssues": [
    {
      "severity": "MEDIUM",
      "type": "Security Concern",
      "description": "Permissive failure mode on DB unavailability - payment checks bypassed if Supabase is down",
      "location": "agentStatus.ts:56-60",
      "blocksRelease": false,
      "recommendation": "Consider fail-closed approach for production reliability"
    },
    {
      "severity": "LOW",
      "type": "Pre-existing",
      "description": "26 TypeScript errors in test files (unrelated to this ticket)",
      "blocksRelease": false,
      "recommendation": "Fix in separate ticket as codebase-wide test quality improvement"
    }
  ],
  "qaReportPath": "docs/agent-output/qa-results/QA-TKT-005e-RETEST-BATCH.md",
  "recommendedAction": "DO NOT MERGE - Fix AC1 blocker before merging to main",
  "estimatedFixTime": "2-4 hours",
  "retestRequired": true
}
