{
  "ticket_id": "TKT-022",
  "ticket_title": "Enforce Seat Limit in API",
  "branch": "agent/tkt-022-enforce-seat-limit-in-api",
  "blocked_at": "2025-12-07T01:32:28Z",
  "blocker_type": "qa_failure",
  "summary": "Critical security vulnerabilities and zero test coverage - negative quantities bypass validation, no tests for new 50-seat limit",
  "failures": [
    {
      "category": "security",
      "criterion": "AC1: API rejects seat count > 50",
      "expected": "All attempts to exceed 50 seats should be blocked with validation errors",
      "actual": "Negative quantities bypass validation entirely - can manipulate seat counts with { action: 'add', quantity: -10 }",
      "evidence": "Code at route.ts:66-73 - newUsedSeats = currentUsedSeats + quantity allows negative values. No validation for quantity > 0. Example: 60 seats + (-10) = 50 bypasses all checks."
    },
    {
      "category": "security",
      "criterion": "Request validation",
      "expected": "Invalid action strings should return 400 error",
      "actual": "Invalid action strings are treated as 'remove' action instead of being rejected",
      "evidence": "Code at route.ts:66-68 uses ternary: action === 'add' ? ... : remove_logic. No validation that action is 'add' or 'remove'. Example: { action: 'hack', quantity: 10 } is treated as remove."
    },
    {
      "category": "acceptance",
      "criterion": "All acceptance criteria require test coverage",
      "expected": "New 50-seat limit validation should have comprehensive test coverage",
      "actual": "ZERO tests for the new limit validation - test file exists (route.test.ts) with 35 tests but none cover the 50-seat limit",
      "evidence": "Searched route.test.ts for '50', 'MAX_SEAT_LIMIT', 'Maximum seat' - no tests found. Existing tests only cover add/remove logic but not the new limit validation added in this ticket."
    },
    {
      "category": "validation",
      "criterion": "Input validation should reject invalid quantities",
      "expected": "Should reject decimal quantities and zero",
      "actual": "Accepts decimal quantities (e.g., 1.5) and zero quantities",
      "evidence": "Code at route.ts:38-40 only validates typeof quantity !== 'number' but doesn't check Number.isInteger() or quantity > 0"
    },
    {
      "category": "regression",
      "criterion": "Test coverage prevents regressions",
      "expected": "Automated tests protect against future breakage",
      "actual": "No automated tests for core feature = high regression risk",
      "evidence": "route.test.ts exists with tests for add/remove but missing: test for exceeding 50, test for boundary at 50, test for grandfathered org, test for negative/decimal quantities"
    }
  ],
  "recommendation": "Add input validation (quantity > 0, isInteger, valid action) and comprehensive test coverage before merge. Estimated 2-4 hours to fix.",
  "dispatch_action": "create_continuation_ticket",
  "continuation_requirements": [
    "Add validation: quantity must be positive integer (quantity > 0 && Number.isInteger(quantity))",
    "Add validation: action must be 'add' or 'remove' (reject invalid actions)",
    "Add test cases for: seats exceeding 50, boundary at 50, grandfathered orgs, negative quantities, decimal quantities, invalid actions",
    "Clarify with PM: Should /api/billing/update-settings also enforce 50-seat limit (potential bypass)?",
    "Run all tests and verify validation blocks exploits"
  ],
  "severity": "high",
  "blocks_merge": true
}
