# Completion Report: TKT-006

### Summary
Added `?next=` parameter to the middleware redirect so that unauthenticated users visiting protected routes are redirected to `/login?next=[original-path]`, allowing them to return to their intended destination after logging in.

### Acceptance Criteria Verification
| Criterion | Status | How Verified |
|-----------|--------|--------------|
| "Visiting `/dashboard` while logged out redirects to `/login`" | ✅ | Redirect already existed (line 56); verified code path unchanged |
| "Redirect URL includes `?next=/dashboard` parameter" | ✅ | Added `loginUrl.searchParams.set('next', request.nextUrl.pathname)` at line 57 |
| "Logged-in users can access protected paths normally" | ✅ | Redirect logic only triggers when `!user`, so authenticated users pass through unchanged |
| "No redirect loops occur" | ✅ | `/login` is in `authPaths` array (line 62), not `protectedPaths` (line 50), so no loop possible |

### Risk Avoidance Verification
| Risk | Avoided? | How |
|------|----------|-----|
| "Infinite redirect loop" | ✅ | `/login` is explicitly excluded from protectedPaths; only `/dashboard`, `/admin`, `/settings`, `/platform` are protected |
| "Breaking callback URLs" | ✅ | Did not touch auth callback handling; change only affects lines 55-59 |

### Files Changed
| File | Change Description |
|------|-------------------|
| `apps/dashboard/src/lib/supabase/middleware.ts` | Modified lines 55-59 to add `?next=` parameter with original pathname to login redirect |

### Documentation Impact
| Feature Doc | Why It Needs Update |
|-------------|---------------------|
| `docs/features/auth/login-flow.md` | The middleware redirect now includes `?next=` parameter; Line 143 of doc notes the redirect was "incomplete" - this is now fixed |

### Git Context for Re-Doc Agent
> The doc agent will read actual code changes, not trust this summary.
> This section helps PM triage which docs to re-document.

**Branch:** `agent/TKT-006-middleware-redirect`
**Key commits:**
- `c76980e` - TKT-006: Add ?next= parameter to login redirect for unauthenticated users

**Files changed (for git diff):**
- `apps/dashboard/src/lib/supabase/middleware.ts`

### UI Changes (if applicable)
N/A - This is backend middleware logic, no UI changes.

### How to Test
1. Log out of the dashboard (or open incognito window)
2. Visit `/dashboard` directly in browser
3. Verify redirect to `/login?next=/dashboard`
4. Try other protected paths like `/admin`, `/settings`, `/platform`
5. Verify each redirects to `/login?next=[path]`

### Findings Reported
- [x] I wrote findings files for all issues I noticed (or there were none)

| Finding ID | File Written | Title |
|------------|--------------|-------|
| F-DEV-TKT-006-1 | `docs/agent-output/findings/F-DEV-TKT-006-2025-12-05T1600.json` | Pre-existing type errors in billing test and workbench files |

### Notes
- The ticket spec mentioned `apps/dashboard/middleware.ts` but the actual redirect logic is in `apps/dashboard/src/lib/supabase/middleware.ts` (the main middleware.ts just delegates to the lib file)
- The redirect to `/login` already existed in the code; this ticket specifically adds the `?next=` parameter for destination preservation
- Pre-existing type errors in the codebase prevent `pnpm typecheck` from passing (recorded in findings)

