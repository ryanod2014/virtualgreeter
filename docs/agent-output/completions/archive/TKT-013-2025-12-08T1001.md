# Completion Report: TKT-013

### Summary
Implemented retention policy retroactive deletion warning system. When an admin reduces the recording retention period, a confirmation modal displays the exact count of recordings that will be deleted and requires typing "DELETE" to confirm before proceeding with the irreversible deletion.

### Acceptance Criteria Verification
| Criterion | Status | How Verified |
|-----------|--------|--------------|
| "Reducing retention triggers confirmation modal" | ✅ | Verified in code: recording-settings-client.tsx:86-125 detects retention reduction and shows modal |
| "Modal shows exact count of recordings to be deleted" | ✅ | Verified in code: countAffectedRecordings action queries DB and returns count, displayed in RetentionWarningModal:122 |
| "User must type 'DELETE' to confirm" | ✅ | Verified in code: RetentionWarningModal.tsx:33 validates confirmText === "DELETE" |
| "Deletion is logged for audit" | ✅ | Verified in code: actions.ts:88-92 logs deletion with org ID, retention days, and triggered by user |
| "Recordings older than new retention are deleted" | ✅ | Verified in code: actions.ts:59-78 calculates cutoff date and deletes recordings older than new retention period |

### Risk Avoidance Verification
| Risk | Avoided? | How |
|------|----------|-----|
| "Deletion is IRREVERSIBLE - confirmation must be very clear" | ✅ | Modal has large red warning box, shows exact count, requires typing DELETE, explains consequences |
| "Count affected recordings accurately before showing warning" | ✅ | countAffectedRecordings action queries call_logs table with proper date filtering before modal display |

### Files Changed
| File | Change Description |
|------|-------------------|
| `apps/dashboard/src/app/(app)/admin/settings/recordings/RetentionWarningModal.tsx` | Created new modal component (233 lines) with DELETE confirmation, shows count, explains consequences |
| `apps/dashboard/src/app/(app)/admin/settings/recordings/actions.ts` | Created server actions: countAffectedRecordings() and triggerRetentionDeletion() with audit logging |
| `apps/dashboard/src/app/(app)/admin/settings/recordings/recording-settings-client.tsx` | Added retention reduction detection logic, modal state management, and confirmation flow integration |

### Documentation Impact
| Feature Doc | Why It Needs Update |
|-------------|---------------------|
| `docs/features/admin/organization-settings.md` | Line 385 open question answered - retention changes are now retroactive with confirmation |
| `docs/features/admin/recording-settings.md` | Should document the new retroactive deletion confirmation flow and user experience |

### Git Context for Re-Doc Agent
> The doc agent will read actual code changes, not trust this summary.
> This section helps PM triage which docs to re-document.

**Branch:** `agent/tkt-013`
**Key commits:**
- `226b7d4` - TKT-013: Add retention policy retroactive deletion warning

**Files changed (for git diff):**
- `apps/dashboard/src/app/(app)/admin/settings/recordings/RetentionWarningModal.tsx`
- `apps/dashboard/src/app/(app)/admin/settings/recordings/actions.ts`
- `apps/dashboard/src/app/(app)/admin/settings/recordings/recording-settings-client.tsx`

### UI Changes
| Change | Description |
|--------|-------------|
| RetentionWarningModal | New confirmation modal with red warning styling, shows retention change summary (90 days → 30 days), displays exact count of affected recordings, shows 3 warning bullets (irreversible, transcriptions deleted, call logs remain), requires typing "DELETE" in input field, has Cancel and Delete buttons |

### How to Test
1. Navigate to Admin → Settings → Call Recording
2. Ensure you have recording_url entries in call_logs table older than various retention periods
3. Select a lower retention period (e.g., change from Forever to 30 days)
4. Click "Save Changes"
5. Verify modal appears showing the exact count of recordings that will be deleted
6. Verify you must type "DELETE" (all caps) to enable the confirm button
7. Click the delete button and verify recordings are removed (recording_url set to null)
8. Check console logs for audit trail entry
9. Test edge cases:
   - Increasing retention (no modal should appear)
   - Reducing but no old recordings exist (no modal, save proceeds normally)
   - Changing from Forever to any specific days (should trigger count check)
   - Typing "delete" in lowercase (should show error message)

### Findings Reported
- [ ] I wrote findings files for all issues I noticed (or there were none)

None - no issues noticed outside scope

### Notes
The implementation follows the existing pattern from CancelModal.tsx for the confirmation flow. The deletion is a "soft delete" (sets recording_url to null) rather than physically deleting files from storage. The actual file deletion would be handled by a separate background job in production (noted in TODO comment at actions.ts:94-97).

Pre-existing type errors exist in the codebase (admin-layout-client.test.tsx, calls-client.test.tsx, agent-stats-client.test.tsx, and widget tests) but these are unrelated to TKT-013 changes. The recording-settings-related files compile correctly within the Next.js build system.
