# QA Report: TKT-005b - FAILED ❌

**Ticket:** TKT-005b - Create Payment Failure Blocking Modal  
**Branch:** agent/tkt-005b  
**Tested At:** 2025-12-10T06:04:32Z  
**QA Agent:** qa-review-TKT-005b  

---

## Summary

**BLOCKED** - PaymentBlocker modal does not appear when org status is past_due. Critical server-side data caching bug prevents fresh organization data from reaching the layout component.

---

## Build Verification

| Check | Status | Notes |
|-------|--------|-------|
| pnpm install | ✅ PASS | Dependencies installed successfully |
| pnpm typecheck | ⚠️ PRE-EXISTING | Widget test errors exist on main branch - not caused by this ticket |
| pnpm lint | ⚠️ SKIPPED | Interactive prompt - skipped |
| pnpm build | ⚠️ NOT RUN | Proceeded with dev server per SOP |
| pnpm test | ⚠️ NOT RUN | Focused on browser testing |
| pnpm dev | ✅ PASS | Dashboard started successfully on port 3105 |

---

## Test Execution

### Test Setup
- Created admin user: `qa-admin-tkt005b-20251210060432@greetnow.test`
- Created agent user: `qa-agent-tkt005b-20251210060432@greetnow.test`
- Organization ID: `5fb6c644-a7a9-4804-8ec4-cdcf768d07e8`
- Set subscription_status to `past_due` via QA API
- Confirmed DB status: `past_due` ✓

### Admin Role Testing
1. **Login**: Successfully logged in as admin user ✅
2. **Navigate to /admin**: Loaded admin dashboard ✅
3. **Check for PaymentBlocker modal**: **FAILED** ❌
   - Expected: Full-screen blocking modal with "Update Payment Method" button
   - Actual: No modal appeared. Dashboard fully accessible.
   - Evidence: Screenshot saved to `.playwright-mcp/admin-no-modal-FAIL.png`

---

## Failures

### Failure 1: PaymentBlocker Modal Does Not Appear (AC1)

**Category:** acceptance  
**Criterion:** AC1 - "Full-screen modal appears when org status is 'past_due'"

**Expected:**
When `organization.subscription_status === 'past_due'`, the PaymentBlocker component should render and block the entire dashboard with a full-screen modal.

**Actual:**
Modal did NOT appear. Dashboard remained fully accessible. User can navigate to all admin pages without any payment warning.

**Evidence:**

1. **Database Verification** (via QA API):
```bash
$ curl http://localhost:3456/api/v2/qa/org-by-email/qa-admin-tkt005b-20251210060432@greetnow.test
{
  "organization": {
    "id": "5fb6c644-a7a9-4804-8ec4-cdcf768d07e8",
    "subscription_status": "past_due"  ← Correct in database
  }
}
```

2. **Component Code Review** (`PaymentBlocker.tsx`):
```tsx
// Component is correctly implemented ✓
export function PaymentBlocker({ isAdmin }: PaymentBlockerProps) {
  return (
    <div className="fixed inset-0 z-50 flex items-center justify-center">
      {/* Full-screen modal with backdrop */}
    </div>
  );
}
```

3. **Layout Integration** (`admin-layout-client.tsx:36-41`):
```tsx
// Integration is correct ✓
const isPastDue = organization.subscription_status === "past_due";
return (
  <div className="min-h-screen bg-background dark relative overflow-hidden">
    {isPastDue && <PaymentBlocker isAdmin={isAdmin} />}
    {/* ... rest of layout */}
  </div>
);
```

4. **Root Cause**:
The issue is in the server-side layout (`apps/dashboard/src/app/(app)/admin/layout.tsx:10-15`):
```tsx
export default async function AdminLayout({ children }: { children: React.ReactNode }) {
  const auth = await getCurrentUser(); // ← Returns STALE data
  
  return (
    <AdminLayoutClient
      organization={auth.organization} // ← organization.subscription_status = "active" (stale!)
      {/* ... */}
    />
  );
}
```

The `getCurrentUser()` function does not fetch fresh organization data. It returns cached/stale data with `subscription_status = "active"` even when the database shows `"past_due"`.

**Screenshot:** `.playwright-mcp/admin-no-modal-FAIL.png`

---

## Root Cause Analysis

**Server-Side Data Caching Bug**

The implementation has these parts working correctly:
1. ✅ PaymentBlocker component renders properly
2. ✅ Layout checks `organization.subscription_status === "past_due"`
3. ✅ Conditionally renders `<PaymentBlocker />` when past_due
4. ✅ Database contains correct "past_due" status

The bug is in `lib/auth/actions.ts` → `getCurrentUser()`:
- This function fetches user authentication data including organization details
- It either has aggressive caching OR doesn't properly join/fetch the latest organization data
- When subscription_status changes in the database, the layout continues receiving stale organization objects
- The client component never receives `isPastDue = true` because the server sends `subscription_status: "active"`

**Fix Required:**
The dev agent must modify `getCurrentUser()` to:
1. Fetch fresh organization data on every call (or implement proper cache invalidation)
2. Ensure the organization JOIN/query includes the latest `subscription_status` from the database
3. Add cache revalidation tags or disable caching for organization data

---

## Tests NOT Performed

Since AC1 (modal appears) completely failed, the following tests were not executed:
- ❌ AC2: Admin sees "Update Payment Method" button
- ❌ AC3: Agent sees "Contact your admin" message  
- ❌ AC4: Modal cannot be dismissed
- ❌ Edge case: ESC key / backdrop click
- ❌ Edge case: Navigation persistence
- ❌ Mobile viewport testing

These tests require the modal to actually appear first.

---

## Recommendation for Dispatch

**CREATE CONTINUATION TICKET**

The dev agent must fix the server-side data fetching bug before this feature can work.

**Specific tasks for continuation ticket:**
1. **Debug `getCurrentUser()` in `lib/auth/actions.ts`**
   - Add logging to see what organization data is returned
   - Check if Supabase query includes fresh organization data
   - Identify caching layer (Next.js cache, React cache, Supabase cache)

2. **Fix data fetching**
   - Ensure organization data is fetched fresh on every page load
   - Add `revalidate: 0` or similar cache opt-out for organization queries
   - Consider using `unstable_noStore()` in Next.js 14

3. **Test cache invalidation**
   - Change subscription_status in database
   - Hard refresh page
   - Verify layout receives fresh data

4. **Re-run QA**
   - After fix, re-test all 4 acceptance criteria
   - Test both admin and agent roles
   - Test edge cases (ESC, backdrop, navigation)

---

## DO NOT MERGE

This branch should NOT be merged until the data fetching bug is resolved. The feature appears implemented but does not function due to stale server-side data.

---

## Test Artifacts

- Test users: `qa-admin-tkt005b-20251210060432@greetnow.test`, `qa-agent-tkt005b-20251210060432@greetnow.test`
- Organization ID: `5fb6c644-a7a9-4804-8ec4-cdcf768d07e8`
- Screenshot: `.playwright-mcp/admin-no-modal-FAIL.png`
- Blocker JSON: `docs/agent-output/blocked/QA-TKT-005b-FAILED-20251209T2307.json`

