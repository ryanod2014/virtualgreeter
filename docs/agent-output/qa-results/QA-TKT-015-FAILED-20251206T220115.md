# QA Review: TKT-015

**Status:** ❌ FAILED
**Ticket:** TKT-015 - Secure Recording URLs with Signed Access
**Branch:** agent/tkt-015
**Tested:** 2025-12-06T22:01:15Z

## Build Verification

| Check | Status | Notes |
|-------|--------|-------|
| pnpm install | ✅ PASSED | Dependencies installed successfully |
| pnpm typecheck | ⚠️ WARNING | Pre-existing widget test type errors (not TKT-015 related) |
| pnpm build | ❌ FAILED | **TKT-015 files have import path errors** |
| pnpm test | ⏭️ SKIPPED | Cannot run due to build failure |

## Build Failures (Blocking)

### Critical Errors in TKT-015 Files

**File:** `apps/server/src/features/recordings/getRecordingUrl.ts:1:26`
```
error TS2835: Relative import paths need explicit file extensions in ECMAScript imports when '--moduleResolution' is 'node16' or 'nodenext'.
Did you mean '../../lib/supabase.js'?
```

**File:** `apps/server/src/features/recordings/uploadRecording.ts:2:26`
```
error TS2835: Relative import paths need explicit file extensions in ECMAScript imports when '--moduleResolution' is 'node16' or 'nodenext'.
Did you mean '../../lib/supabase.js'?
```

**Root Cause:** Both files import from `"../../lib/supabase"` but need `"../../lib/supabase.js"` to satisfy TypeScript's ESM module resolution requirements.

## Code Review Against Acceptance Criteria

Despite the build failure, I reviewed the implementation for completeness:

### ✅ Acceptance Criterion 1: New recordings go to private bucket
**Status:** IMPLEMENTED
- **Evidence:** `apps/server/src/features/recordings/uploadRecording.ts:48-53`
  - Uses `supabase.storage.from("recordings")` bucket
  - No public URL generation in upload flow
  - Recording ID stored in `call_logs.recording_url` (line 68)
- **API Route:** `apps/dashboard/src/app/api/recordings/upload/route.ts:68-74`

### ✅ Acceptance Criterion 2: Recording URLs are signed with 1-hour expiration
**Status:** IMPLEMENTED
- **Evidence:** `apps/server/src/features/recordings/getRecordingUrl.ts:26,42-44`
  - Default expiration: `3600` seconds (1 hour)
  - Uses `supabase.storage.createSignedUrl(filePath, expiresIn)`
  - Returns `expiresAt` timestamp (line 62)
- **API Route:** `apps/dashboard/src/app/api/recordings/url/route.ts:12,75-77`

### ✅ Acceptance Criterion 3: URLs contain randomized UUIDs
**Status:** IMPLEMENTED
- **Evidence:** `apps/server/src/features/recordings/uploadRecording.ts:39`
  - Uses `randomUUID()` from Node.js crypto module
  - Path format: `{organizationId}/{recordingId}.webm` (line 43)
  - No predictable pattern based on org/call IDs
- **API Route:** `apps/dashboard/src/app/api/recordings/upload/route.ts:56`

### ✅ Acceptance Criterion 4: Playback works with signed URLs
**Status:** IMPLEMENTED
- **Evidence:** `apps/dashboard/src/features/recordings/RecordingPlayer.tsx:42-107`
  - Fetches signed URL via `/api/recordings/url` (line 51)
  - Renders `<video>` element with signed URL (line 152-161)
  - Handles loading and error states (lines 123-144)

### ✅ Acceptance Criterion 5: URL refreshes automatically if user watches longer than 1 hour
**Status:** IMPLEMENTED
- **Evidence:** `apps/dashboard/src/features/recordings/RecordingPlayer.tsx:87-99`
  - Schedules refresh 15 minutes before expiration (line 93)
  - Preserves playback position during refresh (lines 71-85)
  - Resumes playback automatically if video was playing (lines 80-84)

## Security Review

### ✅ Authorization Checks
- **Upload API:** Verifies user authentication and organization ownership (upload/route.ts:18-40)
- **URL API:** Verifies recording belongs to user's organization (url/route.ts:54-67)
- **Call Log Update:** Ensures user owns the call log with org_id check (upload/route.ts:92)

### ✅ Private Bucket Access
- Recordings stored with randomized UUIDs prevent enumeration attacks
- No public URLs generated - all access through signed URLs
- Signed URLs expire after 1 hour, limiting exposure window

## Regression Risk Assessment

**Risk Level:** LOW

The changes are isolated to:
1. New files: `uploadRecording.ts`, `getRecordingUrl.ts`
2. New API routes: `/api/recordings/upload`, `/api/recordings/url`
3. New component: `RecordingPlayer.tsx`

**Existing recording functionality:** Not modified - this is additive functionality.

## Summary

The implementation **correctly addresses all 5 acceptance criteria** with proper security controls and automatic URL refresh. However, the build fails due to a **TypeScript configuration requirement** for explicit `.js` extensions in import paths.

## Required Fix

Change line 1 in both files:

**Before:**
```typescript
import { supabase } from "../../lib/supabase";
```

**After:**
```typescript
import { supabase } from "../../lib/supabase.js";
```

**Files to modify:**
1. `apps/server/src/features/recordings/getRecordingUrl.ts`
2. `apps/server/src/features/recordings/uploadRecording.ts`

## Recommendation

**DO NOT MERGE** - Create continuation ticket to fix TypeScript import paths, then re-run QA.

---

## Pre-existing Issues (Not Blocking)

The following issues exist in the codebase but are **not related to TKT-015**:

1. **Widget typecheck errors:** Test files with type mismatches (e.g., `LiveCallView.test.tsx`, `useWebRTC.test.ts`)
2. **Server typecheck errors:** Test files with unused variables and type issues

These should be tracked separately and not block TKT-015.
