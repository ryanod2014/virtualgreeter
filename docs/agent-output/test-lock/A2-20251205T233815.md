# Test Lock Complete: A2

## Summary
- **Feature:** A2 - Incoming Call
- **Status:** COMPLETE
- **Completed At:** 2025-12-05T23:38:15Z

## Test Files Created

| Test File | Behaviors Covered |
|-----------|-------------------|
| `apps/dashboard/src/features/workbench/incoming-call-modal.test.tsx` | 34 |
| `apps/dashboard/src/features/workbench/hooks/useIncomingCall.test.ts` | 31 |
| `apps/server/src/features/signaling/socket-handlers.test.ts` | Pre-existing file extended - now 115 tests covering call lifecycle |

**Total New Tests Added:** 65 tests

## Behaviors Locked In

### incoming-call-modal.tsx

| Area | Behaviors Tested |
|------|------------------|
| **Display - Visitor ID** | 1. Shows visitor ID truncated to 20 chars with ellipsis, 2. Consistent truncation for any ID length, 3. Displays 'Visitor ID' label |
| **Display - Page URL** | 4. Shows full page URL, 5. Displays 'Page URL' label, 6. Truncates long URLs with CSS |
| **Display - Location** | 7. Shows location with country flag, 8. Shows 'Unknown location' when null, 9. Displays 'Location' label |
| **Display - Countdown** | 10. Shows countdown starting at 30s, 11. Decrements every second, 12. Shows progress bar, 13. Timer continues when call changes (current behavior) |
| **Display - Time on Page** | 14. Shows time in M:SS format, 15. Displays 'Time on page' label, 16. Pads seconds correctly |
| **Display - Modal** | 17. Returns null when incomingCall null, 18. Renders modal when call provided, 19. Shows subtitle text |
| **Actions - Accept** | 20. Calls onAccept with requestId, 21. Has green success styling, 22. Shows Phone icon |
| **Actions - Reject** | 23. Calls onReject with requestId and 'Busy', 24. Has red destructive styling, 25. Shows PhoneOff icon |
| **Edge Cases** | 26-29. Handles short IDs, zero time, missing location, timer cleanup |
| **Visual Elements** | 30-34. Full-screen backdrop, pulsing icon, ping animation, glass effect |

### useIncomingCall.ts

| Function | Behaviors Tested |
|----------|------------------|
| **AudioContext** | 1. Creates AudioContext when initializing |
| **startRinging** | 2. Dual-tone ring (440Hz + 480Hz), 3. Browser notification with requireInteraction, 4. Title flash interval, 5. Fallback alert when blocked |
| **stopRinging** | 6. Clears ring interval, 7. Closes browser notification, 8. Clears title flash, 9. Removes fallback alert |
| **Notification** | 10. Returns false when API not supported, 11. Updates permission state, 12. Handles denied gracefully |
| **Audio Pattern** | 13. Uses 440Hz + 480Hz frequencies, 14. 1000ms ring, 2000ms pause, 15. 3000ms total interval |
| **Title Flash** | 16-17. Alternates messages, flashes every 800ms |
| **State Management** | 18-19. Prevents duplicate calls, allows restart after stop |
| **Cleanup** | 20-21. Calls stopRinging on unmount, closes AudioContext |
| **Fallback Alert** | 22-25. Correct styles, removes existing, click handler behavior |
| **Integration** | 26-31. All channels activate, stop on accept/reject/cancel, background behavior |

### socket-handlers.ts (Call Request Handlers)

| Handler | Behaviors Tested |
|---------|------------------|
| **CALL_REQUEST** | Creates CallRequest in pool manager, Updates visitor state, Stores in pendingCalls |
| **CALL_ACCEPT** | Creates ActiveCall, Removes from pendingCalls, Updates visitor/agent state, Returns undefined for invalid |
| **CALL_REJECT** | Removes request, Keeps visitor in call_requested state for reroute |
| **RNA Timeout** | Skips away/in_call/offline agents, Returns undefined when all unavailable, updateAgentStatus works correctly |
| **Rerouting** | excludeAgentId works, reassignVisitors handles all scenarios |
| **Max Duration** | Tracks startedAt, call can end before timeout, proper state queries |

## Test Run Results

```
✓ incoming-call-modal.test.tsx - 34 tests passed
✓ useIncomingCall.test.ts - 31 tests passed
✓ socket-handlers.test.ts - 115 tests passed (all call lifecycle tests)
✓ All workbench feature tests - 124 tests passed
```

**Note:** Pre-existing tests in `apps/dashboard/src/app/paywall/billing/page.test.tsx` are failing due to React import issues unrelated to this feature. These failures existed before this test lock task.

## Configuration Changes

Updated `apps/dashboard/vitest.config.ts`:
- Added `esbuild: { jsx: "automatic" }` to enable automatic JSX runtime for component tests

## Notes

1. **Timer Reset Behavior:** The countdown timer in `IncomingCallModal` does NOT reset when switching between incoming calls - it only resets when `incomingCall` becomes null. This is captured in the test as current behavior, though it may be a bug (the UI shows countdown from where it was, not from 30s for the new call).

2. **Mock Patterns:** Following existing patterns in the codebase:
   - `@vitest-environment jsdom` directive for React component tests
   - `vi.mock()` for external dependencies (lucide-react, utility functions)
   - `vi.useFakeTimers()` for timer-based tests

3. **Comprehensive Coverage:** Tests cover all behaviors listed in the task spec including:
   - Display behaviors for all UI elements
   - Accept/Reject button actions
   - All notification channels (audio, browser notification, title flash, fallback alert)
   - Edge cases and error handling

4. **Socket Handler Tests:** The existing `socket-handlers.test.ts` already had comprehensive tests for CALL_REQUEST, CALL_ACCEPT, and CALL_REJECT behaviors via the PoolManager. These tests were verified to pass and cover the behaviors specified in the task.

