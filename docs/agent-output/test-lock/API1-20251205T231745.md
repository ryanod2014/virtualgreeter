# Test Lock Complete: API1

## Summary
- **Feature:** Agent API
- **Status:** PARTIAL COMPLETE
- **Completed At:** 2025-12-05T23:17:45Z

## Test Files Created

| Test File | Behaviors Covered |
|-----------|-------------------|
| `apps/dashboard/src/app/api/agents/remove/route.test.ts` | 14 |
| `apps/server/src/features/agents/agentStatus.test.ts` | 22 |

**Total Tests:** 36

## Behaviors Locked In

### remove/route.ts (POST /api/agents/remove)

| Method | Behaviors Tested |
|--------|------------------|
| POST | 1. Returns 401 if user is not authenticated, 2. Returns 403 if user is not an admin, 3. Returns 403 if user profile is not found, 4. Returns 400 when agentProfileId is missing, 5. Returns 404 when agent is not found, 6. Returns 404 when agent belongs to different org (cross-org protection), 7. Returns 400 when agent is already deactivated, 8. Returns success when agent is removed, 9. Soft deletes by setting is_active to false, 10. Removes agent from all pools, 11. Credits back the billing seat, 12. Forwards cookies to billing API for authentication, 13. Returns 500 when update fails, 14. Returns 500 when unexpected error occurs |

### agentStatus.ts

| Function | Behaviors Tested |
|----------|------------------|
| `isOrgPastDue` | 1. Returns true when subscription is past_due, 2. Returns false when active, 3. Returns false when trialing, 4. Returns false when cancelled, 5. Returns false when paused |
| `canAgentGoAvailable` | 1. Allows when subscription is active, 2. Allows when trialing, 3. Blocks with reason "payment_failed" when past_due, 4. Blocks with reason "subscription_cancelled" when cancelled, 5. Blocks with reason "subscription_paused" when paused |
| `getPaymentBlockedMessage` | 1. Returns correct payment blocked message |
| `isOrgOperational` | 1. Returns true when active, 2. Returns true when trialing, 3. Returns false when past_due, 4. Returns false when cancelled, 5. Returns false when paused |
| `getAgentOrgId` | 1. Returns organization_id when agent found, 2. Queries agent_profiles with correct agent id, 3. Returns null when agent not found, 4. Returns null on database error, 5. Returns null when supabase throws exception |

## Test Run Results

```
✓ 14 tests passed (route.test.ts)
✓ 22 tests passed (agentStatus.test.ts)
```

## Files NOT Tested

### apps/dashboard/src/app/api/agents/route.ts (GET agents list)

**Reason:** File does not exist.

Per the feature documentation (`docs/features/api/agent-api.md`), the Agent API uses a **hybrid architecture**:
- Most CRUD operations use direct Supabase client calls from the client component (`agents-client.tsx`)
- Only billing-integrated actions like remove and invites have dedicated REST endpoints

The doc explicitly notes: "No dedicated list/get/update REST endpoints - All CRUD except delete via client Supabase"

### apps/dashboard/src/app/api/agents/[id]/route.ts (GET/PATCH/DELETE agent)

**Reason:** File does not exist.

Same as above - these operations are performed via direct Supabase calls in the client component, not through REST endpoints.

### What EXISTS vs What Was Expected

| Expected in Prompt | Actually Exists | Status |
|--------------------|-----------------|--------|
| `apps/dashboard/src/app/api/agents/route.ts` | ❌ No | NOT TESTED - Does not exist |
| `apps/dashboard/src/app/api/agents/[id]/route.ts` | ❌ No | NOT TESTED - Does not exist |
| `apps/server/src/features/agents/agentStatus.ts` | ✅ Yes | TESTED ✓ |
| `apps/dashboard/src/app/api/agents/remove/route.ts` | ✅ Yes (discovered) | TESTED ✓ |

## Existing Agent API Endpoints

The actual REST endpoints for Agent API are:

| Endpoint | File | Status |
|----------|------|--------|
| POST `/api/agents/remove` | `apps/dashboard/src/app/api/agents/remove/route.ts` | TESTED ✓ |
| POST `/api/invites/send` | `apps/dashboard/src/app/api/invites/send/route.ts` | OUT OF SCOPE (covered in API3) |
| POST `/api/invites/revoke` | `apps/dashboard/src/app/api/invites/revoke/route.ts` | OUT OF SCOPE (covered in API3) |

## Notes

1. **Architecture mismatch:** The prompt expected REST endpoints that don't exist. The system uses direct Supabase client calls for most agent operations. This is documented in the feature spec as a design decision (not an oversight).

2. **Test coverage achieved:** Despite the missing files, 100% of the existing Agent API-related code was tested:
   - `remove/route.ts` - Full behavior coverage
   - `agentStatus.ts` - Full behavior coverage

3. **Related features:** Invite-related endpoints (`/api/invites/send`, `/api/invites/revoke`) are documented as part of API3 (Invites API) and should be tested separately.

4. **Client-side operations not tested:** The following operations happen in `agents-client.tsx` via direct Supabase calls and are not testable as REST API behaviors:
   - List agents (Supabase query)
   - Update agent name (Supabase update)
   - Add agent to pool (Supabase insert)
   - Remove agent from pool (Supabase delete)
   - Add self as agent (Supabase insert/update)

## Quality Checklist

- [x] **Every existing file tested** (2 of 2 existing files)
- [x] **Every exported function has tests** (agentStatus.ts: 5 functions, all tested)
- [x] **Every code path covered** (happy, edge, error for all endpoints)
- [x] **Test names describe specific behaviors**
- [x] **All tests pass** (36/36 passing)
- [x] **Followed existing test patterns** (matched billing/seats/route.test.ts and geolocation.test.ts)
- [x] **Tests are in correct location** (same dir as source)
- [x] **Mocks match codebase patterns**
- [x] **Completion report written**
- [ ] **route.ts tested** — DOES NOT EXIST
- [ ] **[id]/route.ts tested** — DOES NOT EXIST




