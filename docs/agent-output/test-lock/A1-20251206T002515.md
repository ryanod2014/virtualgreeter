# Test Lock Complete: A1

## Summary
- **Feature:** Bullpen & Agent States
- **Status:** COMPLETE
- **Completed At:** 2025-12-06T00:25:15Z

## Test Files Created/Verified

| Test File | Behaviors Covered |
|-----------|-------------------|
| `apps/dashboard/src/features/signaling/use-signaling.test.ts` | 16 |
| `apps/dashboard/src/features/workbench/hooks/useIdleTimer.test.ts` | 29 |
| `apps/dashboard/src/features/workbench/hooks/useHeartbeat.test.ts` | 30 |
| `apps/server/src/features/routing/pool-manager.test.ts` | 49 |
| `apps/server/src/features/signaling/socket-handlers.test.ts` | 115 |

**Total: 239 tests**

## Behaviors Locked In

### use-signaling.ts

| Function | Behaviors Tested |
|----------|------------------|
| `setAway` | 1. Emits agent:away with 'idle' reason, 2. Emits agent:away with 'manual' reason, 3. Retries up to 3 times on ack timeout, 4. Retries up to 3 times when socket disconnected, 5. Sets isMarkedAway=true on successful ack, 6. Sets awayReason message based on reason type, 7. Sets isMarkedAway=true even after max retries (fallback) |
| `setBack` | 1. Emits agent:back event, 2. Retries up to 3 times on ack timeout, 3. Retries up to 3 times when socket disconnected, 4. Clears isMarkedAway on successful ack, 5. Clears isMarkedAway even after max retries (fallback) |
| `handleAgentMarkedAway` | 1. Sets isMarkedAway=true when receiving event, 2. Sets awayReason from payload message, 3. Handles idle reason message, 4. Clears incoming call when marked away |

### useIdleTimer.ts

| Area | Behaviors Tested |
|------|------------------|
| **Idle Detection** | 1. Detects inactivity after configured timeout (5 min default), 2. Does not mark idle before timeout, 3. Uses configurable timeout value, 4. Resets on mouse/keyboard/scroll/touch events, 5. Tracks all activity event types |
| **Web Worker** | 1. Uses Web Worker when available, 2. Falls back to setTimeout when Worker unavailable, 3. Worker posts tick messages every second, 4. Worker posts idle message when timeout reached, 5. Worker resets elapsed on reset message, 6. Worker stops interval on stop message |
| **Hidden Tab** | 1. Shows browser notification when tab hidden and idle, 2. Uses 60 second grace period for notification response, 3. Starts visibility grace period when notifications not permitted, 4. Returns to active state when tab becomes visible during grace, 5. Immediately marks idle when tab is visible |
| **Callbacks** | 1. Fires onIdle callback when idle confirmed, 2. Fires onActive callback when user returns from idle, 3. Does not fire onActive when already active, 4. Keeps callback refs fresh via useRef pattern |
| **Timer Management** | 1. Provides resetTimer function to manually reset, 2. Provides markActive function for manual activation, 3. Provides timeUntilIdle for countdown UI, 4. Cleans up on unmount, 5. Does not track activity when disabled, 6. Stops worker when disabled |

### useHeartbeat.ts

| Area | Behaviors Tested |
|------|------------------|
| **Heartbeat Sending** | 1. Sends heartbeat every 25 seconds, 2. Emits heartbeat event with timestamp, 3. Updates lastHeartbeat timestamp on send, 4. Skips heartbeat when socket not connected |
| **Web Worker** | 1. Uses Web Worker when available, 2. Worker posts heartbeat messages at interval, 3. Falls back to setInterval when Worker fails, 4. Fallback interval still sends heartbeats, 5. Worker responds to start/stop/ping messages |
| **Connection Health** | 1. Tracks isConnectionHealthy state, 2. Marks connection as stale after 60 seconds without heartbeat, 3. Calls onConnectionStale callback when stale detected, 4. Connection remains healthy when heartbeats are regular |
| **Tab Visibility** | 1. Sends immediate heartbeat when tab becomes visible, 2. Checks connection health when tab becomes visible, 3. Attempts socket reconnect if disconnected when tab visible, 4. Does not reconnect if already connected |
| **State Management** | 1. Tracks isWorkerActive state, 2. Sets isWorkerActive=false on worker error, 3. Cleans up worker on unmount |

### pool-manager.ts

| Function | Behaviors Tested |
|----------|------------------|
| `updateAgentStatus` | 1. Updates agent.profile.status to 'away', 2. Updates agent.profile.status to 'idle', 3. Updates agent.profile.status to 'offline', 4. Updates agent.profile.status to 'in_simulation', 5. Does not throw when agent does not exist, 6. Does not affect other agents |
| `updateAgentActivity` | 1. Updates lastActivityAt to current time, 2. Does not throw when agent does not exist |
| `getStaleAgents` | 1. Returns agents whose lastActivityAt exceeds threshold, 2. Only checks idle agents - skips agents in_call, 3. Only checks idle agents - skips agents already away, 4. Returns empty array when all agents are active |

### socket-handlers.ts (Agent Status Events)

| Handler | Behaviors Tested |
|---------|------------------|
| **Agent Status Filtering** | 1. findBestAgent skips agents with status 'away', 2. findBestAgent skips agents with status 'in_call', 3. findBestAgent skips agents with status 'offline', 4. Returns undefined when all agents unavailable |
| **AGENT_AWAY implied** | 1. updateAgentStatus marks agent as 'away', 2. reassignVisitors moves visitors to available agents, 3. Unassigned visitors marked when no agents available |
| **AGENT_BACK implied** | 1. updateAgentStatus marks agent as 'idle', 2. Agent becomes available for routing again |
| **Staleness Check** | 1. getStaleAgents returns idle agents without recent activity, 2. Stale threshold is configurable, 3. In-call and away agents excluded from staleness check |

## Test Run Results

```
Dashboard tests:
 ✓ src/features/signaling/use-signaling.test.ts (16 tests) 151ms
 ✓ src/features/workbench/hooks/useHeartbeat.test.ts (30 tests) 227ms
 ✓ src/features/workbench/hooks/useIdleTimer.test.ts (29 tests) 201ms

Server tests:
 ✓ src/features/routing/pool-manager.test.ts (49 tests) 73ms
 ✓ src/features/signaling/socket-handlers.test.ts (115 tests) 218ms

Total: 239 tests passed, 0 failed
```

## Notes

1. **Test Structure:** All test files already existed with comprehensive behavior coverage. The existing tests follow the SOP patterns and capture current behavior at the behavior level.

2. **Coverage Highlights:**
   - The `use-signaling.test.ts` tests use mock socket patterns to test retry logic without actual socket connections
   - The `useIdleTimer.test.ts` and `useHeartbeat.test.ts` tests simulate Web Worker behavior and fallback scenarios
   - The `pool-manager.test.ts` tests directly test the PoolManager class methods with fake timers for staleness detection
   - The `socket-handlers.test.ts` tests cover the full call lifecycle, agent status management, and co-browse relay behaviors

3. **Existing Patterns Used:**
   - `vi.useFakeTimers()` for timeout and interval testing
   - Mock socket objects with `emit`, `connected`, and `connect` methods
   - Direct PoolManager instance testing for server-side logic
   - Behavior-level assertions (one behavior per `it()` block)

4. **Behaviors Captured (not fixed):**
   - The tests capture current behavior including:
     - Round-robin agent selection may leave some visitors unassigned during reassignment (line 707-712 in pool-manager.test.ts)
     - Fallback behavior sets local state even after max retries failed
     - Staleness check only targets idle agents (not in_call or already away)




