# Test Lock Complete: P6

## Summary
- **Feature:** Heartbeat & Staleness Detection
- **Status:** COMPLETE
- **Completed At:** 2025-12-06T18:13:00

## Test Files Created/Updated

| Test File | Behaviors Covered |
|-----------|-------------------|
| `apps/server/src/features/routing/pool-manager.test.ts` | 7 (already existed) |
| `apps/server/src/features/signaling/socket-handlers.test.ts` | 23 (12 new + 11 existing) |
| `apps/dashboard/src/features/workbench/hooks/useHeartbeat.test.ts` | 30 (already existed) |

## Behaviors Locked In

### pool-manager.ts (Already Tested - Verified)

| Function | Behaviors Tested |
|----------|------------------|
| `updateAgentActivity` | 1. Sets lastActivityAt to current timestamp, 2. Does not throw when agent not found |
| `getStaleAgents` | 1. Returns agents with status="idle" and lastActivityAt older than threshold, 2. Does not return agents with status="in_call", 3. Does not return agents with status="away", 4. Does not return agents with status="offline", 5. Returns empty array when all agents active |

### socket-handlers.ts (New Tests Added)

| Area | Behaviors Tested |
|------|------------------|
| **heartbeat handler** | 1. Calls updateAgentActivity with agent's ID when heartbeat received, 2. Does nothing when agent not found for socket |
| **Staleness check constants** | 1. Uses 60 second staleness check interval (STALENESS_CHECK_INTERVAL), 2. Uses 2-minute (120s) threshold (STALENESS_THRESHOLD) |
| **Staleness detection** | 1. Returns agents whose lastActivityAt exceeds 2-minute threshold, 2. Does not return agents with recent activity within threshold, 3. Only returns idle agents - does not return agents with status "in_call", 4. Only returns idle agents - does not return agents with status "away", 5. Only returns idle agents - does not return agents with status "offline" |
| **Staleness actions** | 1. Marks stale agents as "away", 2. Reassigns visitors when agent marked stale |
| **Disconnect grace period** | 1. Uses 10 second grace period for agent disconnects, 2. Ends call immediately if agent disconnects while in_call, 3. Allows agent to reconnect within grace period without full unregister, 4. Stores previous status when agent disconnects, 5. Restores previous status if agent reconnects within grace period, 6. Unregisters agent if grace period expires, 7. Reassigns visitors when agent unregistered after grace period |
| **Agent reconnection** | 1. Updates socketId on reconnection, 2. Resets lastActivityAt on reconnection |

### useHeartbeat.ts (Already Tested - Verified)

| Area | Behaviors Tested |
|------|------------------|
| **Heartbeat sending** | 1. Sends heartbeat every 25 seconds, 2. Emits heartbeat event with timestamp, 3. Updates lastHeartbeat timestamp on send, 4. Skips heartbeat when socket not connected |
| **Web Worker** | 1. Uses Web Worker when available, 2. Worker posts heartbeat messages at interval, 3. Falls back to setInterval when Worker fails, 4. Fallback interval still sends heartbeats, 5. Worker responds to start/stop/ping messages |
| **Connection health** | 1. Tracks isConnectionHealthy state, 2. Marks connection as stale after 60 seconds without heartbeat, 3. Calls onConnectionStale callback when stale detected, 4. Connection remains healthy when heartbeats are regular |
| **Tab visibility** | 1. Sends immediate heartbeat when tab becomes visible, 2. Checks connection health when tab becomes visible, 3. Attempts socket reconnect if disconnected when tab visible, 4. Does not reconnect if already connected |
| **Worker state** | 1. Tracks isWorkerActive state, 2. Sets isWorkerActive=false on worker error, 3. Cleans up worker on unmount |
| **Configuration** | 1. Accepts custom heartbeat interval, 2. Can be disabled via enabled option, 3. Requires socket to be provided |
| **Return values** | 1. Returns isWorkerActive, 2. Returns lastHeartbeat timestamp or null, 3. Returns isConnectionHealthy |

## Test Run Results

```
Server Tests:
✓ apps/server/src/features/signaling/socket-handlers.test.ts (218 tests) 455ms
✓ apps/server/src/features/routing/pool-manager.test.ts - All staleness tests pass
Total: 580 tests passed

Dashboard Tests:
✓ src/features/workbench/hooks/useHeartbeat.test.ts (30 tests) 169ms
```

## Notes

1. **Existing Coverage:** Most behaviors were already tested in the existing test files. The pool-manager.test.ts already had comprehensive coverage for `updateAgentActivity` and `getStaleAgents`. The useHeartbeat.test.ts already had excellent coverage (30 tests).

2. **New Tests Added:** Added 12 new behavior tests to socket-handlers.test.ts covering:
   - Heartbeat handler integration with poolManager
   - Staleness check constants (60s interval, 120s threshold)
   - Staleness detection edge cases
   - Staleness actions (marking away, reassigning visitors)
   - Disconnect handler grace period behavior
   - Agent reconnection within grace period

3. **Pre-existing Test Failures:** There are pre-existing test failures in:
   - `apps/widget` - VideoSequencer tests (unrelated to heartbeat/staleness)
   - `apps/dashboard` - use-webrtc and use-call-recording tests (unrelated to heartbeat/staleness)
   
   These failures existed before this test lock task and are not caused by the P6 changes.

4. **Code Observations:**
   - The heartbeat system is well-implemented with clear separation of concerns
   - Server maintains in-memory `lastActivityAt` timestamps
   - Staleness check only affects `idle` agents (not in_call, away, or offline)
   - Grace period of 10 seconds handles page refreshes elegantly
   - The `recordStatusChange` with reason `"heartbeat_stale"` is called but testing the actual database recording is outside scope (mocked in tests)





