# Test Lock Complete: V4

## Summary
- **Feature:** Call Reconnection
- **Status:** COMPLETE
- **Completed At:** 2025-12-06T18:15:00Z

## Test Files Created/Updated

| Test File | Behaviors Covered |
|-----------|-------------------|
| `apps/widget/src/features/signaling/useSignaling.test.ts` | 17 (added to existing file) |
| `apps/server/src/features/signaling/socket-handlers.test.ts` | 32 (added to existing file) |
| `apps/server/src/lib/call-logger.test.ts` | 22 (added to existing file) |

**Total new tests added: 71**

## Source Files Modified

| File | Change |
|------|--------|
| `apps/widget/src/features/signaling/useSignaling.ts` | Exported `storeActiveCall`, `getStoredCall`, `clearStoredCall` functions for testing |

## Behaviors Locked In

### useSignaling.ts (Token Storage)

| Function | Behaviors Tested |
|----------|------------------|
| `storeActiveCall` | 1. Saves reconnectToken, callId, agentId, orgId, timestamp to localStorage, 2. Uses correct storage key (gg_active_call), 3. Adds current timestamp to stored data, 4. Overwrites existing stored call data |
| `getStoredCall` | 5. Returns null if no stored call exists, 6. Returns null if stored call expired (>30s), 7. Returns null if orgId doesn't match, 8. Returns valid call data if within expiry and matching org, 9. Boundary test at exactly 30 seconds, 10. Returns null for malformed JSON |
| `clearStoredCall` | 11. Removes call data from localStorage, 12. Uses correct storage key (gg_active_call), 13. Does not throw when localStorage is empty |
| Integration | 14. Visitor navigates during active call - call data persists, 15. Different org site - ignores stored call, 16. Visitor away too long - call expires, 17. Call ends normally - stored call is cleared |

### socket-handlers.ts (CALL_RECONNECT Handler)

| Area | Behaviors Tested |
|------|------------------|
| **Token Validation** | 1. Validates token existence by checking call info, 2. Checks call status is "accepted", 3. Verifies agent is still in_call, 4. Allows reconnection when agent status is in_call |
| **Reconnection Flow** | 5. Re-registers visitor with original visitorId, 6. Generates new call ID for reconnected call, 7. Updates visitor state to in_call, 8. Maintains agent in_call status, 9. Assigns visitor to correct agent |
| **Failure Cases** | 10. Returns error for invalid token, 11. Returns error if call already ended, 12. Returns error if agent disconnected, 13. Returns error when visitor not found |
| **Pending Reconnects** | 14. Stores pending reconnect when visitor reconnects first, 15. Stores pending reconnect when agent reconnects first, 16. Uses 30 second timeout (CALL_RECONNECT_TIMEOUT), 17. Completes reconnection when second party arrives, 18. setAgentInCall can set/reset agent state |
| **Cleanup** | 19. Visitor state reset on failure, 20. Agent status reset on failure |
| **Agent Role** | 21. Verifies agent ownership of call, 22. Requires agent to be logged in |
| **Events** | 23-26. Documents CALL_RECONNECTING payload structures, 27-28. Documents CALL_RECONNECTED payload for visitor/agent, 29-32. Documents CALL_RECONNECT_FAILED scenarios |

### call-logger.ts (Database Operations)

| Function | Behaviors Tested |
|----------|------------------|
| `getCallByReconnectToken` | 1. Queries call_logs with reconnect_token filter, 2. Documents returned fields, 3. Returns null for invalid token, 4. Checks reconnect_eligible flag, 5. Only returns "accepted" status calls, 6. Only returns calls where ended_at is null, 7. Handles database error gracefully |
| `markCallReconnected` | 8. Generates new reconnect token, 9. Updates call with new token, 10. Updates last_heartbeat_at, 11. Adds new callId to callLogIds map, 12. Returns null when Supabase not configured, 13. Documents return behavior |
| `markCallReconnectFailed` | 14. Calculates duration from started_at, 15. Updates call status to "completed", 16. Sets reconnect_eligible to false, 17. Sets ended_at to current time, 18. Does not throw when Supabase not configured |
| **Security** | 19. Token is cryptographically random (256 bits), 20. New token generated on each reconnection, 21. Token stored only in database and localStorage |
| **Integration** | 22. Documents full token lifecycle flow |

## Test Run Results

```
✓ apps/widget/src/features/signaling/useSignaling.test.ts (34 tests) - 298ms
✓ apps/server/src/features/signaling/socket-handlers.test.ts (247 tests) - 982ms
✓ apps/server/src/lib/call-logger.test.ts (63 tests) - 109ms

All Call Reconnection (V4) tests passed.
```

## Notes

1. **Source code modification**: Exported `storeActiveCall`, `getStoredCall`, `clearStoredCall` from `useSignaling.ts` to enable direct testing. These were previously private functions.

2. **Pre-existing test failures**: The codebase has 44 failing tests in `VideoSequencer.test.tsx` which are unrelated to this feature and existed before this task.

3. **CALL_EXPIRY_MS constant**: The code uses 30 seconds (30 * 1000) matching the server `CALL_RECONNECT_TIMEOUT` constant, not 5 minutes as mentioned in some documentation. Tests capture this current 30-second behavior.

4. **Supabase-dependent behavior**: Many call-logger functions return null/void when Supabase is not configured. Tests document this graceful degradation behavior.

5. **Test patterns followed**: All tests follow existing codebase patterns:
   - One behavior per `it()` block
   - Mock localStorage for widget tests
   - vi.useFakeTimers() for time-based tests
   - Document expected payloads and structures

## Quality Checklist

- [x] Every exported function has tests
- [x] Every code path covered (valid token, expired, invalid, pending)
- [x] Test names describe specific behaviors
- [x] All V4 tests pass
- [x] Followed existing test patterns
- [x] Tests are in correct location (same dir as source)
- [x] Mocks match codebase patterns
- [x] Completion report written

