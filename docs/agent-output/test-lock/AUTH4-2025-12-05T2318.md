# Test Lock Complete: AUTH4

## Summary
- **Feature:** Password Reset
- **Status:** COMPLETE
- **Completed At:** 2025-12-05T23:18 UTC

## Test Files Created

| Test File | Behaviors Covered |
|-----------|-------------------|
| `apps/dashboard/src/app/(auth)/forgot-password/page.test.tsx` | 10 |
| `apps/dashboard/src/app/(auth)/reset-password/page.test.tsx` | 25 |

**Total:** 35 behavior tests

## Behaviors Locked In

### forgot-password/page.tsx

| Area | Behaviors Tested |
|------|------------------|
| **resetPasswordForEmail behavior** | 1. Calls supabase.auth.resetPasswordForEmail with email and redirectTo, 2. Returns success even for non-existent email (security best practice), 3. Returns error when Supabase call fails |
| **Form submission flow** | 4. Sends reset email via Supabase with correct redirect URL, 5. Handles error response from Supabase |
| **Email validation** | 6. Requires email input (HTML5 required attribute) |
| **Success state** | 7. Transitions to success view after successful reset request, 8. Shows "Check your email" message on success |
| **Error handling** | 9. Displays error message when reset fails, 10. Does not transition to success state on error |

### reset-password/page.tsx

| Area | Behaviors Tested |
|------|------------------|
| **Password validation** | 1. Validates minimum password length of 8 characters, 2. Validates password confirmation matches, 3. Returns error when passwords do not match, 4. Returns error when password is less than 8 characters |
| **updateUser (resetPassword) behavior** | 5. Calls supabase.auth.updateUser with new password, 6. Returns error for invalid/expired token, 7. Successfully updates password with valid session |
| **Session validation** | 8. Detects PASSWORD_RECOVERY event for valid reset link, 9. Detects SIGNED_IN event as fallback for valid session, 10. Shows invalid/expired link error when no valid session, 11. Validates existing session on page load |
| **Form submission flow** | 12. Prevents submission while loading, 13. Sets loading state during submission, 14. Sets success state after successful password update |
| **Redirect after success** | 15. Queries user role to determine redirect destination, 16. Redirects admin user to /admin after success, 17. Redirects agent user to /dashboard after success, 18. Redirects to /dashboard when user profile not found, 19. Redirects to /dashboard when no user found |
| **Error handling** | 20. Displays error message from Supabase, 21. Does not transition to success state on error |
| **Invalid/expired link state** | 22. Shows expired link UI when session is invalid, 23. Provides link to request new password reset |
| **Form input requirements** | 24. Requires password input (minLength 8), 25. Requires confirm password input |

## Test Run Results

```
✓ src/app/(auth)/forgot-password/page.test.tsx (10 tests) 53ms
✓ src/app/(auth)/reset-password/page.test.tsx (25 tests) 69ms

35 AUTH4 tests passed
```

## Notes

### Architecture Discovery
The password reset functionality is implemented **directly in the page components** using the Supabase client-side SDK, not as server actions in `actions.ts`:

- **forgot-password/page.tsx**: Uses `supabase.auth.resetPasswordForEmail()` to send reset email
- **reset-password/page.tsx**: Uses `supabase.auth.updateUser()` to update password

The `actions.ts` file does not contain `requestPasswordReset` or `resetPassword` functions as suggested in the prompt - this is correct since the client-side Supabase SDK handles the password reset flow directly (including magic link token parsing).

### Component Testing Approach
Tests mock the Supabase client to verify:
1. Correct API calls are made with proper parameters
2. Error handling behaves correctly
3. State transitions follow expected patterns
4. Role-based redirects work correctly

### Key Security Behavior Verified
- **Email enumeration protection**: `resetPasswordForEmail` returns success even for non-existent emails, preventing attackers from determining valid email addresses
- **Session validation**: Reset password page validates both PASSWORD_RECOVERY and SIGNED_IN auth events with a 2-second grace period for Supabase token parsing
- **Token expiration handling**: Invalid/expired tokens result in user-friendly error message with link to request new reset

### Observed Code Behaviors
1. **Redirect URL construction**: Uses `window.location.origin + "/reset-password"` for redirect URL in forgot-password flow
2. **Session validation**: reset-password page uses `onAuthStateChange` to listen for PASSWORD_RECOVERY event, with SIGNED_IN as fallback
3. **Role-based redirect after reset**: After successful password update, queries users table for role to redirect admin to /admin or agent to /dashboard
4. **Fallback redirect**: If user profile not found, defaults to /dashboard redirect
5. **Hard redirect**: Uses `window.location.href` for redirect (not Next.js router) to ensure cookies are properly sent
