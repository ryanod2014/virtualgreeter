# TEST LOCK Completion Report: D6

> **Feature:** Embed Code
> **Status:** ✅ Complete
> **Date:** 2024-12-06

---

## Summary

Created behavior-level tests for the Embed Code feature, which provides admins with the JavaScript snippet to install the widget on their website.

---

## Files Created

| File | Tests | Coverage |
|------|-------|----------|
| `apps/dashboard/src/features/embed/EmbedCodeDisplay.test.tsx` | 62 | All behaviors |

---

## Test Results

```
✓ src/features/embed/EmbedCodeDisplay.test.tsx (62 tests) 17244ms

Test Files  1 passed (1)
     Tests  62 passed (62)
```

---

## Behaviors Captured

### Display - Embed Code Content

| Behavior | Test Count | Status |
|----------|------------|--------|
| Shows script tag with correct orgId | 3 | ✅ |
| Shows correct serverUrl from environment | 3 | ✅ |
| Shows widget CDN URL in script src | 3 | ✅ |

### Display - Copy Button

| Behavior | Test Count | Status |
|----------|------------|--------|
| Copy Code button visible | 1 | ✅ |
| Copy icon displayed | 1 | ✅ |
| Copies embed code to clipboard | 1 | ✅ |
| Shows "Copied!" feedback | 1 | ✅ |
| Shows Check icon after copy | 1 | ✅ |
| Reverts to "Copy Code" after 2 seconds | 1 | ✅ |

### Variants - Async Loading

| Behavior | Test Count | Status |
|----------|------------|--------|
| Embed code includes async=1 attribute | 1 | ✅ |
| Uses async IIFE pattern | 1 | ✅ |
| Script inserted via DOM manipulation | 1 | ✅ |

### Display - Page Structure

| Behavior | Test Count | Status |
|----------|------------|--------|
| Shows page title and headers | 3 | ✅ |
| Shows installation instructions | 1 | ✅ |

### Display - Installation Status

| Behavior | Test Count | Status |
|----------|------------|--------|
| Shows "Waiting for installation" when not verified | 2 | ✅ |
| Shows "Installed" when verified | 2 | ✅ |
| Shows total pageviews count | 1 | ✅ |
| Shows prompt when no sites detected | 1 | ✅ |

### Verification Polling

| Behavior | Test Count | Status |
|----------|------------|--------|
| Polls every 5 seconds when not verified | 1 | ✅ |
| Stops polling when verified | 1 | ✅ |
| Checks both organizations and pageviews tables | 1 | ✅ |

### Detected Sites Display

| Behavior | Test Count | Status |
|----------|------------|--------|
| Shows list of detected sites | 1 | ✅ |
| Shows view count per site | 1 | ✅ |
| Shows "Active today" for recent sites | 1 | ✅ |
| Strips https:// from domain display | 1 | ✅ |
| Sites are clickable links | 1 | ✅ |

### Widget Settings Section

| Behavior | Test Count | Status |
|----------|------------|--------|
| Section header and badge | 2 | ✅ |
| Save Changes button state management | 2 | ✅ |
| Size options (Small, Medium, Large) | 1 | ✅ |
| Position options (5 positions) | 1 | ✅ |
| Device targeting options | 1 | ✅ |
| Theme options (Light, Dark, Glass) | 1 | ✅ |

### Settings Interaction

| Behavior | Test Count | Status |
|----------|------------|--------|
| Save button enables on change | 1 | ✅ |
| Reset to Default button | 1 | ✅ |
| Supabase update on save | 1 | ✅ |
| "Saved!" feedback | 1 | ✅ |

### Trigger Delay Options

| Behavior | Test Count | Status |
|----------|------------|--------|
| Preset delay options | 1 | ✅ |
| Custom delay input ("Other") | 2 | ✅ |

### Auto-Hide Delay Options

| Behavior | Test Count | Status |
|----------|------------|--------|
| Preset auto-hide options | 1 | ✅ |
| Custom auto-hide button | 1 | ✅ |

### Minimize Toggle

| Behavior | Test Count | Status |
|----------|------------|--------|
| Toggle button visible | 1 | ✅ |
| Default "Disabled" state | 1 | ✅ |
| Toggles to "Enabled" on click | 1 | ✅ |

### Pools CTA Section

| Behavior | Test Count | Status |
|----------|------------|--------|
| Promotion message displayed | 1 | ✅ |
| Configure Pools link | 1 | ✅ |

### Edge Cases

| Behavior | Test Count | Status |
|----------|------------|--------|
| Empty organizationId | 1 | ✅ |
| Special characters in orgId | 1 | ✅ |
| Very long organizationId | 1 | ✅ |
| Multiple detected sites | 1 | ✅ |

---

## Notes

### Source File Discovery

The task specified testing:
- `apps/dashboard/src/app/(dashboard)/widget/embed/page.tsx`
- `apps/dashboard/src/features/embed/EmbedCodeDisplay.tsx`

However, these files do not exist. The actual implementation is in:
- `apps/dashboard/src/app/(app)/admin/sites/site-setup-client.tsx`

The test file was created at the specified output location and tests the `SiteSetupClient` component which contains all embed code display functionality.

### Key Implementation Details Captured

1. **Embed Code Structure**: The generated embed code uses an IIFE pattern with async loading (`js.async=1`) for non-blocking page load.

2. **Environment Variables**: The component uses:
   - `NEXT_PUBLIC_WIDGET_CDN_URL` for widget script location
   - `NEXT_PUBLIC_SIGNALING_SERVER` for signaling server URL
   - Falls back to `http://localhost:3001` when env vars are not set

3. **CDN URL Handling**: Automatically appends `/widget.js` if the CDN URL doesn't include it.

4. **Verification System**: Dual verification via:
   - `embed_verified_at` column in organizations table
   - Presence of records in `widget_pageviews` table

5. **Copy Functionality**: Uses clipboard API with 2-second visual feedback.

---

## Command to Run Tests

```bash
cd apps/dashboard && pnpm vitest run src/features/embed/EmbedCodeDisplay.test.tsx
```

