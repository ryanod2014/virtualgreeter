# Test Lock Complete: V3

## Summary
- **Feature:** V3 - Visitor Call (Call Initiation & Active Call)
- **Status:** COMPLETE
- **Completed At:** 2025-12-06T18:18:00Z

## Test Files Created/Updated

| Test File | Behaviors Covered |
|-----------|-------------------|
| `apps/widget/src/Widget.test.tsx` | 47 (pre-existing, comprehensive coverage) |
| `apps/widget/src/features/signaling/useSignaling.test.ts` | 34 (pre-existing) |
| `apps/widget/src/features/webrtc/useWebRTC.test.ts` | 27 (NEW) |
| `apps/widget/src/features/webrtc/LiveCallView.test.tsx` | 33 (NEW) |

**Total: 141 tests for V3 Visitor Call feature**

## Behaviors Locked In

### Widget.tsx (Pre-existing - 47 tests)

| Area | Behaviors Tested |
|------|------------------|
| State Machine | 1. Initial state is hidden, 2. Transitions to open after trigger_delay + agent assigned, 3. Stays hidden without agent, 4. open → minimized on minimize click, 5. open → waiting_for_agent on camera/mic click, 6. in_call → minimized on call end |
| Trigger Delay | 7. Uses widgetSettings.trigger_delay value, 8. Accounts for time already on page, 9. Timer cleared on unmount |
| Auto-Hide | 10. Minimizes after auto_hide_delay, 11. Auto-hide cancelled on interaction, 12. Only active when state=open and delay is set |
| Device Detection | 13. isMobileDevice for small screens, 14. Touch devices without fine pointer, 15. devices=desktop hides on mobile |
| Drag & Drop | 16. handleDragStart captures position, 17. handleDragMove updates transform, 18. handleDragEnd triggers snapping, 19. Drag disabled in fullscreen |

### useSignaling.ts (Pre-existing - 34 tests)

| Function | Behaviors Tested |
|----------|------------------|
| `storeWidgetState` | Stores state with timestamp to localStorage |
| `getStoredWidgetState` | Returns null when empty, returns valid state, clears expired state (>30 min) |
| `clearStoredWidgetState` | Removes widget state from localStorage |
| `shouldSkipIntroForAgent` | Returns false when no state/intro incomplete/different agent/different videos, returns true for same agent + same videos |
| `storeActiveCall` | Stores reconnectToken, callId, agentId, orgId, timestamp |
| `getStoredCall` | Returns null when expired (>30s), returns null for different org, returns valid call data |
| `clearStoredCall` | Removes call data from localStorage |

### useWebRTC.ts (NEW - 27 tests)

| Function | Behaviors Tested |
|----------|------------------|
| `initializeCall` | 1. Creates RTCPeerConnection with ICE servers, 2. Gets user media for local stream, 3. Adds tracks to peer connection, 4. Sets localStream state, 5. Sets isConnecting to true |
| `processSignal` | 6. Handles offer → creates answer, 7. Handles ICE candidate → adds to peer, 8. Queues signals before peer ready |
| Connection states | 9. "connected" sets isConnected=true, 10. "failed" sets error, 11. Starts connection timeout timer, 12. Clears timeout on success |
| Cleanup | 13. Closes peer connection, 14. Stops all tracks, 15. Resets streams, 16. Removes event handlers on unmount |
| Error handling | 17-19. Handles getUserMedia errors (NotAllowed, NotFound, NotReadable), 20. Sets error on ICE failure |
| Other | 21. retryConnection cleans up and reinitializes, 22-24. Does not initialize when conditions not met, 25. Emits ICE candidates, 26-27. Handles remote stream |

### LiveCallView.tsx (NEW - 33 tests)

| Area | Behaviors Tested |
|------|------------------|
| Video Display | 1. Displays remote video when stream provided, 2. Hides remote video when null, 3. Displays local video when stream provided, 4. Hides self-view when null, 5. Shows self-view with active class |
| LIVE Badge | 6. Displays LIVE badge during call, 7. Red dot when no error, 8. ERROR text and grey dot when error present |
| Connecting State | 9. Shows connecting message, 10. Shows helpful subtext, 11. Shows pulsing animation |
| Error State | 12. Displays error message, 13. Shows retry button when onRetry provided, 14. Calls onRetry on click, 15. Hides retry button when no onRetry, 16. Shows warning icon |
| Waiting State | 17. Shows waiting message, 18. Shows video camera icon |
| Connected State | 19. Shows connected badge, 20-21. Hides badge when error/not connected, 22. Shows green dot |
| Accessibility | 23. aria-label on remote video, 24. aria-label on local video, 25. role=status on placeholder, 26-27. proper aria-labels on badges, 28. role=status on connected badge |
| Video Attributes | 29. autoPlay on remote, 30. playsInline on remote, 31. muted on local, 32. autoPlay on local, 33. playsInline on local |

## Test Run Results

```
✓ src/Widget.test.tsx (47 tests) 30ms
✓ src/features/signaling/useSignaling.test.ts (34 tests) 608ms
✓ src/features/webrtc/useWebRTC.test.ts (27 tests) 1461ms
✓ src/features/webrtc/LiveCallView.test.tsx (33 tests) 7512ms

Test Files  4 passed (4)
     Tests  141 passed (141)
```

## Notes

1. **Pre-existing Widget.test.tsx Coverage:** The existing Widget.test.tsx already had comprehensive coverage of call initiation behaviors including camera/mic toggle, state transitions, and call request flow. No changes were needed.

2. **Pre-existing useSignaling.test.ts Coverage:** Tests for call events (requestCall emits, cancelCall emits, endCall emits, call:accepted/rejected/ended handlers) are indirectly tested through the Widget integration tests. The localStorage utility functions for call reconnection are fully covered.

3. **New useWebRTC.test.ts:** Created comprehensive tests for WebRTC peer connection management, signal processing, connection state handling, cleanup, and error scenarios.

4. **New LiveCallView.test.tsx:** Created tests for the in-call video UI component covering video display, badges, states, accessibility, and video element attributes.

5. **Pre-existing Test Failures:** Some tests in `main.test.ts`, `useCobrowse.test.ts`, and `VideoSequencer.test.tsx` were failing before this task. These are outside the scope of V3 Visitor Call feature and were not modified.

6. **Mocking Approach:** Tests use vitest's `vi.mock` for dependencies, mock MediaStream/RTCPeerConnection for WebRTC tests, and preact testing-library for component rendering.

