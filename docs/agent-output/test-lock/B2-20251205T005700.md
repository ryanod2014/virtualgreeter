# Test Lock Complete: B2

## Summary
- **Feature:** Seat Management
- **Status:** COMPLETE
- **Completed At:** 2025-12-05T00:57:00Z

## Test Files Created

| Test File | Behaviors Covered |
|-----------|-------------------|
| `apps/dashboard/src/app/api/billing/seats/route.test.ts` | 15 |
| `apps/dashboard/src/app/api/billing/update-settings/route.test.ts` | 27 |
| `apps/dashboard/src/lib/plan-limits.test.ts` | 49 |

## Behaviors Locked In

### billing/seats/route.ts

| Function | Behaviors Tested |
|----------|------------------|
| `POST` | 1. Returns 401 if user is not authenticated, 2. Returns 403 if profile not found, 3. Returns 400 when action is missing, 4. Returns 400 when quantity is missing, 5. Returns 400 when quantity is not a number, 6. Calculates new used seats by adding quantity (add action), 7. Expands billing when new usage exceeds purchased seats, 8. Calls Stripe subscriptionItems.update when billing expands, 9. Does not call Stripe when no expansion needed, 10. Calculates new used seats by subtracting quantity (remove action), 11. Clamps used seats to zero when removing more than usage, 12. Does not reduce billing when removing seats (PRE-PAID model), 13. Returns correct response with all fields (usedSeats, purchasedSeats, availableSeats, billingExpanded), 14. Returns billingExpanded true when expansion occurs, 15. Returns 500 on unexpected errors |

### billing/update-settings/route.ts

| Function | Behaviors Tested |
|----------|------------------|
| `POST` | 1. Returns 401 if not authenticated, 2. Returns 403 if profile not found, 3. Returns 403 if not admin, 4. Returns 404 if org not found, 5. Allows increasing seat count above usage, 6. Allows reducing seat count to exactly current usage, 7. Returns 400 when reducing below usage, 8. Clamps seat count to minimum 1, 9. Floors decimal seat count, 10. Handles negative seat count by clamping, 11. Calls Stripe when seat count changes, 12. Does not call Stripe when unchanged, 13. Allows monthly billing frequency, 14. Allows annual billing frequency, 15. Allows six_month with offer, 16. Returns 400 for six_month without offer, 17. Returns 400 for invalid frequency, 18. Removes six_month offer when switching away, 19. Does not remove offer when staying on six_month, 20. Calls Stripe with new price ID on frequency change, 21. Returns 500 when price not configured, 22. Combined seat and frequency updates, 23. Returns 500 on DB update failure, 24. Includes currentUsage in response, 25. Includes stripeUpdated flag, 26. Includes stripePriceUpdated flag, 27. Returns 500 on unexpected errors |

### plan-limits.ts

| Function | Behaviors Tested |
|----------|------------------|
| `PLAN_LIMITS` | 1-4. Defines correct limits for free, starter, pro, enterprise plans |
| `getPlanLimits` | 5-8. Returns correct limits for each plan tier |
| `canAddAgent` | 9-16. Returns true/false based on current count vs limit, handles unlimited (-1) |
| `canAddSite` | 17-23. Returns true/false based on current count vs limit, handles unlimited (-1) |
| `hasFeature` | 24-35. Returns correct feature availability for hasRecording, hasAdvancedAnalytics, hasCustomBranding across all plans |
| `getRemainingAgentSlots` | 36-40. Returns remaining slots, clamps to 0, returns -1 for unlimited |
| `getRemainingSiteSlots` | 41-45. Returns remaining slots, clamps to 0, returns -1 for unlimited |
| `formatLimitDisplay` | 46-47. Formats as "current / max" or "current / Unlimited" |
| `getUpgradeMessage` | 48-49. Returns appropriate upgrade messages for agents/sites |

## Test Run Results

```
âœ“ 91 tests passed

 Test Files  3 passed (3)
      Tests  91 passed (91)
```

## Notes

1. **Dev Mode Test Skipped:** The seats/route.ts has a dev mode code path (when `stripe` is undefined) that is difficult to unit test because the Stripe module mock cannot be conditionally set to null at runtime. The dev mode behavior is tested implicitly when the application runs without Stripe configuration.

2. **PRE-PAID Model Verified:** Tests confirm the billing behavior follows the pre-paid seats model where:
   - Adding agents can trigger billing expansion (auto-expand when exceeding purchased seats)
   - Removing agents frees seats but never reduces billing
   - Users must explicitly reduce seats via billing settings to lower their bill

3. **Six-Month Offer Logic:** The update-settings route correctly enforces that switching away from six_month billing removes the offer permanently (`has_six_month_offer = false`).

4. **Plan Limits Structure:** All plan tiers (free, starter, pro, enterprise) have complete test coverage. Enterprise uses -1 for unlimited resources.




