# Test Lock Complete: P2

## Summary
- **Feature:** P2 - Agent Assignment Algorithm
- **Status:** COMPLETE
- **Completed At:** 2024-12-06T17:43:00Z

## Test Files Updated

| Test File | Behaviors Added |
|-----------|-----------------|
| `apps/server/src/features/routing/pool-manager.test.ts` | 34 new tests |
| `apps/server/src/features/signaling/socket-handlers.test.ts` | 31 new tests |

## Behaviors Locked In

### pool-manager.ts

| Function | Behaviors Tested |
|----------|------------------|
| `matchPathToPool` | 1. Returns matching pool when path pattern matches, 2. Returns defaultPoolId when no rules match, 3. Returns null when no config exists for org, 4. Evaluates rules by priority (DESC) - higher priority wins, 5. First matching rule wins (rules are ORed), 6. Uses conditions-based matching when conditions array is present, 7. Skips inactive rules, 8. Returns null defaultPoolId when default is null and no rules match |
| `matchConditions` | 1. Matches when ALL conditions are true (AND logic), 2. Does not match when ANY condition fails (AND logic), 3. Matches path with 'is_exactly' match type, 4. Matches path with 'contains' match type, 5. Matches path with 'starts_with' match type, 6. Matches path with 'ends_with' match type, 7. Matches path with 'does_not_contain' match type, 8. Matches query parameter with 'is_exactly' match type, 9. Matches query parameter with 'contains' match type, 10. Does not match when query parameter is missing, 11. Matches case-insensitively for query parameter names, 12. Matches domain with 'contains' match type, 13. Matches domain with 'is_exactly' match type |
| `assignVisitorToAgent` | 1. Adds visitor to agent's currentSimulations array, 2. Increments assignment counter with each assignment, 3. Updates lastAssignmentOrder for the assigned agent, 4. Updates visitor assignedAgentId, 5. Updates visitor state to watching_simulation, 6. Updates agent status to in_simulation when first visitor assigned, 7. Removes visitor from previous agent when reassigning, 8. Returns false if visitor not found, 9. Returns false if agent not found, 10. Returns true on successful assignment |

### socket-handlers.ts (VISITOR_JOIN)

| Area | Behaviors Tested |
|------|------------------|
| **Visitor Registration** | 1. registerVisitor creates visitor session with orgId and pageUrl, 2. Tracks visitor for lookup by socket ID, 3. Tracks visitor for lookup by visitor ID, 4. Sets initial state to browsing, 5. Sets connectedAt timestamp, 6. Stores IP address when provided |
| **Agent Finding** | 1. findBestAgentForVisitor returns agent and poolId when available, 2. Uses path routing to determine pool, 3. Returns undefined when no agents available, 4. Skips agents in_call, 5. Skips agents with away status, 6. Falls back to any agent when pool has no available agents |
| **Agent Assignment** | 1. assignVisitorToAgent associates visitor with agent, 2. Adds visitor to agent's currentSimulations, 3. Changes visitor state to watching_simulation, 4. Agent profile contains required fields for emission |
| **No Agent Available** | 1. matchPathToPool returns pool for widgetSettings lookup even when no agents, 2. Visitor session stores matchedPoolId when no agent assigned, 3. getUnassignedVisitors returns visitors without agents, 4. Unassigned visitors can be assigned when agent becomes available |
| **Edge Cases** | 1. Handles visitor reconnection (same visitorId, new socket), 2. Existing visitor in call skips VISITOR_JOIN registration, 3. Updates pageUrl on existing in_call visitor |

### Integration Tests

| Area | Behaviors Tested |
|------|------------------|
| **Tiered Routing** | 1. Assigns to tier 1 agent first, then overflows to tier 2, 2. Distributes visitors evenly within same tier using round-robin, 3. Uses least-connections when agents have existing load |
| **Pool-based Routing** | 1. Routes visitors to different pools based on URL, 2. Uses priority ranking per pool for same agent in multiple pools |

## Test Run Results

```
✓ src/features/routing/pool-manager.test.ts (80 tests)
✓ src/features/signaling/socket-handlers.test.ts (172 tests)

Test Files  2 passed (2)
     Tests  252 passed (252)
  Duration  2.01s
```

## Notes

1. **Existing Test Coverage**: The pool-manager.test.ts and socket-handlers.test.ts files already had substantial test coverage for many behaviors. This lock-in added specific tests for:
   - `matchPathToPool` priority ordering and rule evaluation
   - `matchConditions` AND logic and all match types (path, query param, domain)
   - `assignVisitorToAgent` explicit state tracking tests
   - Complete VISITOR_JOIN flow tests

2. **Known Issue in Code (Documented, Not Fixed)**: The `reassignVisitors()` function calls `findBestAgent()` without a poolId, which can route visitors to agents outside their matched pool. This is captured in the feature documentation as Q-1202-001.

3. **Test Patterns Used**: All tests follow existing codebase patterns with:
   - `vi.clearAllMocks()` in beforeEach
   - `vi.restoreAllMocks()` in afterEach  
   - `vi.useFakeTimers()` / `vi.useRealTimers()` for timing tests
   - One behavior per `it()` block

4. **All Tests Pass**: Tests capture CURRENT behavior, not intended behavior. The test suite validates the existing implementation.

