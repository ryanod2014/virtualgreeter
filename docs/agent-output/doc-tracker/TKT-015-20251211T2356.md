# Doc Complete: TKT-015

- **Ticket ID:** TKT-015
- **Title:** Secure Recording URLs with Signed Access
- **Status:** COMPLETE
- **Docs Updated:**
  - `docs/features/agent/video-recordings.md`
  - `docs/features/admin/call-logs.md`
- **Completed At:** 2025-12-11T23:56:00Z

## Summary of Changes

TKT-015 implemented secure recording storage by moving from predictable public URLs to a private bucket with signed, time-limited URLs. This resolves HIPAA/GDPR compliance risks.

### Key Implementation Changes

1. **Private Storage with Randomized UUIDs**
   - Recordings now upload to a private Supabase bucket
   - Filenames use randomized UUIDs instead of predictable `{orgId}/{callLogId}_{timestamp}` patterns
   - Path format: `{organizationId}/{uuid}.webm`

2. **Signed URL Generation**
   - New API endpoint: `POST /api/recordings/url`
   - Generates signed URLs with 1-hour expiration
   - Includes organization validation to prevent cross-org access
   - Returns both `signedUrl` and `expiresAt` timestamp

3. **Auto-Refresh Mechanism**
   - New `RecordingPlayer` component handles signed URL lifecycle
   - Automatically refreshes URL 15 minutes before expiration (at 45-minute mark)
   - Maintains playback position across URL refreshes
   - Handles errors gracefully with user-friendly messages

4. **Server-Side Upload**
   - New API endpoint: `POST /api/recordings/upload`
   - Recording upload moved from client-side to server-side
   - Authentication and organization checks enforced
   - Stores recording ID (not full URL) in `call_logs.recording_url`

### Documentation Updates

#### `docs/features/agent/video-recordings.md`

1. **Updated Security Section:**
   - Added 4 new security rows covering private bucket, URL patterns, expiration, and direct access controls

2. **Updated Data Flow:**
   - Revised CALL ENDS flow to show new API-based upload with UUID generation
   - Added PLAYBACK flow showing signed URL generation and auto-refresh mechanism

3. **Updated Key Functions/Components:**
   - Added 4 new entries for upload/URL APIs and RecordingPlayer component

4. **Updated Edge Cases:**
   - Added 5 new scenarios covering signed URL expiration, generation failures, cross-org access, and direct file access

5. **Updated Error States:**
   - Added 3 new error types: SIGNED_URL_GENERATION_FAILED, SIGNED_URL_EXPIRED, UNAUTHORIZED_ACCESS

6. **Updated Code References:**
   - Added references to new files: uploadRecording.ts, getRecordingUrl.ts, RecordingPlayer.tsx, and API routes
   - Updated line numbers for modified files

7. **Updated Open Questions:**
   - Added 3 new questions about signed URL expiration timing, download behavior, and migration of existing recordings

#### `docs/features/admin/call-logs.md`

1. **Updated Data Field Definition:**
   - Changed `recording_url` field description from "S3 URL to recording file" to "Recording ID (UUID) for signed URL generation"
   - Reflects new storage pattern where only the UUID is stored, not the full URL

## Technical Details

### New Files Created
- `apps/server/src/features/recordings/uploadRecording.ts` - Server-side upload logic
- `apps/server/src/features/recordings/getRecordingUrl.ts` - Signed URL generation logic
- `apps/dashboard/src/app/api/recordings/upload/route.ts` - Upload API endpoint
- `apps/dashboard/src/app/api/recordings/url/route.ts` - URL generation API endpoint
- `apps/dashboard/src/features/recordings/RecordingPlayer.tsx` - Client component with auto-refresh

### Modified Files
- `apps/dashboard/src/features/webrtc/use-call-recording.ts` - Updated to use new upload API
- `apps/dashboard/src/app/(app)/admin/calls/calls-client.tsx` - Uses RecordingPlayer component
- `apps/dashboard/src/app/(app)/dashboard/calls/agent-calls-client.tsx` - Uses RecordingPlayer component

### Security Improvements

1. **No More Predictable URLs:** Random UUIDs prevent URL guessing attacks
2. **Time-Limited Access:** Signed URLs expire after 1 hour, limiting exposure window
3. **Private Bucket:** Direct file access blocked - requires authentication
4. **Organization Validation:** API enforces org ownership before generating signed URLs
5. **Automatic Cleanup:** Expired URLs become invalid, requiring re-authentication

## Compliance Impact

This change significantly improves HIPAA and GDPR compliance by:
- Preventing unauthorized access through URL guessing
- Implementing time-limited access controls
- Enforcing authentication for all recording access
- Reducing exposure window for sensitive medical/personal data

## Migration Notes

Documentation does not yet cover migration path for existing public recordings. This remains an open question (#9 in the Open Questions section).
