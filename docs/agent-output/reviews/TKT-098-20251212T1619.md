# Review Complete: TKT-098 - Tiered Agent Assignment Documentation

**Reviewed:** December 12, 2024
**Ticket:** TKT-098 - Fix Tiered Routing to Prefer Idle Agents Over Least-Connections
**Doc File:** `docs/features/admin/tiered-routing.md`
**Reviewer:** Review Agent

---

## Executive Summary

The documentation for Tiered Agent Assignment has **NOT been updated** to reflect the changes made in TKT-098. Multiple sections still describe the old, buggy algorithm where idle and busy agents could be evaluated simultaneously. The core fix—using a `hasIdleCandidate` flag to guarantee idle agents are ALWAYS preferred before busy agents—is not documented anywhere.

**Critical Issue:** The appendix pseudocode actually shows the BUGGY pre-TKT-098 behavior, where a busy agent can overwrite an idle agent selection. This is misleading and potentially dangerous if developers reference it.

---

## Findings Submitted to Staging

| # | Title | Severity | Finding ID |
|---|-------|----------|------------|
| 1 | Documentation doesn't reflect TKT-098 idle-first algorithm | HIGH | F-1765581426959 |
| 2 | Section 2 High-Level Flow step 4 is misleading about algorithm order | MEDIUM | F-1765581438608 |
| 3 | Key Functions table doesn't reference correct line numbers post-TKT-098 | LOW | F-1765581451961 |
| 4 | Edge case #7 doesn't reflect new idle-first behavior | MEDIUM | F-1765581468578 |
| 5 | CRITICAL: Appendix pseudocode is incorrect and shows pre-TKT-098 buggy algorithm | HIGH | F-1765581491296 |
| 6 | Section 7 'Identified Issues' table doesn't mention TKT-098 fix | LOW | F-1765581508050 |
| 7 | Documentation doesn't reference TKT-098 tests that prove correctness | LOW | F-1765581539994 |
| 8 | Section 10 Open Questions #2 is now definitively answered by TKT-098 | LOW | F-1765581555828 |
| 9 | CODE REFERENCES Notes column uses misleading '+' phrasing | LOW | F-1765581573373 |

---

## Summary

- **Total Findings:** 9
- **Critical:** 0
- **High:** 2
- **Medium:** 2
- **Low:** 5

---

## Key Issues by Priority

### HIGH (2)

1. **F-1765581426959**: Section 3 (Data Flow) and Section 8 (Appendix) describe the old algorithm. Lines 124-127 say "For idle agents... For agents with load..." implying simultaneous evaluation. Actual code uses two-phase: collect ALL idle, THEN (only if no idle) use busy.

2. **F-1765581491296**: The appendix pseudocode (lines 347-377) is WRONG and shows the bug that TKT-098 fixed. It allows `bestAgent` to be overwritten from idle → busy, which was the exact problem. This is dangerous because developers might copy it.

### MEDIUM (2)

1. **F-1765581438608**: Section 2 step 4 says "round-robin + least-connections" with a `+`, implying both run together. Should say "idle-first (round-robin), fallback (least-connections)".

2. **F-1765581468578**: Edge cases table is missing the scenario TKT-098 specifically fixed: "Idle agent (0 calls) vs Busy agent (2 calls) in same tier". This should be documented as a test case.

### LOW (5)

- Missing change notes in code references table
- Tests for TKT-098 not referenced in documentation
- Identified Issues table doesn't show TKT-098 as resolved
- Open Question #2 could reference TKT-098 behavior
- CODE REFERENCES notes use misleading `+` phrasing

---

## Root Cause

**The documentation was not updated when TKT-098 was merged.** The code was fixed (commit `bcc6df2`), tests were added (3 new tests in pool-manager.test.ts), but the feature documentation was left in its original state describing the buggy behavior.

---

## Impact Assessment

**Severity: HIGH**

This documentation gap has several risks:

1. **Developer Confusion**: New developers reading the docs will misunderstand how the algorithm works
2. **Copy-Paste Bug**: The appendix pseudocode could be copied and propagate the bug to other systems
3. **Misleading QA**: QA agents might test based on incorrect documented behavior
4. **Lost Institutional Knowledge**: The reason for TKT-098 fix (Finding F-088) is not captured in the docs

---

## Recommended Actions

**IMMEDIATE (High Priority):**
1. Rewrite Section 3 Data Flow (lines 124-127) to show two-phase idle/busy selection
2. Rewrite Section 8 Appendix pseudocode (lines 347-377) to include `hasIdleCandidate` flag
3. Update Section 2 step 4 to clarify "idle-first, fallback least-connections"

**SHORT-TERM (Medium Priority):**
1. Add missing edge case: "Idle vs Busy in same tier → Always selects idle (TKT-098)"
2. Update all instances of "round-robin + least-connections" to accurate phrasing

**OPTIONAL (Low Priority):**
1. Add TKT-098 to "Identified Issues" table as RESOLVED
2. Reference the 3 test cases added in TKT-098
3. Update Open Question #2 with idle-first clarification

---

## Notes

**Positive Observations:**
- The code implementation is correct (reviewed pool-manager.ts lines 641-685)
- Test coverage is excellent (3 comprehensive tests added)
- The fix is working as intended per acceptance criteria

**What Went Well:**
- TKT-098 was implemented correctly with proper testing
- The `hasIdleCandidate` flag is a clean, simple solution

**Gap:**
- Documentation was skipped or forgotten during the merge
- No docs agent was triggered to update the feature docs
- This suggests the docs pipeline might not be running for all tickets

---

## Related Findings

- **Finding F-088**: Original finding that led to TKT-098 (mentioned in ticket but not in docs)
- **No duplicate findings**: This is the first review of tiered routing post-TKT-098

---

## Verification

I verified the following:
- ✅ Read entire doc file (docs/features/admin/tiered-routing.md)
- ✅ Read actual code implementation (apps/server/src/features/routing/pool-manager.ts:641-685)
- ✅ Checked git history for TKT-098 commits
- ✅ Reviewed test coverage (pool-manager.test.ts lines 692, 723, 752)
- ✅ Checked existing findings for duplicates (no duplicates found)
- ✅ All findings submitted via CLI
- ✅ Each finding includes options and recommendation

---

**Review Agent Session Complete**

Triage Agent: Please process these 9 findings into the human inbox for prioritization.
