# Review Complete: TKT-005A (Payment Failure Feature Documentation)

**Reviewed:** 2025-12-12
**Doc File:** `docs/features/billing/payment-failure.md`
**Reviewer:** Review Agent
**Session ID:** 6c16ef21-03f7-43e2-97f7-14a9d55ed619

---

## Executive Summary

Reviewed the payment failure feature documentation for accuracy, consistency, and completeness. The documentation is comprehensive and well-structured, but contains **6 findings** that need attention, primarily related to outdated information about the TypeScript type fix and several ambiguities in state transitions and edge case handling.

**Note:** CLI findings submission failed due to PM Dashboard API endpoint `/api/v2/findings` returning "Not found". Findings are documented in this report for manual triage.

---

## Findings Summary

| # | Title | Severity | Status |
|---|-------|----------|--------|
| 1 | Documentation references TypeScript type as missing when it's implemented | Medium | Needs Update |
| 2 | Ambiguous pause expiration behavior in state definitions | Medium | Needs Clarification |
| 3 | Inconsistent cancellation exit condition in trialing state | Low | Needs Fix |
| 4 | Seat addition payment failure edge case lacks resolution | High | Needs Investigation |
| 5 | Contradictory timing scenario for subscription cancellation | Medium | Needs Clarification |
| 6 | Missing webhook signature verification implementation details | Low | Needs Enhancement |

**Total:** 6 findings
- **Critical:** 0
- **High:** 1
- **Medium:** 3
- **Low:** 2

---

## Detailed Findings

### Finding 1: Documentation references TypeScript type as missing when it's implemented

**Severity:** Medium
**Category:** Outdated Documentation
**Location:**
- Section 7: Identified Issues table, row 5 (line 246)
- Section 10: Open Questions, question #6 (lines 287-290)
- Section 8: Code References, line 260

**Issue:**
The documentation states that `SubscriptionStatus` type doesn't include `past_due` in `packages/domain/src/database.types.ts:39`, marking it with ❌ and listing it as an identified issue. However, code review confirms that line 39 of `database.types.ts` currently shows:

```typescript
export type SubscriptionStatus = "active" | "paused" | "cancelled" | "trialing" | "past_due";
```

The type **has been implemented** (presumably by TKT-005A), making this documentation outdated.

**Options:**
1. **Remove these references entirely** - Clean up since the issue is resolved
2. **Move to "Implementation History" section** - Show it was previously missing but now fixed
3. **Add resolution annotation** - Add "(Fixed by TKT-005A)" to maintain traceability
4. **Skip** - Leave as-is for historical context (not recommended due to confusion)

**Recommendation:** Option 3 - Update the documentation to reflect resolution by TKT-005A:
- Change ❌ indicators to ✅
- Add annotation: "(Fixed by TKT-005A)"
- Update Open Question #6 answer to "Yes - resolved by TKT-005A"
- Update Implementation Status table (line 302) from "❌ Missing" to "✅ Implemented"

---

### Finding 2: Ambiguous pause expiration behavior in state definitions

**Severity:** Medium
**Category:** Confusing User Story
**Location:** Section 2: State Definitions table, `paused` state row (line 86)

**Issue:**
The `paused` state definition states it can be exited via "pause period ends" suggesting automatic expiration. However, nowhere else in the document is automatic pause expiration mentioned. The implementation status section and related features don't describe this behavior.

This creates ambiguity: Is pause time-limited or indefinite? Does it auto-resume or require manual action?

**Options:**
1. **Clarify as manual-only** - Remove "pause period ends", state only "Admin resumes"
2. **Document the auto-expiration behavior** - Add details about pause duration limits
3. **Mark as future enhancement** - Note that auto-expiration is planned but not implemented
4. **Skip** - Accept the ambiguity (not recommended)

**Recommendation:** Option 1 or 3, depending on actual implementation:
- If pause is indefinite: Remove "pause period ends" from exit conditions
- If auto-expiration exists: Document the duration and behavior in Section 3 (Detailed Logic)
- If planned but not implemented: Add to Section 10 (Open Questions) and mark in state table

**Suggested Fix:**
Investigate the actual pause implementation and update the state definition to match reality. If pause is indefinite, the exit column should read: "Admin resumes" (remove "pause period ends").

---

### Finding 3: Inconsistent cancellation exit condition in trialing state

**Severity:** Low
**Category:** Inconsistency
**Location:** Section 2: State Definitions table, `trialing` state row (line 83)

**Issue:**
The `trialing` state's "How to Enter" column says "Subscription created" but the state table structure doesn't have an "admin cancels" option in the "How to Exit" column, even though this is a valid exit path from trialing.

This is a minor documentation inconsistency where the state table doesn't fully capture all state transitions.

**Options:**
1. **Add cancellation to exit paths** - Update "How to Exit" to include "admin cancels → cancelled"
2. **Reference the state machine diagram** - Note that state table is simplified and refer to diagram
3. **Skip** - Minor issue, not worth fixing
4. **Consolidate into comprehensive state transition table** - Create exhaustive state→state matrix

**Recommendation:** Option 1 - Add to exit conditions:
"Trial ends, payment processed, admin cancels"

**Suggested Fix:**
Update line 83 "How to Exit" column from "Trial ends, payment processed" to "Trial ends, payment processed, admin cancels"

---

### Finding 4: Seat addition payment failure edge case lacks resolution

**Severity:** High
**Category:** Logic Issue + Documented Issue
**Location:**
- Section 4: Edge Cases table, scenario #8 (line 159)
- Section 10: Open Questions, question #7 (lines 292-293)

**Issue:**
The documentation identifies that if payment fails during seat addition, there may be inconsistency between the database `seat_count` and Stripe's subscription quantity. The current behavior:

1. Admin adds seats via `update-settings` API
2. Database optimistically updates `seat_count`
3. Stripe processes invoice asynchronously
4. If payment fails, seats remain in DB but aren't paid for in Stripe

This creates a data integrity issue where the organization has more seats in the local DB than they're paying for. The documentation flags this as "⚠️" and notes "This needs investigation" but provides no resolution path.

**Options:**
1. **Implement pessimistic seat updates** - Only update DB after Stripe confirms payment
2. **Add reconciliation job** - Periodic sync between DB and Stripe quantities
3. **Add rollback on payment failure** - Webhook handler removes seats if invoice fails
4. **Block seat additions during past_due** - Prevent the scenario entirely
5. **Skip** - Accept data inconsistency (not recommended for billing features)

**Recommendation:** Option 3 (short-term) + Option 2 (long-term):
- Immediate: Enhance `handleInvoicePaymentFailed` to check if the failed invoice was a seat addition and rollback the seat count
- Long-term: Implement periodic reconciliation job that syncs seat counts weekly
- This maintains good UX (seats are added immediately on success) while ensuring eventual consistency

**Suggested Fix:**
Create a new ticket to:
1. Add seat addition detection to payment failure handler
2. Implement rollback logic when seat addition invoices fail
3. Add reconciliation job for periodic Stripe→DB sync
4. Add monitoring/alerting for seat count mismatches

---

### Finding 5: Contradictory timing scenario for subscription cancellation

**Severity:** Medium
**Category:** Logic Issue
**Location:** Section 4: Edge Cases table, scenario #14 (line 165)

**Issue:**
Scenario #14 states: "Subscription cancelled then payment succeeds" with current behavior "Depends on timing" marked as ⚠️ and noted "Edge case not explicitly handled".

This represents a potential race condition:
1. Stripe sends `subscription.deleted` webhook
2. Server updates status to `cancelled`
3. Stripe sends `invoice.paid` webhook (late/delayed)
4. Server updates status to `active`
5. Organization now appears active but has no Stripe subscription

This could lead to free service access or confused state.

**Options:**
1. **Add webhook ordering logic** - Track webhook event timestamps and ignore out-of-order events
2. **Verify subscription exists before status updates** - Query Stripe API on `invoice.paid` to confirm subscription is active
3. **Accept eventual consistency** - Document that subsequent webhook will correct the state
4. **Add subscription_deleted_at timestamp** - Prevent status updates after cancellation timestamp
5. **Skip** - Very rare scenario, acceptable risk

**Recommendation:** Option 4 (simplest and most reliable):
- Add `subscription_deleted_at` timestamp column to organizations table
- In `handleInvoicePaymentFailed` and `handleInvoicePaid`, check if subscription was deleted
- If `subscription_deleted_at` exists and is before invoice event timestamp, skip status update
- Log warning about out-of-order webhook

**Suggested Fix:**
Document the expected behavior and update edge case scenario #14 to specify:
- If cancellation happens first: Ignore subsequent payment webhooks (subscription is terminated)
- If payment succeeds first: Normal flow, cancellation will override if it follows
Update status from "⚠️ Edge case not explicitly handled" to "✅ Handled by webhook timestamp ordering"

---

### Finding 6: Missing webhook signature verification implementation details

**Severity:** Low
**Category:** Missing Scenarios
**Location:** Section 6: Security table (lines 210-214)

**Issue:**
The security section states "Stripe signature verification using `webhookSecret`" but doesn't provide implementation details that would be useful for understanding the security model:

- Where is the webhook secret stored? (Environment variable? Secrets manager?)
- What happens if verification fails? (Logged? Alerted?)
- Is there rate limiting on webhook failures?
- Are invalid webhooks logged for security auditing?

While the security measure is implemented, the documentation lacks operational details that would help with:
- Troubleshooting webhook issues
- Security auditing
- Incident response

**Options:**
1. **Add implementation subsection** - Create "Webhook Security Implementation" section with details
2. **Reference code location** - Point to specific lines in webhook handler showing the check
3. **Add to Code References section** - Expand line 255 entry to include security details
4. **Skip** - Security details intentionally omitted from feature docs (security through obscurity)

**Recommendation:** Option 3 - Expand the Code References section:
Add details about:
- Webhook secret location (environment variable)
- Verification failure behavior (400 response, logged)
- Signature verification code location

**Suggested Fix:**
Add to Section 8 (Code References), webhook handler entry (line 255):
```
| Webhook signature verification | `apps/server/src/features/billing/stripe-webhook-handler.ts` | 220-225 | Uses Stripe SDK, secret from `process.env.STRIPE_WEBHOOK_SECRET`, returns 400 on failure |
```

---

## Additional Observations

### Strengths
1. **Comprehensive structure** - All 10 required sections are present and well-organized
2. **Clear state machine diagram** - Visual representation helps understand transitions
3. **Honest implementation status** - Documentation clearly states what's NOT implemented
4. **Good use of warning indicators** - ⚠️ and ❌ symbols make missing features obvious
5. **Edge case coverage** - 14 scenarios documented with current behavior assessment

### Areas for Enhancement
1. **Consider adding sequence diagrams** - Would complement state machine for webhook flows
2. **Add admin user stories** - Section 1 mentions admin goals but could expand with actual user stories
3. **Link to Stripe documentation** - Reference Stripe Smart Retries docs for webhook behavior
4. **Add monitoring/observability section** - How to track past_due orgs, failed payments, etc.

---

## Recommendations Priority

| Priority | Finding # | Action | Estimated Effort |
|----------|-----------|--------|------------------|
| **P0** | 1 | Update TypeScript type documentation to reflect TKT-005A fix | 5 min |
| **P0** | 4 | Create ticket for seat addition payment failure handling | 30 min (ticket creation) |
| **P1** | 5 | Document webhook ordering strategy for cancelled subscriptions | 15 min |
| **P1** | 2 | Clarify pause expiration behavior | 10 min (if manual-only), 30 min (if needs investigation) |
| **P2** | 3 | Add cancellation to trialing state exit conditions | 2 min |
| **P2** | 6 | Add webhook security implementation details | 10 min |

---

## Next Steps

1. **Immediate:** Update documentation to fix Finding #1 (TypeScript type is now implemented)
2. **Triage Agent:** Process findings and create tickets for:
   - Finding #4: Seat addition payment failure reconciliation
   - Finding #5: Webhook race condition handling
3. **Documentation Team:** Address findings #2, #3, #6 in next doc update
4. **PM Review:** Determine if findings #4 and #5 require immediate fixes or can be backlogged

---

## Completion Checklist

- [x] Checked existing findings for this feature (PM Dashboard API unavailable)
- [x] Read entire doc file (315 lines)
- [x] Analyzed all 10 sections for issues
- [x] Identified 6 findings with severity ratings
- [x] Each finding has options for resolution
- [x] Each finding has a recommendation
- [x] Wrote summary to `docs/agent-output/reviews/TKT-005A-20251212T1506.md`
- [x] Attempted CLI submission (failed - API not available)

---

**Review Status:** ✅ COMPLETE

**Note to Triage Agent:** PM Dashboard findings API was unavailable during review. Please manually process these findings into the staging/inbox system.
