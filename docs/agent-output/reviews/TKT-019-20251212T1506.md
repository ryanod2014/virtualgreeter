# Review Complete: TKT-019

**Reviewed:** 2025-12-12
**Session ID:** 3f6cc326-d7d6-42d4-99b5-840dae928cb8
**Doc Files:**
- `docs/features/agent/incoming-call.md`
- `docs/features/agent/rna-timeout.md`

**Ticket:** TKT-019 - Sync Incoming Call Countdown with RNA Timeout
**Status:** `done` (but incomplete implementation found)

---

## Executive Summary

TKT-019 was supposed to sync the incoming call modal countdown with the organization's RNA timeout setting. The code changes were partially implemented but **not fully wired up**, resulting in the bug still existing in production. The documentation also wasn't updated to reflect the intended fix.

**Critical Issue:** The countdown still defaults to 15 seconds and doesn't sync with org settings because the server doesn't send `rnaTimeoutSeconds` to the dashboard.

---

## Findings

### 1. TKT-019 Implementation Incomplete (CRITICAL)

**Category:** Implementation Gap
**Severity:** Critical
**Location:**
- Component: `apps/dashboard/src/features/workbench/incoming-call-modal.tsx`
- Shell: `apps/dashboard/src/features/signaling/dashboard-shell.tsx:103-107`
- Server: `apps/server/src/features/signaling/socket-handlers.ts:375-383`
- Types: `packages/domain/src/types.ts:361-364`

**Issue:**

The incoming call modal component was updated to accept `rnaTimeoutSeconds` as a prop (line 13, 23), but:

1. The prop is **not passed** when the component is rendered in `dashboard-shell.tsx`:
   ```tsx
   <IncomingCallModal
     incomingCall={incomingCall}
     onAccept={acceptCall}
     onReject={rejectCall}
     // ❌ Missing: rnaTimeoutSeconds={...}
   />
   ```

2. The `CallIncomingPayload` type doesn't include `rnaTimeoutSeconds`:
   ```typescript
   export interface CallIncomingPayload {
     request: CallRequest;
     visitor: Pick<VisitorSession, "visitorId" | "pageUrl" | "connectedAt" | "location">;
     // ❌ Missing: rnaTimeoutSeconds: number;
   }
   ```

3. The server doesn't send the RNA timeout value when emitting `call:incoming` (socket-handlers.ts:375).

**Result:** The modal defaults to 15 seconds (hardcoded constant) regardless of org settings, which is exactly the bug TKT-019 was supposed to fix.

**Options:**

1. **Complete the implementation** (Recommended)
   - Add `rnaTimeoutSeconds` to `CallIncomingPayload` interface
   - Server fetches org RNA timeout and includes it in the payload
   - Dashboard shell passes the value to the modal component
   - Update tests

2. **Revert the partial fix**
   - Remove the `rnaTimeoutSeconds` prop from the component
   - Document that countdown is always 15s
   - Accept the mismatch as a known limitation

3. **Alternative: Store org settings in client state**
   - Send RNA timeout during login
   - Store in agent state
   - Use stored value for countdown
   - Pros: One-time fetch, less data per event
   - Cons: Stale if admin changes setting mid-session

4. **Skip** - Leave as-is (not recommended)

**Recommendation:** Option 1. The component is already built to handle this, we just need to wire it up properly. This is the cleanest solution and matches the original ticket intent.

**Estimated Effort:** ~1-2 hours (update types, server emit, pass prop, test)

---

### 2. Documentation Still Shows Bug as Unfixed (HIGH)

**Category:** Documentation Out of Sync
**Severity:** High
**Location:** `docs/features/agent/incoming-call.md:133-138`

**Issue:**

The documentation still describes the bug TKT-019 was supposed to fix:

```markdown
| UI Countdown Display | 30 seconds | ❌ No | Hardcoded in `incoming-call-modal.tsx` |

**⚠️ UI/Server Mismatch**: The modal shows a 30-second countdown but RNA actually
fires at 15 seconds (or org-configured value). See finding Q-1202-003 below.
```

This suggests either:
- The docs weren't updated after TKT-019 was marked "done"
- The reviewer who marked it done didn't verify the full implementation
- There's confusion about what was actually implemented

**Options:**

1. **Update docs to reflect actual state** (Recommended)
   - Change entry to show "15 seconds" not "30 seconds" (component now defaults to 15, not 30)
   - Keep the warning that it still doesn't sync with org settings
   - Reference this finding as the blocker

2. **Reopen TKT-019**
   - Mark ticket status back to "in_progress" or "blocked"
   - Add notes about what's missing

3. **Create new ticket for completion**
   - TKT-019A: "Complete RNA timeout sync - wire up server payload"
   - Keep original ticket as "done" (component ready)
   - New ticket for integration

**Recommendation:** Option 1 + Option 3. Update docs to current state (defaults to 15s, not synced), and create a follow-up ticket to complete the wiring.

---

### 3. File Path Inconsistency in Documentation (MEDIUM)

**Category:** Documentation Accuracy
**Severity:** Medium
**Location:**
- Docs: `incoming-call.md:111, 343`
- Ticket: `tickets.json` TKT-019 `files_to_modify`

**Issue:**

The documentation references:
```
apps/dashboard/src/features/workbench/incoming-call-modal.tsx
```

But TKT-019 specifies:
```
apps/dashboard/src/features/incoming-call/incoming-call-modal.tsx
```

**Actual path:** `apps/dashboard/src/features/workbench/incoming-call-modal.tsx` ✅

The docs are correct, but the ticket has the wrong path. This could confuse future devs.

**Options:**

1. **Update ticket data** (Recommended)
   - Fix `files_to_modify` in tickets.json
   - Ensures future agents get correct paths

2. **Add note to docs**
   - Add comment that file was moved from `incoming-call/` to `workbench/`
   - Helps explain discrepancy

3. **Skip** - Minor issue, actual file is findable

**Recommendation:** Option 1. Takes 30 seconds to fix and prevents confusion.

---

### 4. No Visitor Notification During Reassignment (MEDIUM)

**Category:** UX Gap (Already Documented)
**Severity:** Medium
**Location:** `incoming-call.md:287-289`, `rna-timeout.md:285-295`

**Issue:**

Both docs mention that when RNA timeout triggers and visitor is reassigned to another agent, the visitor sees no indication of what's happening:

> **If Reassigned:**
> - Seamless experience - visitor continues seeing "Connecting..." UI
> - **No explicit "finding another agent" message** currently

This could lead to visitor confusion if the wait seems long.

**Options:**

1. **Add reassignment notification**
   - Widget shows: "Agent unavailable, connecting you to another team member..."
   - Gives visitor context for the delay
   - Manages expectations

2. **Keep silent but add subtle indicator**
   - Update "Connecting..." to show elapsed time
   - "Connecting... (5s)" gives feedback without alarming visitor

3. **Skip** - Current behavior is intentional for seamless experience
   - Visitor doesn't know there was a problem
   - Fast reassignment makes this a non-issue

**Recommendation:** Option 2. A simple elapsed time indicator gives feedback without making the visitor anxious about the reassignment. Only show message if reassignment takes >5s.

**Note:** This is already documented as an issue in both feature docs, so this finding is mainly to ensure it doesn't get lost.

---

### 5. Multiple Tabs Behavior Under-Documented (LOW)

**Category:** Documentation Completeness
**Severity:** Low
**Location:** `incoming-call.md:195-196`, `rna-timeout.md` (no mention)

**Issue:**

The incoming-call doc mentions multiple tabs briefly:

> | 8 | Multiple tabs open | Agent logged in on 2 tabs | Both receive notification | ⚠️ | Accepting on one clears both |

But doesn't explain:
- What happens if agent accepts on Tab A while Tab B is still showing modal?
- Does Tab B get a "call was answered" notification?
- What if RNA timeout fires and both tabs are backgrounded?
- Is this tested? Are there race conditions?

The RNA timeout doc doesn't mention multiple tabs at all.

**Options:**

1. **Add detailed multi-tab section** (Recommended)
   - Document exact behavior
   - Add state diagram for multi-tab scenarios
   - Document any known issues

2. **Add to edge cases table**
   - Expand row 8 in incoming-call.md
   - Add similar row to rna-timeout.md

3. **Test and document**
   - QA tests multi-tab scenarios
   - Document actual behavior found
   - File bugs for any issues

4. **Skip** - Edge case, most agents use one tab

**Recommendation:** Option 2. Expand the edge case documentation to include more details about multi-tab behavior. If testing reveals issues, file separate tickets.

---

### 6. Countdown Shows Negative Time Edge Case (LOW)

**Category:** Code Quality
**Severity:** Low
**Location:** `incoming-call-modal.tsx:137`

**Issue:**

The countdown uses `Math.max(0, rnaTimeoutSeconds - timeElapsed)` to prevent negative numbers, which is good. However, if there's any delay in receiving the `call:cancelled` event, the countdown could sit at "0s" briefly.

Current code:
```tsx
Request expires in {Math.max(0, rnaTimeoutSeconds - timeElapsed)}s
```

**Options:**

1. **Change text at 0s**
   - When countdown reaches 0, show "Connecting..." instead of "expires in 0s"
   - Better UX

2. **Add slight buffer**
   - Count down to 1s instead of 0s
   - Show "Connecting..." for last second

3. **Skip** - Math.max handles it fine, 0s is acceptable

**Recommendation:** Option 3. This is handled correctly, just noting for completeness.

---

## Summary Statistics

- **Total Findings:** 6
- **Critical:** 1 (Incomplete implementation)
- **High:** 1 (Documentation out of sync)
- **Medium:** 3 (File path, reassignment UX, multi-tab)
- **Low:** 2 (Multi-tab docs, countdown edge case)

---

## Critical Path Items

To properly close TKT-019, the following must be done:

1. ✅ Component accepts `rnaTimeoutSeconds` prop (DONE)
2. ❌ Add `rnaTimeoutSeconds` to `CallIncomingPayload` type
3. ❌ Server fetches org RNA timeout and sends in payload
4. ❌ Dashboard shell passes prop to modal
5. ❌ Update documentation to remove warning
6. ❌ Test with various org timeout settings

**Recommendation:** Create TKT-019A to complete items 2-6.

---

## Related Tickets to Consider

Based on findings, consider creating:

- **TKT-019A:** Complete RNA timeout sync (wire up server → client)
- **TKT-XXX:** Add visitor notification during reassignment
- **TKT-XXX:** Document/test multiple tab behavior
- **TKT-XXX:** Fix file path in TKT-019 ticket data

---

## Notes

### Testing Recommendations

When implementing the fix:

1. Test with org timeout set to: 10s, 15s, 20s, 30s
2. Test accept at exact timeout moment (100ms grace period)
3. Test with multiple tabs open
4. Test countdown accuracy (should match RNA timeout exactly)
5. Verify RNA still fires at correct time on server

### Code Review Checklist

- [ ] `CallIncomingPayload` includes `rnaTimeoutSeconds: number`
- [ ] Server fetches from `callSettings.rna_timeout_seconds`
- [ ] Server includes value in `call:incoming` emit
- [ ] Dashboard shell extracts value from payload
- [ ] Dashboard shell passes to `<IncomingCallModal>`
- [ ] Component uses value correctly (already implemented)
- [ ] Tests updated for all timeout values
- [ ] Documentation warning removed
- [ ] Timing table updated to show "Yes" for configurable countdown

---

## Agent Output

**Review Agent Session:** 3f6cc326-d7d6-42d4-99b5-840dae928cb8
**Completed:** 2025-12-12T15:06:00Z
**Agent Type:** Review Agent
**Status:** ✅ Review Complete

**Next Steps:**
1. Human reviews findings
2. Triage agent processes into inbox
3. Human decides priority
4. Ticket agent creates follow-up tickets

---

*Note: The agent-cli.sh add-finding command returned "Not found" errors, likely because the PM Dashboard API endpoints are not fully implemented. Findings are documented here instead of in the staging database.*
