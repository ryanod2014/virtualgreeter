# Review Complete: TKT-098

**Reviewed:** 2025-12-12
**Ticket:** TKT-098 - Fix Tiered Routing to Prefer Idle Agents Over Least-Connections
**Feature:** Tiered Agent Assignment
**Doc Files:**
- `docs/features/admin/tiered-routing.md`
- `apps/server/src/features/routing/pool-manager.ts` (implementation)

---

## Executive Summary

Reviewed documentation for TKT-098, which fixed a bug where busy agents could be selected over idle agents in the same tier. The code fix (pool-manager.ts:641-685) correctly implements the `hasIdleCandidate` flag to ensure idle agents are always preferred.

**However**, the feature documentation has NOT been updated to reflect this fix. The pseudocode in the APPENDIX still shows the buggy algorithm, which could mislead future developers.

---

## Findings Submitted to Staging

| Finding ID | Title | Severity | Status |
|------------|-------|----------|--------|
| F-786 | Outdated pseudocode shows buggy algorithm (pre-TKT-098) | High | Staging |
| F-787 | Data flow description does not clarify idle-always-first priority | Medium | Staging |
| F-788 | Edge case matrix missing TKT-098 scenario | Low | Staging |

---

## Summary by Severity

- **Total:** 3
- **Critical:** 0
- **High:** 1
- **Medium:** 1
- **Low:** 1

---

## Finding Details

### F-786: Outdated pseudocode shows buggy algorithm (pre-TKT-098) ðŸ”´ HIGH

**Location:** docs/features/admin/tiered-routing.md - Section APPENDIX, lines 347-377

**Issue:**
The APPENDIX pseudocode shows the OLD algorithm from before TKT-098 fix. It's missing the `hasIdleCandidate` flag that ensures idle agents are always preferred over busy agents.

Specifically, lines 360-374 show:
```typescript
// For idle agents with 0 load: round-robin (oldest assignment order wins)
if (agent.status === 'idle' && load === 0) {
  if (order < oldestOrder) {
    oldestOrder = order;
    bestAgent = agent;
  }
  continue;
}

// For agents with load: least-connections
if (load < lowestLoad) {
  lowestLoad = load;
  bestAgent = agent;  // âŒ BUG: This can overwrite idle agent!
}
```

The actual implementation (pool-manager.ts:645-685) correctly has:
```typescript
let hasIdleCandidate = false;

// ... in loop ...
if (agent.profile.status === "idle" && currentLoad === 0) {
  hasIdleCandidate = true;
  // ... select idle agent ...
}

// âœ… FIX: Only consider busy agents if no idle found
if (!hasIdleCandidate && currentLoad < lowestLoad) {
  lowestLoad = currentLoad;
  bestAgent = agent;
}
```

**Options:**
1. Update pseudocode to match current implementation - Add hasIdleCandidate flag
2. Add warning comment that this is the old algorithm
3. Remove pseudocode entirely - Rely only on actual code references
4. Skip - accept that documentation may lag behind code

**Recommendation:** Option 1 - Developers rely on this doc for understanding the algorithm.

---

### F-787: Data flow description does not clarify idle-always-first priority ðŸŸ¡ MEDIUM

**Location:** docs/features/admin/tiered-routing.md - Section 3, lines 124-132

**Issue:**
The "Data Flow" section describes within-tier selection as two parallel strategies:
- "For idle agents with 0 load: Pick oldest assignmentOrder (round-robin)"
- "For agents with load: Pick lowest currentSimulations.length"

This reads like two equal strategies rather than a priority hierarchy. A developer might think busy agents with load=1 can compete with idle agents with load=0.

**Options:**
1. Add explicit priority statement: "Priority: Idle agents are ALWAYS selected before busy agents"
2. Add flowchart showing idle-first decision tree
3. Rewrite as numbered steps with IF/ELSE logic
4. Skip - current description is sufficient

**Recommendation:** Option 1 - Quick fix that clarifies intent.

---

### F-788: Edge case matrix missing TKT-098 scenario ðŸŸ¢ LOW

**Location:** docs/features/admin/tiered-routing.md - Section 4, lines 160-172

**Issue:**
The edge case matrix doesn't document the specific scenario TKT-098 fixed: "Same tier has both idle agent (load=0) and busy agent (load=1+) - which gets selected?"

Adding this as a tested edge case would:
- Document the fix for future reference
- Prevent regression
- Make TKT-098 discoverable when reading the docs

**Options:**
1. Add row to edge case matrix documenting idle-first selection
2. Add dedicated test case section referencing TKT-098
3. Skip - algorithm section already covers this

**Recommendation:** Option 1 - Makes the fix discoverable.

---

## Review Notes

### What Was Reviewed

1. **Feature Documentation:**
   - docs/features/admin/tiered-routing.md (all 10 sections)
   - Related: docs/features/admin/routing-rules.md (for context)

2. **Code Implementation:**
   - apps/server/src/features/routing/pool-manager.ts (tiered routing algorithm)
   - Specifically lines 641-685 (findBestAgentInTier function)

3. **Original Finding:**
   - F-088: Algorithm May Select Busy Agent Over Idle Agent (the bug TKT-098 fixed)

### What Was NOT Reviewed

- Test files (not in scope for doc review)
- UI components (not affected by this change)
- Other routing features (not modified by TKT-098)

### Positive Observations

1. **Code is correct** - The implementation properly fixes F-088
2. **Edge case matrix is comprehensive** - Covers most scenarios well
3. **State machine diagrams are clear** - Visual flow is easy to follow
4. **Code references are accurate** - Line numbers and file paths are correct

### Critical Path

The HIGH severity finding (F-786) is the most important. Outdated pseudocode in developer documentation can:
- Mislead future developers implementing similar features
- Cause regressions if someone "fixes" the code to match the docs
- Waste time debugging when code behavior doesn't match documentation

---

## Recommendations for Triage

1. **Prioritize F-786 (High)** - Create ticket to update pseudocode immediately
2. **Consider F-787 (Medium)** - Low effort, high clarity improvement
3. **Optional F-788 (Low)** - Nice-to-have for completeness

---

## Session Info

- **Session ID:** 681f77e8-48b2-428a-96ad-fd9024250988
- **Agent Type:** Review Agent
- **Reviewed:** 2025-12-12 15:06 UTC
- **Finding IDs:** F-786, F-787, F-788

---

## Next Steps

Findings are now in **staging**. The Triage Agent will:
1. Review findings
2. Deduplicate if needed
3. Promote to human inbox
4. Human decides: create tickets, merge, or reject
