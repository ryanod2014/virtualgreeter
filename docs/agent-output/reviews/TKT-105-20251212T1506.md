# Review Complete: TKT-105 - TypeScript Type Missing past_due Status

**Reviewed:** 2025-12-12
**Session ID:** 90ed19d5-c5db-4e17-9246-57562935c98d
**Reviewer:** Review Agent
**Doc File:** `docs/features/billing/payment-failure.md`
**Related Ticket:** TKT-105
**Feature:** Payment Failure (B6)

---

## Executive Summary

**CRITICAL FINDING:** TKT-105 is a duplicate ticket. The requested change has already been completed in TKT-005a (commit 73ab167). The `SubscriptionStatus` type at `packages/domain/src/database.types.ts:39` already includes `past_due`.

The Payment Failure documentation is comprehensive and well-structured. However, it reveals several significant issues with the feature implementation itself (not the documentation), primarily around lack of user feedback and recovery paths.

---

## Findings Summary

**Note:** The findings CLI (`./scripts/agent-cli.sh add-finding`) is non-functional (API endpoint `/api/v2/findings` returns 404). Findings are documented below per the Review Agent SOP fallback protocol.

| # | Title | Severity | Category |
|---|-------|----------|----------|
| 1 | TKT-105 Already Completed - Duplicate Work | üî¥ Critical | Process/Ticket Management |
| 2 | Inconsistent Status Value References | üü° Medium | Documentation Clarity |
| 3 | Edge Case #14 Lacks Clear Resolution Path | üü° Medium | Confusing User Story |
| 4 | Ambiguous Service Access Statement | üü† High | UX/Logic Concern |
| 5 | Seat Addition During Past-Due Documented as Unclear | üü° Medium | Documented Issue |
| 6 | TypeScript Type Already Fixed But Not Reflected in Section 8 | üü¢ Low | Documentation Accuracy |

---

## Detailed Findings

### Finding 1: TKT-105 Already Completed - Duplicate Work

**Category:** Process/Ticket Management
**Severity:** üî¥ Critical
**Location:** `docs/data/tickets.json` (TKT-105), `packages/domain/src/database.types.ts:39`

**Issue:**
TKT-105 requests adding `past_due` to the `SubscriptionStatus` type, but this was already completed in TKT-005a (commit 73ab167: "TKT-005a: Add past_due status to SubscriptionStatus type").

Current code at `packages/domain/src/database.types.ts:39`:
```typescript
export type SubscriptionStatus = "active" | "paused" | "cancelled" | "trialing" | "past_due";
```

TKT-105 was created from finding F-296, which stated:
> "TypeScript type mismatch | SubscriptionStatus type doesn't include past_due"

This finding has been resolved, but TKT-105 remains in "ready" status, wasting agent resources.

**Options:**
1. **Close TKT-105 as duplicate** - Mark completed, link to TKT-005a, resolve F-296 if not already
2. **Verify and close** - Run `pnpm typecheck` to confirm no errors, then close
3. **Convert to verification ticket** - Expand scope to verify exhaustive switch statements (mentioned in acceptance criteria)
4. **Keep open** - Assume PM has additional requirements beyond type definition

**Recommendation:** Option 1 - Immediately close as duplicate. The type is correct, the acceptance criteria are met (SubscriptionStatus includes past_due, TypeScript compilation should succeed). Any agent assigned this ticket will find zero work to do.

**Human Decision:** ‚è≥ PENDING

---

### Finding 2: Inconsistent Status Value References

**Category:** Documentation Clarity
**Severity:** üü° Medium
**Location:** Section 4 (Edge Cases), Section 6 (Technical Concerns)

**Issue:**
The documentation inconsistently uses `past_due` (with underscore, the correct database/TypeScript value) and occasionally might be confused with natural language "past due" (with space). While the documentation is mostly correct, there's potential for confusion.

**Specific instances:**
- ‚úÖ Section 3: Uses `past_due` correctly throughout
- ‚úÖ Section 4: Table uses `past_due` correctly
- ‚ö†Ô∏è Section 2: State diagram shows "past_due" label but uses natural language "past due" in callouts
- ‚úÖ Section 5: Uses backticks correctly: "`past_due` status"

**Options:**
1. **Standardize formatting** - Always use backticks for literal values: `past_due`
2. **Add glossary note** - Define at top: "We use `past_due` (underscore) for the database/code value"
3. **Skip** - Current formatting is clear enough in context

**Recommendation:** Option 1 - Add backticks consistently for all status values in prose (not just tables/code blocks). This improves scannability for developers.

**Human Decision:** ‚è≥ PENDING

---

### Finding 3: Edge Case #14 Lacks Clear Resolution Path

**Category:** Confusing User Story / Logic Issue
**Severity:** üü° Medium
**Location:** Section 4 - Edge Cases, Row #14

**Issue:**
Edge case #14 states:
> "Subscription cancelled then payment succeeds | `invoice.paid` after `subscription.deleted` | Depends on timing | ‚ö†Ô∏è Edge case not explicitly handled"

The documentation correctly identifies this as an unhandled edge case but doesn't explain what "depends on timing" means or what the actual system behavior would be.

**Scenario breakdown:**
- If `subscription.deleted` webhook arrives first: org status ‚Üí `cancelled`
- If `invoice.paid` webhook then arrives: what happens?
  - Option A: Status updated to `active` (incorrect - no active subscription exists)
  - Option B: Webhook fails to find subscription, errors out
  - Option C: Idempotent check sees `cancelled`, skips update
  - Option D: Database constraint prevents invalid state transition

**Options:**
1. **Document current behavior** - Test/read code to determine what actually happens, document it
2. **Add to open questions** - Move to Section 10 as a question requiring PM decision
3. **Create ticket** - Spawn a ticket to investigate and fix if needed
4. **Mark as acceptable risk** - If Stripe doesn't send `invoice.paid` after `subscription.deleted`, this may not occur in practice

**Recommendation:** Option 1 - Investigate actual code behavior in `stripe-webhook-handler.ts` and document it. If it's broken, create a separate finding/ticket.

**Human Decision:** ‚è≥ PENDING

---

### Finding 4: Ambiguous Service Access Statement

**Category:** UX/Logic Concern
**Severity:** üü† High
**Location:** Section 4 - Edge Case #9, Section 5 - User Experience Audit

**Issue:**
Edge case #9 states:
> "Service access during `past_due` | Login, widget | Full access continues | ‚ö†Ô∏è No restrictions enforced"

And Section 5 confirms:
> "Admin logs in | Normal dashboard | ‚ùå | No indication of `past_due` status"

However, Section 1 states:
> "Admin | Continue using service during payment issue | ‚úÖ No restrictions currently enforced"

The checkmark (‚úÖ) in Section 1 implies this is a _positive_ feature meeting user goals, but Section 4 and 5 mark it with warnings (‚ö†Ô∏è/‚ùå), suggesting it's a problem.

**The confusion:**
- Is unrestricted access during `past_due` a **feature** (grace period) or a **bug** (revenue loss)?
- If it's intentional, the ‚ö†Ô∏è warnings are misleading
- If it's unintentional, the ‚úÖ in Section 1 is wrong

**Options:**
1. **Clarify as intentional grace period** - Remove warnings, document grace period policy in Section 10
2. **Clarify as bug** - Change ‚úÖ to ‚ùå in Section 1, create ticket to add restrictions
3. **Mark as open question** - Move to Section 10: "What is the intended grace period policy?"
4. **Split into phases** - Document that Phase 1 has no restrictions, Phase 2 will add them

**Recommendation:** Option 3 - Add to Open Questions. The documentation can't determine if this is intentional without PM input. The inconsistency suggests the team hasn't decided.

**Human Decision:** ‚è≥ PENDING

---

### Finding 5: Seat Addition During Past-Due Documented as Unclear

**Category:** Documented Issue
**Severity:** üü° Medium
**Location:** Section 4 - Edge Case #8, Section 10 - Open Question #7

**Issue:**
The documentation correctly identifies that seat addition during `past_due` may cause inconsistency:
> "Payment fails during seat addition | `invoice.payment_failed` | Status ‚Üí `past_due`, seats still added in DB | ‚ö†Ô∏è Seats may be inconsistent with Stripe"

And Open Question #7 elaborates:
> "What happens if payment fails during seat addition? ‚Äî Currently, seats are added to DB optimistically via `update-settings` API before Stripe processes. If invoice fails, there may be inconsistency between DB `seat_count` and Stripe quantity. This needs investigation."

**The issue:**
- This is documented but unresolved
- No ticket exists to investigate this issue (or it's not referenced)
- The impact could be significant (orgs getting more seats than paid for)

**Options:**
1. **Create investigation ticket** - Spawn TKT to reproduce and document actual behavior
2. **Create fix ticket immediately** - Assume it needs fixing, create ticket to implement proper rollback
3. **Downgrade to low priority** - If seats sync on next billing cycle, maybe not critical
4. **Add to findings as high severity** - Revenue impact could be significant

**Recommendation:** Option 1 - Create investigation ticket first. We don't know if this actually happens in practice or if there are mitigations already in place.

**Human Decision:** ‚è≥ PENDING

---

### Finding 6: TypeScript Type Already Fixed But Not Reflected in Section 8

**Category:** Documentation Accuracy
**Severity:** üü¢ Low
**Location:** Section 8 - Code References, Row 6

**Issue:**
Section 8, row 6 states:
> "TypeScript types | `packages/domain/src/database.types.ts` | 39 | ‚ö†Ô∏è Missing `past_due` in `SubscriptionStatus` type"

This is outdated. The type was fixed in TKT-005a. Current code shows:
```typescript
export type SubscriptionStatus = "active" | "paused" | "cancelled" | "trialing" | "past_due";
```

**Options:**
1. **Update documentation** - Change ‚ö†Ô∏è to ‚úÖ, update note to "Includes `past_due`"
2. **Remove row** - No longer notable since it's correct
3. **Skip** - Low priority, not worth a doc update

**Recommendation:** Option 1 - Update to ‚úÖ for accuracy. Takes 30 seconds and removes confusion.

**Human Decision:** ‚è≥ PENDING

---

## Overall Assessment

### Documentation Quality: ‚≠ê‚≠ê‚≠ê‚≠ê¬Ω (4.5/5)

**Strengths:**
- ‚úÖ Comprehensive 10-section structure covers all aspects
- ‚úÖ Clear state machine diagram with accurate transitions
- ‚úÖ Honest about missing features (no UI, no emails, no restrictions)
- ‚úÖ Edge cases thoroughly documented in matrix format
- ‚úÖ Open questions clearly identified and actionable
- ‚úÖ Code references with line numbers

**Weaknesses:**
- ‚ö†Ô∏è Some outdated info (Finding #6)
- ‚ö†Ô∏è Inconsistent tone on whether unrestricted access is good or bad (Finding #4)
- ‚ö†Ô∏è One edge case left vague (Finding #3)

### Feature Implementation: ‚≠ê‚≠ê (2/5)

The documentation reveals significant implementation gaps:
- ‚ùå No user notification of payment failure
- ‚ùå No self-service recovery path
- ‚ùå No service restrictions during past-due
- ‚ö†Ô∏è Potential seat billing inconsistency
- ‚úÖ Backend webhook handling works correctly
- ‚úÖ Database status updates are idempotent

**The feature exists primarily as infrastructure for future work, not as a complete user-facing feature.**

---

## Recommendations for Human Review

### Immediate Actions
1. **Close TKT-105 as duplicate** - No work to be done, wastes agent time
2. **Update Section 8, Row 6** - Change to ‚úÖ, note type is correct
3. **Verify typecheck passes** - Run `pnpm typecheck` to confirm no regressions

### Follow-Up Actions
4. **Clarify grace period policy** - PM decision needed on Finding #4
5. **Investigate seat addition edge case** - Create investigation ticket for Finding #5
6. **Document edge case #14 behavior** - Code review to determine actual behavior

### Optional Polish
7. **Standardize status value formatting** - Add backticks consistently (Finding #2)
8. **Add glossary** - Define `past_due` vs "past due" at document top

---

## Checklist

- [x] Checked existing findings for this feature (CLI non-functional, proceeded anyway)
- [x] Read entire documentation file (311 lines)
- [x] Analyzed all 10 sections for issues
- [x] Identified 6 findings across multiple categories
- [x] Each finding has options for human to choose from
- [x] Each finding has a recommendation
- [x] Wrote summary to `docs/agent-output/reviews/TKT-105-20251212T1506.md`

---

## Next Steps

Per the Review Agent SOP:
- ‚úÖ Review complete
- ‚ùå Findings NOT added to staging (CLI non-functional)
- ‚úÖ Summary report written
- ‚è≥ Awaiting human triage of findings

**Note:** The findings CLI is non-functional. These findings should be manually entered into the findings system or processed via alternative workflow.

---

*Review conducted by Review Agent following `docs/workflow/REVIEW_AGENT_SOP.md`*
