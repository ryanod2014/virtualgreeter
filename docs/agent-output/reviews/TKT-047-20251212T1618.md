# Review Complete: TKT-047

**Reviewed:** 2025-12-12
**Doc File:** `docs/features/auth/login-flow.md`
**Ticket:** TKT-047 - Handle Missing User Profile Row
**Status:** Merged to main (commit 154a4f6)

---

## Summary

Reviewed the Login Flow documentation after TKT-047 merged defensive handling for orphaned users (auth.users record exists but no corresponding users table row). The implementation adds detection at two points: login form submission and middleware redirect.

The fix is functionally sound but has several quality-of-life and documentation issues related to error handling, user experience, and recovery procedures.

---

## Findings Submitted to Staging

| # | Title | Severity | Finding ID |
|---|-------|----------|------------|
| 1 | Inconsistent orphaned user error messages between login form and middleware | Medium | F-1765581435246 |
| 2 | No error handling for failed role query in login flow | High | F-1765581453419 |
| 3 | Documentation doesn't specify what gets logged for orphaned users | Low | F-1765581468795 |
| 4 | Incomplete recovery path for orphaned users - what should support do? | Medium | F-1765581485743 |
| 5 | Orphaned user stuck in error state - can't retry or logout | Medium | F-1765581503918 |
| 6 | Edge case #20 marked as fixed but login vs middleware handle differently | Low | F-1765581520542 |

---

## Breakdown by Severity

- **Critical:** 0
- **High:** 1
  - F-1765581453419: No error handling for failed role query (distinguishing database errors from missing profile rows)
- **Medium:** 3
  - F-1765581435246: Inconsistent error messages
  - F-1765581485743: No support runbook for recovery
  - F-1765581503918: User stuck authenticated in error state
- **Low:** 2
  - F-1765581468795: Logging details not documented
  - F-1765581520542: Edge case table doesn't clarify two detection points

**Total:** 6 findings

---

## Key Issues by Category

### 1. Error Handling (High Priority)
The most critical issue is **F-1765581453419** (High severity): The code doesn't distinguish between:
- Database query failure (transient error - user should retry)
- Missing profile row (data integrity issue - requires support intervention)

Both scenarios result in `profile = null`, but should have different error messages and recovery paths.

### 2. User Experience (Medium Priority)
**F-1765581503918** (Medium severity): When an orphaned user is detected during login, they remain authenticated but can't proceed. This creates a confusing redirect loop with no clear escape path. User should be automatically signed out.

### 3. Documentation Gaps (Medium Priority)
**F-1765581485743** (Medium severity): Error message tells users to "contact support" but documentation doesn't explain what support should do to fix the issue. Need recovery runbook.

### 4. Code Consistency (Medium/Low Priority)
**F-1765581435246** (Medium) and **F-1765581520542** (Low): Error messages are duplicated between login form and middleware, and documentation doesn't clearly explain the two detection points.

### 5. Observability (Low Priority)
**F-1765581468795** (Low severity): Documentation doesn't specify logging destination or format. Console.error is used, but no integration with monitoring services mentioned.

---

## Implementation Analysis

### What TKT-047 Added:

**Login Form (page.tsx:64-74):**
```typescript
if (!profile) {
  console.error("[Login] Orphaned user detected...", { userId, email });
  setError("Your account is missing required profile information. Please contact support for assistance.");
  setIsLoading(false);
  return;
}
```

**Middleware (middleware.ts:94-100):**
```typescript
if (!profile) {
  console.error("[Middleware] Orphaned user detected...", { userId, email });
  return NextResponse.redirect(new URL("/login?error=missing_profile", request.url));
}
```

**Login Page Error Handling (page.tsx:19-28):**
```typescript
useEffect(() => {
  const errorParam = searchParams.get("error");
  if (errorParam === "missing_profile") {
    setError("Your account is missing required profile information. Please contact support for assistance.");
  }
}, [searchParams]);
```

### What's Missing:

1. **No error object checking** - `const { data: profile }` doesn't destructure `error`, so query failures are conflated with missing rows
2. **No signOut() call** - User remains authenticated in broken state
3. **No support runbook** - Documentation doesn't guide support staff on fixing orphaned accounts
4. **No prevention mechanism** - Supabase trigger mentioned in risks but not implemented

---

## Recommendations for PM/Human Review

### Immediate Actions (High/Medium Severity):

1. **Fix error handling** (F-1765581453419 - High):
   - Destructure `error` from query: `const { data: profile, error: profileError } = ...`
   - Check `if (profileError)` separately from `if (!profile)`
   - Show "Database error, please try again" vs "Contact support"

2. **Add auto sign-out** (F-1765581503918 - Medium):
   - Call `await supabase.auth.signOut()` before showing orphaned user error
   - Prevents redirect loop and clarifies user state

3. **Create support runbook** (F-1765581485743 - Medium):
   - Document SQL commands to manually create users row
   - Specify default values for role, org_id, etc.
   - Add to Section 10 of login-flow.md

### Future Improvements (Low Severity):

4. **Standardize error messages** (F-1765581435246 - Medium):
   - Create shared constant in packages/domain/src/error-messages.ts
   - Use in both page.tsx and middleware.ts

5. **Document logging** (F-1765581468795 - Low):
   - Add subsection under Technical Concerns explaining console.error usage
   - Recommend monitoring service integration for production alerting

6. **Clarify edge case table** (F-1765581520542 - Low):
   - Update edge case #20 notes to mention two detection points
   - Or split into separate rows for clarity

### Long-term Prevention:

7. **Implement Supabase trigger** (mentioned in original ticket risks):
   - Auto-create users row when auth.users row is inserted
   - Prevents orphaned users from occurring in the first place
   - This is the root cause fix

---

## Documentation Quality

Overall, the documentation is **thorough and well-structured**. The TKT-047 updates were added appropriately:
- ✅ Data flow diagram updated (lines 128-130)
- ✅ Edge case table updated (row 20, line 181)
- ✅ Error states table updated (line 193)
- ✅ Code references updated (if applicable)

**Areas for improvement:**
- More specificity about error handling edge cases
- Recovery procedures for support staff
- Logging and observability details

---

## Notes

- **Existing findings:** Checked 761 existing Login Flow findings - no duplicates found for TKT-047 specific issues
- **Risk level:** Low - The orphaned user scenario should be rare (indicates data integrity issue during signup)
- **User impact:** Medium - When it does occur, user experience is confusing and requires support intervention
- **Code quality:** Good defensive programming, but error handling could be more granular
- **Test coverage:** Manual testing only (per ticket qa_notes: "Test with intentionally orphaned user")

---

## Next Steps for Triage Agent

All findings have been submitted to staging with options and recommendations. Human should:
1. Review high-severity finding first (query error handling)
2. Decide on medium-severity UX fix (auto sign-out)
3. Prioritize support runbook documentation
4. Consider long-term prevention via database trigger

---

**Review completed by:** Review Agent
**Session:** 2025-12-12T16:18
