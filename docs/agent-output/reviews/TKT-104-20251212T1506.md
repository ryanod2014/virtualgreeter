# Review Complete: TKT-104 - Widget Not Disabled During Pause

**Reviewed:** 2025-12-12
**Session ID:** 57cfec21-6074-4002-94f8-b25291004624
**Ticket:** TKT-104 - Widget Not Disabled During Pause
**Feature:** Pause Subscription
**Doc Files:**
- `docs/features/billing/pause-subscription.md`
- `docs/features/visitor/widget-lifecycle.md` (referenced, widget-initialization.md does not exist)

---

## Executive Summary

TKT-104 addresses a critical gap where the widget continues to show and accept calls for paused organizations, completely negating the purpose of subscription pausing. The documentation review reveals that this issue is **already well-documented** in multiple sections of the pause-subscription.md file, but with **conflicting severity ratings** and no cross-reference to this ticket.

**Key Finding:** The issue is documented in at least 3 places with inconsistent severity:
- Edge Case #16: Marked as ‚ùå (broken/critical)
- Section 6 Technical Concerns (Issue #3): Rated üü° Medium
- TKT-104 itself: Rated High priority

---

## Findings Summary

### Critical Findings: 0
### High Severity Findings: 5
### Medium Severity Findings: 2
### Low Severity Findings: 1

**Total: 8 findings**

---

## Detailed Findings

### Finding 1: Conflicting Severity Ratings for Widget Visibility Issue
- **Severity:** High
- **Category:** Documentation Inconsistency
- **Location:** `docs/features/billing/pause-subscription.md`
  - Line 169 (Edge Case #16)
  - Lines 252-256 (Section 6, Issue #3)

**Issue:**
The same problem (widget not disabled during pause) is documented in multiple locations with conflicting severity ratings:
- **Edge Case #16:** "Widget visibility during pause | Visitor loads site | **Widget still shows** - server doesn't check pause status | ‚ùå | TODO in code comments"
- **Section 6, Issue #3:** "Widget Not Disabled During Pause" rated as üü° Medium with "Impact: Medium - Service continues during 'pause'"
- **TKT-104:** Marked as "high" priority in tickets.json

The business impact is actually **High** because paused organizations can still receive calls, which defeats the entire value proposition of pausing (stopping both billing AND service).

**Options:**
1. **Update all documentation to reflect High severity** - Make severity consistent across all mentions, clarify that this defeats core pause value prop
2. **Keep Medium but add business impact** - Maintain Medium rating but extensively document why service during pause is problematic
3. **Split into separate concerns** - Treat widget visibility (High) and service access (Medium) as two different issues
4. **Leave as-is** - Accept inconsistency, consider it different perspectives on same issue

**Recommendation:** Option 1 - This should be High severity across all docs. Service availability during pause defeats the core promise to customers that their service is "frozen."

---

### Finding 2: Missing Cross-Reference to TKT-104
- **Severity:** High
- **Category:** Documentation Completeness
- **Location:** `docs/features/billing/pause-subscription.md` - Edge Case #16, Section 6

**Issue:**
Edge Case #16 and Technical Concerns Issue #3 document the widget visibility problem but do not mention that TKT-104 is actively addressing this. The docs say "TODO in code comments" but don't indicate that a ticket exists.

Without this cross-reference:
- Readers don't know this is being fixed
- Future reviewers may create duplicate tickets
- No way to track when docs should be updated post-fix

**Options:**
1. **Add ticket reference** - Update both locations to say "Being addressed in TKT-104"
2. **Remove from edge cases** - Since it's being fixed, remove from edge case matrix entirely
3. **Add status column** - Extend edge case table to show ticket ID for known issues
4. **Wait until fixed** - Update docs only after TKT-104 is merged

**Recommendation:** Option 1 - Add "‚ö†Ô∏è Being fixed in TKT-104" to Edge Case #16 and Section 6. This provides transparency without removing valuable context.

---

### Finding 3: No Documentation of Expected Widget Behavior During Pause
- **Severity:** High
- **Category:** Missing Specification
- **Location:** `docs/features/billing/pause-subscription.md` - Section 2 (How It Works)

**Issue:**
The pause-subscription.md doc mentions that widgets "should be disabled" in TODO comments, but nowhere explicitly defines:
- **What should visitors see** when they visit a paused org's website?
  - Should the widget never load at all?
  - Should it show an error state?
  - Should it show a "temporarily unavailable" message?
- **What happens to widget in localStorage** if visitor navigated during active call and returns during pause?
- **Should embed code detect pause status** client-side or rely entirely on server?

**Options:**
1. **Document expected behavior in pause-subscription.md** - Add subsection "Widget Behavior During Pause" with UX specs
2. **Create separate widget-pause-behavior.md** - New feature doc specifically for this interaction
3. **Add to widget-lifecycle.md** - Document paused state as a widget lifecycle state
4. **Wait for implementation** - Let TKT-104 dev agent define behavior, then document

**Recommendation:** Option 1 - Add "Widget Behavior During Pause" subsection to Section 2 (How It Works) in pause-subscription.md. Should specify:
- Widget never initializes (checked server-side in VISITOR_JOIN handler)
- No error message shown to visitor (widget simply absent)
- Prevents any service access during pause period

---

### Finding 4: Widget Lifecycle Doc Missing "Paused Organization" State
- **Severity:** High
- **Category:** Missing Edge Case
- **Location:** `docs/features/visitor/widget-lifecycle.md`
  - Section 4 (Edge Cases) - Missing from scenario matrix
  - State machine diagram (lines 52-80) - No transition for paused org

**Issue:**
The widget-lifecycle.md document has a comprehensive 22-row edge case matrix (lines 349-374) but does not include a scenario for "Organization paused during widget session" or "Visitor loads site for paused organization."

This is a significant omission because:
- Widget lifecycle depends on organization subscription status
- Current state machine shows `hidden --> open` when agent assigned, but doesn't show `hidden --> [error]` when org is paused
- Edge case #3 mentions "Agent goes away mid-viewing" but not "Org paused mid-viewing"

**Options:**
1. **Add edge case rows** - Insert "Visitor loads paused org site" and "Org paused during active widget session" to matrix
2. **Add to state machine** - Extend state diagram to show paused org path: `[*] --> error_paused` or stay in `hidden`
3. **Reference pause-subscription doc** - Add note that widget visibility is controlled by org subscription status (see pause-subscription.md)
4. **Create cross-feature doc** - New doc specifically about subscription-status impacts on widget

**Recommendation:** Option 1 + 3 - Add edge case rows to widget-lifecycle.md AND add reference note: "Widget availability is dependent on organization subscription_status. See pause-subscription.md for pause behavior."

New edge cases should be:
- **#23**: Visitor loads paused org site | Page loads | Widget never initializes (server rejects VISITOR_JOIN) | ‚úÖ (after TKT-104) | No error shown, widget absent
- **#24**: Org paused mid-viewing | Admin pauses during loop playback | Widget receives agent:unavailable, shows handoff, then hides | ‚ö†Ô∏è Needs testing | May need dedicated event

---

### Finding 5: Unclear What Happens to Active Calls When Org Paused
- **Severity:** High
- **Category:** Undefined Behavior
- **Location:** `docs/features/billing/pause-subscription.md`
  - Edge Case #6 (line 159)
  - Section 10 Open Questions #2 (line 319)

**Issue:**
Edge Case #6 states: "Pause requested during active call | Admin pauses mid-call | Pause proceeds immediately | ‚ö†Ô∏è | Call may continue until ended; widget behavior unclear"

Open Question #2 asks: "What happens to active calls when paused? Current behavior allows calls to continue. Should we end active calls immediately or let them complete naturally?"

This is documented as an open question but it's actually a **critical business logic decision** that needs to be made before TKT-104 is complete:

**Scenario:**
1. Visitor is on active video call with agent
2. Admin clicks "Pause for 3 months"
3. What happens?

**Options:**
1. **Graceful completion** - Allow active call to continue, disable widget for NEW visitors only
2. **Immediate termination** - End active call immediately when pause is clicked
3. **Grace period** - Allow call to continue for X minutes, then force disconnect
4. **Admin choice** - Show modal: "End active call now?" checkbox on pause confirmation

**Recommendation:** Option 1 (Graceful completion) - Let active calls complete naturally. Pausing should:
- Immediately prevent NEW widget initializations (TKT-104 scope)
- Allow existing call to end naturally
- After call ends, widget for that visitor should hide/disconnect
- This matches the principle: don't disrupt in-progress customer interactions

**Action Required:** Remove from "Open Questions" and add to pause-subscription.md Section 3 (Detailed Logic) as defined behavior. Update TKT-104 acceptance criteria if needed.

---

### Finding 6: Missing File Reference in TKT-104
- **Severity:** Medium
- **Category:** Ticket Specification Gap
- **Location:** `docs/data/tickets.json` - TKT-104.feature_docs

**Issue:**
TKT-104's `feature_docs` array lists:
```json
"feature_docs": [
  "docs/features/billing/pause-subscription.md",
  "docs/features/widget/widget-initialization.md"
]
```

However, `docs/features/widget/widget-initialization.md` **does not exist**. The actual file is `docs/features/visitor/widget-lifecycle.md`.

This could cause:
- Dev agent unable to find referenced file
- Incomplete context for implementation
- Confusion about what docs to update

**Options:**
1. **Update TKT-104.feature_docs** - Change to correct path: `docs/features/visitor/widget-lifecycle.md`
2. **Create widget-initialization.md** - Write new doc specifically about widget init process
3. **Remove from feature_docs** - Since pause-subscription.md covers the issue sufficiently
4. **Leave as-is** - Dev agent will discover correct file via search

**Recommendation:** Option 1 - Update tickets.json to reference the correct file path. This is a simple fix that improves dev agent workflow.

---

### Finding 7: Auto-Resume Interaction with Widget Not Documented
- **Severity:** Medium
- **Category:** Missing Specification
- **Location:** `docs/features/billing/pause-subscription.md` - Section 2, State Machine

**Issue:**
The state machine (lines 44-52) shows:
```
paused --> active: Auto-resume at pause_ends_at (NOT YET IMPLEMENTED)
```

The docs extensively cover manual resume (lines 123-145) but don't specify what happens with widget when auto-resume occurs:
- Should widget become immediately available?
- Is there a delay/cache issue?
- Do existing visitors need to refresh page?
- How is this different from manual resume?

Since auto-resume is not yet implemented (separate ticket TKT-103), this may be premature, BUT it's worth documenting the intended behavior now to avoid future issues.

**Options:**
1. **Document auto-resume widget behavior now** - Add to pause-subscription.md even though feature doesn't exist yet
2. **Wait for TKT-103** - Document when auto-resume is actually being implemented
3. **Add to TKT-103 scope** - Make widget behavior part of auto-resume ticket's acceptance criteria
4. **Add to Open Questions** - Move to Section 10 as question #8

**Recommendation:** Option 3 - Add note to TKT-103 (if it exists) that auto-resume must specify widget availability behavior. For now, add brief note to pause-subscription.md: "Auto-resume should make widget immediately available to new visitors. Existing page loads may require refresh."

---

### Finding 8: No Test Scenarios for Widget Pause Behavior
- **Severity:** Low
- **Category:** Testing Coverage
- **Location:** `docs/data/tickets.json` - TKT-104.qa_notes

**Issue:**
TKT-104's `qa_notes` state: "Test with paused organization in staging. Verify widget doesn't load and shows user-friendly message. Test that resuming organization immediately makes widget available."

However, Finding #3 above shows there's no spec for what "user-friendly message" means. Additionally, the qa_notes don't cover:
- Widget already loaded when org transitions to paused
- Multiple page navigation scenarios
- localStorage cleanup for paused org
- Race conditions (paused between widget init and agent assignment)

**Options:**
1. **Expand qa_notes** - Add comprehensive test matrix to TKT-104
2. **Create test plan doc** - Write `docs/testing/widget-pause-test-plan.md`
3. **Let QA agent define** - QA agent will create test cases based on implementation
4. **Add to widget-lifecycle edge cases** - Use edge case matrix as test scenarios

**Recommendation:** Option 1 - Expand TKT-104.qa_notes with specific scenarios:
- New visitor on paused org site (widget never loads)
- Active widget when org pauses (widget receives disconnect event)
- Manual resume (widget becomes available within 5 seconds)
- Paused org with widget localStorage (cleared on reconnect attempt)
- Race condition: pause during VISITOR_JOIN handshake

---

## Related Documentation Observations

### Strengths
1. **Comprehensive edge case documentation** - pause-subscription.md has excellent 18-row edge case matrix
2. **Clear state machines** - Both docs have well-defined state diagrams
3. **Code references** - Line-level references to implementation files
4. **Known gaps explicitly marked** - TODOs and NOT IMPLEMENTED flags are clear

### Areas for Improvement
1. **Cross-feature references** - Widget lifecycle should reference pause subscription impacts
2. **Consistency in severity ratings** - Same issue rated differently in different sections
3. **Ticket cross-references** - Known issues should link to tickets when they exist
4. **File path accuracy** - Feature_docs in tickets should reference real files

---

## Recommendations for TKT-104 Implementation

Based on this documentation review, the TKT-104 dev agent should:

1. **Read pause-subscription.md Section 6** - This explicitly documents the issue being fixed
2. **Update docs after implementation** - Change Edge Case #16 from ‚ùå to ‚úÖ and update Section 6
3. **Clarify visitor experience** - Document what visitors see (nothing? error? message?)
4. **Test active call scenario** - Verify behavior when org paused during active call
5. **Update widget-lifecycle.md** - Add edge case rows for paused org scenarios
6. **Check localStorage handling** - Ensure widget state is cleared for paused orgs

---

## Next Steps

1. **Triage Agent**: Review findings, promote relevant ones to inbox
2. **Human Decision**: Prioritize documentation updates (especially severity consistency)
3. **Update TKT-104**: Consider expanding scope to include doc updates, or create follow-up doc ticket
4. **Fix tickets.json**: Update feature_docs path for TKT-104

---

## Notes

- **Documentation Quality:** Overall very high. The pause-subscription.md doc is exceptionally thorough.
- **Finding Source:** All findings derived from reading documentation only, no code inspection
- **API Issue:** Attempted to use agent-cli.sh to add findings to staging, but API endpoint returned "Not found" (dbModule likely not loaded on running server). Documented findings in this review report instead.
- **Session Info:** Review Agent session 57cfec21-6074-4002-94f8-b25291004624

---

**Review completed:** 2025-12-12T15:06:00Z
**Documents reviewed:** 2 feature docs, 1 ticket specification
**Lines analyzed:** ~900 lines of documentation
**Findings submitted:** 8 (5 High, 2 Medium, 1 Low)
