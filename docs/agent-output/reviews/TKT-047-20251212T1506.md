# Review Complete: TKT-047

**Reviewed:** 2025-12-12
**Session ID:** 02ee70d5-3a71-43a5-9c20-d10c9f2733f1
**Ticket:** TKT-047 - Handle Missing User Profile Row
**Feature:** Login Flow
**Doc File:** `docs/features/auth/login-flow.md`

---

## Executive Summary

Reviewed documentation changes for TKT-047, which adds defensive handling for orphaned users (auth.users exists but no users table row). Found **5 issues** requiring attention, ranging from critical inconsistencies to documentation improvements.

**Key Concern:** The documentation shows conflicting approaches for missing profile handling between client-side and middleware, which could lead to implementation confusion.

---

## Findings

### Finding 1: Inconsistent Missing Profile Error Handling Between Client and Middleware

**Severity:** üî¥ HIGH
**Category:** Logic Issue / Inconsistency
**Location:** Section 3 (Data Flow)
- Lines 128-130: Client flow
- Lines 151-152: Middleware flow

**Issue:**

Documentation shows two different behaviors for orphaned users:

1. **Client Flow (line 128-130):** "If no profile: Log error, show support message, STOP"
   - This implies showing an in-page error message

2. **Middleware Flow (line 151-152):** "If no profile exists: Redirect to /login?error=missing_profile"
   - This uses a redirect with query parameter

These are fundamentally different UX patterns. The client approach shows an immediate error banner, while middleware does a redirect. This inconsistency will confuse implementers.

**Options:**

1. **Client-only handling** - Remove middleware check, handle entirely in login page
   - Pros: Simpler, error appears immediately after login attempt
   - Cons: Misses edge cases where user navigates directly to protected routes

2. **Middleware-only handling** - Remove client check, let middleware catch on redirect
   - Pros: Consistent with other middleware checks (TKT-006), single source of truth
   - Cons: Slight delay before user sees error (one extra redirect)

3. **Both with query param** - Client redirects to `/login?error=missing_profile`, middleware does same
   - Pros: Defensive programming, catches all cases, consistent error display
   - Cons: Slightly more complex

4. **Skip** - Accept dual handling as acceptable

**Recommendation:** Option 3 - Standardize both client and middleware to redirect to `/login?error=missing_profile` for consistency. The existing pattern already uses query params for errors (see line 192: `auth_callback_error`). This provides defense in depth while maintaining consistent UX.

**Suggested Fix:**
- Update line 129-130 to: "If no profile: Redirect to /login?error=missing_profile"
- Add documentation showing error banner reads `missing_profile` query param on login page
- Ensure both paths use identical error message (line 193)

---

### Finding 2: Missing Implementation Details for Error Message Display

**Severity:** üü° MEDIUM
**Category:** Missing Scenario
**Location:** Section 4 (Edge Cases), Line 193

**Issue:**

Documentation states the error message for missing profile is:
> "Your account is missing required profile information. Please contact support for assistance."

However, the doc doesn't specify:
1. **How** this message is displayed (banner? modal? inline?)
2. **Where** the error param is parsed (login page component?)
3. **Which** component renders it
4. Whether there's a support contact link or just text

Line 151-152 mentions `?error=missing_profile` but doesn't connect this to the error message in line 193.

**Options:**

1. **Add implementation section** - Add subsection showing how `/login?error=missing_profile` maps to error banner
   - Pros: Complete documentation
   - Cons: More detail to maintain

2. **Reference existing error handling** - Point to existing auth error display pattern
   - Pros: DRY, assumes consistent pattern
   - Cons: Assumes pattern exists

3. **Skip** - Implementation detail, not doc concern

**Recommendation:** Option 1 - Add a small implementation note under line 193 showing:
```
Error displayed via query param check on login page:
- Read `error` from URL searchParams
- If `error === 'missing_profile'`, show error banner
- Banner uses destructive styling (see line 217)
```

**Suggested Fix:**
Add subsection "4.1 Error Display Implementation" with pseudocode showing query param ‚Üí error banner flow.

---

### Finding 3: Logging Requirement Not Documented in Error States

**Severity:** üü° MEDIUM
**Category:** Documented Issue / Incomplete Spec
**Location:** Section 4 (Edge Cases), Line 193; Ticket acceptance criteria

**Issue:**

TKT-047 acceptance criteria specifies:
> "Orphaned user is logged for admin investigation"

However, the error states table (line 193) doesn't mention logging. Line 129 mentions "Log error" but doesn't specify:
1. What to log (user ID? email? timestamp?)
2. Where to log (console? file? Supabase logs? monitoring service?)
3. Log level (error? warn?)
4. What data to include for debugging

Without this spec, implementers won't know how to fulfill the acceptance criteria.

**Options:**

1. **Add logging specification** - Add column to error states table or separate section
   - Pros: Clear requirements
   - Cons: More maintenance

2. **Add to data flow** - Expand line 129 with logging details
   - Pros: Shows in context
   - Cons: Could clutter data flow

3. **Create separate "Logging" section** - New section 6.1 under Technical Concerns
   - Pros: Comprehensive, separate concern
   - Cons: May be overkill

4. **Skip** - Trust implementer judgment

**Recommendation:** Option 2 - Expand line 129 to:
```
‚îú‚îÄ‚ñ∫ If no profile:
‚îÇ   ‚îú‚îÄ‚ñ∫ console.error('Orphaned user detected', { userId: user.id, email: user.email })
‚îÇ   ‚îú‚îÄ‚ñ∫ Redirect to /login?error=missing_profile
‚îÇ   ‚îî‚îÄ‚ñ∫ STOP
```

**Suggested Fix:**
Update data flow diagram with explicit logging call showing what data to include.

---

### Finding 4: Unclear Whether Profile Check Happens on Every Login

**Severity:** üü¢ LOW
**Category:** Confusing User Story
**Location:** Section 3 (Data Flow), Lines 126-130

**Issue:**

The data flow shows profile check after authentication:
```
‚îú‚îÄ‚ñ∫ Client: Query users table for role
‚îÇ   ‚îî‚îÄ‚ñ∫ supabase.from("users").select("role").eq("id", user.id).single()
‚îÇ
‚îú‚îÄ‚ñ∫ Check if profile exists (orphaned user detection - TKT-047)
```

But it's unclear if this is:
- A new separate query (2 queries total)
- Checked within the role query (1 query, check for null)
- Validated by checking query error vs null result

The existing line 126-127 already queries the profile. Line 128 seems to add a new check, but efficient implementation would validate the existing query result, not make a second query.

**Options:**

1. **Clarify it's the same query** - Update line 128 to "Check role query result"
   - Pros: Accurate, prevents unnecessary queries
   - Cons: Small change

2. **Show it's two queries** - Make explicit there are 2 separate queries
   - Pros: Clear separation of concerns
   - Cons: Inefficient implementation

3. **Skip** - Implementation detail

**Recommendation:** Option 1 - Clarify that profile existence is checked from the role query result, not a separate query. Change:
```
‚îú‚îÄ‚ñ∫ Check if profile exists (orphaned user detection - TKT-047)
‚îÇ   ‚îú‚îÄ‚ñ∫ If no profile: ...
```
To:
```
‚îú‚îÄ‚ñ∫ Validate profile exists from role query result
‚îÇ   ‚îú‚îÄ‚ñ∫ If query returned no rows (profile doesn't exist): ...
```

**Suggested Fix:**
Update lines 128-130 to clarify this validates the role query result, not a new query.

---

### Finding 5: Edge Case #20 Marked as Fixed But Implementation Unclear

**Severity:** üü° MEDIUM
**Category:** Documentation vs Reality
**Location:** Section 4 (Edge Cases), Line 180-181

**Issue:**

Edge case #20 is marked with ‚úÖ "Fixed in TKT-047":
```
| 20 | User with no profile row (orphaned user) | Auth exists, no users row | Shows error message with support contact instruction | ‚úÖ | Fixed in TKT-047 |
```

However, since this is a review agent analyzing documentation for TKT-047 changes, this creates a circular dependency. The doc is describing what TKT-047 *should* do, but marks it as complete before implementation is verified.

**Additional Context:**
The ticket shows `status: "done"` but the review agent is running *post-merge* to catch issues. If the code was merged, the ‚úÖ is correct. If this is pre-implementation documentation, it's premature.

**Options:**

1. **Change to ‚ö†Ô∏è "In Progress"** - Mark as being implemented in TKT-047
   - Pros: Accurate if this doc was written before code
   - Cons: Incorrect if code is already merged

2. **Add verification note** - "‚úÖ Fixed in TKT-047 (verified post-merge)"
   - Pros: Shows verification happened
   - Cons: May be redundant

3. **Check ticket status** - If ticket status is "done", leave as ‚úÖ
   - Pros: Trusts ticket state
   - Cons: Assumes ticket state is accurate

4. **Skip** - Documentation is correct

**Recommendation:** Option 3 - Since ticket shows `status: "done"`, the ‚úÖ is correct. However, add a note in section 10 (Open Questions) asking if there's manual testing verification:

**Suggested Fix:**
Add to section 10:
```
8. **Was TKT-047 manually tested?** Edge case #20 marked as fixed. Has this been verified with:
   - Deleting a user's profile row in Supabase
   - Attempting to log in with those credentials
   - Confirming error message displays as expected
   - Verifying user is logged for admin investigation
```

---

## Findings Summary

| # | Title | Severity | Category | Status |
|---|-------|----------|----------|--------|
| 1 | Inconsistent missing profile error handling between client and middleware | üî¥ HIGH | Logic Issue | Needs decision |
| 2 | Missing implementation details for error message display | üü° MEDIUM | Missing Scenario | Needs documentation |
| 3 | Logging requirement not documented in error states | üü° MEDIUM | Incomplete Spec | Needs documentation |
| 4 | Unclear whether profile check happens on every login | üü¢ LOW | Confusing Flow | Minor clarification |
| 5 | Edge case #20 marked as fixed but implementation unclear | üü° MEDIUM | Documentation | Needs verification |

**Total:** 5 findings
**Critical:** 0
**High:** 1
**Medium:** 3
**Low:** 1

---

## Overall Assessment

The TKT-047 documentation changes are **mostly complete** with one significant issue requiring attention:

‚úÖ **Strengths:**
- Edge case properly identified and documented
- Error message is clear and helpful
- Both client and middleware handling mentioned (defense in depth)
- Integration with existing error patterns (query params)

‚ö†Ô∏è **Concerns:**
- **Critical inconsistency** in error handling approach (Finding #1) - could cause implementation bugs
- Missing implementation details for several aspects
- Logging requirements not fully specified

**Recommendation:** Address Finding #1 (inconsistent error handling) before any developer implements this ticket. Findings #2-5 are documentation improvements that would help future maintainers but aren't blockers.

---

## Next Steps

Per Review Agent SOP:
1. ‚úÖ Read documentation thoroughly
2. ‚úÖ Checked for existing findings (none found for this feature)
3. ‚úÖ Analyzed for issues across all categories
4. ‚ùå Could not write findings to staging via CLI (API not available)
5. ‚úÖ Wrote summary report to `docs/agent-output/reviews/TKT-047-20251212T1506.md`

**Note:** The `agent-cli.sh add-finding` command failed with "Not found" error. The PM dashboard is running but the `/api/v2/findings` endpoint returns 404. Findings have been documented in this report instead. The Triage Agent should:
- Review these findings manually
- Create finding records in the system
- Route to human inbox for decisions

---

## Appendix: Review Checklist

- [x] Checked existing findings for this feature (no duplicates)
- [x] Read entire doc file (324 lines)
- [x] Checked all 10 sections for issues
- [x] Documented ALL findings in this report (5 total)
- [x] Each finding has options for human to choose from
- [x] Each finding has a recommendation
- [x] Wrote summary to `docs/agent-output/reviews/TKT-047-20251212T1506.md`

---

**Session Complete:** Ready for triage
