# Review Complete: TKT-019

**Reviewed:** 2025-12-12
**Ticket:** TKT-019 - Sync Incoming Call Countdown with RNA Timeout
**Doc Files:**
- `docs/features/agent/incoming-call.md`
- `docs/features/agent/rna-timeout.md`

## Executive Summary

TKT-019 was merged to main (commit 6d209a8) to fix the UI/server mismatch where the incoming call modal countdown showed a hardcoded value while the server's RNA timeout was configurable. The code implementation is **incomplete** - the component was updated to accept an `rnaTimeoutSeconds` prop, but this prop is not being passed from parent components. Additionally, the documentation has not been updated to reflect the changes made in TKT-019.

## Findings Submitted to Staging

| Title | Severity | Finding ID | Status |
|-------|----------|------------|--------|
| TKT-019 incomplete: rnaTimeoutSeconds prop not passed to IncomingCallModal | High | F-1765581455782 | üî¥ BLOCKING |
| Documentation outdated: incoming-call.md shows hardcoded 30s countdown | Medium | F-1765581470200 | ‚ö†Ô∏è SHOULD FIX |
| Documentation incorrectly states UI/server mismatch still exists | Medium | F-1765581486606 | ‚ö†Ô∏è SHOULD FIX |
| Open question #1 already addressed by TKT-019 implementation | Low | F-1765581502078 | ‚ÑπÔ∏è NICE-TO-HAVE |

## Summary

- **Total:** 4 findings
- **Critical:** 0
- **High:** 1
- **Medium:** 2
- **Low:** 1

## Detailed Analysis

### 1. Code Implementation Issue (HIGH)

**What was done in TKT-019:**
- Updated `IncomingCallModal` component to accept `rnaTimeoutSeconds` prop
- Changed countdown logic from hardcoded `30 - timeElapsed` to `rnaTimeoutSeconds - timeElapsed`
- Changed progress bar calculation to use `rnaTimeoutSeconds` instead of hardcoded 30
- Added default value of 15 seconds

**What was NOT done:**
- The prop is not passed to `IncomingCallModal` in either parent component:
  - `apps/dashboard/src/features/signaling/app-shell.tsx:102-106`
  - `apps/dashboard/src/features/signaling/dashboard-shell.tsx:103-107`
- No mechanism exists to fetch or provide the org's RNA timeout to these components
- The `CallIncomingPayload` type does not include `rna_timeout_seconds`

**Impact:**
The countdown will always show 15 seconds (the default) regardless of the organization's configured RNA timeout. For orgs with custom values (20s, 25s, 30s), the UI countdown will not match the actual server timeout, reintroducing the exact problem TKT-019 was meant to solve.

### 2. Documentation Issues (MEDIUM)

The documentation in `docs/features/agent/incoming-call.md` was not updated after TKT-019 was merged. Specific issues:

1. **Line 134:** Still shows "UI Countdown Display: 30 seconds" and marks it as "Not configurable"
2. **Line 138:** States there is a UI/server mismatch (30s vs 15s)
3. **Lines 331-333:** Lists the mismatch as an open issue with suggested fix "Sync UI countdown with org's RNA timeout"
4. **Line 369:** Has an open question "Should UI countdown match org's RNA timeout?"

All of these are now outdated because:
- The component code was changed (no longer hardcoded to 30s)
- The default is now 15s, not 30s
- The component has infrastructure for syncing (the prop), it's just not wired up
- The decision was made (yes, they should sync)

### 3. RNA Timeout Documentation

The `docs/features/agent/rna-timeout.md` file is still accurate and does not require updates based on TKT-019 changes. It correctly describes the server-side RNA timeout logic.

## Recommendations

### Immediate Actions (High Priority)

1. **Complete TKT-019 Implementation:**
   - Add `rna_timeout_seconds` field to `CallIncomingPayload` type in `packages/domain/src/types.ts`
   - Include `rna_timeout_seconds` in the socket payload when server emits `call:incoming` (it already has this value from `getCallSettings()`)
   - Pass `rnaTimeoutSeconds={incomingCall.rna_timeout_seconds}` prop in both shell files
   - Alternative: If org-level customization is not supported, remove the prop and document this limitation

2. **Create Follow-up Ticket:**
   - Consider creating TKT-019-B to complete the implementation
   - Include QA testing for different org timeout values (15s, 20s, 25s, 30s)

### Documentation Updates (Medium Priority)

3. **Update incoming-call.md:**
   - Line 134: Change to reflect 15s default and partial implementation
   - Line 138: Note partial fix by TKT-019, link to follow-up finding
   - Lines 331-333: Update status to "PARTIAL" with TKT-019 reference
   - Line 369: Mark open question as resolved/partially resolved

## Notes

### Positive Observations

- The code change in `incoming-call-modal.tsx` is clean and correct
- Good use of `Math.max(0, ...)` to prevent negative countdown values
- Default value matches server default (15 seconds)
- Comment on line 12 clearly documents the prop's purpose

### Testing Gap

The ticket's acceptance criteria state:
- "Countdown matches org's RNA timeout setting"
- "Works correctly for different org configurations (15s, 25s, 30s)"

These cannot be verified as passing because the prop is not wired up. QA may have tested with default 15s only, which would appear to work but wouldn't catch the missing prop issue for custom timeout values.

### Architecture Note

Two implementation approaches were available:
1. **Server includes timeout in payload** (cleaner, single source of truth)
2. **Client fetches org settings** (more client-side data fetching)

The component design suggests approach #1 was intended (simple prop with no complex state), but this was not completed.

---

**Review conducted by:** Review Agent
**Next steps:** Triage Agent will process these findings into human inbox for prioritization
