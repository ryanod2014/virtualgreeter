# Review Complete: TKT-002

**Reviewed:** 2025-12-12
**Session ID:** b5b9ccb5-3054-489d-95dd-e9e0f8a144b8
**Ticket:** TKT-002 - Complete Stripe Subscription Cancellation
**Doc Files:**
- `docs/features/billing/cancel-subscription.md`
- `docs/features/admin/organization-settings.md`

---

## Executive Summary

Reviewed documentation for TKT-002 which aims to complete Stripe subscription cancellation functionality. The documentation reveals that **TKT-002's core requirement is still not implemented** - the code still contains TODO comments indicating Stripe API integration is incomplete. Additionally, found critical inconsistencies between the documented "grace period" behavior and actual implementation.

**Critical Finding:** The documentation itself confirms that TKT-002's primary goal has not been achieved.

---

## Findings Submitted to Staging

**Note:** Unable to submit findings via CLI due to database connectivity issues. Findings documented here for manual entry.

### Finding 1: TKT-002 Core Requirement Still Not Implemented

- **Title:** Stripe API cancellation not implemented despite TKT-002
- **Severity:** CRITICAL
- **Feature:** cancel-subscription
- **Location:** `cancel-subscription.md` Section 6 - Technical Concerns, Issue 1 (lines 277-290)

**Issue:**
TKT-002's entire purpose is to implement Stripe subscription cancellation via API. The ticket explicitly states:

From TKT-002 acceptance criteria:
- "Clicking 'Cancel' calls Stripe API with cancel_at_period_end: true"
- "Stripe dashboard shows subscription as 'canceling'"
- "User retains access until their paid period ends (stored in DB)"

However, the documentation reveals this is **still TODO**:

> "The code contains TODO comments indicating Stripe cancellation is not fully implemented:
> ```typescript
> // In production, you would also:
> // 1. Call Stripe to cancel the subscription
> // 2. Update the organization's plan to 'free' or mark as cancelled
> // 3. Send a confirmation email
> // 4. Schedule data retention/deletion
> ```
>
> **Current behavior:** Only downgrades plan to "free", does NOT call Stripe API.
> **Impact:** Stripe subscription may continue billing."

**Current Behavior:**
- User clicks "Cancel Subscription" in UI
- System saves feedback to database
- System updates organization plan to "free" in Supabase
- **System DOES NOT call Stripe API**
- Stripe subscription continues unchanged
- Customer continues being charged

**Impact:**
- Customers believe they've cancelled but continue being billed
- Violates user expectations and trust
- Potential legal/compliance issues
- Manual admin intervention required to actually cancel in Stripe dashboard

**Options:**
1. **Implement immediately per TKT-002 spec** - Call `stripe.subscriptions.update({ cancel_at_period_end: true })`, store `current_period_end` from response, add webhook handler for `customer.subscription.deleted`
2. **Add temporary safeguard** - Disable cancel button and show "Cancellation temporarily unavailable" until Stripe integration complete
3. **Document workaround** - Add prominent notice in UI: "Cancellation will take effect within 24 hours. If you continue to be charged, contact support."
4. **Manual fallback** - Create internal admin tool to manually cancel Stripe subscriptions daily based on `plan='free'` changes

**Recommendation:** Option 1 - This is the **entire purpose of TKT-002**. The ticket is marked as CRITICAL priority. This must be implemented before TKT-002 can be considered complete.

---

### Finding 2: Grace Period Documented But Not Implemented

- **Title:** Grace period access contradicts implementation
- **Severity:** HIGH
- **Feature:** cancel-subscription
- **Location:**
  - `cancel-subscription.md` Section 6 - Issue 4 (lines 309-313)
  - `organization-settings.md` Section 10 - Open Question 3 (lines 399-400)

**Issue:**
Both documentation files consistently reference a "grace period" where users retain access until the end of their billing period after cancellation. However, the implementation does not support this.

**From cancel-subscription.md:**
> "⚠️ Issue 4: No Grace Period Logic
> The code mentions 'access continues until end of billing period' in UI but:
> - No `subscription_ends_at` field tracked
> - No access gating based on billing period end
> - Immediate downgrade to 'free'"

**From organization-settings.md:**
> "**Is there a grace period for cancelled subscriptions?** - The code shows immediate plan downgrade to 'free' but the cancel modal mentions 'access will continue until the end of your current billing period' - implementation may not match UI copy."

**Current Behavior:**
- UI tells user: "Access continues until end of billing period"
- Reality: Immediate downgrade to `plan='free'`
- No field stores when the billing period ends
- No logic to check if user is in "cancelled but still paid-up" state

**Impact:**
- User expects access until Jan 15 (paid through then)
- Actually loses access immediately after clicking Cancel
- False advertising / deceptive practice
- Poor user experience and potential refund demands

**Options:**
1. **Implement grace period** - Add `subscription_ends_at` field, store Stripe's `current_period_end`, check this date before restricting access, plan stays active until that date
2. **Remove misleading copy** - Update TKT-003 to remove grace period language, set expectations for immediate access loss
3. **Hybrid approach** - Immediate downgrade but add "cancelled" status distinct from "free" that preserves widget access until period end
4. **Skip - Not critical** - Document that this is a known limitation and will be addressed in future ticket

**Recommendation:** Option 1 or Option 2. Option 1 is the right user experience and aligns with TKT-002's acceptance criteria ("User retains access until their paid period ends"). Option 2 is faster but worse UX. **This is blocked by Finding #1** - can't implement grace period without Stripe integration to get `current_period_end`.

---

### Finding 3: Webhook Handler Not Implemented

- **Title:** Stripe webhook handler for subscription deletion incomplete
- **Severity:** HIGH
- **Feature:** cancel-subscription
- **Location:** `cancel-subscription.md` Section 3 - Triggers & Events (line 120)

**Issue:**
TKT-002 requires webhook handling for the final subscription deletion event. Documentation shows this exists but provides no detail.

**From documentation:**
> "| Webhook: `customer.subscription.deleted` | Stripe → Server | Updates org status to 'cancelled' | DB update |"

**From TKT-002 acceptance criteria:**
- "Webhook properly handles the final cancellation event"

**From TKT-002 fix_required:**
- "Add webhook handler for customer.subscription.deleted to finalize downgrade"

**Current State Unknown:**
- Code reference shows `handleSubscriptionDeleted` exists in `apps/server/src/features/billing/stripe-webhook-handler.ts` lines 204-209
- No detail on what it actually does
- No confirmation it handles the cancellation flow correctly
- No indication it's been tested with the cancel_at_period_end flow

**Impact:**
- If webhook doesn't fire correctly, user may lose access mid-billing period
- If webhook isn't idempotent, replay attacks could cause issues
- If signature verification fails, security risk

**Options:**
1. **Verify implementation** - Read the actual webhook handler code to confirm it correctly handles this event
2. **Add to testing plan** - Ensure QA tests webhook delivery using Stripe CLI
3. **Document behavior** - Add details to docs about exactly what the webhook does
4. **Skip - Trust existing code** - Assume the handler works correctly

**Recommendation:** Option 1 then Option 3 - Verify the webhook handler implementation, then document its behavior in the feature docs. This is part of TKT-002's scope.

---

### Finding 4: No Email Notification System

- **Title:** Cancellation confirmation email not implemented
- **Severity:** MEDIUM
- **Feature:** cancel-subscription
- **Location:** `cancel-subscription.md` Section 6 - Issue 3 (lines 302-307)

**Issue:**
Documentation explicitly lists missing email notifications as an identified issue.

**From docs:**
> "⚠️ Issue 3: No Notification System
> No emails or in-app notifications are sent:
> - No cancellation confirmation email
> - No agents notified
> - No reminder emails"

**Current Behavior:**
- User cancels subscription
- UI shows success message
- **No email confirmation sent**
- User has no paper trail

**Impact:**
- User may forget they cancelled
- No confirmation for their records
- Harder to dispute billing issues
- Poor professional impression
- Standard industry practice not followed

**Options:**
1. **Add email notification** - Send cancellation confirmation with details (cancellation date, final billing date, data retention policy)
2. **Add to future ticket** - Document as known limitation, create follow-up ticket
3. **Skip - Not required** - Email isn't essential, UI confirmation sufficient
4. **Use transactional email service** - Integrate SendGrid/Postmark for all billing emails

**Recommendation:** Option 2 - This is MEDIUM priority, not blocking for TKT-002. Create a follow-up ticket (e.g., TKT-005: Add Billing Email Notifications) to handle cancellation confirmations, payment receipts, etc. This is a broader scope than just cancellation.

---

### Finding 5: Data Retention Warning Now Accurate (Positive Finding)

- **Title:** TKT-003 successfully fixed misleading deletion warning
- **Severity:** N/A (Resolved)
- **Feature:** cancel-subscription
- **Location:** `cancel-subscription.md` Section 6 - Issue 2 (lines 291-300)

**Issue:** ✅ **RESOLVED**

**Previous State:**
- UI warned: "This will permanently delete your data"
- Reality: Data retained for 30 days
- Misleading and potentially legally problematic

**Current State (Fixed by TKT-003):**
- Header: "Data Retention Notice" (was "Permanently delete data")
- Copy: "Your data will be retained for 30 days after cancellation, then may be permanently deleted."
- Added: "You can resubscribe within 30 days to retain your data."
- Styling: Amber warning (was red danger)
- Accurate and transparent

**Impact:**
This was correctly identified as an issue and **has been resolved**. Good catch by the documentation review process.

---

### Finding 6: Inconsistent Feature References Between Docs

- **Title:** Organization Settings doc references cancel but provides limited detail
- **Severity:** LOW
- **Feature:** organization-settings
- **Location:** `organization-settings.md` Section 3 - Data Flow (lines 194-204), Section 10 - Open Questions (lines 399-402)

**Issue:**
The Organization Settings documentation references the cancellation flow but does so inconsistently and with less detail than the dedicated cancel-subscription.md file.

**From organization-settings.md:**
```
└─► Admin cancels subscription
    ├─► Click "Cancel Subscription" → opens PauseAccountModal first (downsell)
    ├─► Click "No, cancel and delete all my data" → opens CancelSubscriptionModal
    ├─► Step 1: Select primary reason
    ├─► Step 2: Add details, additional reasons, competitor info
    ├─► Step 3: Confirm with data deletion warning
    ├─► handleCancelSubscription(data)
    ├─► submitCancellationFeedback() server action
    ├─► Insert into cancellation_feedback
    ├─► Update org: plan = "free"
    └─► Show confirmation, close modal
```

**Inconsistencies:**
1. Says "with data deletion warning" but TKT-003 changed this to "data retention notice"
2. Doesn't mention the TODO about Stripe integration
3. Less detailed than cancel-subscription.md
4. Open Questions section duplicates issues already documented in cancel-subscription.md

**Impact:**
- Minor confusion if reading only organization-settings.md
- Maintenance burden (two files to update for cancel flow changes)
- Potential for docs to drift out of sync

**Options:**
1. **Reference canonical doc** - Organization Settings should link to cancel-subscription.md for full details rather than duplicating
2. **Keep synchronized** - Ensure both files are updated together whenever cancellation flow changes
3. **Skip - Acceptable duplication** - Some overlap is fine for context
4. **Consolidate** - Move all billing to organization-settings.md (but this would be very long)

**Recommendation:** Option 1 - Add a note in organization-settings.md saying "For full cancellation flow details, see [Cancel Subscription feature doc](../billing/cancel-subscription.md)" and keep just the high-level flow.

---

### Finding 7: Agent Notification Gap During Cancellation

- **Title:** Active agents not notified when org cancels subscription
- **Severity:** MEDIUM
- **Feature:** cancel-subscription
- **Location:** `cancel-subscription.md` Section 4 - Edge Cases, row 15 (line 206)

**Issue:**
Documentation identifies that agents are not notified when their organization cancels the subscription.

**From edge case matrix:**
> "| 15 | Cancel with active agents | Agents still online | No special handling | ⚠️ | Agents not notified/logged out |"

**Current Behavior:**
- Admin cancels subscription
- Plan changes to "free"
- Agents still logged in
- Widget stops working mid-call (or immediately?)
- Agents confused about what happened

**Impact:**
- Poor agent experience
- Agents may be on active calls when widget stops working
- No way to gracefully wrap up current interactions
- Looks like a bug to the agent
- Support tickets from confused agents

**Options:**
1. **Add real-time notification** - Use WebSocket/Server-Sent Events to notify all logged-in agents when org downgrades
2. **Graceful degradation** - Allow current calls to complete, block new calls
3. **Email notification to agents** - Send email to all agents in org when subscription is cancelled
4. **In-app message on next login** - Show banner on next login: "Your organization's subscription has been cancelled"
5. **Skip - Out of scope** - This is an edge case, manual communication is fine

**Recommendation:** Option 4 for immediate implementation (low effort), then Option 1 in a future notification system ticket. Most cancellations likely happen during off-hours, so immediate notification isn't critical, but agents should know why the widget stopped working.

---

## Summary Statistics

- **Total Findings:** 7 (6 issues + 1 resolved positive finding)
- **Critical:** 1 (Stripe integration not implemented)
- **High:** 2 (Grace period mismatch, Webhook handler unclear)
- **Medium:** 2 (Email notifications, Agent notifications)
- **Low:** 1 (Doc inconsistency)
- **Resolved:** 1 (TKT-003 data retention warning)

---

## Overall Assessment

### Documentation Quality: GOOD
The documentation is thorough, well-structured, and **honestly identifies known issues**. The fact that it calls out the Stripe integration as still TODO is exactly what documentation should do.

### Implementation Status: INCOMPLETE
**TKT-002 does NOT appear to be complete** based on the documentation. The core requirement - calling the Stripe API to actually cancel subscriptions - is explicitly documented as still TODO.

### Risk Assessment: HIGH
If this code is in production and the cancel button is accessible to users, **users are being billed for cancelled subscriptions**. This is:
- A revenue leak (if refunded)
- A trust violation (if not refunded)
- Potentially a legal issue
- A support burden

### Recommendations

**IMMEDIATE:**
1. **Verify TKT-002 implementation status** - Check if the TODO comments in the docs reflect stale information, or if the Stripe integration truly is incomplete
2. **If incomplete: Block production deployment** - This cancel button should not be accessible to real users until Stripe integration is complete
3. **If complete but docs are stale: Update documentation** - Remove TODO comments and document actual Stripe integration

**SHORT TERM (TKT-002 scope):**
1. Implement Finding #1: Stripe API cancellation
2. Implement Finding #2: Grace period logic (blocked by #1)
3. Verify Finding #3: Webhook handler behavior

**MEDIUM TERM (Follow-up tickets):**
1. Create ticket for Finding #4: Email notification system
2. Create ticket for Finding #7: Agent notification system
3. Address Finding #6: Documentation consolidation

---

## Notes

- Unable to submit findings to staging via agent-cli.sh due to "Not found" errors (API v2 database not responding)
- Findings documented in this report for manual entry or triage
- The positive finding about TKT-003 shows the review process is working well
- Would benefit from code inspection to verify if TODOs in docs match reality in code
- QA testing should verify Stripe integration status using test mode

---

## Files Reviewed

1. **docs/features/billing/cancel-subscription.md** (433 lines)
   - Comprehensive documentation of cancellation flow
   - Honestly identifies 4 open issues
   - Shows state machine, data flow, edge cases
   - Good coverage of analytics dashboard
   - TKT-003 updates properly documented

2. **docs/features/admin/organization-settings.md** (409 lines)
   - Broader org settings context
   - Includes cancellation as one section
   - Some duplication with cancel-subscription.md
   - Good coverage of related settings (billing, seats, pause)

---

**Review completed at:** 2025-12-12T15:07:00Z
**Reviewer:** Review Agent (Claude Sonnet 4.5)
**Session ID:** b5b9ccb5-3054-489d-95dd-e9e0f8a144b8
