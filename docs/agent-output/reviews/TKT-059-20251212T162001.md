# Review Complete: TKT-059 - Cancelled Calls Have No Audit Trail

**Reviewed:** 2025-12-12
**Reviewer:** Review Agent
**Doc Files:**
- `docs/features/admin/call-logs.md`
- `docs/features/platform/call-lifecycle.md`
- `apps/server/src/lib/call-logger.ts`

---

## Executive Summary

**Status:** ⚠️ CRITICAL ISSUES FOUND

The documentation for TKT-059 describes the feature as complete and working (✅), but the implementation has critical blockers that will cause **runtime failures**. The code attempts to set `status='cancelled'` but the database schema explicitly prohibits this value via a CHECK constraint.

**Impact:** Feature will fail in production with database constraint violation errors. No cancelled calls will be logged.

---

## Findings Submitted to Staging

| Finding ID | Title | Severity |
|------------|-------|----------|
| F-1765581535729 | Database CHECK constraint blocks 'cancelled' status | **Critical** |
| F-1765581545193 | TypeScript type CallStatus missing 'cancelled' option | **High** |
| F-1765581595673 | Documentation claims feature works but implementation will fail | **High** |
| F-1765581557951 | UI status filter missing 'cancelled' option | Medium |
| F-1765581569484 | CallLogRow getStatusIcon missing 'cancelled' case | Medium |
| F-1765581580435 | Agent stats client needs 'cancelled' in status filter | Low |

---

## Summary by Severity

- **Critical:** 1 finding (database constraint violation)
- **High:** 2 findings (TypeScript type error, docs-reality mismatch)
- **Medium:** 2 findings (UI filtering and display)
- **Low:** 1 finding (consistency in agent view)
- **Total:** 6 findings

---

## Critical Blocker Details

### Database Constraint Violation

**File:** `supabase/migrations/20251125200000_initial_schema.sql:107`

```sql
status TEXT NOT NULL DEFAULT 'pending'
  CHECK (status IN ('pending', 'accepted', 'rejected', 'completed', 'missed'))
```

The database schema **does not allow** `'cancelled'` as a valid status value. When the code tries to execute:

```typescript
await supabase
  .from("call_logs")
  .update({ status: "cancelled", ended_at: new Date().toISOString() })
```

PostgreSQL will reject it with:
```
ERROR: new row for relation "call_logs" violates check constraint "call_logs_status_check"
```

**Required Fix:** Database migration to expand the CHECK constraint.

---

## Documentation Review - What Was Changed

### Changes Made (Commit 86e4bc8)

1. **call-logs.md:**
   - Added 'cancelled' to state machine diagram
   - Added 'cancelled' row to state definitions table
   - Updated edge case #4 to show status='cancelled' instead of deletion
   - Updated statistics to note cancelled calls count in total rings
   - Updated CSV export notes
   - Added call-logger.ts to code references

2. **call-lifecycle.md:**
   - Changed call:cancel event description from "deletes" to "marks as cancelled"
   - Updated edge case #3 to show "DB marked cancelled" instead of "DB deleted"
   - Added note "Preserves audit trail"

3. **call-logger.ts:**
   - Added comprehensive JSDoc to `markCallCancelled` function
   - Explained rationale for preserving records vs deletion

### Documentation Quality

**Strengths:**
- ✅ Clear explanation of rationale (audit trail for visitor behavior)
- ✅ Comprehensive JSDoc with example
- ✅ Updated multiple related docs for consistency
- ✅ State machine diagram properly updated
- ✅ Edge cases clearly documented

**Issues:**
- ❌ Documentation marked feature as working (✅) when implementation is incomplete
- ❌ No mention of required database migration
- ❌ No "OPEN QUESTIONS" or "Identified Issues" section
- ❌ Doesn't note the multiple UI updates needed

---

## Root Cause Analysis

This appears to be a **sequencing issue** where:

1. **Dev Agent** implemented the TypeScript code (markCallCancelled sets status='cancelled')
2. **Docs Agent** documented the intended behavior as if complete
3. **QA Agent** likely tested with mock data or didn't trigger the database path
4. **Auto-merge** happened because tests passed (tests may not cover database constraints)
5. **Nobody verified** that the database schema actually allows 'cancelled'

The core logic is correct, but the foundational data layer was never updated to support the new status value.

---

## Relationship to Original Finding

**Original Finding:** F-025 - "Cancelled Calls Have No Audit Trail"

**PM Decision:** "Log cancelled calls with status='cancelled' instead of deleting them"

**Implementation Status:**
- ✅ Code written to set status='cancelled'
- ✅ Tests updated to verify behavior
- ✅ Documentation updated
- ❌ **Database schema not updated to allow 'cancelled'**
- ❌ **TypeScript types not updated**
- ❌ **UI not updated to display/filter 'cancelled'**

The feature is **3/6 complete**. The conceptual work (design, code logic, tests, docs) is done, but the infrastructure (database, types, UI) was not updated.

---

## Recommended Fix Sequence

1. **FIRST:** Create database migration to add 'cancelled' to CHECK constraint
2. **SECOND:** Update TypeScript `CallStatus` type in database.types.ts
3. **THIRD:** Add 'cancelled' to UI filter options (admin and agent views)
4. **FOURTH:** Add 'cancelled' case to CallLogRow getStatusIcon function
5. **FIFTH:** Run QA with real database to verify constraint no longer blocks
6. **SIXTH:** Update docs to reflect any actual behavior differences found

**Estimated Effort:** 30-60 minutes to fix all issues

**Risk Level:** Low - Changes are straightforward, localized, and additive

---

## Notes

- The JSDoc added to call-logger.ts is excellent and provides clear rationale
- The state machine diagram update is accurate and helpful
- The edge case documentation is thorough
- This review caught the issues before they could cause production failures
- The original finding (F-025) is now ticketed, which creates an audit trail loop: we're preserving audit trails for cancelled calls to create better audit trails!

---

## Next Steps for Triage Agent

1. Review all 6 findings
2. Decide whether to:
   - Create a single "fix TKT-059 blockers" ticket covering all 6 issues
   - OR reopen TKT-059 and add the missing implementation steps
   - OR create separate tickets for database, TypeScript, and UI work
3. Consider priority: **Critical/High** - Feature is documented as complete but will fail
4. Note that this is a good candidate for a **Dev Agent continuation ticket** since the original work is 50% done

---

**Review Agent Session Complete**
