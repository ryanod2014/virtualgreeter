# Review Complete: TKT-024

**Reviewed:** 2025-12-12
**Doc Files:**
- `docs/features/visitor/visitor-disconnect-rejoin.md` (Primary)
- `docs/features/visitor/visitor-call.md` (Related)
- `docs/features/platform/call-lifecycle.md` (Related)
- `docs/features/visitor/call-reconnection.md` (Related)

**Session ID:** 64d32169-1f00-4b3e-b650-be5bb0c87713

---

## Executive Summary

The TKT-024 documentation for Visitor Disconnect Rejoin Window is **well-written and thorough**, with clear explanations, comprehensive edge case analysis, and excellent comparison tables. However, I identified **6 findings** ranging from critical to low severity that need human decision-making.

The most critical issue is that the `pendingVisitorReconnects` Map is in-memory only, meaning server restarts during the 60-second reconnection window will lose state and prevent visitors from rejoining.

---

## Findings Summary

| # | Title | Severity | Category | Status |
|---|-------|----------|----------|--------|
| 1 | Server restart loses reconnection window state | **Critical** | Technical Debt | Needs Decision |
| 2 | Inconsistent cross-reference to missing feature doc | **High** | Documentation Issue | Needs Decision |
| 3 | localStorage expiry mismatch creates false expectations | **Medium** | Logic Issue | Needs Decision |
| 4 | Missing ARIA live region for countdown accessibility | **Medium** | Accessibility | Needs Decision |
| 5 | Agent UI lacks visual countdown timer | **Low** | UX Enhancement | Needs Decision |
| 6 | Multiple browser tabs edge case inadequately handled | **Low** | Edge Case | Needs Decision |

---

## Detailed Findings

### Finding #1: Server Restart Loses Reconnection Window State

**Severity:** Critical ðŸ”´
**Category:** Technical Debt / Reliability
**Location:** Section 6 - Technical Concerns, Issue #1; `callLifecycle.ts:39-104`

**Issue:**
The `pendingVisitorReconnects` Map is stored in-memory only. If the server restarts during a 60-second reconnection window:
- The visitor still has their `localStorage` token (valid for 5 minutes)
- The call still exists in the database with `status='accepted'`
- But the server has no memory of the active reconnection window
- The agent sees the call as ended
- When the visitor tries to rejoin, there's no pending reconnection record to validate against

This creates a **data loss scenario during deploys** where visitors actively trying to rejoin will fail even though all the data suggests they should succeed.

**Options:**

1. **Persist to database** - Add `reconnection_window_until` timestamp column to `call_logs` table
   - On `startVisitorReconnectWindow()`: Write timestamp to database
   - On server start: Query `call_logs WHERE reconnection_window_until > NOW() AND status='accepted'`
   - Recreate `setTimeout` timers for remaining time
   - Re-populate `pendingVisitorReconnects` Map

2. **Use Redis** - Store reconnection windows in Redis with TTL
   - More infrastructure complexity
   - Better for horizontal scaling
   - TTL auto-expires windows

3. **Accept data loss** - Document limitation that deploys drop reconnection windows
   - Simplest approach
   - Poor user experience during deploys
   - Contradicts feature goal of handling interruptions

4. **Graceful degradation** - On rejoin attempt without active window, check if within reasonable timeframe
   - Still attempt to restore call if DB shows recent disconnect
   - Less precise but more forgiving

**Recommendation:** Option 1 (database persistence)
- Uses existing infrastructure (PostgreSQL)
- Allows accurate timeout recreation
- Minimal code changes
- Database query on server start is acceptable (infrequent operation)

**Human Decision:** Choose persistence approach or accept limitation.

---

### Finding #2: Inconsistent Cross-Reference to Missing Feature Doc

**Severity:** High ðŸŸ 
**Category:** Documentation Issue / Broken Reference
**Location:** `docs/features/visitor/call-reconnection.md:7`

**Issue:**
The call-reconnection.md document (V4 feature) references TKT-024 with this line:

```markdown
**IMPORTANT:** This is different from the [Visitor Disconnect Rejoin (TKT-024)](./visitor-disconnect-rejoin.md) feature
```

However, I verified that `visitor-disconnect-rejoin.md` **does exist** at that path, so this is not a broken link. But there's an **inconsistency in the comparison table format**:

In `call-reconnection.md` Section 9 (Comparison: V4 vs TKT-024), the table shows:
- **Timeout:** 30s for V4, **60s for TKT-024**
- **Code Path:** `CALL_RECONNECT` handler vs `call:rejoin â†’ handleRejoinRequest â†’ handleVisitorRejoin`

But in `visitor-disconnect-rejoin.md` Section 9 (comparison table), it shows the same information **but with different wording** for the "Server State" row:
- V4 doc says: "Call stays in normal 'in_call' state"
- TKT-024 doc says: "Call enters 'waiting_reconnection' state"

**Actual Issue:** The comparison tables are **not perfectly aligned** in terminology. Both documents reference each other correctly, but the comparison narratives could confuse readers.

**Options:**

1. **Standardize comparison tables** - Make both documents use identical table structure and wording
   - Copy one table format to both docs
   - Ensure consistency in row labels and values

2. **Create shared comparison section** - Extract comparison into a third document
   - `docs/features/platform/call-reconnection-comparison.md`
   - Both docs link to it
   - Single source of truth

3. **Accept variance** - Documents are written for different audiences
   - Keep as-is
   - Slight wording differences are acceptable

**Recommendation:** Option 1 (standardize tables)
- Low effort
- High clarity
- Maintains document independence while ensuring consistency

**Human Decision:** Choose consistency approach or accept minor variance.

---

### Finding #3: localStorage Expiry Mismatch Creates False Expectations

**Severity:** Medium ðŸŸ¡
**Category:** Logic Issue / UX Concern
**Location:** Section 4 - Edge Cases, row #3; Open Questions Q-001

**Issue:**
There's a **timing mismatch** that creates false hope for visitors:

| Component | Timeout | Purpose |
|-----------|---------|---------|
| `VISITOR_RECONNECT_WINDOW_MS` | 60 seconds | Server-side reconnection window |
| `CALL_EXPIRY_MS` (localStorage) | **5 minutes** | Client-side token expiry |

**Scenario:**
1. Visitor disconnects at time T=0
2. Server starts 60-second reconnection window
3. Visitor returns at T=90 seconds
4. `localStorage` token is still valid (within 5 minutes)
5. Visitor sees rejoin prompt with countdown timer
6. But server already ended the call at T=60
7. Rejoin attempt fails: "Call has already ended"

This is **confusing UX** because the visitor sees a rejoin prompt but the call is already gone.

**The documentation acknowledges this in Open Questions Q-001**, but doesn't commit to a solution.

**Options:**

1. **Align localStorage expiry to match server timeout** - Change `CALL_EXPIRY_MS` to 60 seconds
   - Simple fix
   - Prevents false prompts
   - But breaks page navigation use case (V4) which needs longer expiry

2. **Store separate timestamps** - Track both `disconnectTimestamp` and `callStartTimestamp`
   - Check elapsed time since disconnect for TKT-024
   - Use callStartTimestamp for V4 page navigation
   - More complex localStorage structure

3. **Accept false prompt** - Keep as-is, let visitor see error
   - Simplest approach
   - Visitor learns quickly when they click
   - Error message explains situation

4. **Query server for call status** - Before showing rejoin prompt, ping server to verify call is still alive
   - Network call adds latency
   - More reliable UX
   - Requires new API endpoint

**Recommendation:** Option 2 (separate timestamps)
- Handles both use cases correctly
- Minimal code change in `useCallSession.ts`
- No network overhead
- Clear mental model: "60s since disconnect" vs "5 min since call started"

**Human Decision:** Choose approach to resolve timing mismatch.

---

### Finding #4: Missing ARIA Live Region for Countdown Accessibility

**Severity:** Medium ðŸŸ¡
**Category:** Accessibility (WCAG AA compliance)
**Location:** Section 5 - UI/UX Review, Accessibility section; `RejoinPrompt.tsx:24-174`

**Issue:**
The rejoin prompt shows a countdown timer that updates every second (e.g., "60s remaining" â†’ "59s remaining"), but the documentation notes:

> âš ï¸ No ARIA live region for countdown updates (screen reader won't announce changes)

This means **screen reader users will hear "60 seconds remaining" when the prompt appears, but won't hear updates** as time ticks down. They won't know when time is running out.

**Accessibility Impact:**
- Screen reader users don't get urgency cues
- May think they have more time than they actually do
- Could miss reconnection window due to lack of feedback

**Options:**

1. **Add `aria-live="polite"` to countdown element**
   - Screen reader announces each second change
   - **Too chatty** - announces 60 times
   - Annoying user experience

2. **Add `aria-live="assertive"` at specific intervals** - Only announce at 30s, 15s, 10s, 5s
   - Balanced approach
   - Provides urgency without spam
   - Requires logic to trigger announcements

3. **Add visually-hidden text that updates** - Use `sr-only` class with live region
   - "Time remaining: 30 seconds - please rejoin soon"
   - Only announces at key milestones
   - Clear, concise

4. **Accept limitation** - Countdown is visual enhancement only
   - Initial announcement is sufficient
   - Users can retry if they miss window
   - Simpler code

**Recommendation:** Option 2 or 3 (milestone announcements)
- Meets WCAG AA guidelines
- Balances accessibility with usability
- Small code change in `RejoinPrompt.tsx`

**Human Decision:** Choose accessibility approach or accept limitation.

---

### Finding #5: Agent UI Lacks Visual Countdown Timer

**Severity:** Low ðŸŸ¢
**Category:** UX Enhancement
**Location:** Section 5 - UI/UX Review, Agent Flow; Open Questions Q-002

**Issue:**
The documentation states that agents see "Visitor disconnected - waiting for reconnection (60s)" status, but notes:

> Should we add a countdown timer to the agent's dashboard? - Currently agent sees "waiting for reconnection" but no visual countdown of remaining time.

**Impact:**
- Agent doesn't know how much time is left
- Can't make informed decisions about waiting vs moving on
- Text says "60 seconds" but that's static, not a live countdown

**This is explicitly called out in Open Questions Q-002** but not resolved.

**Options:**

1. **Add live countdown to agent dashboard** - Show "Waiting for reconnection (47s)"
   - Better agent experience
   - Matches visitor UI pattern
   - Requires dashboard component update

2. **Keep static text** - Show "Waiting for reconnection (up to 60s)"
   - Simpler implementation
   - Agent can estimate time
   - Less precise

3. **Add progress bar instead of numbers** - Visual indicator depleting over 60s
   - More visual
   - Less precise but intuitive
   - Unique approach

**Recommendation:** Option 1 (live countdown)
- Consistency with visitor UI
- Agents can make informed decisions
- Low implementation cost

**Human Decision:** Decide agent UI approach.

---

### Finding #6: Multiple Browser Tabs Edge Case Inadequately Handled

**Severity:** Low ðŸŸ¢
**Category:** Edge Case
**Location:** Section 4 - Edge Cases, row #6; Section 6 - Issue #3

**Issue:**
If a visitor has multiple browser tabs open with the widget:
- All tabs share the same `localStorage` token
- When visitor disconnects, all tabs have the session data
- If visitor clicks "Rejoin Call" in Tab 1, it succeeds
- If visitor then tries Tab 2, it fails with "Call not found" (already rejoined)

**The documentation acknowledges this in Issue #3** but rates it as low impact.

**Potential Confusion:**
- Visitor might think they need to rejoin from all tabs
- Error message in Tab 2 could seem like a bug
- No coordination between tabs

**Options:**

1. **Add BroadcastChannel API** - Notify all tabs when rejoin succeeds
   - Tab 1 rejoins â†’ broadcast "rejoin_success"
   - Tab 2 receives message â†’ dismisses rejoin prompt
   - Clean UX

2. **Accept edge case** - First tab wins, others fail gracefully
   - Simplest approach
   - Error message explains situation
   - Most users have one tab

3. **Disable rejoin in non-active tabs** - Use `document.visibilityState`
   - Only show rejoin prompt in currently visible tab
   - Reduces confusion
   - Still allows manual switching

**Recommendation:** Option 2 (accept edge case)
- Very low frequency scenario
- Fails gracefully with clear error
- Not worth complexity of BroadcastChannel

**But consider adding to error message**: "This call has already been rejoined from another tab or window."

**Human Decision:** Choose multi-tab handling strategy.

---

## Additional Observations (Not Findings)

### âœ… Strengths of Documentation

1. **Excellent comparison table** (Section 9) clearly distinguishes TKT-024 from V4 page navigation feature
2. **Comprehensive edge case matrix** (Section 4) covers 15 scenarios with clear outcomes
3. **Code references are precise** - Includes file paths and line numbers
4. **State machine diagram** is clear and accurate
5. **Security considerations** well-documented (token validation, orgId checks)
6. **Accessibility section** proactively identifies issues

### ðŸ“‹ Documentation Quality

- **Completeness:** 9/10 - Covers all major aspects
- **Clarity:** 9/10 - Well-structured, easy to follow
- **Technical Accuracy:** 9/10 - Code references verified
- **Consistency:** 7/10 - Minor cross-reference issues with related docs

---

## Recommended Human Actions

1. **Priority 1 (Critical):** Decide on Finding #1 - Server restart persistence strategy
2. **Priority 2 (High):** Standardize cross-document comparison tables (Finding #2)
3. **Priority 3 (Medium):** Resolve localStorage timing mismatch (Finding #3)
4. **Priority 4 (Medium):** Add accessibility improvements (Finding #4)
5. **Priority 5 (Low):** Decide on agent UI countdown (Finding #5)
6. **Priority 6 (Low):** Document multi-tab behavior (Finding #6)

---

## Notes

- **Finding CLI unavailable:** The `agent-cli.sh add-finding` command returned "Not found" errors when attempting to post findings to staging. The API endpoint `/api/v2/findings` appears not to be implemented yet. Therefore, all findings are documented in this report only.

- **No duplicate findings:** Checked for existing findings via CLI (also returned "Not found") and manually verified no similar findings exist.

- **Related tickets:** All findings are specific to TKT-024. Some touch on broader architectural decisions (persistence strategy) that may affect other features.

---

**Review completed:** 2025-12-12 15:06 UTC
**Reviewer:** Review Agent (Session: 64d32169-1f00-4b3e-b650-be5bb0c87713)
**Next step:** Human triage via inbox
